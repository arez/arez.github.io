<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: arez, class: ArezContext">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package arez;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import arez.spy.ActionCompleteEvent;</span>
<span class="source-line-no">004</span><span id="line-4">import arez.spy.ActionStartEvent;</span>
<span class="source-line-no">005</span><span id="line-5">import arez.spy.ComponentCreateStartEvent;</span>
<span class="source-line-no">006</span><span id="line-6">import arez.spy.ObservableValueCreateEvent;</span>
<span class="source-line-no">007</span><span id="line-7">import arez.spy.ObserveScheduleEvent;</span>
<span class="source-line-no">008</span><span id="line-8">import arez.spy.ObserverErrorEvent;</span>
<span class="source-line-no">009</span><span id="line-9">import arez.spy.PropertyAccessor;</span>
<span class="source-line-no">010</span><span id="line-10">import arez.spy.PropertyMutator;</span>
<span class="source-line-no">011</span><span id="line-11">import arez.spy.Spy;</span>
<span class="source-line-no">012</span><span id="line-12">import grim.annotations.OmitSymbol;</span>
<span class="source-line-no">013</span><span id="line-13">import java.util.Collection;</span>
<span class="source-line-no">014</span><span id="line-14">import java.util.Collections;</span>
<span class="source-line-no">015</span><span id="line-15">import java.util.HashMap;</span>
<span class="source-line-no">016</span><span id="line-16">import java.util.List;</span>
<span class="source-line-no">017</span><span id="line-17">import java.util.Map;</span>
<span class="source-line-no">018</span><span id="line-18">import java.util.Objects;</span>
<span class="source-line-no">019</span><span id="line-19">import javax.annotation.Nonnull;</span>
<span class="source-line-no">020</span><span id="line-20">import javax.annotation.Nullable;</span>
<span class="source-line-no">021</span><span id="line-21">import org.intellij.lang.annotations.MagicConstant;</span>
<span class="source-line-no">022</span><span id="line-22">import static org.realityforge.braincheck.Guards.*;</span>
<span class="source-line-no">023</span><span id="line-23"></span>
<span class="source-line-no">024</span><span id="line-24">/**</span>
<span class="source-line-no">025</span><span id="line-25"> * The ArezContext defines the top level container of interconnected observables and observers.</span>
<span class="source-line-no">026</span><span id="line-26"> * The context also provides the mechanism for creating transactions to read and write state</span>
<span class="source-line-no">027</span><span id="line-27"> * within the system.</span>
<span class="source-line-no">028</span><span id="line-28"> */</span>
<span class="source-line-no">029</span><span id="line-29">@SuppressWarnings( { "Duplicates" } )</span>
<span class="source-line-no">030</span><span id="line-30">public final class ArezContext</span>
<span class="source-line-no">031</span><span id="line-31">{</span>
<span class="source-line-no">032</span><span id="line-32">  /**</span>
<span class="source-line-no">033</span><span id="line-33">   * ID of the next node to be created.</span>
<span class="source-line-no">034</span><span id="line-34">   * This is only used if {@link Arez#areNamesEnabled()} returns true but no name has been supplied.</span>
<span class="source-line-no">035</span><span id="line-35">   */</span>
<span class="source-line-no">036</span><span id="line-36">  private int _nextNodeId = 1;</span>
<span class="source-line-no">037</span><span id="line-37">  /**</span>
<span class="source-line-no">038</span><span id="line-38">   * ID of the next transaction to be created.</span>
<span class="source-line-no">039</span><span id="line-39">   * This needs to start at 1 as {@link ObservableValue#NOT_IN_CURRENT_TRACKING} is used</span>
<span class="source-line-no">040</span><span id="line-40">   * to optimize dependency tracking in transactions.</span>
<span class="source-line-no">041</span><span id="line-41">   */</span>
<span class="source-line-no">042</span><span id="line-42">  private int _nextTransactionId = 1;</span>
<span class="source-line-no">043</span><span id="line-43">  /**</span>
<span class="source-line-no">044</span><span id="line-44">   * Zone associated with the context. This should be null unless {@link Arez#areZonesEnabled()} returns &lt;code&gt;true&lt;/code&gt;.</span>
<span class="source-line-no">045</span><span id="line-45">   */</span>
<span class="source-line-no">046</span><span id="line-46">  @OmitSymbol( unless = "arez.enable_zones" )</span>
<span class="source-line-no">047</span><span id="line-47">  @Nullable</span>
<span class="source-line-no">048</span><span id="line-48">  private final Zone _zone;</span>
<span class="source-line-no">049</span><span id="line-49">  /**</span>
<span class="source-line-no">050</span><span id="line-50">   * Tasks scheduled but yet to be run.</span>
<span class="source-line-no">051</span><span id="line-51">   */</span>
<span class="source-line-no">052</span><span id="line-52">  @Nonnull</span>
<span class="source-line-no">053</span><span id="line-53">  private final TaskQueue _taskQueue = new TaskQueue( Task.Flags.PRIORITY_COUNT, 100 );</span>
<span class="source-line-no">054</span><span id="line-54">  /**</span>
<span class="source-line-no">055</span><span id="line-55">   * Executor responsible for executing tasks.</span>
<span class="source-line-no">056</span><span id="line-56">   */</span>
<span class="source-line-no">057</span><span id="line-57">  @Nonnull</span>
<span class="source-line-no">058</span><span id="line-58">  private final RoundBasedTaskExecutor _executor = new RoundBasedTaskExecutor( _taskQueue, 100 );</span>
<span class="source-line-no">059</span><span id="line-59">  /**</span>
<span class="source-line-no">060</span><span id="line-60">   * Support infrastructure for propagating observer errors.</span>
<span class="source-line-no">061</span><span id="line-61">   */</span>
<span class="source-line-no">062</span><span id="line-62">  @OmitSymbol( unless = "arez.enable_observer_error_handlers" )</span>
<span class="source-line-no">063</span><span id="line-63">  @Nullable</span>
<span class="source-line-no">064</span><span id="line-64">  private final ObserverErrorHandlerSupport _observerErrorHandlerSupport =</span>
<span class="source-line-no">065</span><span id="line-65">    Arez.areObserverErrorHandlersEnabled() ? new ObserverErrorHandlerSupport() : null;</span>
<span class="source-line-no">066</span><span id="line-66">  /**</span>
<span class="source-line-no">067</span><span id="line-67">   * Support infrastructure for spy events.</span>
<span class="source-line-no">068</span><span id="line-68">   */</span>
<span class="source-line-no">069</span><span id="line-69">  @OmitSymbol( unless = "arez.enable_spies" )</span>
<span class="source-line-no">070</span><span id="line-70">  @Nullable</span>
<span class="source-line-no">071</span><span id="line-71">  private final SpyImpl _spy = Arez.areSpiesEnabled() ? new SpyImpl( Arez.areZonesEnabled() ? this : null ) : null;</span>
<span class="source-line-no">072</span><span id="line-72">  /**</span>
<span class="source-line-no">073</span><span id="line-73">   * Support infrastructure for components.</span>
<span class="source-line-no">074</span><span id="line-74">   */</span>
<span class="source-line-no">075</span><span id="line-75">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">076</span><span id="line-76">  @Nullable</span>
<span class="source-line-no">077</span><span id="line-77">  private final Map&lt;String, Map&lt;Object, Component&gt;&gt; _components =</span>
<span class="source-line-no">078</span><span id="line-78">    Arez.areNativeComponentsEnabled() ? new HashMap&lt;&gt;() : null;</span>
<span class="source-line-no">079</span><span id="line-79">  /**</span>
<span class="source-line-no">080</span><span id="line-80">   * Registry of top level observables.</span>
<span class="source-line-no">081</span><span id="line-81">   * These are all the Observables instances not contained within a component.</span>
<span class="source-line-no">082</span><span id="line-82">   */</span>
<span class="source-line-no">083</span><span id="line-83">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">084</span><span id="line-84">  @Nullable</span>
<span class="source-line-no">085</span><span id="line-85">  private final Map&lt;String, ObservableValue&lt;?&gt;&gt; _observableValues =</span>
<span class="source-line-no">086</span><span id="line-86">    Arez.areRegistriesEnabled() ? new HashMap&lt;&gt;() : null;</span>
<span class="source-line-no">087</span><span id="line-87">  /**</span>
<span class="source-line-no">088</span><span id="line-88">   * Registry of top level computable values.</span>
<span class="source-line-no">089</span><span id="line-89">   * These are all the ComputableValue instances not contained within a component.</span>
<span class="source-line-no">090</span><span id="line-90">   */</span>
<span class="source-line-no">091</span><span id="line-91">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">092</span><span id="line-92">  @Nullable</span>
<span class="source-line-no">093</span><span id="line-93">  private final Map&lt;String, ComputableValue&lt;?&gt;&gt; _computableValues =</span>
<span class="source-line-no">094</span><span id="line-94">    Arez.areRegistriesEnabled() ? new HashMap&lt;&gt;() : null;</span>
<span class="source-line-no">095</span><span id="line-95">  /**</span>
<span class="source-line-no">096</span><span id="line-96">   * Registry of all active tasks.</span>
<span class="source-line-no">097</span><span id="line-97">   */</span>
<span class="source-line-no">098</span><span id="line-98">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">099</span><span id="line-99">  @Nullable</span>
<span class="source-line-no">100</span><span id="line-100">  private final Map&lt;String, Task&gt; _tasks = Arez.areRegistriesEnabled() ? new HashMap&lt;&gt;() : null;</span>
<span class="source-line-no">101</span><span id="line-101">  /**</span>
<span class="source-line-no">102</span><span id="line-102">   * Registry of top level observers.</span>
<span class="source-line-no">103</span><span id="line-103">   * These are all the Observer instances not contained within a component.</span>
<span class="source-line-no">104</span><span id="line-104">   */</span>
<span class="source-line-no">105</span><span id="line-105">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">106</span><span id="line-106">  @Nullable</span>
<span class="source-line-no">107</span><span id="line-107">  private final Map&lt;String, Observer&gt; _observers = Arez.areRegistriesEnabled() ? new HashMap&lt;&gt;() : null;</span>
<span class="source-line-no">108</span><span id="line-108">  /**</span>
<span class="source-line-no">109</span><span id="line-109">   * Locator used to resolve references.</span>
<span class="source-line-no">110</span><span id="line-110">   */</span>
<span class="source-line-no">111</span><span id="line-111">  @OmitSymbol( unless = "arez.enable_references" )</span>
<span class="source-line-no">112</span><span id="line-112">  @Nullable</span>
<span class="source-line-no">113</span><span id="line-113">  private final AggregateLocator _locator = Arez.areReferencesEnabled() ? new AggregateLocator() : null;</span>
<span class="source-line-no">114</span><span id="line-114">  /**</span>
<span class="source-line-no">115</span><span id="line-115">   * Flag indicating whether the scheduler should run next time it is triggered.</span>
<span class="source-line-no">116</span><span id="line-116">   * This should be active only when there is no uncommitted transaction for context.</span>
<span class="source-line-no">117</span><span id="line-117">   */</span>
<span class="source-line-no">118</span><span id="line-118">  private boolean _schedulerEnabled = true;</span>
<span class="source-line-no">119</span><span id="line-119">  /**</span>
<span class="source-line-no">120</span><span id="line-120">   * The number of un-released locks on the scheduler.</span>
<span class="source-line-no">121</span><span id="line-121">   */</span>
<span class="source-line-no">122</span><span id="line-122">  private int _schedulerLockCount;</span>
<span class="source-line-no">123</span><span id="line-123">  /**</span>
<span class="source-line-no">124</span><span id="line-124">   * Flag indicating whether the scheduler is currently active.</span>
<span class="source-line-no">125</span><span id="line-125">   */</span>
<span class="source-line-no">126</span><span id="line-126">  private boolean _schedulerActive;</span>
<span class="source-line-no">127</span><span id="line-127">  /**</span>
<span class="source-line-no">128</span><span id="line-128">   * Cached copy of action to execute tasks.</span>
<span class="source-line-no">129</span><span id="line-129">   */</span>
<span class="source-line-no">130</span><span id="line-130">  @OmitSymbol( unless = "arez.enable_task_interceptor" )</span>
<span class="source-line-no">131</span><span id="line-131">  @Nullable</span>
<span class="source-line-no">132</span><span id="line-132">  private final SafeProcedure _taskExecuteAction = Arez.isTaskInterceptorEnabled() ? _executor::runTasks : null;</span>
<span class="source-line-no">133</span><span id="line-133">  /**</span>
<span class="source-line-no">134</span><span id="line-134">   * Interceptor that wraps all task executions.</span>
<span class="source-line-no">135</span><span id="line-135">   */</span>
<span class="source-line-no">136</span><span id="line-136">  @OmitSymbol( unless = "arez.enable_task_interceptor" )</span>
<span class="source-line-no">137</span><span id="line-137">  @Nullable</span>
<span class="source-line-no">138</span><span id="line-138">  private TaskInterceptor _taskInterceptor;</span>
<span class="source-line-no">139</span><span id="line-139"></span>
<span class="source-line-no">140</span><span id="line-140">  /**</span>
<span class="source-line-no">141</span><span id="line-141">   * Arez context should not be created directly but only accessed via Arez.</span>
<span class="source-line-no">142</span><span id="line-142">   */</span>
<span class="source-line-no">143</span><span id="line-143">  ArezContext( @Nullable final Zone zone )</span>
<span class="source-line-no">144</span><span id="line-144">  {</span>
<span class="source-line-no">145</span><span id="line-145">    _zone = Arez.areZonesEnabled() ? Objects.requireNonNull( zone ) : null;</span>
<span class="source-line-no">146</span><span id="line-146">  }</span>
<span class="source-line-no">147</span><span id="line-147"></span>
<span class="source-line-no">148</span><span id="line-148">  /**</span>
<span class="source-line-no">149</span><span id="line-149">   * Return the map for components of specified type.</span>
<span class="source-line-no">150</span><span id="line-150">   *</span>
<span class="source-line-no">151</span><span id="line-151">   * @param type the component type.</span>
<span class="source-line-no">152</span><span id="line-152">   * @return the map for components of specified type.</span>
<span class="source-line-no">153</span><span id="line-153">   */</span>
<span class="source-line-no">154</span><span id="line-154">  @Nonnull</span>
<span class="source-line-no">155</span><span id="line-155">  private Map&lt;Object, Component&gt; getComponentByTypeMap( @Nonnull final String type )</span>
<span class="source-line-no">156</span><span id="line-156">  {</span>
<span class="source-line-no">157</span><span id="line-157">    assert null != _components;</span>
<span class="source-line-no">158</span><span id="line-158">    return _components.computeIfAbsent( type, t -&gt; new HashMap&lt;&gt;() );</span>
<span class="source-line-no">159</span><span id="line-159">  }</span>
<span class="source-line-no">160</span><span id="line-160"></span>
<span class="source-line-no">161</span><span id="line-161">  /**</span>
<span class="source-line-no">162</span><span id="line-162">   * Return true if the component identified by type and id has been defined in context.</span>
<span class="source-line-no">163</span><span id="line-163">   *</span>
<span class="source-line-no">164</span><span id="line-164">   * @param type the component type.</span>
<span class="source-line-no">165</span><span id="line-165">   * @param id   the component id.</span>
<span class="source-line-no">166</span><span id="line-166">   * @return true if component is defined in context.</span>
<span class="source-line-no">167</span><span id="line-167">   */</span>
<span class="source-line-no">168</span><span id="line-168">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">169</span><span id="line-169">  public boolean isComponentPresent( @Nonnull final String type, @Nonnull final Object id )</span>
<span class="source-line-no">170</span><span id="line-170">  {</span>
<span class="source-line-no">171</span><span id="line-171">    apiInvariant( Arez::areNativeComponentsEnabled,</span>
<span class="source-line-no">172</span><span id="line-172">                  () -&gt; "Arez-0135: ArezContext.isComponentPresent() invoked when Arez.areNativeComponentsEnabled() returns false." );</span>
<span class="source-line-no">173</span><span id="line-173">    return getComponentByTypeMap( type ).containsKey( id );</span>
<span class="source-line-no">174</span><span id="line-174">  }</span>
<span class="source-line-no">175</span><span id="line-175"></span>
<span class="source-line-no">176</span><span id="line-176">  /**</span>
<span class="source-line-no">177</span><span id="line-177">   * Create a component with the specified parameters and return it.</span>
<span class="source-line-no">178</span><span id="line-178">   * This method should only be invoked if {@link Arez#areNativeComponentsEnabled()} returns true.</span>
<span class="source-line-no">179</span><span id="line-179">   * This method should not be invoked if {@link #isComponentPresent(String, Object)} returns true for</span>
<span class="source-line-no">180</span><span id="line-180">   * the parameters. The caller should invoke {@link Component#complete()} on the returned component as</span>
<span class="source-line-no">181</span><span id="line-181">   * soon as the component definition has completed.</span>
<span class="source-line-no">182</span><span id="line-182">   *</span>
<span class="source-line-no">183</span><span id="line-183">   * @param type the component type.</span>
<span class="source-line-no">184</span><span id="line-184">   * @param id   the component id.</span>
<span class="source-line-no">185</span><span id="line-185">   * @return the created component.</span>
<span class="source-line-no">186</span><span id="line-186">   */</span>
<span class="source-line-no">187</span><span id="line-187">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">188</span><span id="line-188">  @Nonnull</span>
<span class="source-line-no">189</span><span id="line-189">  public Component component( @Nonnull final String type, @Nonnull final Object id )</span>
<span class="source-line-no">190</span><span id="line-190">  {</span>
<span class="source-line-no">191</span><span id="line-191">    return component( type, id, Arez.areNamesEnabled() ? type + "@" + id : null );</span>
<span class="source-line-no">192</span><span id="line-192">  }</span>
<span class="source-line-no">193</span><span id="line-193"></span>
<span class="source-line-no">194</span><span id="line-194">  /**</span>
<span class="source-line-no">195</span><span id="line-195">   * Create a component with the specified parameters and return it.</span>
<span class="source-line-no">196</span><span id="line-196">   * This method should only be invoked if {@link Arez#areNativeComponentsEnabled()} returns true.</span>
<span class="source-line-no">197</span><span id="line-197">   * This method should not be invoked if {@link #isComponentPresent(String, Object)} returns true for</span>
<span class="source-line-no">198</span><span id="line-198">   * the parameters. The caller should invoke {@link Component#complete()} on the returned component as</span>
<span class="source-line-no">199</span><span id="line-199">   * soon as the component definition has completed.</span>
<span class="source-line-no">200</span><span id="line-200">   *</span>
<span class="source-line-no">201</span><span id="line-201">   * @param type the component type.</span>
<span class="source-line-no">202</span><span id="line-202">   * @param id   the component id.</span>
<span class="source-line-no">203</span><span id="line-203">   * @param name the name of the component. Should be null if {@link Arez#areNamesEnabled()} returns false.</span>
<span class="source-line-no">204</span><span id="line-204">   * @return the created component.</span>
<span class="source-line-no">205</span><span id="line-205">   */</span>
<span class="source-line-no">206</span><span id="line-206">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">207</span><span id="line-207">  @Nonnull</span>
<span class="source-line-no">208</span><span id="line-208">  public Component component( @Nonnull final String type, @Nonnull final Object id, @Nullable final String name )</span>
<span class="source-line-no">209</span><span id="line-209">  {</span>
<span class="source-line-no">210</span><span id="line-210">    return component( type, id, name, null );</span>
<span class="source-line-no">211</span><span id="line-211">  }</span>
<span class="source-line-no">212</span><span id="line-212"></span>
<span class="source-line-no">213</span><span id="line-213">  /**</span>
<span class="source-line-no">214</span><span id="line-214">   * Create a component with the specified parameters and return it.</span>
<span class="source-line-no">215</span><span id="line-215">   * This method should only be invoked if {@link Arez#areNativeComponentsEnabled()} returns true.</span>
<span class="source-line-no">216</span><span id="line-216">   * This method should not be invoked if {@link #isComponentPresent(String, Object)} returns true for</span>
<span class="source-line-no">217</span><span id="line-217">   * the parameters. The caller should invoke {@link Component#complete()} on the returned component as</span>
<span class="source-line-no">218</span><span id="line-218">   * soon as the component definition has completed.</span>
<span class="source-line-no">219</span><span id="line-219">   *</span>
<span class="source-line-no">220</span><span id="line-220">   * @param type       the component type.</span>
<span class="source-line-no">221</span><span id="line-221">   * @param id         the component id.</span>
<span class="source-line-no">222</span><span id="line-222">   * @param name       the name of the component. Should be null if {@link Arez#areNamesEnabled()} returns false.</span>
<span class="source-line-no">223</span><span id="line-223">   * @param preDispose the hook action called just before the Component is disposed. The hook method is called from within the dispose transaction.</span>
<span class="source-line-no">224</span><span id="line-224">   * @return the created component.</span>
<span class="source-line-no">225</span><span id="line-225">   */</span>
<span class="source-line-no">226</span><span id="line-226">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">227</span><span id="line-227">  @Nonnull</span>
<span class="source-line-no">228</span><span id="line-228">  public Component component( @Nonnull final String type,</span>
<span class="source-line-no">229</span><span id="line-229">                              @Nonnull final Object id,</span>
<span class="source-line-no">230</span><span id="line-230">                              @Nullable final String name,</span>
<span class="source-line-no">231</span><span id="line-231">                              @Nullable final SafeProcedure preDispose )</span>
<span class="source-line-no">232</span><span id="line-232">  {</span>
<span class="source-line-no">233</span><span id="line-233">    return component( type, id, name, preDispose, null );</span>
<span class="source-line-no">234</span><span id="line-234">  }</span>
<span class="source-line-no">235</span><span id="line-235"></span>
<span class="source-line-no">236</span><span id="line-236">  /**</span>
<span class="source-line-no">237</span><span id="line-237">   * Create a component with the specified parameters and return it.</span>
<span class="source-line-no">238</span><span id="line-238">   * This method should only be invoked if {@link Arez#areNativeComponentsEnabled()} returns true.</span>
<span class="source-line-no">239</span><span id="line-239">   * This method should not be invoked if {@link #isComponentPresent(String, Object)} returns true for</span>
<span class="source-line-no">240</span><span id="line-240">   * the parameters. The caller should invoke {@link Component#complete()} on the returned component as</span>
<span class="source-line-no">241</span><span id="line-241">   * soon as the component definition has completed.</span>
<span class="source-line-no">242</span><span id="line-242">   *</span>
<span class="source-line-no">243</span><span id="line-243">   * @param type        the component type.</span>
<span class="source-line-no">244</span><span id="line-244">   * @param id          the component id.</span>
<span class="source-line-no">245</span><span id="line-245">   * @param name        the name of the component. Should be null if {@link Arez#areNamesEnabled()} returns false.</span>
<span class="source-line-no">246</span><span id="line-246">   * @param preDispose  the hook action called just before the Component is disposed. The hook method is called from within the dispose transaction.</span>
<span class="source-line-no">247</span><span id="line-247">   * @param postDispose the hook action called just after the Component is disposed. The hook method is called from within the dispose transaction.</span>
<span class="source-line-no">248</span><span id="line-248">   * @return the created component.</span>
<span class="source-line-no">249</span><span id="line-249">   */</span>
<span class="source-line-no">250</span><span id="line-250">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">251</span><span id="line-251">  @Nonnull</span>
<span class="source-line-no">252</span><span id="line-252">  public Component component( @Nonnull final String type,</span>
<span class="source-line-no">253</span><span id="line-253">                              @Nonnull final Object id,</span>
<span class="source-line-no">254</span><span id="line-254">                              @Nullable final String name,</span>
<span class="source-line-no">255</span><span id="line-255">                              @Nullable final SafeProcedure preDispose,</span>
<span class="source-line-no">256</span><span id="line-256">                              @Nullable final SafeProcedure postDispose )</span>
<span class="source-line-no">257</span><span id="line-257">  {</span>
<span class="source-line-no">258</span><span id="line-258">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">259</span><span id="line-259">    {</span>
<span class="source-line-no">260</span><span id="line-260">      apiInvariant( Arez::areNativeComponentsEnabled,</span>
<span class="source-line-no">261</span><span id="line-261">                    () -&gt; "Arez-0008: ArezContext.component() invoked when Arez.areNativeComponentsEnabled() returns false." );</span>
<span class="source-line-no">262</span><span id="line-262">    }</span>
<span class="source-line-no">263</span><span id="line-263">    final Map&lt;Object, Component&gt; map = getComponentByTypeMap( type );</span>
<span class="source-line-no">264</span><span id="line-264">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">265</span><span id="line-265">    {</span>
<span class="source-line-no">266</span><span id="line-266">      apiInvariant( () -&gt; !map.containsKey( id ),</span>
<span class="source-line-no">267</span><span id="line-267">                    () -&gt; "Arez-0009: ArezContext.component() invoked for type '" + type + "' and id '" +</span>
<span class="source-line-no">268</span><span id="line-268">                          id + "' but a component already exists for specified type+id." );</span>
<span class="source-line-no">269</span><span id="line-269">    }</span>
<span class="source-line-no">270</span><span id="line-270">    final Component component =</span>
<span class="source-line-no">271</span><span id="line-271">      new Component( Arez.areZonesEnabled() ? this : null, type, id, name, preDispose, postDispose );</span>
<span class="source-line-no">272</span><span id="line-272">    map.put( id, component );</span>
<span class="source-line-no">273</span><span id="line-273">    if ( willPropagateSpyEvents() )</span>
<span class="source-line-no">274</span><span id="line-274">    {</span>
<span class="source-line-no">275</span><span id="line-275">      getSpy().reportSpyEvent( new ComponentCreateStartEvent( getSpy().asComponentInfo( component ) ) );</span>
<span class="source-line-no">276</span><span id="line-276">    }</span>
<span class="source-line-no">277</span><span id="line-277">    return component;</span>
<span class="source-line-no">278</span><span id="line-278">  }</span>
<span class="source-line-no">279</span><span id="line-279"></span>
<span class="source-line-no">280</span><span id="line-280">  /**</span>
<span class="source-line-no">281</span><span id="line-281">   * Invoked by the component during it's dispose to release resources associated with the component.</span>
<span class="source-line-no">282</span><span id="line-282">   *</span>
<span class="source-line-no">283</span><span id="line-283">   * @param component the component.</span>
<span class="source-line-no">284</span><span id="line-284">   */</span>
<span class="source-line-no">285</span><span id="line-285">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">286</span><span id="line-286">  void deregisterComponent( @Nonnull final Component component )</span>
<span class="source-line-no">287</span><span id="line-287">  {</span>
<span class="source-line-no">288</span><span id="line-288">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">289</span><span id="line-289">    {</span>
<span class="source-line-no">290</span><span id="line-290">      invariant( Arez::areNativeComponentsEnabled,</span>
<span class="source-line-no">291</span><span id="line-291">                 () -&gt; "Arez-0006: ArezContext.deregisterComponent() invoked when Arez.areNativeComponentsEnabled() returns false." );</span>
<span class="source-line-no">292</span><span id="line-292">    }</span>
<span class="source-line-no">293</span><span id="line-293">    final String type = component.getType();</span>
<span class="source-line-no">294</span><span id="line-294">    final Map&lt;Object, Component&gt; map = getComponentByTypeMap( type );</span>
<span class="source-line-no">295</span><span id="line-295">    final Component removed = map.remove( component.getId() );</span>
<span class="source-line-no">296</span><span id="line-296">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">297</span><span id="line-297">    {</span>
<span class="source-line-no">298</span><span id="line-298">      invariant( () -&gt; component == removed,</span>
<span class="source-line-no">299</span><span id="line-299">                 () -&gt; "Arez-0007: ArezContext.deregisterComponent() invoked for '" + component + "' but was " +</span>
<span class="source-line-no">300</span><span id="line-300">                       "unable to remove specified component from registry. Actual component removed: " + removed );</span>
<span class="source-line-no">301</span><span id="line-301">    }</span>
<span class="source-line-no">302</span><span id="line-302">    if ( map.isEmpty() )</span>
<span class="source-line-no">303</span><span id="line-303">    {</span>
<span class="source-line-no">304</span><span id="line-304">      assert _components != null;</span>
<span class="source-line-no">305</span><span id="line-305">      _components.remove( type );</span>
<span class="source-line-no">306</span><span id="line-306">    }</span>
<span class="source-line-no">307</span><span id="line-307">  }</span>
<span class="source-line-no">308</span><span id="line-308"></span>
<span class="source-line-no">309</span><span id="line-309">  /**</span>
<span class="source-line-no">310</span><span id="line-310">   * Return component with specified type and id if component exists.</span>
<span class="source-line-no">311</span><span id="line-311">   *</span>
<span class="source-line-no">312</span><span id="line-312">   * @param type the component type.</span>
<span class="source-line-no">313</span><span id="line-313">   * @param id   the component id.</span>
<span class="source-line-no">314</span><span id="line-314">   * @return the component or null.</span>
<span class="source-line-no">315</span><span id="line-315">   */</span>
<span class="source-line-no">316</span><span id="line-316">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">317</span><span id="line-317">  @Nullable</span>
<span class="source-line-no">318</span><span id="line-318">  Component findComponent( @Nonnull final String type, @Nonnull final Object id )</span>
<span class="source-line-no">319</span><span id="line-319">  {</span>
<span class="source-line-no">320</span><span id="line-320">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">321</span><span id="line-321">    {</span>
<span class="source-line-no">322</span><span id="line-322">      invariant( Arez::areNativeComponentsEnabled,</span>
<span class="source-line-no">323</span><span id="line-323">                 () -&gt; "Arez-0010: ArezContext.findComponent() invoked when Arez.areNativeComponentsEnabled() returns false." );</span>
<span class="source-line-no">324</span><span id="line-324">    }</span>
<span class="source-line-no">325</span><span id="line-325">    assert null != _components;</span>
<span class="source-line-no">326</span><span id="line-326">    final Map&lt;Object, Component&gt; map = _components.get( type );</span>
<span class="source-line-no">327</span><span id="line-327">    if ( null != map )</span>
<span class="source-line-no">328</span><span id="line-328">    {</span>
<span class="source-line-no">329</span><span id="line-329">      return map.get( id );</span>
<span class="source-line-no">330</span><span id="line-330">    }</span>
<span class="source-line-no">331</span><span id="line-331">    else</span>
<span class="source-line-no">332</span><span id="line-332">    {</span>
<span class="source-line-no">333</span><span id="line-333">      return null;</span>
<span class="source-line-no">334</span><span id="line-334">    }</span>
<span class="source-line-no">335</span><span id="line-335">  }</span>
<span class="source-line-no">336</span><span id="line-336"></span>
<span class="source-line-no">337</span><span id="line-337">  /**</span>
<span class="source-line-no">338</span><span id="line-338">   * Return all the components with specified type.</span>
<span class="source-line-no">339</span><span id="line-339">   *</span>
<span class="source-line-no">340</span><span id="line-340">   * @param type the component type.</span>
<span class="source-line-no">341</span><span id="line-341">   * @return the components for type.</span>
<span class="source-line-no">342</span><span id="line-342">   */</span>
<span class="source-line-no">343</span><span id="line-343">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">344</span><span id="line-344">  @Nonnull</span>
<span class="source-line-no">345</span><span id="line-345">  Collection&lt;Component&gt; findAllComponentsByType( @Nonnull final String type )</span>
<span class="source-line-no">346</span><span id="line-346">  {</span>
<span class="source-line-no">347</span><span id="line-347">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">348</span><span id="line-348">    {</span>
<span class="source-line-no">349</span><span id="line-349">      invariant( Arez::areNativeComponentsEnabled,</span>
<span class="source-line-no">350</span><span id="line-350">                 () -&gt; "Arez-0011: ArezContext.findAllComponentsByType() invoked when Arez.areNativeComponentsEnabled() returns false." );</span>
<span class="source-line-no">351</span><span id="line-351">    }</span>
<span class="source-line-no">352</span><span id="line-352">    assert null != _components;</span>
<span class="source-line-no">353</span><span id="line-353">    final Map&lt;Object, Component&gt; map = _components.get( type );</span>
<span class="source-line-no">354</span><span id="line-354">    if ( null != map )</span>
<span class="source-line-no">355</span><span id="line-355">    {</span>
<span class="source-line-no">356</span><span id="line-356">      return map.values();</span>
<span class="source-line-no">357</span><span id="line-357">    }</span>
<span class="source-line-no">358</span><span id="line-358">    else</span>
<span class="source-line-no">359</span><span id="line-359">    {</span>
<span class="source-line-no">360</span><span id="line-360">      return Collections.emptyList();</span>
<span class="source-line-no">361</span><span id="line-361">    }</span>
<span class="source-line-no">362</span><span id="line-362">  }</span>
<span class="source-line-no">363</span><span id="line-363"></span>
<span class="source-line-no">364</span><span id="line-364">  /**</span>
<span class="source-line-no">365</span><span id="line-365">   * Return all the component types as a collection.</span>
<span class="source-line-no">366</span><span id="line-366">   *</span>
<span class="source-line-no">367</span><span id="line-367">   * @return the component types.</span>
<span class="source-line-no">368</span><span id="line-368">   */</span>
<span class="source-line-no">369</span><span id="line-369">  @OmitSymbol( unless = "arez.enable_native_components" )</span>
<span class="source-line-no">370</span><span id="line-370">  @Nonnull</span>
<span class="source-line-no">371</span><span id="line-371">  Collection&lt;String&gt; findAllComponentTypes()</span>
<span class="source-line-no">372</span><span id="line-372">  {</span>
<span class="source-line-no">373</span><span id="line-373">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">374</span><span id="line-374">    {</span>
<span class="source-line-no">375</span><span id="line-375">      invariant( Arez::areNativeComponentsEnabled,</span>
<span class="source-line-no">376</span><span id="line-376">                 () -&gt; "Arez-0012: ArezContext.findAllComponentTypes() invoked when Arez.areNativeComponentsEnabled() returns false." );</span>
<span class="source-line-no">377</span><span id="line-377">    }</span>
<span class="source-line-no">378</span><span id="line-378">    assert null != _components;</span>
<span class="source-line-no">379</span><span id="line-379">    return _components.keySet();</span>
<span class="source-line-no">380</span><span id="line-380">  }</span>
<span class="source-line-no">381</span><span id="line-381"></span>
<span class="source-line-no">382</span><span id="line-382">  /**</span>
<span class="source-line-no">383</span><span id="line-383">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">384</span><span id="line-384">   *</span>
<span class="source-line-no">385</span><span id="line-385">   * @param &lt;T&gt;      the type of the computable value.</span>
<span class="source-line-no">386</span><span id="line-386">   * @param function the function that computes the value.</span>
<span class="source-line-no">387</span><span id="line-387">   * @return the ComputableValue instance.</span>
<span class="source-line-no">388</span><span id="line-388">   */</span>
<span class="source-line-no">389</span><span id="line-389">  @Nonnull</span>
<span class="source-line-no">390</span><span id="line-390">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nonnull final SafeFunction&lt;T&gt; function )</span>
<span class="source-line-no">391</span><span id="line-391">  {</span>
<span class="source-line-no">392</span><span id="line-392">    return computable( function, 0 );</span>
<span class="source-line-no">393</span><span id="line-393">  }</span>
<span class="source-line-no">394</span><span id="line-394"></span>
<span class="source-line-no">395</span><span id="line-395">  /**</span>
<span class="source-line-no">396</span><span id="line-396">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">397</span><span id="line-397">   *</span>
<span class="source-line-no">398</span><span id="line-398">   * @param &lt;T&gt;      the type of the computable value.</span>
<span class="source-line-no">399</span><span id="line-399">   * @param function the function that computes the value.</span>
<span class="source-line-no">400</span><span id="line-400">   * @param flags    the flags used to create the ComputableValue. The acceptable flags are defined in {@link ComputableValue.Flags}.</span>
<span class="source-line-no">401</span><span id="line-401">   * @return the ComputableValue instance.</span>
<span class="source-line-no">402</span><span id="line-402">   */</span>
<span class="source-line-no">403</span><span id="line-403">  @Nonnull</span>
<span class="source-line-no">404</span><span id="line-404">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nonnull final SafeFunction&lt;T&gt; function,</span>
<span class="source-line-no">405</span><span id="line-405">                                            @MagicConstant( flagsFromClass = ComputableValue.Flags.class ) final int flags )</span>
<span class="source-line-no">406</span><span id="line-406">  {</span>
<span class="source-line-no">407</span><span id="line-407">    return computable( null, function, flags );</span>
<span class="source-line-no">408</span><span id="line-408">  }</span>
<span class="source-line-no">409</span><span id="line-409"></span>
<span class="source-line-no">410</span><span id="line-410">  /**</span>
<span class="source-line-no">411</span><span id="line-411">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">412</span><span id="line-412">   *</span>
<span class="source-line-no">413</span><span id="line-413">   * @param &lt;T&gt;      the type of the computable value.</span>
<span class="source-line-no">414</span><span id="line-414">   * @param name     the name of the ComputableValue.</span>
<span class="source-line-no">415</span><span id="line-415">   * @param function the function that computes the value.</span>
<span class="source-line-no">416</span><span id="line-416">   * @return the ComputableValue instance.</span>
<span class="source-line-no">417</span><span id="line-417">   */</span>
<span class="source-line-no">418</span><span id="line-418">  @Nonnull</span>
<span class="source-line-no">419</span><span id="line-419">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nullable final String name, @Nonnull final SafeFunction&lt;T&gt; function )</span>
<span class="source-line-no">420</span><span id="line-420">  {</span>
<span class="source-line-no">421</span><span id="line-421">    return computable( name, function, 0 );</span>
<span class="source-line-no">422</span><span id="line-422">  }</span>
<span class="source-line-no">423</span><span id="line-423"></span>
<span class="source-line-no">424</span><span id="line-424">  /**</span>
<span class="source-line-no">425</span><span id="line-425">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">426</span><span id="line-426">   *</span>
<span class="source-line-no">427</span><span id="line-427">   * @param &lt;T&gt;      the type of the computable value.</span>
<span class="source-line-no">428</span><span id="line-428">   * @param name     the name of the ComputableValue.</span>
<span class="source-line-no">429</span><span id="line-429">   * @param function the function that computes the value.</span>
<span class="source-line-no">430</span><span id="line-430">   * @param flags    the flags used to create the ComputableValue. The acceptable flags are defined in {@link ComputableValue.Flags}.</span>
<span class="source-line-no">431</span><span id="line-431">   * @return the ComputableValue instance.</span>
<span class="source-line-no">432</span><span id="line-432">   */</span>
<span class="source-line-no">433</span><span id="line-433">  @Nonnull</span>
<span class="source-line-no">434</span><span id="line-434">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nullable final String name,</span>
<span class="source-line-no">435</span><span id="line-435">                                            @Nonnull final SafeFunction&lt;T&gt; function,</span>
<span class="source-line-no">436</span><span id="line-436">                                            @MagicConstant( flagsFromClass = ComputableValue.Flags.class ) final int flags )</span>
<span class="source-line-no">437</span><span id="line-437">  {</span>
<span class="source-line-no">438</span><span id="line-438">    return computable( null, name, function, flags );</span>
<span class="source-line-no">439</span><span id="line-439">  }</span>
<span class="source-line-no">440</span><span id="line-440"></span>
<span class="source-line-no">441</span><span id="line-441">  /**</span>
<span class="source-line-no">442</span><span id="line-442">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">443</span><span id="line-443">   *</span>
<span class="source-line-no">444</span><span id="line-444">   * @param &lt;T&gt;       the type of the computable value.</span>
<span class="source-line-no">445</span><span id="line-445">   * @param component the component that contains the ComputableValue if any. Must be null unless {@link Arez#areNativeComponentsEnabled()} returns true.</span>
<span class="source-line-no">446</span><span id="line-446">   * @param name      the name of the ComputableValue.</span>
<span class="source-line-no">447</span><span id="line-447">   * @param function  the function that computes the value.</span>
<span class="source-line-no">448</span><span id="line-448">   * @return the ComputableValue instance.</span>
<span class="source-line-no">449</span><span id="line-449">   */</span>
<span class="source-line-no">450</span><span id="line-450">  @Nonnull</span>
<span class="source-line-no">451</span><span id="line-451">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nullable final Component component,</span>
<span class="source-line-no">452</span><span id="line-452">                                            @Nullable final String name,</span>
<span class="source-line-no">453</span><span id="line-453">                                            @Nonnull final SafeFunction&lt;T&gt; function )</span>
<span class="source-line-no">454</span><span id="line-454">  {</span>
<span class="source-line-no">455</span><span id="line-455">    return computable( component, name, function, 0 );</span>
<span class="source-line-no">456</span><span id="line-456">  }</span>
<span class="source-line-no">457</span><span id="line-457"></span>
<span class="source-line-no">458</span><span id="line-458">  /**</span>
<span class="source-line-no">459</span><span id="line-459">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">460</span><span id="line-460">   *</span>
<span class="source-line-no">461</span><span id="line-461">   * @param &lt;T&gt;       the type of the computable value.</span>
<span class="source-line-no">462</span><span id="line-462">   * @param component the component that contains the ComputableValue if any. Must be null unless {@link Arez#areNativeComponentsEnabled()} returns true.</span>
<span class="source-line-no">463</span><span id="line-463">   * @param name      the name of the ComputableValue.</span>
<span class="source-line-no">464</span><span id="line-464">   * @param function  the function that computes the value.</span>
<span class="source-line-no">465</span><span id="line-465">   * @param flags     the flags used to create the ComputableValue. The acceptable flags are defined in {@link ComputableValue.Flags}.</span>
<span class="source-line-no">466</span><span id="line-466">   * @return the ComputableValue instance.</span>
<span class="source-line-no">467</span><span id="line-467">   */</span>
<span class="source-line-no">468</span><span id="line-468">  @Nonnull</span>
<span class="source-line-no">469</span><span id="line-469">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nullable final Component component,</span>
<span class="source-line-no">470</span><span id="line-470">                                            @Nullable final String name,</span>
<span class="source-line-no">471</span><span id="line-471">                                            @Nonnull final SafeFunction&lt;T&gt; function,</span>
<span class="source-line-no">472</span><span id="line-472">                                            @MagicConstant( flagsFromClass = ComputableValue.Flags.class ) final int flags )</span>
<span class="source-line-no">473</span><span id="line-473">  {</span>
<span class="source-line-no">474</span><span id="line-474">    return computable( component, name, function, null, null, flags );</span>
<span class="source-line-no">475</span><span id="line-475">  }</span>
<span class="source-line-no">476</span><span id="line-476"></span>
<span class="source-line-no">477</span><span id="line-477">  /**</span>
<span class="source-line-no">478</span><span id="line-478">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">479</span><span id="line-479">   *</span>
<span class="source-line-no">480</span><span id="line-480">   * @param &lt;T&gt;          the type of the computable value.</span>
<span class="source-line-no">481</span><span id="line-481">   * @param component    the component that contains the ComputableValue if any. Must be null unless {@link Arez#areNativeComponentsEnabled()} returns true.</span>
<span class="source-line-no">482</span><span id="line-482">   * @param name         the name of the ComputableValue.</span>
<span class="source-line-no">483</span><span id="line-483">   * @param function     the function that computes the value.</span>
<span class="source-line-no">484</span><span id="line-484">   * @param onActivate   the procedure to invoke when the ComputableValue changes from the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.</span>
<span class="source-line-no">485</span><span id="line-485">   * @param onDeactivate the procedure to invoke when the ComputableValue changes to the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.</span>
<span class="source-line-no">486</span><span id="line-486">   * @return the ComputableValue instance.</span>
<span class="source-line-no">487</span><span id="line-487">   */</span>
<span class="source-line-no">488</span><span id="line-488">  @Nonnull</span>
<span class="source-line-no">489</span><span id="line-489">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nullable final Component component,</span>
<span class="source-line-no">490</span><span id="line-490">                                            @Nullable final String name,</span>
<span class="source-line-no">491</span><span id="line-491">                                            @Nonnull final SafeFunction&lt;T&gt; function,</span>
<span class="source-line-no">492</span><span id="line-492">                                            @Nullable final Procedure onActivate,</span>
<span class="source-line-no">493</span><span id="line-493">                                            @Nullable final Procedure onDeactivate )</span>
<span class="source-line-no">494</span><span id="line-494">  {</span>
<span class="source-line-no">495</span><span id="line-495">    return computable( component, name, function, onActivate, onDeactivate, 0 );</span>
<span class="source-line-no">496</span><span id="line-496">  }</span>
<span class="source-line-no">497</span><span id="line-497"></span>
<span class="source-line-no">498</span><span id="line-498">  /**</span>
<span class="source-line-no">499</span><span id="line-499">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">500</span><span id="line-500">   *</span>
<span class="source-line-no">501</span><span id="line-501">   * @param &lt;T&gt;          the type of the computable value.</span>
<span class="source-line-no">502</span><span id="line-502">   * @param name         the name of the ComputableValue.</span>
<span class="source-line-no">503</span><span id="line-503">   * @param function     the function that computes the value.</span>
<span class="source-line-no">504</span><span id="line-504">   * @param onActivate   the procedure to invoke when the ComputableValue changes from the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.</span>
<span class="source-line-no">505</span><span id="line-505">   * @param onDeactivate the procedure to invoke when the ComputableValue changes to the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.</span>
<span class="source-line-no">506</span><span id="line-506">   * @return the ComputableValue instance.</span>
<span class="source-line-no">507</span><span id="line-507">   */</span>
<span class="source-line-no">508</span><span id="line-508">  @Nonnull</span>
<span class="source-line-no">509</span><span id="line-509">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nullable final String name,</span>
<span class="source-line-no">510</span><span id="line-510">                                            @Nonnull final SafeFunction&lt;T&gt; function,</span>
<span class="source-line-no">511</span><span id="line-511">                                            @Nullable final Procedure onActivate,</span>
<span class="source-line-no">512</span><span id="line-512">                                            @Nullable final Procedure onDeactivate )</span>
<span class="source-line-no">513</span><span id="line-513">  {</span>
<span class="source-line-no">514</span><span id="line-514">    return computable( name, function, onActivate, onDeactivate, 0 );</span>
<span class="source-line-no">515</span><span id="line-515">  }</span>
<span class="source-line-no">516</span><span id="line-516"></span>
<span class="source-line-no">517</span><span id="line-517">  /**</span>
<span class="source-line-no">518</span><span id="line-518">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">519</span><span id="line-519">   *</span>
<span class="source-line-no">520</span><span id="line-520">   * @param &lt;T&gt;          the type of the computable value.</span>
<span class="source-line-no">521</span><span id="line-521">   * @param name         the name of the ComputableValue.</span>
<span class="source-line-no">522</span><span id="line-522">   * @param function     the function that computes the value.</span>
<span class="source-line-no">523</span><span id="line-523">   * @param onActivate   the procedure to invoke when the ComputableValue changes from the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.</span>
<span class="source-line-no">524</span><span id="line-524">   * @param onDeactivate the procedure to invoke when the ComputableValue changes to the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.</span>
<span class="source-line-no">525</span><span id="line-525">   * @param flags        the flags used to create the ComputableValue. The acceptable flags are defined in {@link ComputableValue.Flags}.</span>
<span class="source-line-no">526</span><span id="line-526">   * @return the ComputableValue instance.</span>
<span class="source-line-no">527</span><span id="line-527">   */</span>
<span class="source-line-no">528</span><span id="line-528">  @Nonnull</span>
<span class="source-line-no">529</span><span id="line-529">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nullable final String name,</span>
<span class="source-line-no">530</span><span id="line-530">                                            @Nonnull final SafeFunction&lt;T&gt; function,</span>
<span class="source-line-no">531</span><span id="line-531">                                            @Nullable final Procedure onActivate,</span>
<span class="source-line-no">532</span><span id="line-532">                                            @Nullable final Procedure onDeactivate,</span>
<span class="source-line-no">533</span><span id="line-533">                                            @MagicConstant( flagsFromClass = ComputableValue.Flags.class ) final int flags )</span>
<span class="source-line-no">534</span><span id="line-534">  {</span>
<span class="source-line-no">535</span><span id="line-535">    return computable( null, name, function, onActivate, onDeactivate, flags );</span>
<span class="source-line-no">536</span><span id="line-536">  }</span>
<span class="source-line-no">537</span><span id="line-537"></span>
<span class="source-line-no">538</span><span id="line-538">  /**</span>
<span class="source-line-no">539</span><span id="line-539">   * Create a ComputableValue with specified parameters.</span>
<span class="source-line-no">540</span><span id="line-540">   *</span>
<span class="source-line-no">541</span><span id="line-541">   * @param &lt;T&gt;          the type of the computable value.</span>
<span class="source-line-no">542</span><span id="line-542">   * @param component    the component that contains the ComputableValue if any. Must be null unless {@link Arez#areNativeComponentsEnabled()} returns true.</span>
<span class="source-line-no">543</span><span id="line-543">   * @param name         the name of the ComputableValue.</span>
<span class="source-line-no">544</span><span id="line-544">   * @param function     the function that computes the value.</span>
<span class="source-line-no">545</span><span id="line-545">   * @param onActivate   the procedure to invoke when the ComputableValue changes from the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.</span>
<span class="source-line-no">546</span><span id="line-546">   * @param onDeactivate the procedure to invoke when the ComputableValue changes to the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.</span>
<span class="source-line-no">547</span><span id="line-547">   * @param flags        the flags used to create the ComputableValue. The acceptable flags are defined in {@link ComputableValue.Flags}.</span>
<span class="source-line-no">548</span><span id="line-548">   * @return the ComputableValue instance.</span>
<span class="source-line-no">549</span><span id="line-549">   */</span>
<span class="source-line-no">550</span><span id="line-550">  @Nonnull</span>
<span class="source-line-no">551</span><span id="line-551">  public &lt;T&gt; ComputableValue&lt;T&gt; computable( @Nullable final Component component,</span>
<span class="source-line-no">552</span><span id="line-552">                                            @Nullable final String name,</span>
<span class="source-line-no">553</span><span id="line-553">                                            @Nonnull final SafeFunction&lt;T&gt; function,</span>
<span class="source-line-no">554</span><span id="line-554">                                            @Nullable final Procedure onActivate,</span>
<span class="source-line-no">555</span><span id="line-555">                                            @Nullable final Procedure onDeactivate,</span>
<span class="source-line-no">556</span><span id="line-556">                                            @MagicConstant( flagsFromClass = ComputableValue.Flags.class ) final int flags )</span>
<span class="source-line-no">557</span><span id="line-557">  {</span>
<span class="source-line-no">558</span><span id="line-558">    return new ComputableValue&lt;&gt;( Arez.areZonesEnabled() ? this : null,</span>
<span class="source-line-no">559</span><span id="line-559">                                  component,</span>
<span class="source-line-no">560</span><span id="line-560">                                  generateName( "ComputableValue", name ),</span>
<span class="source-line-no">561</span><span id="line-561">                                  function,</span>
<span class="source-line-no">562</span><span id="line-562">                                  onActivate,</span>
<span class="source-line-no">563</span><span id="line-563">                                  onDeactivate,</span>
<span class="source-line-no">564</span><span id="line-564">                                  flags );</span>
<span class="source-line-no">565</span><span id="line-565">  }</span>
<span class="source-line-no">566</span><span id="line-566"></span>
<span class="source-line-no">567</span><span id="line-567">  /**</span>
<span class="source-line-no">568</span><span id="line-568">   * Build name for node.</span>
<span class="source-line-no">569</span><span id="line-569">   * If {@link Arez#areNamesEnabled()} returns false then this method will return null, otherwise the specified</span>
<span class="source-line-no">570</span><span id="line-570">   * name will be returned or a name synthesized from the prefix and a running number if no name is specified.</span>
<span class="source-line-no">571</span><span id="line-571">   *</span>
<span class="source-line-no">572</span><span id="line-572">   * @param prefix the prefix used if this method needs to generate name.</span>
<span class="source-line-no">573</span><span id="line-573">   * @param name   the name specified by the user.</span>
<span class="source-line-no">574</span><span id="line-574">   * @return the name.</span>
<span class="source-line-no">575</span><span id="line-575">   */</span>
<span class="source-line-no">576</span><span id="line-576">  @Nullable</span>
<span class="source-line-no">577</span><span id="line-577">  String generateName( @Nonnull final String prefix, @Nullable final String name )</span>
<span class="source-line-no">578</span><span id="line-578">  {</span>
<span class="source-line-no">579</span><span id="line-579">    return Arez.areNamesEnabled() ?</span>
<span class="source-line-no">580</span><span id="line-580">           null != name ? name : prefix + "@" + _nextNodeId++ :</span>
<span class="source-line-no">581</span><span id="line-581">           null;</span>
<span class="source-line-no">582</span><span id="line-582">  }</span>
<span class="source-line-no">583</span><span id="line-583"></span>
<span class="source-line-no">584</span><span id="line-584">  /**</span>
<span class="source-line-no">585</span><span id="line-585">   * Create an "autorun" observer that reschedules observed procedure when dependency updates occur.</span>
<span class="source-line-no">586</span><span id="line-586">   *</span>
<span class="source-line-no">587</span><span id="line-587">   * @param observe the executable observed by the observer.</span>
<span class="source-line-no">588</span><span id="line-588">   * @return the new Observer.</span>
<span class="source-line-no">589</span><span id="line-589">   */</span>
<span class="source-line-no">590</span><span id="line-590">  @Nonnull</span>
<span class="source-line-no">591</span><span id="line-591">  public Observer observer( @Nonnull final Procedure observe )</span>
<span class="source-line-no">592</span><span id="line-592">  {</span>
<span class="source-line-no">593</span><span id="line-593">    return observer( observe, 0 );</span>
<span class="source-line-no">594</span><span id="line-594">  }</span>
<span class="source-line-no">595</span><span id="line-595"></span>
<span class="source-line-no">596</span><span id="line-596">  /**</span>
<span class="source-line-no">597</span><span id="line-597">   * Create an "autorun" observer that reschedules observed procedure when dependency updates occur.</span>
<span class="source-line-no">598</span><span id="line-598">   *</span>
<span class="source-line-no">599</span><span id="line-599">   * @param observe the executable observed by the observer.</span>
<span class="source-line-no">600</span><span id="line-600">   * @param flags   the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">601</span><span id="line-601">   * @return the new Observer.</span>
<span class="source-line-no">602</span><span id="line-602">   */</span>
<span class="source-line-no">603</span><span id="line-603">  @Nonnull</span>
<span class="source-line-no">604</span><span id="line-604">  public Observer observer( @Nonnull final Procedure observe,</span>
<span class="source-line-no">605</span><span id="line-605">                            @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">606</span><span id="line-606">  {</span>
<span class="source-line-no">607</span><span id="line-607">    return observer( (String) null, observe, flags );</span>
<span class="source-line-no">608</span><span id="line-608">  }</span>
<span class="source-line-no">609</span><span id="line-609"></span>
<span class="source-line-no">610</span><span id="line-610">  /**</span>
<span class="source-line-no">611</span><span id="line-611">   * Create an "autorun" observer that reschedules observed procedure when dependency updates occur.</span>
<span class="source-line-no">612</span><span id="line-612">   *</span>
<span class="source-line-no">613</span><span id="line-613">   * @param name    the name of the observer.</span>
<span class="source-line-no">614</span><span id="line-614">   * @param observe the executable observed by the observer.</span>
<span class="source-line-no">615</span><span id="line-615">   * @return the new Observer.</span>
<span class="source-line-no">616</span><span id="line-616">   */</span>
<span class="source-line-no">617</span><span id="line-617">  @Nonnull</span>
<span class="source-line-no">618</span><span id="line-618">  public Observer observer( @Nullable final String name, @Nonnull final Procedure observe )</span>
<span class="source-line-no">619</span><span id="line-619">  {</span>
<span class="source-line-no">620</span><span id="line-620">    return observer( name, observe, 0 );</span>
<span class="source-line-no">621</span><span id="line-621">  }</span>
<span class="source-line-no">622</span><span id="line-622"></span>
<span class="source-line-no">623</span><span id="line-623">  /**</span>
<span class="source-line-no">624</span><span id="line-624">   * Create an "autorun" observer that reschedules observed procedure when dependency updates occur.</span>
<span class="source-line-no">625</span><span id="line-625">   *</span>
<span class="source-line-no">626</span><span id="line-626">   * @param name    the name of the observer.</span>
<span class="source-line-no">627</span><span id="line-627">   * @param observe the executable observed by the observer.</span>
<span class="source-line-no">628</span><span id="line-628">   * @param flags   the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">629</span><span id="line-629">   * @return the new Observer.</span>
<span class="source-line-no">630</span><span id="line-630">   */</span>
<span class="source-line-no">631</span><span id="line-631">  @Nonnull</span>
<span class="source-line-no">632</span><span id="line-632">  public Observer observer( @Nullable final String name,</span>
<span class="source-line-no">633</span><span id="line-633">                            @Nonnull final Procedure observe,</span>
<span class="source-line-no">634</span><span id="line-634">                            @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">635</span><span id="line-635">  {</span>
<span class="source-line-no">636</span><span id="line-636">    return observer( null, name, observe, flags );</span>
<span class="source-line-no">637</span><span id="line-637">  }</span>
<span class="source-line-no">638</span><span id="line-638"></span>
<span class="source-line-no">639</span><span id="line-639">  /**</span>
<span class="source-line-no">640</span><span id="line-640">   * Create an "autorun" observer that reschedules observed procedure when dependency updates occur.</span>
<span class="source-line-no">641</span><span id="line-641">   *</span>
<span class="source-line-no">642</span><span id="line-642">   * @param component the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">643</span><span id="line-643">   * @param name      the name of the observer.</span>
<span class="source-line-no">644</span><span id="line-644">   * @param observe   the executable observed by the observer.</span>
<span class="source-line-no">645</span><span id="line-645">   * @return the new Observer.</span>
<span class="source-line-no">646</span><span id="line-646">   */</span>
<span class="source-line-no">647</span><span id="line-647">  @Nonnull</span>
<span class="source-line-no">648</span><span id="line-648">  public Observer observer( @Nullable final Component component,</span>
<span class="source-line-no">649</span><span id="line-649">                            @Nullable final String name,</span>
<span class="source-line-no">650</span><span id="line-650">                            @Nonnull final Procedure observe )</span>
<span class="source-line-no">651</span><span id="line-651">  {</span>
<span class="source-line-no">652</span><span id="line-652">    return observer( component, name, observe, 0 );</span>
<span class="source-line-no">653</span><span id="line-653">  }</span>
<span class="source-line-no">654</span><span id="line-654"></span>
<span class="source-line-no">655</span><span id="line-655">  /**</span>
<span class="source-line-no">656</span><span id="line-656">   * Create an "autorun" observer that reschedules observed procedure when dependency updates occur.</span>
<span class="source-line-no">657</span><span id="line-657">   *</span>
<span class="source-line-no">658</span><span id="line-658">   * @param component the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">659</span><span id="line-659">   * @param name      the name of the observer.</span>
<span class="source-line-no">660</span><span id="line-660">   * @param observe   the executable observed by the observer.</span>
<span class="source-line-no">661</span><span id="line-661">   * @param flags     the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">662</span><span id="line-662">   * @return the new Observer.</span>
<span class="source-line-no">663</span><span id="line-663">   */</span>
<span class="source-line-no">664</span><span id="line-664">  @Nonnull</span>
<span class="source-line-no">665</span><span id="line-665">  public Observer observer( @Nullable final Component component,</span>
<span class="source-line-no">666</span><span id="line-666">                            @Nullable final String name,</span>
<span class="source-line-no">667</span><span id="line-667">                            @Nonnull final Procedure observe,</span>
<span class="source-line-no">668</span><span id="line-668">                            @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">669</span><span id="line-669">  {</span>
<span class="source-line-no">670</span><span id="line-670">    return observer( component, name, Objects.requireNonNull( observe ), null, flags );</span>
<span class="source-line-no">671</span><span id="line-671">  }</span>
<span class="source-line-no">672</span><span id="line-672"></span>
<span class="source-line-no">673</span><span id="line-673">  /**</span>
<span class="source-line-no">674</span><span id="line-674">   * Create an observer.</span>
<span class="source-line-no">675</span><span id="line-675">   * The user must pass either the &lt;code&gt;observe&lt;/code&gt; or &lt;code&gt;onDepsChange&lt;/code&gt; parameter.</span>
<span class="source-line-no">676</span><span id="line-676">   *</span>
<span class="source-line-no">677</span><span id="line-677">   * @param component    the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">678</span><span id="line-678">   * @param name         the name of the observer.</span>
<span class="source-line-no">679</span><span id="line-679">   * @param observe      the executable observed by the observer. May be null if observer is externally scheduled.</span>
<span class="source-line-no">680</span><span id="line-680">   * @param onDepsChange the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.</span>
<span class="source-line-no">681</span><span id="line-681">   * @return the new Observer.</span>
<span class="source-line-no">682</span><span id="line-682">   */</span>
<span class="source-line-no">683</span><span id="line-683">  @Nonnull</span>
<span class="source-line-no">684</span><span id="line-684">  public Observer observer( @Nullable final Component component,</span>
<span class="source-line-no">685</span><span id="line-685">                            @Nullable final String name,</span>
<span class="source-line-no">686</span><span id="line-686">                            @Nullable final Procedure observe,</span>
<span class="source-line-no">687</span><span id="line-687">                            @Nullable final Procedure onDepsChange )</span>
<span class="source-line-no">688</span><span id="line-688">  {</span>
<span class="source-line-no">689</span><span id="line-689">    return observer( component, name, observe, onDepsChange, 0 );</span>
<span class="source-line-no">690</span><span id="line-690">  }</span>
<span class="source-line-no">691</span><span id="line-691"></span>
<span class="source-line-no">692</span><span id="line-692">  /**</span>
<span class="source-line-no">693</span><span id="line-693">   * Create an observer.</span>
<span class="source-line-no">694</span><span id="line-694">   * The user must pass either the &lt;code&gt;observe&lt;/code&gt; or &lt;code&gt;onDepsChange&lt;/code&gt; or both parameters.</span>
<span class="source-line-no">695</span><span id="line-695">   *</span>
<span class="source-line-no">696</span><span id="line-696">   * @param observe      the executable observed by the observer. May be null if observer is externally scheduled.</span>
<span class="source-line-no">697</span><span id="line-697">   * @param onDepsChange the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.</span>
<span class="source-line-no">698</span><span id="line-698">   * @return the new Observer.</span>
<span class="source-line-no">699</span><span id="line-699">   */</span>
<span class="source-line-no">700</span><span id="line-700">  @Nonnull</span>
<span class="source-line-no">701</span><span id="line-701">  public Observer observer( @Nullable final Procedure observe, @Nullable final Procedure onDepsChange )</span>
<span class="source-line-no">702</span><span id="line-702">  {</span>
<span class="source-line-no">703</span><span id="line-703">    return observer( observe, onDepsChange, 0 );</span>
<span class="source-line-no">704</span><span id="line-704">  }</span>
<span class="source-line-no">705</span><span id="line-705"></span>
<span class="source-line-no">706</span><span id="line-706">  /**</span>
<span class="source-line-no">707</span><span id="line-707">   * Create an observer.</span>
<span class="source-line-no">708</span><span id="line-708">   * The user must pass either the &lt;code&gt;observe&lt;/code&gt; or &lt;code&gt;onDepsChange&lt;/code&gt; or both parameters.</span>
<span class="source-line-no">709</span><span id="line-709">   *</span>
<span class="source-line-no">710</span><span id="line-710">   * @param observe      the executable observed by the observer. May be null if observer is externally scheduled.</span>
<span class="source-line-no">711</span><span id="line-711">   * @param onDepsChange the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.</span>
<span class="source-line-no">712</span><span id="line-712">   * @param flags        the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">713</span><span id="line-713">   * @return the new Observer.</span>
<span class="source-line-no">714</span><span id="line-714">   */</span>
<span class="source-line-no">715</span><span id="line-715">  @Nonnull</span>
<span class="source-line-no">716</span><span id="line-716">  public Observer observer( @Nullable final Procedure observe,</span>
<span class="source-line-no">717</span><span id="line-717">                            @Nullable final Procedure onDepsChange,</span>
<span class="source-line-no">718</span><span id="line-718">                            @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">719</span><span id="line-719">  {</span>
<span class="source-line-no">720</span><span id="line-720">    return observer( null, observe, onDepsChange, flags );</span>
<span class="source-line-no">721</span><span id="line-721">  }</span>
<span class="source-line-no">722</span><span id="line-722"></span>
<span class="source-line-no">723</span><span id="line-723">  /**</span>
<span class="source-line-no">724</span><span id="line-724">   * Create an observer.</span>
<span class="source-line-no">725</span><span id="line-725">   * The user must pass either the &lt;code&gt;observe&lt;/code&gt; or &lt;code&gt;onDepsChange&lt;/code&gt; or both parameters.</span>
<span class="source-line-no">726</span><span id="line-726">   *</span>
<span class="source-line-no">727</span><span id="line-727">   * @param name         the name of the observer.</span>
<span class="source-line-no">728</span><span id="line-728">   * @param observe      the executable observed by the observer. May be null if observer is externally scheduled.</span>
<span class="source-line-no">729</span><span id="line-729">   * @param onDepsChange the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.</span>
<span class="source-line-no">730</span><span id="line-730">   * @return the new Observer.</span>
<span class="source-line-no">731</span><span id="line-731">   */</span>
<span class="source-line-no">732</span><span id="line-732">  @Nonnull</span>
<span class="source-line-no">733</span><span id="line-733">  public Observer observer( @Nullable final String name,</span>
<span class="source-line-no">734</span><span id="line-734">                            @Nullable final Procedure observe,</span>
<span class="source-line-no">735</span><span id="line-735">                            @Nullable final Procedure onDepsChange )</span>
<span class="source-line-no">736</span><span id="line-736">  {</span>
<span class="source-line-no">737</span><span id="line-737">    return observer( name, observe, onDepsChange, 0 );</span>
<span class="source-line-no">738</span><span id="line-738">  }</span>
<span class="source-line-no">739</span><span id="line-739"></span>
<span class="source-line-no">740</span><span id="line-740">  /**</span>
<span class="source-line-no">741</span><span id="line-741">   * Create an observer.</span>
<span class="source-line-no">742</span><span id="line-742">   * The user must pass either the &lt;code&gt;observe&lt;/code&gt; or &lt;code&gt;onDepsChange&lt;/code&gt; or both parameters.</span>
<span class="source-line-no">743</span><span id="line-743">   *</span>
<span class="source-line-no">744</span><span id="line-744">   * @param name         the name of the observer.</span>
<span class="source-line-no">745</span><span id="line-745">   * @param observe      the executable observed by the observer. May be null if observer is externally scheduled.</span>
<span class="source-line-no">746</span><span id="line-746">   * @param onDepsChange the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.</span>
<span class="source-line-no">747</span><span id="line-747">   * @param flags        the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">748</span><span id="line-748">   * @return the new Observer.</span>
<span class="source-line-no">749</span><span id="line-749">   */</span>
<span class="source-line-no">750</span><span id="line-750">  @Nonnull</span>
<span class="source-line-no">751</span><span id="line-751">  public Observer observer( @Nullable final String name,</span>
<span class="source-line-no">752</span><span id="line-752">                            @Nullable final Procedure observe,</span>
<span class="source-line-no">753</span><span id="line-753">                            @Nullable final Procedure onDepsChange,</span>
<span class="source-line-no">754</span><span id="line-754">                            @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">755</span><span id="line-755">  {</span>
<span class="source-line-no">756</span><span id="line-756">    return observer( null, name, observe, onDepsChange, flags );</span>
<span class="source-line-no">757</span><span id="line-757">  }</span>
<span class="source-line-no">758</span><span id="line-758"></span>
<span class="source-line-no">759</span><span id="line-759">  /**</span>
<span class="source-line-no">760</span><span id="line-760">   * Create an observer.</span>
<span class="source-line-no">761</span><span id="line-761">   * The user must pass either the &lt;code&gt;observe&lt;/code&gt; or &lt;code&gt;onDepsChange&lt;/code&gt; or both parameters.</span>
<span class="source-line-no">762</span><span id="line-762">   *</span>
<span class="source-line-no">763</span><span id="line-763">   * @param component    the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">764</span><span id="line-764">   * @param name         the name of the observer.</span>
<span class="source-line-no">765</span><span id="line-765">   * @param observe      the executable observed by the observer. May be null if observer is externally scheduled.</span>
<span class="source-line-no">766</span><span id="line-766">   * @param onDepsChange the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.</span>
<span class="source-line-no">767</span><span id="line-767">   * @param flags        the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">768</span><span id="line-768">   * @return the new Observer.</span>
<span class="source-line-no">769</span><span id="line-769">   */</span>
<span class="source-line-no">770</span><span id="line-770">  @Nonnull</span>
<span class="source-line-no">771</span><span id="line-771">  public Observer observer( @Nullable final Component component,</span>
<span class="source-line-no">772</span><span id="line-772">                            @Nullable final String name,</span>
<span class="source-line-no">773</span><span id="line-773">                            @Nullable final Procedure observe,</span>
<span class="source-line-no">774</span><span id="line-774">                            @Nullable final Procedure onDepsChange,</span>
<span class="source-line-no">775</span><span id="line-775">                            @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">776</span><span id="line-776">  {</span>
<span class="source-line-no">777</span><span id="line-777">    return new Observer( Arez.areZonesEnabled() ? this : null,</span>
<span class="source-line-no">778</span><span id="line-778">                         component,</span>
<span class="source-line-no">779</span><span id="line-779">                         generateName( "Observer", name ),</span>
<span class="source-line-no">780</span><span id="line-780">                         observe,</span>
<span class="source-line-no">781</span><span id="line-781">                         onDepsChange,</span>
<span class="source-line-no">782</span><span id="line-782">                         flags );</span>
<span class="source-line-no">783</span><span id="line-783">  }</span>
<span class="source-line-no">784</span><span id="line-784"></span>
<span class="source-line-no">785</span><span id="line-785">  /**</span>
<span class="source-line-no">786</span><span id="line-786">   * Create a tracking observer. The tracking observer triggers the onDepsChange hook function when</span>
<span class="source-line-no">787</span><span id="line-787">   * dependencies in the observe function are updated. Application code is responsible for executing the</span>
<span class="source-line-no">788</span><span id="line-788">   * observe function by invoking a observe method such as {@link #observe(Observer, Function)}.</span>
<span class="source-line-no">789</span><span id="line-789">   *</span>
<span class="source-line-no">790</span><span id="line-790">   * @param onDepsChange the hook invoked when dependencies changed.</span>
<span class="source-line-no">791</span><span id="line-791">   * @return the new Observer.</span>
<span class="source-line-no">792</span><span id="line-792">   */</span>
<span class="source-line-no">793</span><span id="line-793">  @Nonnull</span>
<span class="source-line-no">794</span><span id="line-794">  public Observer tracker( @Nonnull final Procedure onDepsChange )</span>
<span class="source-line-no">795</span><span id="line-795">  {</span>
<span class="source-line-no">796</span><span id="line-796">    return tracker( onDepsChange, 0 );</span>
<span class="source-line-no">797</span><span id="line-797">  }</span>
<span class="source-line-no">798</span><span id="line-798"></span>
<span class="source-line-no">799</span><span id="line-799">  /**</span>
<span class="source-line-no">800</span><span id="line-800">   * Create a tracking observer. The tracking observer triggers the onDepsChange hook function when</span>
<span class="source-line-no">801</span><span id="line-801">   * dependencies in the observe function are updated. Application code is responsible for executing the</span>
<span class="source-line-no">802</span><span id="line-802">   * observe function by invoking a observe method such as {@link #observe(Observer, Function)}.</span>
<span class="source-line-no">803</span><span id="line-803">   *</span>
<span class="source-line-no">804</span><span id="line-804">   * @param onDepsChange the hook invoked when dependencies changed.</span>
<span class="source-line-no">805</span><span id="line-805">   * @param flags        the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">806</span><span id="line-806">   * @return the new Observer.</span>
<span class="source-line-no">807</span><span id="line-807">   */</span>
<span class="source-line-no">808</span><span id="line-808">  @Nonnull</span>
<span class="source-line-no">809</span><span id="line-809">  public Observer tracker( @Nonnull final Procedure onDepsChange,</span>
<span class="source-line-no">810</span><span id="line-810">                           @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">811</span><span id="line-811">  {</span>
<span class="source-line-no">812</span><span id="line-812">    return tracker( null, onDepsChange, flags );</span>
<span class="source-line-no">813</span><span id="line-813">  }</span>
<span class="source-line-no">814</span><span id="line-814"></span>
<span class="source-line-no">815</span><span id="line-815">  /**</span>
<span class="source-line-no">816</span><span id="line-816">   * Create a tracking observer. The tracking observer triggers the onDepsChange hook function when</span>
<span class="source-line-no">817</span><span id="line-817">   * dependencies in the observe function are updated. Application code is responsible for executing the</span>
<span class="source-line-no">818</span><span id="line-818">   * observe function by invoking a observe method such as {@link #observe(Observer, Function)}.</span>
<span class="source-line-no">819</span><span id="line-819">   *</span>
<span class="source-line-no">820</span><span id="line-820">   * @param name         the name of the observer.</span>
<span class="source-line-no">821</span><span id="line-821">   * @param onDepsChange the hook invoked when dependencies changed.</span>
<span class="source-line-no">822</span><span id="line-822">   * @return the new Observer.</span>
<span class="source-line-no">823</span><span id="line-823">   */</span>
<span class="source-line-no">824</span><span id="line-824">  @Nonnull</span>
<span class="source-line-no">825</span><span id="line-825">  public Observer tracker( @Nullable final String name, @Nonnull final Procedure onDepsChange )</span>
<span class="source-line-no">826</span><span id="line-826">  {</span>
<span class="source-line-no">827</span><span id="line-827">    return tracker( name, onDepsChange, 0 );</span>
<span class="source-line-no">828</span><span id="line-828">  }</span>
<span class="source-line-no">829</span><span id="line-829"></span>
<span class="source-line-no">830</span><span id="line-830">  /**</span>
<span class="source-line-no">831</span><span id="line-831">   * Create a tracking observer. The tracking observer triggers the onDepsChange hook function when</span>
<span class="source-line-no">832</span><span id="line-832">   * dependencies in the observe function are updated. Application code is responsible for executing the</span>
<span class="source-line-no">833</span><span id="line-833">   * observe function by invoking a observe method such as {@link #observe(Observer, Function)}.</span>
<span class="source-line-no">834</span><span id="line-834">   *</span>
<span class="source-line-no">835</span><span id="line-835">   * @param name         the name of the observer.</span>
<span class="source-line-no">836</span><span id="line-836">   * @param onDepsChange the hook invoked when dependencies changed.</span>
<span class="source-line-no">837</span><span id="line-837">   * @param flags        the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">838</span><span id="line-838">   * @return the new Observer.</span>
<span class="source-line-no">839</span><span id="line-839">   */</span>
<span class="source-line-no">840</span><span id="line-840">  @Nonnull</span>
<span class="source-line-no">841</span><span id="line-841">  public Observer tracker( @Nullable final String name,</span>
<span class="source-line-no">842</span><span id="line-842">                           @Nonnull final Procedure onDepsChange,</span>
<span class="source-line-no">843</span><span id="line-843">                           @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">844</span><span id="line-844">  {</span>
<span class="source-line-no">845</span><span id="line-845">    return tracker( null, name, onDepsChange, flags );</span>
<span class="source-line-no">846</span><span id="line-846">  }</span>
<span class="source-line-no">847</span><span id="line-847"></span>
<span class="source-line-no">848</span><span id="line-848">  /**</span>
<span class="source-line-no">849</span><span id="line-849">   * Create a tracking observer. The tracking observer triggers the onDepsChange hook function when</span>
<span class="source-line-no">850</span><span id="line-850">   * dependencies in the observe function are updated. Application code is responsible for executing the</span>
<span class="source-line-no">851</span><span id="line-851">   * observe function by invoking a observe method such as {@link #observe(Observer, Function)}.</span>
<span class="source-line-no">852</span><span id="line-852">   *</span>
<span class="source-line-no">853</span><span id="line-853">   * @param component    the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">854</span><span id="line-854">   * @param name         the name of the observer.</span>
<span class="source-line-no">855</span><span id="line-855">   * @param onDepsChange the hook invoked when dependencies changed.</span>
<span class="source-line-no">856</span><span id="line-856">   * @return the new Observer.</span>
<span class="source-line-no">857</span><span id="line-857">   */</span>
<span class="source-line-no">858</span><span id="line-858">  @Nonnull</span>
<span class="source-line-no">859</span><span id="line-859">  public Observer tracker( @Nullable final Component component,</span>
<span class="source-line-no">860</span><span id="line-860">                           @Nullable final String name,</span>
<span class="source-line-no">861</span><span id="line-861">                           @Nonnull final Procedure onDepsChange )</span>
<span class="source-line-no">862</span><span id="line-862">  {</span>
<span class="source-line-no">863</span><span id="line-863">    return tracker( component, name, onDepsChange, 0 );</span>
<span class="source-line-no">864</span><span id="line-864">  }</span>
<span class="source-line-no">865</span><span id="line-865"></span>
<span class="source-line-no">866</span><span id="line-866">  /**</span>
<span class="source-line-no">867</span><span id="line-867">   * Create a tracking observer. The tracking observer triggers the onDepsChange hook function when</span>
<span class="source-line-no">868</span><span id="line-868">   * dependencies in the observe function are updated. Application code is responsible for executing the</span>
<span class="source-line-no">869</span><span id="line-869">   * observe function by invoking a observe method such as {@link #observe(Observer, Procedure)}.</span>
<span class="source-line-no">870</span><span id="line-870">   *</span>
<span class="source-line-no">871</span><span id="line-871">   * @param component    the component containing the observer, if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">872</span><span id="line-872">   * @param name         the name of the observer.</span>
<span class="source-line-no">873</span><span id="line-873">   * @param onDepsChange the hook invoked when dependencies changed.</span>
<span class="source-line-no">874</span><span id="line-874">   * @param flags        the flags used to create the observer. The acceptable flags are defined in {@link Observer.Flags}.</span>
<span class="source-line-no">875</span><span id="line-875">   * @return the new Observer.</span>
<span class="source-line-no">876</span><span id="line-876">   */</span>
<span class="source-line-no">877</span><span id="line-877">  @Nonnull</span>
<span class="source-line-no">878</span><span id="line-878">  public Observer tracker( @Nullable final Component component,</span>
<span class="source-line-no">879</span><span id="line-879">                           @Nullable final String name,</span>
<span class="source-line-no">880</span><span id="line-880">                           @Nonnull final Procedure onDepsChange,</span>
<span class="source-line-no">881</span><span id="line-881">                           @MagicConstant( flagsFromClass = Observer.Flags.class ) final int flags )</span>
<span class="source-line-no">882</span><span id="line-882">  {</span>
<span class="source-line-no">883</span><span id="line-883">    return observer( component, name, null, Objects.requireNonNull( onDepsChange ), flags );</span>
<span class="source-line-no">884</span><span id="line-884">  }</span>
<span class="source-line-no">885</span><span id="line-885"></span>
<span class="source-line-no">886</span><span id="line-886">  /**</span>
<span class="source-line-no">887</span><span id="line-887">   * Create an ObservableValue synthesizing name if required.</span>
<span class="source-line-no">888</span><span id="line-888">   *</span>
<span class="source-line-no">889</span><span id="line-889">   * @param &lt;T&gt; the type of observable.</span>
<span class="source-line-no">890</span><span id="line-890">   * @return the new ObservableValue.</span>
<span class="source-line-no">891</span><span id="line-891">   */</span>
<span class="source-line-no">892</span><span id="line-892">  @Nonnull</span>
<span class="source-line-no">893</span><span id="line-893">  public &lt;T&gt; ObservableValue&lt;T&gt; observable()</span>
<span class="source-line-no">894</span><span id="line-894">  {</span>
<span class="source-line-no">895</span><span id="line-895">    return observable( null );</span>
<span class="source-line-no">896</span><span id="line-896">  }</span>
<span class="source-line-no">897</span><span id="line-897"></span>
<span class="source-line-no">898</span><span id="line-898">  /**</span>
<span class="source-line-no">899</span><span id="line-899">   * Create an ObservableValue with the specified name.</span>
<span class="source-line-no">900</span><span id="line-900">   *</span>
<span class="source-line-no">901</span><span id="line-901">   * @param name the name of the ObservableValue. Should be non-null if {@link Arez#areNamesEnabled()} returns true, null otherwise.</span>
<span class="source-line-no">902</span><span id="line-902">   * @param &lt;T&gt;  the type of observable.</span>
<span class="source-line-no">903</span><span id="line-903">   * @return the new ObservableValue.</span>
<span class="source-line-no">904</span><span id="line-904">   */</span>
<span class="source-line-no">905</span><span id="line-905">  @Nonnull</span>
<span class="source-line-no">906</span><span id="line-906">  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final String name )</span>
<span class="source-line-no">907</span><span id="line-907">  {</span>
<span class="source-line-no">908</span><span id="line-908">    return observable( name, null, null );</span>
<span class="source-line-no">909</span><span id="line-909">  }</span>
<span class="source-line-no">910</span><span id="line-910"></span>
<span class="source-line-no">911</span><span id="line-911">  /**</span>
<span class="source-line-no">912</span><span id="line-912">   * Create an ObservableValue.</span>
<span class="source-line-no">913</span><span id="line-913">   *</span>
<span class="source-line-no">914</span><span id="line-914">   * @param name     the name of the observable. Should be non-null if {@link Arez#areNamesEnabled()} returns true, null otherwise.</span>
<span class="source-line-no">915</span><span id="line-915">   * @param accessor the accessor for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.</span>
<span class="source-line-no">916</span><span id="line-916">   * @param mutator  the mutator for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.</span>
<span class="source-line-no">917</span><span id="line-917">   * @param &lt;T&gt;      the type of observable.</span>
<span class="source-line-no">918</span><span id="line-918">   * @return the new ObservableValue.</span>
<span class="source-line-no">919</span><span id="line-919">   */</span>
<span class="source-line-no">920</span><span id="line-920">  @Nonnull</span>
<span class="source-line-no">921</span><span id="line-921">  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final String name,</span>
<span class="source-line-no">922</span><span id="line-922">                                            @Nullable final PropertyAccessor&lt;T&gt; accessor,</span>
<span class="source-line-no">923</span><span id="line-923">                                            @Nullable final PropertyMutator&lt;T&gt; mutator )</span>
<span class="source-line-no">924</span><span id="line-924">  {</span>
<span class="source-line-no">925</span><span id="line-925">    return observable( null, name, accessor, mutator );</span>
<span class="source-line-no">926</span><span id="line-926">  }</span>
<span class="source-line-no">927</span><span id="line-927"></span>
<span class="source-line-no">928</span><span id="line-928">  /**</span>
<span class="source-line-no">929</span><span id="line-929">   * Create an ObservableValue.</span>
<span class="source-line-no">930</span><span id="line-930">   *</span>
<span class="source-line-no">931</span><span id="line-931">   * @param &lt;T&gt;       The type of the value that is observable.</span>
<span class="source-line-no">932</span><span id="line-932">   * @param component the component containing observable if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">933</span><span id="line-933">   * @param name      the name of the observable. Should be non-null if {@link Arez#areNamesEnabled()} returns true, null otherwise.</span>
<span class="source-line-no">934</span><span id="line-934">   * @return the new ObservableValue.</span>
<span class="source-line-no">935</span><span id="line-935">   */</span>
<span class="source-line-no">936</span><span id="line-936">  @Nonnull</span>
<span class="source-line-no">937</span><span id="line-937">  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final Component component,</span>
<span class="source-line-no">938</span><span id="line-938">                                            @Nullable final String name )</span>
<span class="source-line-no">939</span><span id="line-939">  {</span>
<span class="source-line-no">940</span><span id="line-940">    return observable( component, name, null );</span>
<span class="source-line-no">941</span><span id="line-941">  }</span>
<span class="source-line-no">942</span><span id="line-942"></span>
<span class="source-line-no">943</span><span id="line-943">  /**</span>
<span class="source-line-no">944</span><span id="line-944">   * Create an ObservableValue.</span>
<span class="source-line-no">945</span><span id="line-945">   *</span>
<span class="source-line-no">946</span><span id="line-946">   * @param &lt;T&gt;       The type of the value that is observable.</span>
<span class="source-line-no">947</span><span id="line-947">   * @param component the component containing observable if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">948</span><span id="line-948">   * @param name      the name of the observable. Should be non-null if {@link Arez#areNamesEnabled()} returns true, null otherwise.</span>
<span class="source-line-no">949</span><span id="line-949">   * @param accessor  the accessor for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.</span>
<span class="source-line-no">950</span><span id="line-950">   * @return the new ObservableValue.</span>
<span class="source-line-no">951</span><span id="line-951">   */</span>
<span class="source-line-no">952</span><span id="line-952">  @Nonnull</span>
<span class="source-line-no">953</span><span id="line-953">  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final Component component,</span>
<span class="source-line-no">954</span><span id="line-954">                                            @Nullable final String name,</span>
<span class="source-line-no">955</span><span id="line-955">                                            @Nullable final PropertyAccessor&lt;T&gt; accessor )</span>
<span class="source-line-no">956</span><span id="line-956">  {</span>
<span class="source-line-no">957</span><span id="line-957">    return observable( component, name, accessor, null );</span>
<span class="source-line-no">958</span><span id="line-958">  }</span>
<span class="source-line-no">959</span><span id="line-959"></span>
<span class="source-line-no">960</span><span id="line-960">  /**</span>
<span class="source-line-no">961</span><span id="line-961">   * Create an ObservableValue.</span>
<span class="source-line-no">962</span><span id="line-962">   *</span>
<span class="source-line-no">963</span><span id="line-963">   * @param &lt;T&gt;       The type of the value that is observable.</span>
<span class="source-line-no">964</span><span id="line-964">   * @param component the component containing observable if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.</span>
<span class="source-line-no">965</span><span id="line-965">   * @param name      the name of the observable. Should be non-null if {@link Arez#areNamesEnabled()} returns true, null otherwise.</span>
<span class="source-line-no">966</span><span id="line-966">   * @param accessor  the accessor for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.</span>
<span class="source-line-no">967</span><span id="line-967">   * @param mutator   the mutator for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.</span>
<span class="source-line-no">968</span><span id="line-968">   * @return the new ObservableValue.</span>
<span class="source-line-no">969</span><span id="line-969">   */</span>
<span class="source-line-no">970</span><span id="line-970">  @Nonnull</span>
<span class="source-line-no">971</span><span id="line-971">  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final Component component,</span>
<span class="source-line-no">972</span><span id="line-972">                                            @Nullable final String name,</span>
<span class="source-line-no">973</span><span id="line-973">                                            @Nullable final PropertyAccessor&lt;T&gt; accessor,</span>
<span class="source-line-no">974</span><span id="line-974">                                            @Nullable final PropertyMutator&lt;T&gt; mutator )</span>
<span class="source-line-no">975</span><span id="line-975">  {</span>
<span class="source-line-no">976</span><span id="line-976">    final ObservableValue&lt;T&gt; observableValue =</span>
<span class="source-line-no">977</span><span id="line-977">      new ObservableValue&lt;&gt;( Arez.areZonesEnabled() ? this : null,</span>
<span class="source-line-no">978</span><span id="line-978">                             component,</span>
<span class="source-line-no">979</span><span id="line-979">                             generateName( "ObservableValue", name ),</span>
<span class="source-line-no">980</span><span id="line-980">                             null,</span>
<span class="source-line-no">981</span><span id="line-981">                             accessor,</span>
<span class="source-line-no">982</span><span id="line-982">                             mutator );</span>
<span class="source-line-no">983</span><span id="line-983">    if ( willPropagateSpyEvents() )</span>
<span class="source-line-no">984</span><span id="line-984">    {</span>
<span class="source-line-no">985</span><span id="line-985">      getSpy().reportSpyEvent( new ObservableValueCreateEvent( observableValue.asInfo() ) );</span>
<span class="source-line-no">986</span><span id="line-986">    }</span>
<span class="source-line-no">987</span><span id="line-987">    return observableValue;</span>
<span class="source-line-no">988</span><span id="line-988">  }</span>
<span class="source-line-no">989</span><span id="line-989"></span>
<span class="source-line-no">990</span><span id="line-990">  /**</span>
<span class="source-line-no">991</span><span id="line-991">   * Pass the supplied observer to the scheduler.</span>
<span class="source-line-no">992</span><span id="line-992">   * The observer should NOT be pending execution.</span>
<span class="source-line-no">993</span><span id="line-993">   *</span>
<span class="source-line-no">994</span><span id="line-994">   * @param observer the reaction to schedule.</span>
<span class="source-line-no">995</span><span id="line-995">   */</span>
<span class="source-line-no">996</span><span id="line-996">  void scheduleReaction( @Nonnull final Observer observer )</span>
<span class="source-line-no">997</span><span id="line-997">  {</span>
<span class="source-line-no">998</span><span id="line-998">    if ( willPropagateSpyEvents() )</span>
<span class="source-line-no">999</span><span id="line-999">    {</span>
<span class="source-line-no">1000</span><span id="line-1000">      getSpy().reportSpyEvent( new ObserveScheduleEvent( observer.asInfo() ) );</span>
<span class="source-line-no">1001</span><span id="line-1001">    }</span>
<span class="source-line-no">1002</span><span id="line-1002">    if ( Arez.shouldEnforceTransactionType() &amp;&amp; isTransactionActive() &amp;&amp; Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">1003</span><span id="line-1003">    {</span>
<span class="source-line-no">1004</span><span id="line-1004">      invariant( () -&gt; getTransaction().isMutation() || getTransaction().isComputableValueTracker(),</span>
<span class="source-line-no">1005</span><span id="line-1005">                 () -&gt; "Arez-0013: Observer named '" + observer.getName() + "' attempted to be scheduled during " +</span>
<span class="source-line-no">1006</span><span id="line-1006">                       "read-only transaction." );</span>
<span class="source-line-no">1007</span><span id="line-1007">      invariant( () -&gt; getTransaction().getTracker() != observer ||</span>
<span class="source-line-no">1008</span><span id="line-1008">                       getTransaction().isMutation(),</span>
<span class="source-line-no">1009</span><span id="line-1009">                 () -&gt; "Arez-0014: Observer named '" + observer.getName() + "' attempted to schedule itself during " +</span>
<span class="source-line-no">1010</span><span id="line-1010">                       "read-only tracking transaction. Observers that are supporting ComputableValue instances " +</span>
<span class="source-line-no">1011</span><span id="line-1011">                       "must not schedule self." );</span>
<span class="source-line-no">1012</span><span id="line-1012">    }</span>
<span class="source-line-no">1013</span><span id="line-1013">    _taskQueue.queueTask( observer.getTask() );</span>
<span class="source-line-no">1014</span><span id="line-1014">  }</span>
<span class="source-line-no">1015</span><span id="line-1015"></span>
<span class="source-line-no">1016</span><span id="line-1016">  /**</span>
<span class="source-line-no">1017</span><span id="line-1017">   * Create and queue a task to be executed by the runtime.</span>
<span class="source-line-no">1018</span><span id="line-1018">   * If the scheduler is not running, then the scheduler will be triggered.</span>
<span class="source-line-no">1019</span><span id="line-1019">   *</span>
<span class="source-line-no">1020</span><span id="line-1020">   * @param work the representation of the task to execute.</span>
<span class="source-line-no">1021</span><span id="line-1021">   * @return the new task.</span>
<span class="source-line-no">1022</span><span id="line-1022">   */</span>
<span class="source-line-no">1023</span><span id="line-1023">  @Nonnull</span>
<span class="source-line-no">1024</span><span id="line-1024">  public Task task( @Nonnull final SafeProcedure work )</span>
<span class="source-line-no">1025</span><span id="line-1025">  {</span>
<span class="source-line-no">1026</span><span id="line-1026">    return task( null, work );</span>
<span class="source-line-no">1027</span><span id="line-1027">  }</span>
<span class="source-line-no">1028</span><span id="line-1028"></span>
<span class="source-line-no">1029</span><span id="line-1029">  /**</span>
<span class="source-line-no">1030</span><span id="line-1030">   * Create and queue a task to be executed by the runtime.</span>
<span class="source-line-no">1031</span><span id="line-1031">   * If the scheduler is not running, then the scheduler will be triggered.</span>
<span class="source-line-no">1032</span><span id="line-1032">   *</span>
<span class="source-line-no">1033</span><span id="line-1033">   * @param name the name of the task. Must be null if {@link Arez#areNamesEnabled()} returns &lt;code&gt;false&lt;/code&gt;.</span>
<span class="source-line-no">1034</span><span id="line-1034">   * @param work the representation of the task to execute.</span>
<span class="source-line-no">1035</span><span id="line-1035">   * @return the new task.</span>
<span class="source-line-no">1036</span><span id="line-1036">   */</span>
<span class="source-line-no">1037</span><span id="line-1037">  @Nonnull</span>
<span class="source-line-no">1038</span><span id="line-1038">  public Task task( @Nullable final String name, @Nonnull final SafeProcedure work )</span>
<span class="source-line-no">1039</span><span id="line-1039">  {</span>
<span class="source-line-no">1040</span><span id="line-1040">    return task( name, work, Task.Flags.STATE_IDLE );</span>
<span class="source-line-no">1041</span><span id="line-1041">  }</span>
<span class="source-line-no">1042</span><span id="line-1042"></span>
<span class="source-line-no">1043</span><span id="line-1043">  /**</span>
<span class="source-line-no">1044</span><span id="line-1044">   * Create and queue a task to be executed by the runtime.</span>
<span class="source-line-no">1045</span><span id="line-1045">   * If the scheduler is not running and the {@link Task.Flags#RUN_LATER} flag has not been supplied then the</span>
<span class="source-line-no">1046</span><span id="line-1046">   * scheduler will be triggered.</span>
<span class="source-line-no">1047</span><span id="line-1047">   *</span>
<span class="source-line-no">1048</span><span id="line-1048">   * @param work  the representation of the task to execute.</span>
<span class="source-line-no">1049</span><span id="line-1049">   * @param flags the flags to configure the task. Valid flags include PRIORITY_* flags, DISPOSE_ON_COMPLETE and RUN_* flags.</span>
<span class="source-line-no">1050</span><span id="line-1050">   * @return the new task.</span>
<span class="source-line-no">1051</span><span id="line-1051">   */</span>
<span class="source-line-no">1052</span><span id="line-1052">  @Nonnull</span>
<span class="source-line-no">1053</span><span id="line-1053">  public Task task( @Nonnull final SafeProcedure work,</span>
<span class="source-line-no">1054</span><span id="line-1054">                    @MagicConstant( flagsFromClass = Task.Flags.class ) final int flags )</span>
<span class="source-line-no">1055</span><span id="line-1055">  {</span>
<span class="source-line-no">1056</span><span id="line-1056">    return task( null, work, flags );</span>
<span class="source-line-no">1057</span><span id="line-1057">  }</span>
<span class="source-line-no">1058</span><span id="line-1058"></span>
<span class="source-line-no">1059</span><span id="line-1059">  /**</span>
<span class="source-line-no">1060</span><span id="line-1060">   * Create and queue a task to be executed by the runtime.</span>
<span class="source-line-no">1061</span><span id="line-1061">   * If the scheduler is not running and the {@link Task.Flags#RUN_LATER} flag has not been supplied then the</span>
<span class="source-line-no">1062</span><span id="line-1062">   * scheduler will be triggered.</span>
<span class="source-line-no">1063</span><span id="line-1063">   *</span>
<span class="source-line-no">1064</span><span id="line-1064">   * @param name  the name of the task. Must be null if {@link Arez#areNamesEnabled()} returns &lt;code&gt;false&lt;/code&gt;.</span>
<span class="source-line-no">1065</span><span id="line-1065">   * @param work  the representation of the task to execute.</span>
<span class="source-line-no">1066</span><span id="line-1066">   * @param flags the flags to configure task. Valid flags include PRIORITY_* flags, DISPOSE_ON_COMPLETE and RUN_* flags.</span>
<span class="source-line-no">1067</span><span id="line-1067">   * @return the new task.</span>
<span class="source-line-no">1068</span><span id="line-1068">   */</span>
<span class="source-line-no">1069</span><span id="line-1069">  @Nonnull</span>
<span class="source-line-no">1070</span><span id="line-1070">  public Task task( @Nullable final String name,</span>
<span class="source-line-no">1071</span><span id="line-1071">                    @Nonnull final SafeProcedure work,</span>
<span class="source-line-no">1072</span><span id="line-1072">                    @MagicConstant( flagsFromClass = Task.Flags.class ) final int flags )</span>
<span class="source-line-no">1073</span><span id="line-1073">  {</span>
<span class="source-line-no">1074</span><span id="line-1074">    final Task task = new Task( Arez.areZonesEnabled() ? this : null, generateName( "Task", name ), work, flags );</span>
<span class="source-line-no">1075</span><span id="line-1075">    task.initialSchedule();</span>
<span class="source-line-no">1076</span><span id="line-1076">    return task;</span>
<span class="source-line-no">1077</span><span id="line-1077">  }</span>
<span class="source-line-no">1078</span><span id="line-1078"></span>
<span class="source-line-no">1079</span><span id="line-1079">  /**</span>
<span class="source-line-no">1080</span><span id="line-1080">   * Return true if the scheduler is currently executing tasks.</span>
<span class="source-line-no">1081</span><span id="line-1081">   *</span>
<span class="source-line-no">1082</span><span id="line-1082">   * @return true if the scheduler is currently executing tasks.</span>
<span class="source-line-no">1083</span><span id="line-1083">   */</span>
<span class="source-line-no">1084</span><span id="line-1084">  public boolean isSchedulerActive()</span>
<span class="source-line-no">1085</span><span id="line-1085">  {</span>
<span class="source-line-no">1086</span><span id="line-1086">    return _schedulerActive;</span>
<span class="source-line-no">1087</span><span id="line-1087">  }</span>
<span class="source-line-no">1088</span><span id="line-1088"></span>
<span class="source-line-no">1089</span><span id="line-1089">  /**</span>
<span class="source-line-no">1090</span><span id="line-1090">   * Return true if there is a transaction in progress.</span>
<span class="source-line-no">1091</span><span id="line-1091">   *</span>
<span class="source-line-no">1092</span><span id="line-1092">   * @return true if there is a transaction in progress.</span>
<span class="source-line-no">1093</span><span id="line-1093">   */</span>
<span class="source-line-no">1094</span><span id="line-1094">  public boolean isTransactionActive()</span>
<span class="source-line-no">1095</span><span id="line-1095">  {</span>
<span class="source-line-no">1096</span><span id="line-1096">    return Transaction.isTransactionActive( this );</span>
<span class="source-line-no">1097</span><span id="line-1097">  }</span>
<span class="source-line-no">1098</span><span id="line-1098"></span>
<span class="source-line-no">1099</span><span id="line-1099">  /**</span>
<span class="source-line-no">1100</span><span id="line-1100">   * Return true if there is a tracking transaction in progress.</span>
<span class="source-line-no">1101</span><span id="line-1101">   * A tracking transaction is one created by an {@link Observer} via the {@link #observer(Procedure)}</span>
<span class="source-line-no">1102</span><span id="line-1102">   * or {@link #tracker(Procedure)} methods or a computable via the {@link #computable(SafeFunction)} function.</span>
<span class="source-line-no">1103</span><span id="line-1103">   *</span>
<span class="source-line-no">1104</span><span id="line-1104">   * @return true if there is a tracking transaction in progress.</span>
<span class="source-line-no">1105</span><span id="line-1105">   */</span>
<span class="source-line-no">1106</span><span id="line-1106">  public boolean isTrackingTransactionActive()</span>
<span class="source-line-no">1107</span><span id="line-1107">  {</span>
<span class="source-line-no">1108</span><span id="line-1108">    return Transaction.isTransactionActive( this ) &amp;&amp; null != Transaction.current().getTracker();</span>
<span class="source-line-no">1109</span><span id="line-1109">  }</span>
<span class="source-line-no">1110</span><span id="line-1110"></span>
<span class="source-line-no">1111</span><span id="line-1111">  /**</span>
<span class="source-line-no">1112</span><span id="line-1112">   * Return true if there is a transaction in progress calculating a computable value.</span>
<span class="source-line-no">1113</span><span id="line-1113">   * The transaction is one created for an {@link ComputableValue} via the {@link #computable(SafeFunction)} functions.</span>
<span class="source-line-no">1114</span><span id="line-1114">   *</span>
<span class="source-line-no">1115</span><span id="line-1115">   * @return true, if there is a transaction in progress calculating a computable value.</span>
<span class="source-line-no">1116</span><span id="line-1116">   */</span>
<span class="source-line-no">1117</span><span id="line-1117">  public boolean isComputableTransactionActive()</span>
<span class="source-line-no">1118</span><span id="line-1118">  {</span>
<span class="source-line-no">1119</span><span id="line-1119">    if ( !Transaction.isTransactionActive( this ) )</span>
<span class="source-line-no">1120</span><span id="line-1120">    {</span>
<span class="source-line-no">1121</span><span id="line-1121">      return false;</span>
<span class="source-line-no">1122</span><span id="line-1122">    }</span>
<span class="source-line-no">1123</span><span id="line-1123">    else</span>
<span class="source-line-no">1124</span><span id="line-1124">    {</span>
<span class="source-line-no">1125</span><span id="line-1125">      final Observer tracker = Transaction.current().getTracker();</span>
<span class="source-line-no">1126</span><span id="line-1126">      return null != tracker &amp;&amp; tracker.isComputableValue();</span>
<span class="source-line-no">1127</span><span id="line-1127">    }</span>
<span class="source-line-no">1128</span><span id="line-1128">  }</span>
<span class="source-line-no">1129</span><span id="line-1129"></span>
<span class="source-line-no">1130</span><span id="line-1130">  /**</span>
<span class="source-line-no">1131</span><span id="line-1131">   * Return true if there is a read-write transaction in progress.</span>
<span class="source-line-no">1132</span><span id="line-1132">   *</span>
<span class="source-line-no">1133</span><span id="line-1133">   * @return true if there is a read-write transaction in progress.</span>
<span class="source-line-no">1134</span><span id="line-1134">   */</span>
<span class="source-line-no">1135</span><span id="line-1135">  public boolean isReadWriteTransactionActive()</span>
<span class="source-line-no">1136</span><span id="line-1136">  {</span>
<span class="source-line-no">1137</span><span id="line-1137">    return Transaction.isTransactionActive( this ) &amp;&amp;</span>
<span class="source-line-no">1138</span><span id="line-1138">           ( !Arez.shouldEnforceTransactionType() || Transaction.current().isMutation() );</span>
<span class="source-line-no">1139</span><span id="line-1139">  }</span>
<span class="source-line-no">1140</span><span id="line-1140"></span>
<span class="source-line-no">1141</span><span id="line-1141">  /**</span>
<span class="source-line-no">1142</span><span id="line-1142">   * Return true if there is a read-only transaction in progress.</span>
<span class="source-line-no">1143</span><span id="line-1143">   *</span>
<span class="source-line-no">1144</span><span id="line-1144">   * @return true if there is a read-only transaction in progress.</span>
<span class="source-line-no">1145</span><span id="line-1145">   */</span>
<span class="source-line-no">1146</span><span id="line-1146">  public boolean isReadOnlyTransactionActive()</span>
<span class="source-line-no">1147</span><span id="line-1147">  {</span>
<span class="source-line-no">1148</span><span id="line-1148">    return Transaction.isTransactionActive( this ) &amp;&amp;</span>
<span class="source-line-no">1149</span><span id="line-1149">           ( !Arez.shouldEnforceTransactionType() || !Transaction.current().isMutation() );</span>
<span class="source-line-no">1150</span><span id="line-1150">  }</span>
<span class="source-line-no">1151</span><span id="line-1151"></span>
<span class="source-line-no">1152</span><span id="line-1152">  /**</span>
<span class="source-line-no">1153</span><span id="line-1153">   * Return the current transaction.</span>
<span class="source-line-no">1154</span><span id="line-1154">   * This method should not be invoked unless a transaction active and will throw an</span>
<span class="source-line-no">1155</span><span id="line-1155">   * exception if invariant checks are enabled.</span>
<span class="source-line-no">1156</span><span id="line-1156">   *</span>
<span class="source-line-no">1157</span><span id="line-1157">   * @return the current transaction.</span>
<span class="source-line-no">1158</span><span id="line-1158">   */</span>
<span class="source-line-no">1159</span><span id="line-1159">  @Nonnull</span>
<span class="source-line-no">1160</span><span id="line-1160">  Transaction getTransaction()</span>
<span class="source-line-no">1161</span><span id="line-1161">  {</span>
<span class="source-line-no">1162</span><span id="line-1162">    final Transaction current = Transaction.current();</span>
<span class="source-line-no">1163</span><span id="line-1163">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">1164</span><span id="line-1164">    {</span>
<span class="source-line-no">1165</span><span id="line-1165">      invariant( () -&gt; !Arez.areZonesEnabled() || current.getContext() == this,</span>
<span class="source-line-no">1166</span><span id="line-1166">                 () -&gt; "Arez-0015: Attempting to get current transaction but current transaction is for different context." );</span>
<span class="source-line-no">1167</span><span id="line-1167">    }</span>
<span class="source-line-no">1168</span><span id="line-1168">    return current;</span>
<span class="source-line-no">1169</span><span id="line-1169">  }</span>
<span class="source-line-no">1170</span><span id="line-1170"></span>
<span class="source-line-no">1171</span><span id="line-1171">  /**</span>
<span class="source-line-no">1172</span><span id="line-1172">   * Enable scheduler so that it will run pending observers next time it is triggered.</span>
<span class="source-line-no">1173</span><span id="line-1173">   */</span>
<span class="source-line-no">1174</span><span id="line-1174">  void enableScheduler()</span>
<span class="source-line-no">1175</span><span id="line-1175">  {</span>
<span class="source-line-no">1176</span><span id="line-1176">    _schedulerEnabled = true;</span>
<span class="source-line-no">1177</span><span id="line-1177">  }</span>
<span class="source-line-no">1178</span><span id="line-1178"></span>
<span class="source-line-no">1179</span><span id="line-1179">  /**</span>
<span class="source-line-no">1180</span><span id="line-1180">   * Disable scheduler so that it will not run pending observers next time it is triggered.</span>
<span class="source-line-no">1181</span><span id="line-1181">   */</span>
<span class="source-line-no">1182</span><span id="line-1182">  void disableScheduler()</span>
<span class="source-line-no">1183</span><span id="line-1183">  {</span>
<span class="source-line-no">1184</span><span id="line-1184">    _schedulerEnabled = false;</span>
<span class="source-line-no">1185</span><span id="line-1185">  }</span>
<span class="source-line-no">1186</span><span id="line-1186"></span>
<span class="source-line-no">1187</span><span id="line-1187">  /**</span>
<span class="source-line-no">1188</span><span id="line-1188">   * Return true if the scheduler enabled flag is true.</span>
<span class="source-line-no">1189</span><span id="line-1189">   * It is still possible that the scheduler has un-released locks so this</span>
<span class="source-line-no">1190</span><span id="line-1190">   * does not necessarily imply that the schedule will run.</span>
<span class="source-line-no">1191</span><span id="line-1191">   *</span>
<span class="source-line-no">1192</span><span id="line-1192">   * @return true if the scheduler enabled flag is true.</span>
<span class="source-line-no">1193</span><span id="line-1193">   */</span>
<span class="source-line-no">1194</span><span id="line-1194">  boolean isSchedulerEnabled()</span>
<span class="source-line-no">1195</span><span id="line-1195">  {</span>
<span class="source-line-no">1196</span><span id="line-1196">    return _schedulerEnabled;</span>
<span class="source-line-no">1197</span><span id="line-1197">  }</span>
<span class="source-line-no">1198</span><span id="line-1198"></span>
<span class="source-line-no">1199</span><span id="line-1199">  /**</span>
<span class="source-line-no">1200</span><span id="line-1200">   * Release a scheduler lock to enable scheduler to run again.</span>
<span class="source-line-no">1201</span><span id="line-1201">   * Trigger reactions if lock reaches 0 and no current transaction.</span>
<span class="source-line-no">1202</span><span id="line-1202">   */</span>
<span class="source-line-no">1203</span><span id="line-1203">  void releaseSchedulerLock()</span>
<span class="source-line-no">1204</span><span id="line-1204">  {</span>
<span class="source-line-no">1205</span><span id="line-1205">    _schedulerLockCount--;</span>
<span class="source-line-no">1206</span><span id="line-1206">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">1207</span><span id="line-1207">    {</span>
<span class="source-line-no">1208</span><span id="line-1208">      invariant( () -&gt; _schedulerLockCount &gt;= 0,</span>
<span class="source-line-no">1209</span><span id="line-1209">                 () -&gt; "Arez-0016: releaseSchedulerLock() reduced schedulerLockCount below 0." );</span>
<span class="source-line-no">1210</span><span id="line-1210">    }</span>
<span class="source-line-no">1211</span><span id="line-1211">    triggerScheduler();</span>
<span class="source-line-no">1212</span><span id="line-1212">  }</span>
<span class="source-line-no">1213</span><span id="line-1213"></span>
<span class="source-line-no">1214</span><span id="line-1214">  /**</span>
<span class="source-line-no">1215</span><span id="line-1215">   * Return true if the scheduler is paused.</span>
<span class="source-line-no">1216</span><span id="line-1216">   * True means that {@link #pauseScheduler()} has been called one or more times and the lock not disposed.</span>
<span class="source-line-no">1217</span><span id="line-1217">   *</span>
<span class="source-line-no">1218</span><span id="line-1218">   * @return true if the scheduler is paused, false otherwise.</span>
<span class="source-line-no">1219</span><span id="line-1219">   */</span>
<span class="source-line-no">1220</span><span id="line-1220">  public boolean isSchedulerPaused()</span>
<span class="source-line-no">1221</span><span id="line-1221">  {</span>
<span class="source-line-no">1222</span><span id="line-1222">    return _schedulerLockCount != 0;</span>
<span class="source-line-no">1223</span><span id="line-1223">  }</span>
<span class="source-line-no">1224</span><span id="line-1224"></span>
<span class="source-line-no">1225</span><span id="line-1225">  /**</span>
<span class="source-line-no">1226</span><span id="line-1226">   * Pause scheduler so that it will not run any reactions next time {@link #triggerScheduler()} is invoked.</span>
<span class="source-line-no">1227</span><span id="line-1227">   * The scheduler will not resume scheduling reactions until the lock returned from this method is disposed.</span>
<span class="source-line-no">1228</span><span id="line-1228">   *</span>
<span class="source-line-no">1229</span><span id="line-1229">   * &lt;p&gt;The intention of this method is to allow the user to manually batch multiple actions, before</span>
<span class="source-line-no">1230</span><span id="line-1230">   * disposing the lock and allowing reactions to flow through the system. A typical use-case is when</span>
<span class="source-line-no">1231</span><span id="line-1231">   * a large network packet is received and processed over multiple ticks but you only want the</span>
<span class="source-line-no">1232</span><span id="line-1232">   * application to react once.&lt;/p&gt;</span>
<span class="source-line-no">1233</span><span id="line-1233">   *</span>
<span class="source-line-no">1234</span><span id="line-1234">   * &lt;p&gt;If this is invoked from within a reaction then the current behaviour will continue to process any</span>
<span class="source-line-no">1235</span><span id="line-1235">   * pending reactions until there is none left. However this behaviour should not be relied upon as it may</span>
<span class="source-line-no">1236</span><span id="line-1236">   * result in an abort in the future.&lt;/p&gt;</span>
<span class="source-line-no">1237</span><span id="line-1237">   *</span>
<span class="source-line-no">1238</span><span id="line-1238">   * &lt;p&gt;It should be noted that this is the one way where inconsistent state can creep into an Arez application.</span>
<span class="source-line-no">1239</span><span id="line-1239">   * If an external action can trigger while the scheduler is paused. i.e. In the browser when an</span>
<span class="source-line-no">1240</span><span id="line-1240">   * event-handler calls back from UI when the reactions have not run. Thus the event handler could be</span>
<span class="source-line-no">1241</span><span id="line-1241">   * based on stale data. If this can occur the developer should &lt;/p&gt;</span>
<span class="source-line-no">1242</span><span id="line-1242">   *</span>
<span class="source-line-no">1243</span><span id="line-1243">   * @return a lock on scheduler.</span>
<span class="source-line-no">1244</span><span id="line-1244">   */</span>
<span class="source-line-no">1245</span><span id="line-1245">  @Nonnull</span>
<span class="source-line-no">1246</span><span id="line-1246">  public SchedulerLock pauseScheduler()</span>
<span class="source-line-no">1247</span><span id="line-1247">  {</span>
<span class="source-line-no">1248</span><span id="line-1248">    _schedulerLockCount++;</span>
<span class="source-line-no">1249</span><span id="line-1249">    return new SchedulerLock( Arez.areZonesEnabled() ? this : null );</span>
<span class="source-line-no">1250</span><span id="line-1250">  }</span>
<span class="source-line-no">1251</span><span id="line-1251"></span>
<span class="source-line-no">1252</span><span id="line-1252">  /**</span>
<span class="source-line-no">1253</span><span id="line-1253">   * Specify a interceptor to use to wrap task execution in.</span>
<span class="source-line-no">1254</span><span id="line-1254">   *</span>
<span class="source-line-no">1255</span><span id="line-1255">   * @param taskInterceptor interceptor used to wrap task execution.</span>
<span class="source-line-no">1256</span><span id="line-1256">   */</span>
<span class="source-line-no">1257</span><span id="line-1257">  @OmitSymbol( unless = "arez.enable_task_interceptor" )</span>
<span class="source-line-no">1258</span><span id="line-1258">  public void setTaskInterceptor( @Nullable final TaskInterceptor taskInterceptor )</span>
<span class="source-line-no">1259</span><span id="line-1259">  {</span>
<span class="source-line-no">1260</span><span id="line-1260">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">1261</span><span id="line-1261">    {</span>
<span class="source-line-no">1262</span><span id="line-1262">      invariant( Arez::isTaskInterceptorEnabled,</span>
<span class="source-line-no">1263</span><span id="line-1263">                 () -&gt; "Arez-0039: setTaskInterceptor() invoked but Arez.isTaskInterceptorEnabled() returns false." );</span>
<span class="source-line-no">1264</span><span id="line-1264">    }</span>
<span class="source-line-no">1265</span><span id="line-1265">    _taskInterceptor = taskInterceptor;</span>
<span class="source-line-no">1266</span><span id="line-1266">  }</span>
<span class="source-line-no">1267</span><span id="line-1267"></span>
<span class="source-line-no">1268</span><span id="line-1268">  /**</span>
<span class="source-line-no">1269</span><span id="line-1269">   * Method invoked to trigger the scheduler to run any pending reactions. The scheduler will only be</span>
<span class="source-line-no">1270</span><span id="line-1270">   * triggered if there is no transaction active. This method is typically used after one or more Observers</span>
<span class="source-line-no">1271</span><span id="line-1271">   * have been created outside a transaction with the runImmediately flag set to false and the caller wants</span>
<span class="source-line-no">1272</span><span id="line-1272">   * to force the observers to react. Otherwise the Observers will not be schedule until the next top-level</span>
<span class="source-line-no">1273</span><span id="line-1273">   * transaction completes.</span>
<span class="source-line-no">1274</span><span id="line-1274">   */</span>
<span class="source-line-no">1275</span><span id="line-1275">  public void triggerScheduler()</span>
<span class="source-line-no">1276</span><span id="line-1276">  {</span>
<span class="source-line-no">1277</span><span id="line-1277">    if ( isSchedulerEnabled() &amp;&amp; !isSchedulerPaused() )</span>
<span class="source-line-no">1278</span><span id="line-1278">    {</span>
<span class="source-line-no">1279</span><span id="line-1279">      // Each reaction creates a top level transaction that attempts to run call</span>
<span class="source-line-no">1280</span><span id="line-1280">      // this method when it completes. Rather than allow this if it is detected</span>
<span class="source-line-no">1281</span><span id="line-1281">      // that we are running reactions already then just abort and assume the top</span>
<span class="source-line-no">1282</span><span id="line-1282">      // most invocation of runPendingTasks will handle scheduling</span>
<span class="source-line-no">1283</span><span id="line-1283">      if ( !_schedulerActive )</span>
<span class="source-line-no">1284</span><span id="line-1284">      {</span>
<span class="source-line-no">1285</span><span id="line-1285">        _schedulerActive = true;</span>
<span class="source-line-no">1286</span><span id="line-1286">        try</span>
<span class="source-line-no">1287</span><span id="line-1287">        {</span>
<span class="source-line-no">1288</span><span id="line-1288">          if ( Arez.isTaskInterceptorEnabled() &amp;&amp; null != _taskInterceptor )</span>
<span class="source-line-no">1289</span><span id="line-1289">          {</span>
<span class="source-line-no">1290</span><span id="line-1290">            assert null != _taskExecuteAction;</span>
<span class="source-line-no">1291</span><span id="line-1291">            do</span>
<span class="source-line-no">1292</span><span id="line-1292">            {</span>
<span class="source-line-no">1293</span><span id="line-1293">              _taskInterceptor.executeTasks( _taskExecuteAction );</span>
<span class="source-line-no">1294</span><span id="line-1294">            } while ( _executor.getPendingTaskCount() &gt; 0 );</span>
<span class="source-line-no">1295</span><span id="line-1295">          }</span>
<span class="source-line-no">1296</span><span id="line-1296">          else</span>
<span class="source-line-no">1297</span><span id="line-1297">          {</span>
<span class="source-line-no">1298</span><span id="line-1298">            _executor.runTasks();</span>
<span class="source-line-no">1299</span><span id="line-1299">          }</span>
<span class="source-line-no">1300</span><span id="line-1300">        }</span>
<span class="source-line-no">1301</span><span id="line-1301">        finally</span>
<span class="source-line-no">1302</span><span id="line-1302">        {</span>
<span class="source-line-no">1303</span><span id="line-1303">          _schedulerActive = false;</span>
<span class="source-line-no">1304</span><span id="line-1304">        }</span>
<span class="source-line-no">1305</span><span id="line-1305">      }</span>
<span class="source-line-no">1306</span><span id="line-1306">    }</span>
<span class="source-line-no">1307</span><span id="line-1307">  }</span>
<span class="source-line-no">1308</span><span id="line-1308"></span>
<span class="source-line-no">1309</span><span id="line-1309">  /**</span>
<span class="source-line-no">1310</span><span id="line-1310">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1311</span><span id="line-1311">   * The executable may throw an exception.</span>
<span class="source-line-no">1312</span><span id="line-1312">   *</span>
<span class="source-line-no">1313</span><span id="line-1313">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1314</span><span id="line-1314">   * @param executable the executable.</span>
<span class="source-line-no">1315</span><span id="line-1315">   * @return the value returned from the executable.</span>
<span class="source-line-no">1316</span><span id="line-1316">   * @throws Exception if the executable throws an an exception.</span>
<span class="source-line-no">1317</span><span id="line-1317">   */</span>
<span class="source-line-no">1318</span><span id="line-1318">  public &lt;T&gt; T action( @Nonnull final Function&lt;T&gt; executable )</span>
<span class="source-line-no">1319</span><span id="line-1319">    throws Throwable</span>
<span class="source-line-no">1320</span><span id="line-1320">  {</span>
<span class="source-line-no">1321</span><span id="line-1321">    return action( executable, 0 );</span>
<span class="source-line-no">1322</span><span id="line-1322">  }</span>
<span class="source-line-no">1323</span><span id="line-1323"></span>
<span class="source-line-no">1324</span><span id="line-1324">  /**</span>
<span class="source-line-no">1325</span><span id="line-1325">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1326</span><span id="line-1326">   * The executable may throw an exception.</span>
<span class="source-line-no">1327</span><span id="line-1327">   *</span>
<span class="source-line-no">1328</span><span id="line-1328">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1329</span><span id="line-1329">   * @param executable the executable.</span>
<span class="source-line-no">1330</span><span id="line-1330">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1331</span><span id="line-1331">   * @return the value returned from the executable.</span>
<span class="source-line-no">1332</span><span id="line-1332">   * @throws Exception if the executable throws an an exception.</span>
<span class="source-line-no">1333</span><span id="line-1333">   */</span>
<span class="source-line-no">1334</span><span id="line-1334">  public &lt;T&gt; T action( @Nonnull final Function&lt;T&gt; executable,</span>
<span class="source-line-no">1335</span><span id="line-1335">                       @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">1336</span><span id="line-1336">    throws Throwable</span>
<span class="source-line-no">1337</span><span id="line-1337">  {</span>
<span class="source-line-no">1338</span><span id="line-1338">    return action( null, executable, flags );</span>
<span class="source-line-no">1339</span><span id="line-1339">  }</span>
<span class="source-line-no">1340</span><span id="line-1340"></span>
<span class="source-line-no">1341</span><span id="line-1341">  /**</span>
<span class="source-line-no">1342</span><span id="line-1342">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1343</span><span id="line-1343">   * The executable may throw an exception.</span>
<span class="source-line-no">1344</span><span id="line-1344">   *</span>
<span class="source-line-no">1345</span><span id="line-1345">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1346</span><span id="line-1346">   * @param name       the name of the action.</span>
<span class="source-line-no">1347</span><span id="line-1347">   * @param executable the executable.</span>
<span class="source-line-no">1348</span><span id="line-1348">   * @return the value returned from the executable.</span>
<span class="source-line-no">1349</span><span id="line-1349">   * @throws Exception if the executable throws an an exception.</span>
<span class="source-line-no">1350</span><span id="line-1350">   */</span>
<span class="source-line-no">1351</span><span id="line-1351">  public &lt;T&gt; T action( @Nullable final String name,</span>
<span class="source-line-no">1352</span><span id="line-1352">                       @Nonnull final Function&lt;T&gt; executable )</span>
<span class="source-line-no">1353</span><span id="line-1353">    throws Throwable</span>
<span class="source-line-no">1354</span><span id="line-1354">  {</span>
<span class="source-line-no">1355</span><span id="line-1355">    return action( name, executable, 0 );</span>
<span class="source-line-no">1356</span><span id="line-1356">  }</span>
<span class="source-line-no">1357</span><span id="line-1357"></span>
<span class="source-line-no">1358</span><span id="line-1358">  /**</span>
<span class="source-line-no">1359</span><span id="line-1359">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1360</span><span id="line-1360">   * The executable may throw an exception.</span>
<span class="source-line-no">1361</span><span id="line-1361">   *</span>
<span class="source-line-no">1362</span><span id="line-1362">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1363</span><span id="line-1363">   * @param name       the name of the action.</span>
<span class="source-line-no">1364</span><span id="line-1364">   * @param executable the executable.</span>
<span class="source-line-no">1365</span><span id="line-1365">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1366</span><span id="line-1366">   * @return the value returned from the executable.</span>
<span class="source-line-no">1367</span><span id="line-1367">   * @throws Exception if the executable throws an an exception.</span>
<span class="source-line-no">1368</span><span id="line-1368">   */</span>
<span class="source-line-no">1369</span><span id="line-1369">  public &lt;T&gt; T action( @Nullable final String name,</span>
<span class="source-line-no">1370</span><span id="line-1370">                       @Nonnull final Function&lt;T&gt; executable,</span>
<span class="source-line-no">1371</span><span id="line-1371">                       @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">1372</span><span id="line-1372">    throws Throwable</span>
<span class="source-line-no">1373</span><span id="line-1373">  {</span>
<span class="source-line-no">1374</span><span id="line-1374">    return action( name, executable, flags, null );</span>
<span class="source-line-no">1375</span><span id="line-1375">  }</span>
<span class="source-line-no">1376</span><span id="line-1376"></span>
<span class="source-line-no">1377</span><span id="line-1377">  /**</span>
<span class="source-line-no">1378</span><span id="line-1378">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1379</span><span id="line-1379">   * The executable may throw an exception.</span>
<span class="source-line-no">1380</span><span id="line-1380">   *</span>
<span class="source-line-no">1381</span><span id="line-1381">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1382</span><span id="line-1382">   * @param name       the name of the action.</span>
<span class="source-line-no">1383</span><span id="line-1383">   * @param executable the executable.</span>
<span class="source-line-no">1384</span><span id="line-1384">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1385</span><span id="line-1385">   * @param parameters the parameters if any. The parameters are only used to generate a spy event.</span>
<span class="source-line-no">1386</span><span id="line-1386">   * @return the value returned from the executable.</span>
<span class="source-line-no">1387</span><span id="line-1387">   * @throws Exception if the executable throws an an exception.</span>
<span class="source-line-no">1388</span><span id="line-1388">   */</span>
<span class="source-line-no">1389</span><span id="line-1389">  public &lt;T&gt; T action( @Nullable final String name,</span>
<span class="source-line-no">1390</span><span id="line-1390">                       @Nonnull final Function&lt;T&gt; executable,</span>
<span class="source-line-no">1391</span><span id="line-1391">                       @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags,</span>
<span class="source-line-no">1392</span><span id="line-1392">                       @Nullable final Object[] parameters )</span>
<span class="source-line-no">1393</span><span id="line-1393">    throws Throwable</span>
<span class="source-line-no">1394</span><span id="line-1394">  {</span>
<span class="source-line-no">1395</span><span id="line-1395">    return _action( name, executable, flags, null, parameters, true );</span>
<span class="source-line-no">1396</span><span id="line-1396">  }</span>
<span class="source-line-no">1397</span><span id="line-1397"></span>
<span class="source-line-no">1398</span><span id="line-1398">  /**</span>
<span class="source-line-no">1399</span><span id="line-1399">   * Execute the observe function with the specified Observer.</span>
<span class="source-line-no">1400</span><span id="line-1400">   * The Observer must be created by the {@link #tracker(Procedure)} methods.</span>
<span class="source-line-no">1401</span><span id="line-1401">   * The observe function may throw an exception.</span>
<span class="source-line-no">1402</span><span id="line-1402">   *</span>
<span class="source-line-no">1403</span><span id="line-1403">   * @param &lt;T&gt;      the type of return value.</span>
<span class="source-line-no">1404</span><span id="line-1404">   * @param observer the Observer.</span>
<span class="source-line-no">1405</span><span id="line-1405">   * @param observe  the observe function.</span>
<span class="source-line-no">1406</span><span id="line-1406">   * @return the value returned from the observe function.</span>
<span class="source-line-no">1407</span><span id="line-1407">   * @throws Exception if the observe function throws an an exception.</span>
<span class="source-line-no">1408</span><span id="line-1408">   */</span>
<span class="source-line-no">1409</span><span id="line-1409">  public &lt;T&gt; T observe( @Nonnull final Observer observer, @Nonnull final Function&lt;T&gt; observe )</span>
<span class="source-line-no">1410</span><span id="line-1410">    throws Throwable</span>
<span class="source-line-no">1411</span><span id="line-1411">  {</span>
<span class="source-line-no">1412</span><span id="line-1412">    return observe( observer, observe, null );</span>
<span class="source-line-no">1413</span><span id="line-1413">  }</span>
<span class="source-line-no">1414</span><span id="line-1414"></span>
<span class="source-line-no">1415</span><span id="line-1415">  /**</span>
<span class="source-line-no">1416</span><span id="line-1416">   * Execute the observe function with the specified Observer.</span>
<span class="source-line-no">1417</span><span id="line-1417">   * The Observer must be created by the {@link #tracker(Procedure)} methods.</span>
<span class="source-line-no">1418</span><span id="line-1418">   * The observe function may throw an exception.</span>
<span class="source-line-no">1419</span><span id="line-1419">   *</span>
<span class="source-line-no">1420</span><span id="line-1420">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1421</span><span id="line-1421">   * @param observer   the Observer.</span>
<span class="source-line-no">1422</span><span id="line-1422">   * @param observe    the observe function.</span>
<span class="source-line-no">1423</span><span id="line-1423">   * @param parameters the parameters if any. The parameters are only used to generate a spy event.</span>
<span class="source-line-no">1424</span><span id="line-1424">   * @return the value returned from the observe function.</span>
<span class="source-line-no">1425</span><span id="line-1425">   * @throws Exception if the observe function throws an an exception.</span>
<span class="source-line-no">1426</span><span id="line-1426">   */</span>
<span class="source-line-no">1427</span><span id="line-1427">  public &lt;T&gt; T observe( @Nonnull final Observer observer,</span>
<span class="source-line-no">1428</span><span id="line-1428">                        @Nonnull final Function&lt;T&gt; observe,</span>
<span class="source-line-no">1429</span><span id="line-1429">                        @Nullable final Object[] parameters )</span>
<span class="source-line-no">1430</span><span id="line-1430">    throws Throwable</span>
<span class="source-line-no">1431</span><span id="line-1431">  {</span>
<span class="source-line-no">1432</span><span id="line-1432">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">1433</span><span id="line-1433">    {</span>
<span class="source-line-no">1434</span><span id="line-1434">      apiInvariant( observer::isApplicationExecutor,</span>
<span class="source-line-no">1435</span><span id="line-1435">                    () -&gt; "Arez-0017: Attempted to invoke observe(..) on observer named '" + observer.getName() +</span>
<span class="source-line-no">1436</span><span id="line-1436">                          "' but observer is not configured to use an application executor." );</span>
<span class="source-line-no">1437</span><span id="line-1437">    }</span>
<span class="source-line-no">1438</span><span id="line-1438">    return _action( observerToName( observer ),</span>
<span class="source-line-no">1439</span><span id="line-1439">                    observe,</span>
<span class="source-line-no">1440</span><span id="line-1440">                    trackerObserveFlags( observer ),</span>
<span class="source-line-no">1441</span><span id="line-1441">                    observer,</span>
<span class="source-line-no">1442</span><span id="line-1442">                    parameters,</span>
<span class="source-line-no">1443</span><span id="line-1443">                    true );</span>
<span class="source-line-no">1444</span><span id="line-1444">  }</span>
<span class="source-line-no">1445</span><span id="line-1445"></span>
<span class="source-line-no">1446</span><span id="line-1446">  /**</span>
<span class="source-line-no">1447</span><span id="line-1447">   * Execute the supplied executable.</span>
<span class="source-line-no">1448</span><span id="line-1448">   * The executable is should not throw an exception.</span>
<span class="source-line-no">1449</span><span id="line-1449">   *</span>
<span class="source-line-no">1450</span><span id="line-1450">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1451</span><span id="line-1451">   * @param executable the executable.</span>
<span class="source-line-no">1452</span><span id="line-1452">   * @return the value returned from the executable.</span>
<span class="source-line-no">1453</span><span id="line-1453">   */</span>
<span class="source-line-no">1454</span><span id="line-1454">  public &lt;T&gt; T safeAction( @Nonnull final SafeFunction&lt;T&gt; executable )</span>
<span class="source-line-no">1455</span><span id="line-1455">  {</span>
<span class="source-line-no">1456</span><span id="line-1456">    return safeAction( executable, 0 );</span>
<span class="source-line-no">1457</span><span id="line-1457">  }</span>
<span class="source-line-no">1458</span><span id="line-1458"></span>
<span class="source-line-no">1459</span><span id="line-1459">  /**</span>
<span class="source-line-no">1460</span><span id="line-1460">   * Execute the supplied executable.</span>
<span class="source-line-no">1461</span><span id="line-1461">   * The executable is should not throw an exception.</span>
<span class="source-line-no">1462</span><span id="line-1462">   *</span>
<span class="source-line-no">1463</span><span id="line-1463">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1464</span><span id="line-1464">   * @param executable the executable.</span>
<span class="source-line-no">1465</span><span id="line-1465">   * @param flags      the flags for the action.</span>
<span class="source-line-no">1466</span><span id="line-1466">   * @return the value returned from the executable.</span>
<span class="source-line-no">1467</span><span id="line-1467">   */</span>
<span class="source-line-no">1468</span><span id="line-1468">  public &lt;T&gt; T safeAction( @Nonnull final SafeFunction&lt;T&gt; executable,</span>
<span class="source-line-no">1469</span><span id="line-1469">                           @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">1470</span><span id="line-1470">  {</span>
<span class="source-line-no">1471</span><span id="line-1471">    return safeAction( null, executable, flags );</span>
<span class="source-line-no">1472</span><span id="line-1472">  }</span>
<span class="source-line-no">1473</span><span id="line-1473"></span>
<span class="source-line-no">1474</span><span id="line-1474">  /**</span>
<span class="source-line-no">1475</span><span id="line-1475">   * Execute the supplied executable.</span>
<span class="source-line-no">1476</span><span id="line-1476">   * The executable is should not throw an exception.</span>
<span class="source-line-no">1477</span><span id="line-1477">   *</span>
<span class="source-line-no">1478</span><span id="line-1478">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1479</span><span id="line-1479">   * @param name       the name of the action.</span>
<span class="source-line-no">1480</span><span id="line-1480">   * @param executable the executable.</span>
<span class="source-line-no">1481</span><span id="line-1481">   * @return the value returned from the executable.</span>
<span class="source-line-no">1482</span><span id="line-1482">   */</span>
<span class="source-line-no">1483</span><span id="line-1483">  public &lt;T&gt; T safeAction( @Nullable final String name, @Nonnull final SafeFunction&lt;T&gt; executable )</span>
<span class="source-line-no">1484</span><span id="line-1484">  {</span>
<span class="source-line-no">1485</span><span id="line-1485">    return safeAction( name, executable, 0 );</span>
<span class="source-line-no">1486</span><span id="line-1486">  }</span>
<span class="source-line-no">1487</span><span id="line-1487"></span>
<span class="source-line-no">1488</span><span id="line-1488">  /**</span>
<span class="source-line-no">1489</span><span id="line-1489">   * Execute the supplied executable.</span>
<span class="source-line-no">1490</span><span id="line-1490">   * The executable is should not throw an exception.</span>
<span class="source-line-no">1491</span><span id="line-1491">   *</span>
<span class="source-line-no">1492</span><span id="line-1492">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1493</span><span id="line-1493">   * @param name       the name of the action.</span>
<span class="source-line-no">1494</span><span id="line-1494">   * @param executable the executable.</span>
<span class="source-line-no">1495</span><span id="line-1495">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1496</span><span id="line-1496">   * @return the value returned from the executable.</span>
<span class="source-line-no">1497</span><span id="line-1497">   */</span>
<span class="source-line-no">1498</span><span id="line-1498">  public &lt;T&gt; T safeAction( @Nullable final String name,</span>
<span class="source-line-no">1499</span><span id="line-1499">                           @Nonnull final SafeFunction&lt;T&gt; executable,</span>
<span class="source-line-no">1500</span><span id="line-1500">                           @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">1501</span><span id="line-1501">  {</span>
<span class="source-line-no">1502</span><span id="line-1502">    return safeAction( name, executable, flags, null );</span>
<span class="source-line-no">1503</span><span id="line-1503">  }</span>
<span class="source-line-no">1504</span><span id="line-1504"></span>
<span class="source-line-no">1505</span><span id="line-1505">  /**</span>
<span class="source-line-no">1506</span><span id="line-1506">   * Execute the supplied executable.</span>
<span class="source-line-no">1507</span><span id="line-1507">   * The executable is should not throw an exception.</span>
<span class="source-line-no">1508</span><span id="line-1508">   *</span>
<span class="source-line-no">1509</span><span id="line-1509">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1510</span><span id="line-1510">   * @param name       the name of the action.</span>
<span class="source-line-no">1511</span><span id="line-1511">   * @param executable the executable.</span>
<span class="source-line-no">1512</span><span id="line-1512">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1513</span><span id="line-1513">   * @param parameters the parameters if any. The parameters are only used to generate a spy event.</span>
<span class="source-line-no">1514</span><span id="line-1514">   * @return the value returned from the executable.</span>
<span class="source-line-no">1515</span><span id="line-1515">   */</span>
<span class="source-line-no">1516</span><span id="line-1516">  public &lt;T&gt; T safeAction( @Nullable final String name,</span>
<span class="source-line-no">1517</span><span id="line-1517">                           @Nonnull final SafeFunction&lt;T&gt; executable,</span>
<span class="source-line-no">1518</span><span id="line-1518">                           @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags,</span>
<span class="source-line-no">1519</span><span id="line-1519">                           @Nullable final Object[] parameters )</span>
<span class="source-line-no">1520</span><span id="line-1520">  {</span>
<span class="source-line-no">1521</span><span id="line-1521">    return _safeAction( name, executable, flags, null, parameters, true, true );</span>
<span class="source-line-no">1522</span><span id="line-1522">  }</span>
<span class="source-line-no">1523</span><span id="line-1523"></span>
<span class="source-line-no">1524</span><span id="line-1524">  /**</span>
<span class="source-line-no">1525</span><span id="line-1525">   * Execute the observe function with the specified Observer.</span>
<span class="source-line-no">1526</span><span id="line-1526">   * The Observer must be created by the {@link #tracker(Procedure)} methods.</span>
<span class="source-line-no">1527</span><span id="line-1527">   * The observe function should not throw an exception.</span>
<span class="source-line-no">1528</span><span id="line-1528">   *</span>
<span class="source-line-no">1529</span><span id="line-1529">   * @param &lt;T&gt;      the type of return value.</span>
<span class="source-line-no">1530</span><span id="line-1530">   * @param observer the Observer.</span>
<span class="source-line-no">1531</span><span id="line-1531">   * @param observe  the observe function.</span>
<span class="source-line-no">1532</span><span id="line-1532">   * @return the value returned from the observe function.</span>
<span class="source-line-no">1533</span><span id="line-1533">   */</span>
<span class="source-line-no">1534</span><span id="line-1534">  public &lt;T&gt; T safeObserve( @Nonnull final Observer observer, @Nonnull final SafeFunction&lt;T&gt; observe )</span>
<span class="source-line-no">1535</span><span id="line-1535">  {</span>
<span class="source-line-no">1536</span><span id="line-1536">    return safeObserve( observer, observe, null );</span>
<span class="source-line-no">1537</span><span id="line-1537">  }</span>
<span class="source-line-no">1538</span><span id="line-1538"></span>
<span class="source-line-no">1539</span><span id="line-1539">  /**</span>
<span class="source-line-no">1540</span><span id="line-1540">   * Execute the observe function with the specified Observer.</span>
<span class="source-line-no">1541</span><span id="line-1541">   * The Observer must be created by the {@link #tracker(Procedure)} methods.</span>
<span class="source-line-no">1542</span><span id="line-1542">   * The observe function should not throw an exception.</span>
<span class="source-line-no">1543</span><span id="line-1543">   *</span>
<span class="source-line-no">1544</span><span id="line-1544">   * @param &lt;T&gt;        the type of return value.</span>
<span class="source-line-no">1545</span><span id="line-1545">   * @param observer   the Observer.</span>
<span class="source-line-no">1546</span><span id="line-1546">   * @param observe    the observe function.</span>
<span class="source-line-no">1547</span><span id="line-1547">   * @param parameters the parameters if any. The parameters are only used to generate a spy event.</span>
<span class="source-line-no">1548</span><span id="line-1548">   * @return the value returned from the observe function.</span>
<span class="source-line-no">1549</span><span id="line-1549">   */</span>
<span class="source-line-no">1550</span><span id="line-1550">  public &lt;T&gt; T safeObserve( @Nonnull final Observer observer,</span>
<span class="source-line-no">1551</span><span id="line-1551">                            @Nonnull final SafeFunction&lt;T&gt; observe,</span>
<span class="source-line-no">1552</span><span id="line-1552">                            @Nullable final Object[] parameters )</span>
<span class="source-line-no">1553</span><span id="line-1553">  {</span>
<span class="source-line-no">1554</span><span id="line-1554">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">1555</span><span id="line-1555">    {</span>
<span class="source-line-no">1556</span><span id="line-1556">      apiInvariant( observer::isApplicationExecutor,</span>
<span class="source-line-no">1557</span><span id="line-1557">                    () -&gt; "Arez-0018: Attempted to invoke safeObserve(..) on observer named '" + observer.getName() +</span>
<span class="source-line-no">1558</span><span id="line-1558">                          "' but observer is not configured to use an application executor." );</span>
<span class="source-line-no">1559</span><span id="line-1559">    }</span>
<span class="source-line-no">1560</span><span id="line-1560">    return _safeAction( observerToName( observer ),</span>
<span class="source-line-no">1561</span><span id="line-1561">                        observe,</span>
<span class="source-line-no">1562</span><span id="line-1562">                        trackerObserveFlags( observer ),</span>
<span class="source-line-no">1563</span><span id="line-1563">                        observer,</span>
<span class="source-line-no">1564</span><span id="line-1564">                        parameters,</span>
<span class="source-line-no">1565</span><span id="line-1565">                        true,</span>
<span class="source-line-no">1566</span><span id="line-1566">                        true );</span>
<span class="source-line-no">1567</span><span id="line-1567">  }</span>
<span class="source-line-no">1568</span><span id="line-1568"></span>
<span class="source-line-no">1569</span><span id="line-1569">  /**</span>
<span class="source-line-no">1570</span><span id="line-1570">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1571</span><span id="line-1571">   * The executable may throw an exception.</span>
<span class="source-line-no">1572</span><span id="line-1572">   *</span>
<span class="source-line-no">1573</span><span id="line-1573">   * @param executable the executable.</span>
<span class="source-line-no">1574</span><span id="line-1574">   * @throws Throwable if the procedure throws an an exception.</span>
<span class="source-line-no">1575</span><span id="line-1575">   */</span>
<span class="source-line-no">1576</span><span id="line-1576">  public void action( @Nonnull final Procedure executable )</span>
<span class="source-line-no">1577</span><span id="line-1577">    throws Throwable</span>
<span class="source-line-no">1578</span><span id="line-1578">  {</span>
<span class="source-line-no">1579</span><span id="line-1579">    action( executable, 0 );</span>
<span class="source-line-no">1580</span><span id="line-1580">  }</span>
<span class="source-line-no">1581</span><span id="line-1581"></span>
<span class="source-line-no">1582</span><span id="line-1582">  /**</span>
<span class="source-line-no">1583</span><span id="line-1583">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1584</span><span id="line-1584">   * The executable may throw an exception.</span>
<span class="source-line-no">1585</span><span id="line-1585">   *</span>
<span class="source-line-no">1586</span><span id="line-1586">   * @param executable the executable.</span>
<span class="source-line-no">1587</span><span id="line-1587">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1588</span><span id="line-1588">   * @throws Throwable if the procedure throws an an exception.</span>
<span class="source-line-no">1589</span><span id="line-1589">   */</span>
<span class="source-line-no">1590</span><span id="line-1590">  public void action( @Nonnull final Procedure executable,</span>
<span class="source-line-no">1591</span><span id="line-1591">                      @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">1592</span><span id="line-1592">    throws Throwable</span>
<span class="source-line-no">1593</span><span id="line-1593">  {</span>
<span class="source-line-no">1594</span><span id="line-1594">    action( null, executable, flags );</span>
<span class="source-line-no">1595</span><span id="line-1595">  }</span>
<span class="source-line-no">1596</span><span id="line-1596"></span>
<span class="source-line-no">1597</span><span id="line-1597">  /**</span>
<span class="source-line-no">1598</span><span id="line-1598">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1599</span><span id="line-1599">   * The executable may throw an exception.</span>
<span class="source-line-no">1600</span><span id="line-1600">   *</span>
<span class="source-line-no">1601</span><span id="line-1601">   * @param name       the name of the action.</span>
<span class="source-line-no">1602</span><span id="line-1602">   * @param executable the executable.</span>
<span class="source-line-no">1603</span><span id="line-1603">   * @throws Throwable if the procedure throws an an exception.</span>
<span class="source-line-no">1604</span><span id="line-1604">   */</span>
<span class="source-line-no">1605</span><span id="line-1605">  public void action( @Nullable final String name, @Nonnull final Procedure executable )</span>
<span class="source-line-no">1606</span><span id="line-1606">    throws Throwable</span>
<span class="source-line-no">1607</span><span id="line-1607">  {</span>
<span class="source-line-no">1608</span><span id="line-1608">    action( name, executable, 0 );</span>
<span class="source-line-no">1609</span><span id="line-1609">  }</span>
<span class="source-line-no">1610</span><span id="line-1610"></span>
<span class="source-line-no">1611</span><span id="line-1611">  /**</span>
<span class="source-line-no">1612</span><span id="line-1612">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1613</span><span id="line-1613">   * The executable may throw an exception.</span>
<span class="source-line-no">1614</span><span id="line-1614">   *</span>
<span class="source-line-no">1615</span><span id="line-1615">   * @param name       the name of the action.</span>
<span class="source-line-no">1616</span><span id="line-1616">   * @param executable the executable.</span>
<span class="source-line-no">1617</span><span id="line-1617">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1618</span><span id="line-1618">   * @throws Throwable if the procedure throws an an exception.</span>
<span class="source-line-no">1619</span><span id="line-1619">   */</span>
<span class="source-line-no">1620</span><span id="line-1620">  public void action( @Nullable final String name,</span>
<span class="source-line-no">1621</span><span id="line-1621">                      @Nonnull final Procedure executable,</span>
<span class="source-line-no">1622</span><span id="line-1622">                      @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">1623</span><span id="line-1623">    throws Throwable</span>
<span class="source-line-no">1624</span><span id="line-1624">  {</span>
<span class="source-line-no">1625</span><span id="line-1625">    action( name, executable, flags, null );</span>
<span class="source-line-no">1626</span><span id="line-1626">  }</span>
<span class="source-line-no">1627</span><span id="line-1627"></span>
<span class="source-line-no">1628</span><span id="line-1628">  /**</span>
<span class="source-line-no">1629</span><span id="line-1629">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1630</span><span id="line-1630">   * The executable may throw an exception.</span>
<span class="source-line-no">1631</span><span id="line-1631">   *</span>
<span class="source-line-no">1632</span><span id="line-1632">   * @param name       the name of the action.</span>
<span class="source-line-no">1633</span><span id="line-1633">   * @param executable the executable.</span>
<span class="source-line-no">1634</span><span id="line-1634">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1635</span><span id="line-1635">   * @param parameters the parameters if any. The parameters are only used to generate a spy event.</span>
<span class="source-line-no">1636</span><span id="line-1636">   * @throws Throwable if the procedure throws an an exception.</span>
<span class="source-line-no">1637</span><span id="line-1637">   */</span>
<span class="source-line-no">1638</span><span id="line-1638">  public void action( @Nullable final String name,</span>
<span class="source-line-no">1639</span><span id="line-1639">                      @Nonnull final Procedure executable,</span>
<span class="source-line-no">1640</span><span id="line-1640">                      @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags,</span>
<span class="source-line-no">1641</span><span id="line-1641">                      @Nullable final Object[] parameters )</span>
<span class="source-line-no">1642</span><span id="line-1642">    throws Throwable</span>
<span class="source-line-no">1643</span><span id="line-1643">  {</span>
<span class="source-line-no">1644</span><span id="line-1644">    _action( name, procedureToFunction( executable ), flags, null, parameters, false );</span>
<span class="source-line-no">1645</span><span id="line-1645">  }</span>
<span class="source-line-no">1646</span><span id="line-1646"></span>
<span class="source-line-no">1647</span><span id="line-1647">  /**</span>
<span class="source-line-no">1648</span><span id="line-1648">   * Execute the observe function with the specified Observer.</span>
<span class="source-line-no">1649</span><span id="line-1649">   * The Observer must be created by the {@link #tracker(Procedure)} methods.</span>
<span class="source-line-no">1650</span><span id="line-1650">   * The observe function may throw an exception.</span>
<span class="source-line-no">1651</span><span id="line-1651">   *</span>
<span class="source-line-no">1652</span><span id="line-1652">   * @param observer the Observer.</span>
<span class="source-line-no">1653</span><span id="line-1653">   * @param observe  the observe function.</span>
<span class="source-line-no">1654</span><span id="line-1654">   * @throws Exception if the observe function throws an an exception.</span>
<span class="source-line-no">1655</span><span id="line-1655">   */</span>
<span class="source-line-no">1656</span><span id="line-1656">  public void observe( @Nonnull final Observer observer, @Nonnull final Procedure observe )</span>
<span class="source-line-no">1657</span><span id="line-1657">    throws Throwable</span>
<span class="source-line-no">1658</span><span id="line-1658">  {</span>
<span class="source-line-no">1659</span><span id="line-1659">    observe( observer, observe, null );</span>
<span class="source-line-no">1660</span><span id="line-1660">  }</span>
<span class="source-line-no">1661</span><span id="line-1661"></span>
<span class="source-line-no">1662</span><span id="line-1662">  /**</span>
<span class="source-line-no">1663</span><span id="line-1663">   * Execute the observe function with the specified Observer.</span>
<span class="source-line-no">1664</span><span id="line-1664">   * The Observer must be created by the {@link #tracker(Procedure)} methods.</span>
<span class="source-line-no">1665</span><span id="line-1665">   * The observe function may throw an exception.</span>
<span class="source-line-no">1666</span><span id="line-1666">   *</span>
<span class="source-line-no">1667</span><span id="line-1667">   * @param observer   the Observer.</span>
<span class="source-line-no">1668</span><span id="line-1668">   * @param observe    the observe function.</span>
<span class="source-line-no">1669</span><span id="line-1669">   * @param parameters the parameters if any. The parameters are only used to generate a spy event.</span>
<span class="source-line-no">1670</span><span id="line-1670">   * @throws Exception if the observe function throws an an exception.</span>
<span class="source-line-no">1671</span><span id="line-1671">   */</span>
<span class="source-line-no">1672</span><span id="line-1672">  public void observe( @Nonnull final Observer observer,</span>
<span class="source-line-no">1673</span><span id="line-1673">                       @Nonnull final Procedure observe,</span>
<span class="source-line-no">1674</span><span id="line-1674">                       @Nullable final Object[] parameters )</span>
<span class="source-line-no">1675</span><span id="line-1675">    throws Throwable</span>
<span class="source-line-no">1676</span><span id="line-1676">  {</span>
<span class="source-line-no">1677</span><span id="line-1677">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">1678</span><span id="line-1678">    {</span>
<span class="source-line-no">1679</span><span id="line-1679">      apiInvariant( observer::isApplicationExecutor,</span>
<span class="source-line-no">1680</span><span id="line-1680">                    () -&gt; "Arez-0019: Attempted to invoke observe(..) on observer named '" + observer.getName() +</span>
<span class="source-line-no">1681</span><span id="line-1681">                          "' but observer is not configured to use an application executor." );</span>
<span class="source-line-no">1682</span><span id="line-1682">    }</span>
<span class="source-line-no">1683</span><span id="line-1683">    rawObserve( observer, observe, parameters );</span>
<span class="source-line-no">1684</span><span id="line-1684">  }</span>
<span class="source-line-no">1685</span><span id="line-1685"></span>
<span class="source-line-no">1686</span><span id="line-1686">  void rawObserve( @Nonnull final Observer observer,</span>
<span class="source-line-no">1687</span><span id="line-1687">                   @Nonnull final Procedure observe,</span>
<span class="source-line-no">1688</span><span id="line-1688">                   @Nullable final Object[] parameters )</span>
<span class="source-line-no">1689</span><span id="line-1689">    throws Throwable</span>
<span class="source-line-no">1690</span><span id="line-1690">  {</span>
<span class="source-line-no">1691</span><span id="line-1691">    _action( observerToName( observer ),</span>
<span class="source-line-no">1692</span><span id="line-1692">             procedureToFunction( observe ),</span>
<span class="source-line-no">1693</span><span id="line-1693">             trackerObserveFlags( observer ),</span>
<span class="source-line-no">1694</span><span id="line-1694">             observer,</span>
<span class="source-line-no">1695</span><span id="line-1695">             parameters,</span>
<span class="source-line-no">1696</span><span id="line-1696">             false );</span>
<span class="source-line-no">1697</span><span id="line-1697">  }</span>
<span class="source-line-no">1698</span><span id="line-1698"></span>
<span class="source-line-no">1699</span><span id="line-1699">  &lt;T&gt; T rawCompute( @Nonnull final ComputableValue&lt;T&gt; computableValue, @Nonnull final SafeFunction&lt;T&gt; action )</span>
<span class="source-line-no">1700</span><span id="line-1700">  {</span>
<span class="source-line-no">1701</span><span id="line-1701">    return _safeAction( Arez.areNamesEnabled() ? computableValue.getName() + ".wrapper" : null,</span>
<span class="source-line-no">1702</span><span id="line-1702">                        action,</span>
<span class="source-line-no">1703</span><span id="line-1703">                        ActionFlags.REQUIRE_NEW_TRANSACTION |</span>
<span class="source-line-no">1704</span><span id="line-1704">                        ActionFlags.NO_VERIFY_ACTION_REQUIRED |</span>
<span class="source-line-no">1705</span><span id="line-1705">                        ActionFlags.READ_ONLY,</span>
<span class="source-line-no">1706</span><span id="line-1706">                        null,</span>
<span class="source-line-no">1707</span><span id="line-1707">                        null,</span>
<span class="source-line-no">1708</span><span id="line-1708">                        false,</span>
<span class="source-line-no">1709</span><span id="line-1709">                        false );</span>
<span class="source-line-no">1710</span><span id="line-1710">  }</span>
<span class="source-line-no">1711</span><span id="line-1711"></span>
<span class="source-line-no">1712</span><span id="line-1712">  /**</span>
<span class="source-line-no">1713</span><span id="line-1713">   * Convert the specified procedure to a function.</span>
<span class="source-line-no">1714</span><span id="line-1714">   * This is done purely to reduce the compiled code-size under js.</span>
<span class="source-line-no">1715</span><span id="line-1715">   *</span>
<span class="source-line-no">1716</span><span id="line-1716">   * @param procedure the procedure.</span>
<span class="source-line-no">1717</span><span id="line-1717">   * @return the function.</span>
<span class="source-line-no">1718</span><span id="line-1718">   */</span>
<span class="source-line-no">1719</span><span id="line-1719">  @Nonnull</span>
<span class="source-line-no">1720</span><span id="line-1720">  private SafeFunction&lt;Object&gt; safeProcedureToFunction( @Nonnull final SafeProcedure procedure )</span>
<span class="source-line-no">1721</span><span id="line-1721">  {</span>
<span class="source-line-no">1722</span><span id="line-1722">    return () -&gt; {</span>
<span class="source-line-no">1723</span><span id="line-1723">      procedure.call();</span>
<span class="source-line-no">1724</span><span id="line-1724">      return null;</span>
<span class="source-line-no">1725</span><span id="line-1725">    };</span>
<span class="source-line-no">1726</span><span id="line-1726">  }</span>
<span class="source-line-no">1727</span><span id="line-1727"></span>
<span class="source-line-no">1728</span><span id="line-1728">  /**</span>
<span class="source-line-no">1729</span><span id="line-1729">   * Convert the specified procedure to a function.</span>
<span class="source-line-no">1730</span><span id="line-1730">   * This is done purely to reduce the compiled code-size under js.</span>
<span class="source-line-no">1731</span><span id="line-1731">   *</span>
<span class="source-line-no">1732</span><span id="line-1732">   * @param procedure the procedure.</span>
<span class="source-line-no">1733</span><span id="line-1733">   * @return the function.</span>
<span class="source-line-no">1734</span><span id="line-1734">   */</span>
<span class="source-line-no">1735</span><span id="line-1735">  @Nonnull</span>
<span class="source-line-no">1736</span><span id="line-1736">  private Function&lt;Object&gt; procedureToFunction( @Nonnull final Procedure procedure )</span>
<span class="source-line-no">1737</span><span id="line-1737">  {</span>
<span class="source-line-no">1738</span><span id="line-1738">    return () -&gt; {</span>
<span class="source-line-no">1739</span><span id="line-1739">      procedure.call();</span>
<span class="source-line-no">1740</span><span id="line-1740">      return null;</span>
<span class="source-line-no">1741</span><span id="line-1741">    };</span>
<span class="source-line-no">1742</span><span id="line-1742">  }</span>
<span class="source-line-no">1743</span><span id="line-1743"></span>
<span class="source-line-no">1744</span><span id="line-1744">  /**</span>
<span class="source-line-no">1745</span><span id="line-1745">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1746</span><span id="line-1746">   *</span>
<span class="source-line-no">1747</span><span id="line-1747">   * @param executable the executable.</span>
<span class="source-line-no">1748</span><span id="line-1748">   */</span>
<span class="source-line-no">1749</span><span id="line-1749">  public void safeAction( @Nonnull final SafeProcedure executable )</span>
<span class="source-line-no">1750</span><span id="line-1750">  {</span>
<span class="source-line-no">1751</span><span id="line-1751">    safeAction( executable, 0 );</span>
<span class="source-line-no">1752</span><span id="line-1752">  }</span>
<span class="source-line-no">1753</span><span id="line-1753"></span>
<span class="source-line-no">1754</span><span id="line-1754">  /**</span>
<span class="source-line-no">1755</span><span id="line-1755">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1756</span><span id="line-1756">   *</span>
<span class="source-line-no">1757</span><span id="line-1757">   * @param executable the executable.</span>
<span class="source-line-no">1758</span><span id="line-1758">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1759</span><span id="line-1759">   */</span>
<span class="source-line-no">1760</span><span id="line-1760">  public void safeAction( @Nonnull final SafeProcedure executable,</span>
<span class="source-line-no">1761</span><span id="line-1761">                          @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">1762</span><span id="line-1762">  {</span>
<span class="source-line-no">1763</span><span id="line-1763">    safeAction( null, executable, flags );</span>
<span class="source-line-no">1764</span><span id="line-1764">  }</span>
<span class="source-line-no">1765</span><span id="line-1765"></span>
<span class="source-line-no">1766</span><span id="line-1766">  /**</span>
<span class="source-line-no">1767</span><span id="line-1767">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1768</span><span id="line-1768">   *</span>
<span class="source-line-no">1769</span><span id="line-1769">   * @param name       the name of the action.</span>
<span class="source-line-no">1770</span><span id="line-1770">   * @param executable the executable.</span>
<span class="source-line-no">1771</span><span id="line-1771">   */</span>
<span class="source-line-no">1772</span><span id="line-1772">  public void safeAction( @Nullable final String name, @Nonnull final SafeProcedure executable )</span>
<span class="source-line-no">1773</span><span id="line-1773">  {</span>
<span class="source-line-no">1774</span><span id="line-1774">    safeAction( name, executable, 0 );</span>
<span class="source-line-no">1775</span><span id="line-1775">  }</span>
<span class="source-line-no">1776</span><span id="line-1776"></span>
<span class="source-line-no">1777</span><span id="line-1777">  /**</span>
<span class="source-line-no">1778</span><span id="line-1778">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1779</span><span id="line-1779">   *</span>
<span class="source-line-no">1780</span><span id="line-1780">   * @param name       the name of the action.</span>
<span class="source-line-no">1781</span><span id="line-1781">   * @param executable the executable.</span>
<span class="source-line-no">1782</span><span id="line-1782">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1783</span><span id="line-1783">   */</span>
<span class="source-line-no">1784</span><span id="line-1784">  public void safeAction( @Nullable final String name,</span>
<span class="source-line-no">1785</span><span id="line-1785">                          @Nonnull final SafeProcedure executable,</span>
<span class="source-line-no">1786</span><span id="line-1786">                          @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">1787</span><span id="line-1787">  {</span>
<span class="source-line-no">1788</span><span id="line-1788">    safeAction( name, executable, flags, null );</span>
<span class="source-line-no">1789</span><span id="line-1789">  }</span>
<span class="source-line-no">1790</span><span id="line-1790"></span>
<span class="source-line-no">1791</span><span id="line-1791">  /**</span>
<span class="source-line-no">1792</span><span id="line-1792">   * Execute the supplied executable in a transaction.</span>
<span class="source-line-no">1793</span><span id="line-1793">   *</span>
<span class="source-line-no">1794</span><span id="line-1794">   * @param name       the name of the action.</span>
<span class="source-line-no">1795</span><span id="line-1795">   * @param executable the executable.</span>
<span class="source-line-no">1796</span><span id="line-1796">   * @param flags      the flags for the action. The acceptable flags are defined in {@link ActionFlags}.</span>
<span class="source-line-no">1797</span><span id="line-1797">   * @param parameters the parameters if any. The parameters are only used to generate a spy event.</span>
<span class="source-line-no">1798</span><span id="line-1798">   */</span>
<span class="source-line-no">1799</span><span id="line-1799">  public void safeAction( @Nullable final String name,</span>
<span class="source-line-no">1800</span><span id="line-1800">                          @Nonnull final SafeProcedure executable,</span>
<span class="source-line-no">1801</span><span id="line-1801">                          @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags,</span>
<span class="source-line-no">1802</span><span id="line-1802">                          @Nullable final Object[] parameters )</span>
<span class="source-line-no">1803</span><span id="line-1803">  {</span>
<span class="source-line-no">1804</span><span id="line-1804">    _safeAction( name, safeProcedureToFunction( executable ), flags, null, parameters, false, true );</span>
<span class="source-line-no">1805</span><span id="line-1805">  }</span>
<span class="source-line-no">1806</span><span id="line-1806"></span>
<span class="source-line-no">1807</span><span id="line-1807">  /**</span>
<span class="source-line-no">1808</span><span id="line-1808">   * Execute the observe function with the specified Observer.</span>
<span class="source-line-no">1809</span><span id="line-1809">   * The Observer must be created by the {@link #tracker(Procedure)} methods.</span>
<span class="source-line-no">1810</span><span id="line-1810">   * The observe function should not throw an exception.</span>
<span class="source-line-no">1811</span><span id="line-1811">   *</span>
<span class="source-line-no">1812</span><span id="line-1812">   * @param observer the Observer.</span>
<span class="source-line-no">1813</span><span id="line-1813">   * @param observe  the observe function.</span>
<span class="source-line-no">1814</span><span id="line-1814">   */</span>
<span class="source-line-no">1815</span><span id="line-1815">  public void safeObserve( @Nonnull final Observer observer, @Nonnull final SafeProcedure observe )</span>
<span class="source-line-no">1816</span><span id="line-1816">  {</span>
<span class="source-line-no">1817</span><span id="line-1817">    safeObserve( observer, observe, null );</span>
<span class="source-line-no">1818</span><span id="line-1818">  }</span>
<span class="source-line-no">1819</span><span id="line-1819"></span>
<span class="source-line-no">1820</span><span id="line-1820">  /**</span>
<span class="source-line-no">1821</span><span id="line-1821">   * Execute the observe function with the specified Observer.</span>
<span class="source-line-no">1822</span><span id="line-1822">   * The Observer must be created by the {@link #tracker(Procedure)} methods.</span>
<span class="source-line-no">1823</span><span id="line-1823">   * The observe function should not throw an exception.</span>
<span class="source-line-no">1824</span><span id="line-1824">   *</span>
<span class="source-line-no">1825</span><span id="line-1825">   * @param observer   the Observer.</span>
<span class="source-line-no">1826</span><span id="line-1826">   * @param observe    the observe function.</span>
<span class="source-line-no">1827</span><span id="line-1827">   * @param parameters the parameters if any. The parameters are only used to generate a spy event.</span>
<span class="source-line-no">1828</span><span id="line-1828">   */</span>
<span class="source-line-no">1829</span><span id="line-1829">  public void safeObserve( @Nonnull final Observer observer,</span>
<span class="source-line-no">1830</span><span id="line-1830">                           @Nonnull final SafeProcedure observe,</span>
<span class="source-line-no">1831</span><span id="line-1831">                           @Nullable final Object[] parameters )</span>
<span class="source-line-no">1832</span><span id="line-1832">  {</span>
<span class="source-line-no">1833</span><span id="line-1833">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">1834</span><span id="line-1834">    {</span>
<span class="source-line-no">1835</span><span id="line-1835">      apiInvariant( observer::isApplicationExecutor,</span>
<span class="source-line-no">1836</span><span id="line-1836">                    () -&gt; "Arez-0020: Attempted to invoke safeObserve(..) on observer named '" + observer.getName() +</span>
<span class="source-line-no">1837</span><span id="line-1837">                          "' but observer is not configured to use an application executor." );</span>
<span class="source-line-no">1838</span><span id="line-1838">    }</span>
<span class="source-line-no">1839</span><span id="line-1839">    _safeAction( observerToName( observer ),</span>
<span class="source-line-no">1840</span><span id="line-1840">                 safeProcedureToFunction( observe ),</span>
<span class="source-line-no">1841</span><span id="line-1841">                 trackerObserveFlags( observer ),</span>
<span class="source-line-no">1842</span><span id="line-1842">                 observer,</span>
<span class="source-line-no">1843</span><span id="line-1843">                 parameters,</span>
<span class="source-line-no">1844</span><span id="line-1844">                 false,</span>
<span class="source-line-no">1845</span><span id="line-1845">                 true );</span>
<span class="source-line-no">1846</span><span id="line-1846">  }</span>
<span class="source-line-no">1847</span><span id="line-1847"></span>
<span class="source-line-no">1848</span><span id="line-1848">  private &lt;T&gt; T _safeAction( @Nullable final String specifiedName,</span>
<span class="source-line-no">1849</span><span id="line-1849">                             @Nonnull final SafeFunction&lt;T&gt; executable,</span>
<span class="source-line-no">1850</span><span id="line-1850">                             final int flags,</span>
<span class="source-line-no">1851</span><span id="line-1851">                             @Nullable final Observer observer,</span>
<span class="source-line-no">1852</span><span id="line-1852">                             @Nullable final Object[] parameters,</span>
<span class="source-line-no">1853</span><span id="line-1853">                             final boolean expectResult,</span>
<span class="source-line-no">1854</span><span id="line-1854">                             final boolean generateActionEvents )</span>
<span class="source-line-no">1855</span><span id="line-1855">  {</span>
<span class="source-line-no">1856</span><span id="line-1856">    final String name = generateName( "Action", specifiedName );</span>
<span class="source-line-no">1857</span><span id="line-1857"></span>
<span class="source-line-no">1858</span><span id="line-1858">    verifyActionFlags( name, flags );</span>
<span class="source-line-no">1859</span><span id="line-1859"></span>
<span class="source-line-no">1860</span><span id="line-1860">    final boolean observe = null != observer;</span>
<span class="source-line-no">1861</span><span id="line-1861">    Throwable t = null;</span>
<span class="source-line-no">1862</span><span id="line-1862">    boolean completed = false;</span>
<span class="source-line-no">1863</span><span id="line-1863">    long startedAt = 0L;</span>
<span class="source-line-no">1864</span><span id="line-1864">    T result;</span>
<span class="source-line-no">1865</span><span id="line-1865">    try</span>
<span class="source-line-no">1866</span><span id="line-1866">    {</span>
<span class="source-line-no">1867</span><span id="line-1867">      if ( Arez.areSpiesEnabled() &amp;&amp; generateActionEvents )</span>
<span class="source-line-no">1868</span><span id="line-1868">      {</span>
<span class="source-line-no">1869</span><span id="line-1869">        startedAt = System.currentTimeMillis();</span>
<span class="source-line-no">1870</span><span id="line-1870">        if ( willPropagateSpyEvents() )</span>
<span class="source-line-no">1871</span><span id="line-1871">        {</span>
<span class="source-line-no">1872</span><span id="line-1872">          reportActionStarted( name, parameters, observe );</span>
<span class="source-line-no">1873</span><span id="line-1873">        }</span>
<span class="source-line-no">1874</span><span id="line-1874">      }</span>
<span class="source-line-no">1875</span><span id="line-1875">      verifyActionNestingAllowed( name, observer );</span>
<span class="source-line-no">1876</span><span id="line-1876">      if ( canImmediatelyInvokeAction( flags ) )</span>
<span class="source-line-no">1877</span><span id="line-1877">      {</span>
<span class="source-line-no">1878</span><span id="line-1878">        result = executable.call();</span>
<span class="source-line-no">1879</span><span id="line-1879">      }</span>
<span class="source-line-no">1880</span><span id="line-1880">      else</span>
<span class="source-line-no">1881</span><span id="line-1881">      {</span>
<span class="source-line-no">1882</span><span id="line-1882">        final Transaction transaction = newTransaction( name, flags, observer );</span>
<span class="source-line-no">1883</span><span id="line-1883">        try</span>
<span class="source-line-no">1884</span><span id="line-1884">        {</span>
<span class="source-line-no">1885</span><span id="line-1885">          result = executable.call();</span>
<span class="source-line-no">1886</span><span id="line-1886">          verifyActionDependencies( name, observer, flags, transaction );</span>
<span class="source-line-no">1887</span><span id="line-1887">        }</span>
<span class="source-line-no">1888</span><span id="line-1888">        finally</span>
<span class="source-line-no">1889</span><span id="line-1889">        {</span>
<span class="source-line-no">1890</span><span id="line-1890">          Transaction.commit( transaction );</span>
<span class="source-line-no">1891</span><span id="line-1891">        }</span>
<span class="source-line-no">1892</span><span id="line-1892">      }</span>
<span class="source-line-no">1893</span><span id="line-1893">      if ( willPropagateSpyEvents() &amp;&amp; generateActionEvents )</span>
<span class="source-line-no">1894</span><span id="line-1894">      {</span>
<span class="source-line-no">1895</span><span id="line-1895">        completed = true;</span>
<span class="source-line-no">1896</span><span id="line-1896">        final boolean noReportResults = ( flags &amp; ActionFlags.NO_REPORT_RESULT ) == ActionFlags.NO_REPORT_RESULT;</span>
<span class="source-line-no">1897</span><span id="line-1897">        reportActionCompleted( name,</span>
<span class="source-line-no">1898</span><span id="line-1898">                               parameters,</span>
<span class="source-line-no">1899</span><span id="line-1899">                               observe,</span>
<span class="source-line-no">1900</span><span id="line-1900">                               null,</span>
<span class="source-line-no">1901</span><span id="line-1901">                               startedAt,</span>
<span class="source-line-no">1902</span><span id="line-1902">                               expectResult,</span>
<span class="source-line-no">1903</span><span id="line-1903">                               noReportResults ? null : result );</span>
<span class="source-line-no">1904</span><span id="line-1904">      }</span>
<span class="source-line-no">1905</span><span id="line-1905">      return result;</span>
<span class="source-line-no">1906</span><span id="line-1906">    }</span>
<span class="source-line-no">1907</span><span id="line-1907">    catch ( final Throwable e )</span>
<span class="source-line-no">1908</span><span id="line-1908">    {</span>
<span class="source-line-no">1909</span><span id="line-1909">      t = e;</span>
<span class="source-line-no">1910</span><span id="line-1910">      throw e;</span>
<span class="source-line-no">1911</span><span id="line-1911">    }</span>
<span class="source-line-no">1912</span><span id="line-1912">    finally</span>
<span class="source-line-no">1913</span><span id="line-1913">    {</span>
<span class="source-line-no">1914</span><span id="line-1914">      if ( willPropagateSpyEvents() &amp;&amp; generateActionEvents )</span>
<span class="source-line-no">1915</span><span id="line-1915">      {</span>
<span class="source-line-no">1916</span><span id="line-1916">        if ( !completed )</span>
<span class="source-line-no">1917</span><span id="line-1917">        {</span>
<span class="source-line-no">1918</span><span id="line-1918">          reportActionCompleted( name, parameters, observe, t, startedAt, expectResult, null );</span>
<span class="source-line-no">1919</span><span id="line-1919">        }</span>
<span class="source-line-no">1920</span><span id="line-1920">      }</span>
<span class="source-line-no">1921</span><span id="line-1921">      triggerScheduler();</span>
<span class="source-line-no">1922</span><span id="line-1922">    }</span>
<span class="source-line-no">1923</span><span id="line-1923">  }</span>
<span class="source-line-no">1924</span><span id="line-1924"></span>
<span class="source-line-no">1925</span><span id="line-1925">  private &lt;T&gt; T _action( @Nullable final String specifiedName,</span>
<span class="source-line-no">1926</span><span id="line-1926">                         @Nonnull final Function&lt;T&gt; executable,</span>
<span class="source-line-no">1927</span><span id="line-1927">                         final int flags,</span>
<span class="source-line-no">1928</span><span id="line-1928">                         @Nullable final Observer observer,</span>
<span class="source-line-no">1929</span><span id="line-1929">                         @Nullable final Object[] parameters,</span>
<span class="source-line-no">1930</span><span id="line-1930">                         final boolean expectResult )</span>
<span class="source-line-no">1931</span><span id="line-1931">    throws Throwable</span>
<span class="source-line-no">1932</span><span id="line-1932">  {</span>
<span class="source-line-no">1933</span><span id="line-1933">    final String name = generateName( "Action", specifiedName );</span>
<span class="source-line-no">1934</span><span id="line-1934"></span>
<span class="source-line-no">1935</span><span id="line-1935">    verifyActionFlags( name, flags );</span>
<span class="source-line-no">1936</span><span id="line-1936">    final boolean observed = null != observer;</span>
<span class="source-line-no">1937</span><span id="line-1937">    final boolean generateActionEvents = !observed || !observer.isComputableValue();</span>
<span class="source-line-no">1938</span><span id="line-1938">    Throwable t = null;</span>
<span class="source-line-no">1939</span><span id="line-1939">    boolean completed = false;</span>
<span class="source-line-no">1940</span><span id="line-1940">    long startedAt = 0L;</span>
<span class="source-line-no">1941</span><span id="line-1941">    T result;</span>
<span class="source-line-no">1942</span><span id="line-1942">    try</span>
<span class="source-line-no">1943</span><span id="line-1943">    {</span>
<span class="source-line-no">1944</span><span id="line-1944">      if ( Arez.areSpiesEnabled() &amp;&amp; generateActionEvents )</span>
<span class="source-line-no">1945</span><span id="line-1945">      {</span>
<span class="source-line-no">1946</span><span id="line-1946">        startedAt = System.currentTimeMillis();</span>
<span class="source-line-no">1947</span><span id="line-1947">        if ( willPropagateSpyEvents() )</span>
<span class="source-line-no">1948</span><span id="line-1948">        {</span>
<span class="source-line-no">1949</span><span id="line-1949">          reportActionStarted( name, parameters, observed );</span>
<span class="source-line-no">1950</span><span id="line-1950">        }</span>
<span class="source-line-no">1951</span><span id="line-1951">      }</span>
<span class="source-line-no">1952</span><span id="line-1952">      verifyActionNestingAllowed( name, observer );</span>
<span class="source-line-no">1953</span><span id="line-1953">      if ( canImmediatelyInvokeAction( flags ) )</span>
<span class="source-line-no">1954</span><span id="line-1954">      {</span>
<span class="source-line-no">1955</span><span id="line-1955">        result = executable.call();</span>
<span class="source-line-no">1956</span><span id="line-1956">      }</span>
<span class="source-line-no">1957</span><span id="line-1957">      else</span>
<span class="source-line-no">1958</span><span id="line-1958">      {</span>
<span class="source-line-no">1959</span><span id="line-1959">        final Transaction transaction = newTransaction( name, flags, observer );</span>
<span class="source-line-no">1960</span><span id="line-1960">        try</span>
<span class="source-line-no">1961</span><span id="line-1961">        {</span>
<span class="source-line-no">1962</span><span id="line-1962">          result = executable.call();</span>
<span class="source-line-no">1963</span><span id="line-1963">          verifyActionDependencies( name, observer, flags, transaction );</span>
<span class="source-line-no">1964</span><span id="line-1964">        }</span>
<span class="source-line-no">1965</span><span id="line-1965">        finally</span>
<span class="source-line-no">1966</span><span id="line-1966">        {</span>
<span class="source-line-no">1967</span><span id="line-1967">          Transaction.commit( transaction );</span>
<span class="source-line-no">1968</span><span id="line-1968">        }</span>
<span class="source-line-no">1969</span><span id="line-1969">      }</span>
<span class="source-line-no">1970</span><span id="line-1970">      if ( willPropagateSpyEvents() &amp;&amp; generateActionEvents )</span>
<span class="source-line-no">1971</span><span id="line-1971">      {</span>
<span class="source-line-no">1972</span><span id="line-1972">        completed = true;</span>
<span class="source-line-no">1973</span><span id="line-1973">        final boolean noReportResults = ( flags &amp; ActionFlags.NO_REPORT_RESULT ) == ActionFlags.NO_REPORT_RESULT;</span>
<span class="source-line-no">1974</span><span id="line-1974">        reportActionCompleted( name,</span>
<span class="source-line-no">1975</span><span id="line-1975">                               parameters,</span>
<span class="source-line-no">1976</span><span id="line-1976">                               observed,</span>
<span class="source-line-no">1977</span><span id="line-1977">                               null,</span>
<span class="source-line-no">1978</span><span id="line-1978">                               startedAt,</span>
<span class="source-line-no">1979</span><span id="line-1979">                               expectResult,</span>
<span class="source-line-no">1980</span><span id="line-1980">                               noReportResults ? null : result );</span>
<span class="source-line-no">1981</span><span id="line-1981">      }</span>
<span class="source-line-no">1982</span><span id="line-1982">      return result;</span>
<span class="source-line-no">1983</span><span id="line-1983">    }</span>
<span class="source-line-no">1984</span><span id="line-1984">    catch ( final Throwable e )</span>
<span class="source-line-no">1985</span><span id="line-1985">    {</span>
<span class="source-line-no">1986</span><span id="line-1986">      t = e;</span>
<span class="source-line-no">1987</span><span id="line-1987">      throw e;</span>
<span class="source-line-no">1988</span><span id="line-1988">    }</span>
<span class="source-line-no">1989</span><span id="line-1989">    finally</span>
<span class="source-line-no">1990</span><span id="line-1990">    {</span>
<span class="source-line-no">1991</span><span id="line-1991">      if ( willPropagateSpyEvents() &amp;&amp; generateActionEvents )</span>
<span class="source-line-no">1992</span><span id="line-1992">      {</span>
<span class="source-line-no">1993</span><span id="line-1993">        if ( !completed )</span>
<span class="source-line-no">1994</span><span id="line-1994">        {</span>
<span class="source-line-no">1995</span><span id="line-1995">          reportActionCompleted( name, parameters, observed, t, startedAt, expectResult, null );</span>
<span class="source-line-no">1996</span><span id="line-1996">        }</span>
<span class="source-line-no">1997</span><span id="line-1997">      }</span>
<span class="source-line-no">1998</span><span id="line-1998">      triggerScheduler();</span>
<span class="source-line-no">1999</span><span id="line-1999">    }</span>
<span class="source-line-no">2000</span><span id="line-2000">  }</span>
<span class="source-line-no">2001</span><span id="line-2001"></span>
<span class="source-line-no">2002</span><span id="line-2002">  private void verifyActionFlags( @Nullable final String name,</span>
<span class="source-line-no">2003</span><span id="line-2003">                                  @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">2004</span><span id="line-2004">  {</span>
<span class="source-line-no">2005</span><span id="line-2005">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">2006</span><span id="line-2006">    {</span>
<span class="source-line-no">2007</span><span id="line-2007">      final int nonActionFlags = flags &amp; ~ActionFlags.CONFIG_FLAGS_MASK;</span>
<span class="source-line-no">2008</span><span id="line-2008">      apiInvariant( () -&gt; 0 == nonActionFlags,</span>
<span class="source-line-no">2009</span><span id="line-2009">                    () -&gt; "Arez-0212: Flags passed to action '" + name + "' include some unexpected " +</span>
<span class="source-line-no">2010</span><span id="line-2010">                          "flags set: " + nonActionFlags );</span>
<span class="source-line-no">2011</span><span id="line-2011">      apiInvariant( () -&gt; !Arez.shouldEnforceTransactionType() ||</span>
<span class="source-line-no">2012</span><span id="line-2012">                          Transaction.Flags.isTransactionModeValid( Transaction.Flags.transactionMode( flags ) |</span>
<span class="source-line-no">2013</span><span id="line-2013">                                                                    flags ),</span>
<span class="source-line-no">2014</span><span id="line-2014">                    () -&gt; "Arez-0126: Flags passed to action '" + name + "' include both READ_ONLY and READ_WRITE." );</span>
<span class="source-line-no">2015</span><span id="line-2015">      apiInvariant( () -&gt; ActionFlags.isVerifyActionRuleValid( flags | ActionFlags.verifyActionRule( flags ) ),</span>
<span class="source-line-no">2016</span><span id="line-2016">                    () -&gt; "Arez-0127: Flags passed to action '" + name + "' include both VERIFY_ACTION_REQUIRED " +</span>
<span class="source-line-no">2017</span><span id="line-2017">                          "and NO_VERIFY_ACTION_REQUIRED." );</span>
<span class="source-line-no">2018</span><span id="line-2018">    }</span>
<span class="source-line-no">2019</span><span id="line-2019">  }</span>
<span class="source-line-no">2020</span><span id="line-2020"></span>
<span class="source-line-no">2021</span><span id="line-2021">  private void verifyActionDependencies( @Nullable final String name,</span>
<span class="source-line-no">2022</span><span id="line-2022">                                         @Nullable final Observer observer,</span>
<span class="source-line-no">2023</span><span id="line-2023">                                         final int flags,</span>
<span class="source-line-no">2024</span><span id="line-2024">                                         @Nonnull final Transaction transaction )</span>
<span class="source-line-no">2025</span><span id="line-2025">  {</span>
<span class="source-line-no">2026</span><span id="line-2026">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2027</span><span id="line-2027">    {</span>
<span class="source-line-no">2028</span><span id="line-2028">      if ( null == observer )</span>
<span class="source-line-no">2029</span><span id="line-2029">      {</span>
<span class="source-line-no">2030</span><span id="line-2030">        verifyActionRequired( transaction, flags );</span>
<span class="source-line-no">2031</span><span id="line-2031">      }</span>
<span class="source-line-no">2032</span><span id="line-2032">      else if ( Observer.Flags.AREZ_DEPENDENCIES == ( flags &amp; Observer.Flags.AREZ_DEPENDENCIES ) )</span>
<span class="source-line-no">2033</span><span id="line-2033">      {</span>
<span class="source-line-no">2034</span><span id="line-2034">        final Transaction current = Transaction.current();</span>
<span class="source-line-no">2035</span><span id="line-2035"></span>
<span class="source-line-no">2036</span><span id="line-2036">        final List&lt;ObservableValue&lt;?&gt;&gt; observableValues = current.getObservableValues();</span>
<span class="source-line-no">2037</span><span id="line-2037">        invariant( () -&gt; Objects.requireNonNull( current.getTracker() ).isDisposing() ||</span>
<span class="source-line-no">2038</span><span id="line-2038">                         ( null != observableValues &amp;&amp; !observableValues.isEmpty() ),</span>
<span class="source-line-no">2039</span><span id="line-2039">                   () -&gt; "Arez-0118: Observer named '" + name + "' completed observed function (executed by " +</span>
<span class="source-line-no">2040</span><span id="line-2040">                         "application) but is not observing any properties." );</span>
<span class="source-line-no">2041</span><span id="line-2041">      }</span>
<span class="source-line-no">2042</span><span id="line-2042">    }</span>
<span class="source-line-no">2043</span><span id="line-2043">  }</span>
<span class="source-line-no">2044</span><span id="line-2044"></span>
<span class="source-line-no">2045</span><span id="line-2045">  private void verifyActionRequired( @Nonnull final Transaction transaction,</span>
<span class="source-line-no">2046</span><span id="line-2046">                                     @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags )</span>
<span class="source-line-no">2047</span><span id="line-2047">  {</span>
<span class="source-line-no">2048</span><span id="line-2048">    if ( Arez.shouldCheckInvariants() &amp;&amp;</span>
<span class="source-line-no">2049</span><span id="line-2049">         ActionFlags.NO_VERIFY_ACTION_REQUIRED != ( flags &amp; ActionFlags.NO_VERIFY_ACTION_REQUIRED ) )</span>
<span class="source-line-no">2050</span><span id="line-2050">    {</span>
<span class="source-line-no">2051</span><span id="line-2051">      invariant( transaction::hasTransactionUseOccured,</span>
<span class="source-line-no">2052</span><span id="line-2052">                 () -&gt; "Arez-0185: Action named '" + transaction.getName() + "' completed but no reads, writes, " +</span>
<span class="source-line-no">2053</span><span id="line-2053">                       "schedules, reportStales or reportPossiblyChanged occurred within the scope of the action." );</span>
<span class="source-line-no">2054</span><span id="line-2054">    }</span>
<span class="source-line-no">2055</span><span id="line-2055">  }</span>
<span class="source-line-no">2056</span><span id="line-2056"></span>
<span class="source-line-no">2057</span><span id="line-2057">  @Nonnull</span>
<span class="source-line-no">2058</span><span id="line-2058">  private Transaction newTransaction( @Nullable final String name,</span>
<span class="source-line-no">2059</span><span id="line-2059">                                      @MagicConstant( flagsFromClass = ActionFlags.class ) final int flags,</span>
<span class="source-line-no">2060</span><span id="line-2060">                                      @Nullable final Observer observer )</span>
<span class="source-line-no">2061</span><span id="line-2061">  {</span>
<span class="source-line-no">2062</span><span id="line-2062">    final boolean mutation = Arez.shouldEnforceTransactionType() &amp;&amp; 0 == ( flags &amp; Transaction.Flags.READ_ONLY );</span>
<span class="source-line-no">2063</span><span id="line-2063">    return Transaction.begin( this, generateName( "Transaction", name ), mutation, observer );</span>
<span class="source-line-no">2064</span><span id="line-2064">  }</span>
<span class="source-line-no">2065</span><span id="line-2065"></span>
<span class="source-line-no">2066</span><span id="line-2066">  /**</span>
<span class="source-line-no">2067</span><span id="line-2067">   * Return true if action can immediately invoked, false if a transaction needs to be created.</span>
<span class="source-line-no">2068</span><span id="line-2068">   */</span>
<span class="source-line-no">2069</span><span id="line-2069">  private boolean canImmediatelyInvokeAction( final int flags )</span>
<span class="source-line-no">2070</span><span id="line-2070">  {</span>
<span class="source-line-no">2071</span><span id="line-2071">    return 0 == ( flags &amp; ActionFlags.REQUIRE_NEW_TRANSACTION ) &amp;&amp;</span>
<span class="source-line-no">2072</span><span id="line-2072">           ( Arez.shouldEnforceTransactionType() &amp;&amp;</span>
<span class="source-line-no">2073</span><span id="line-2073">             ( ActionFlags.READ_ONLY == ( flags &amp; ActionFlags.READ_ONLY ) ) ?</span>
<span class="source-line-no">2074</span><span id="line-2074">             isReadOnlyTransactionActive() :</span>
<span class="source-line-no">2075</span><span id="line-2075">             isReadWriteTransactionActive() );</span>
<span class="source-line-no">2076</span><span id="line-2076">  }</span>
<span class="source-line-no">2077</span><span id="line-2077"></span>
<span class="source-line-no">2078</span><span id="line-2078">  private void verifyActionNestingAllowed( @Nullable final String name, @Nullable final Observer observer )</span>
<span class="source-line-no">2079</span><span id="line-2079">  {</span>
<span class="source-line-no">2080</span><span id="line-2080">    if ( Arez.shouldEnforceTransactionType() )</span>
<span class="source-line-no">2081</span><span id="line-2081">    {</span>
<span class="source-line-no">2082</span><span id="line-2082">      final Transaction parentTransaction = Transaction.isTransactionActive( this ) ? Transaction.current() : null;</span>
<span class="source-line-no">2083</span><span id="line-2083">      if ( null != parentTransaction )</span>
<span class="source-line-no">2084</span><span id="line-2084">      {</span>
<span class="source-line-no">2085</span><span id="line-2085">        final Observer parent = parentTransaction.getTracker();</span>
<span class="source-line-no">2086</span><span id="line-2086">        apiInvariant( () -&gt; null == parent ||</span>
<span class="source-line-no">2087</span><span id="line-2087">                            parent.nestedActionsAllowed() ||</span>
<span class="source-line-no">2088</span><span id="line-2088">                            ( null != observer &amp;&amp; observer.isComputableValue() ),</span>
<span class="source-line-no">2089</span><span id="line-2089">                      () -&gt; "Arez-0187: Attempting to nest action named '" + name + "' " +</span>
<span class="source-line-no">2090</span><span id="line-2090">                            "inside transaction named '" + parentTransaction.getName() + "' created by an " +</span>
<span class="source-line-no">2091</span><span id="line-2091">                            "observer that does not allow nested actions." );</span>
<span class="source-line-no">2092</span><span id="line-2092">      }</span>
<span class="source-line-no">2093</span><span id="line-2093">    }</span>
<span class="source-line-no">2094</span><span id="line-2094">  }</span>
<span class="source-line-no">2095</span><span id="line-2095"></span>
<span class="source-line-no">2096</span><span id="line-2096">  /**</span>
<span class="source-line-no">2097</span><span id="line-2097">   * Return next transaction id and increment internal counter.</span>
<span class="source-line-no">2098</span><span id="line-2098">   * The id is a monotonically increasing number starting at 1.</span>
<span class="source-line-no">2099</span><span id="line-2099">   *</span>
<span class="source-line-no">2100</span><span id="line-2100">   * @return the next transaction id.</span>
<span class="source-line-no">2101</span><span id="line-2101">   */</span>
<span class="source-line-no">2102</span><span id="line-2102">  int nextTransactionId()</span>
<span class="source-line-no">2103</span><span id="line-2103">  {</span>
<span class="source-line-no">2104</span><span id="line-2104">    return _nextTransactionId++;</span>
<span class="source-line-no">2105</span><span id="line-2105">  }</span>
<span class="source-line-no">2106</span><span id="line-2106"></span>
<span class="source-line-no">2107</span><span id="line-2107">  /**</span>
<span class="source-line-no">2108</span><span id="line-2108">   * Register an entity locator to use to resolve references.</span>
<span class="source-line-no">2109</span><span id="line-2109">   * The Locator must not already be registered.</span>
<span class="source-line-no">2110</span><span id="line-2110">   * This should not be invoked unless Arez.areReferencesEnabled() returns true.</span>
<span class="source-line-no">2111</span><span id="line-2111">   *</span>
<span class="source-line-no">2112</span><span id="line-2112">   * @param locator the Locator to register.</span>
<span class="source-line-no">2113</span><span id="line-2113">   * @return the disposable to dispose to deregister locator.</span>
<span class="source-line-no">2114</span><span id="line-2114">   */</span>
<span class="source-line-no">2115</span><span id="line-2115">  @OmitSymbol( unless = "arez.enable_references" )</span>
<span class="source-line-no">2116</span><span id="line-2116">  @Nonnull</span>
<span class="source-line-no">2117</span><span id="line-2117">  public Disposable registerLocator( @Nonnull final Locator locator )</span>
<span class="source-line-no">2118</span><span id="line-2118">  {</span>
<span class="source-line-no">2119</span><span id="line-2119">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">2120</span><span id="line-2120">    {</span>
<span class="source-line-no">2121</span><span id="line-2121">      apiInvariant( Arez::areReferencesEnabled,</span>
<span class="source-line-no">2122</span><span id="line-2122">                    () -&gt; "Arez-0191: ArezContext.registerLocator invoked but Arez.areReferencesEnabled() returned false." );</span>
<span class="source-line-no">2123</span><span id="line-2123">    }</span>
<span class="source-line-no">2124</span><span id="line-2124">    assert null != _locator;</span>
<span class="source-line-no">2125</span><span id="line-2125">    return _locator.registerLocator( Objects.requireNonNull( locator ) );</span>
<span class="source-line-no">2126</span><span id="line-2126">  }</span>
<span class="source-line-no">2127</span><span id="line-2127"></span>
<span class="source-line-no">2128</span><span id="line-2128">  /**</span>
<span class="source-line-no">2129</span><span id="line-2129">   * Return the locator that can be used to resolve references.</span>
<span class="source-line-no">2130</span><span id="line-2130">   * This should not be invoked unless Arez.areReferencesEnabled() returns true.</span>
<span class="source-line-no">2131</span><span id="line-2131">   *</span>
<span class="source-line-no">2132</span><span id="line-2132">   * @return the Locator.</span>
<span class="source-line-no">2133</span><span id="line-2133">   */</span>
<span class="source-line-no">2134</span><span id="line-2134">  @OmitSymbol( unless = "arez.enable_references" )</span>
<span class="source-line-no">2135</span><span id="line-2135">  @Nonnull</span>
<span class="source-line-no">2136</span><span id="line-2136">  public Locator locator()</span>
<span class="source-line-no">2137</span><span id="line-2137">  {</span>
<span class="source-line-no">2138</span><span id="line-2138">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">2139</span><span id="line-2139">    {</span>
<span class="source-line-no">2140</span><span id="line-2140">      apiInvariant( Arez::areReferencesEnabled,</span>
<span class="source-line-no">2141</span><span id="line-2141">                    () -&gt; "Arez-0192: ArezContext.locator() invoked but Arez.areReferencesEnabled() returned false." );</span>
<span class="source-line-no">2142</span><span id="line-2142">    }</span>
<span class="source-line-no">2143</span><span id="line-2143">    assert null != _locator;</span>
<span class="source-line-no">2144</span><span id="line-2144">    return _locator;</span>
<span class="source-line-no">2145</span><span id="line-2145">  }</span>
<span class="source-line-no">2146</span><span id="line-2146"></span>
<span class="source-line-no">2147</span><span id="line-2147">  /**</span>
<span class="source-line-no">2148</span><span id="line-2148">   * Add error handler to the list of error handlers called.</span>
<span class="source-line-no">2149</span><span id="line-2149">   * The handler should not already be in the list. This method should NOT be called if</span>
<span class="source-line-no">2150</span><span id="line-2150">   * {@link Arez#areObserverErrorHandlersEnabled()} returns false.</span>
<span class="source-line-no">2151</span><span id="line-2151">   *</span>
<span class="source-line-no">2152</span><span id="line-2152">   * @param handler the error handler.</span>
<span class="source-line-no">2153</span><span id="line-2153">   */</span>
<span class="source-line-no">2154</span><span id="line-2154">  @OmitSymbol( unless = "arez.enable_observer_error_handlers" )</span>
<span class="source-line-no">2155</span><span id="line-2155">  public void addObserverErrorHandler( @Nonnull final ObserverErrorHandler handler )</span>
<span class="source-line-no">2156</span><span id="line-2156">  {</span>
<span class="source-line-no">2157</span><span id="line-2157">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2158</span><span id="line-2158">    {</span>
<span class="source-line-no">2159</span><span id="line-2159">      invariant( Arez::areObserverErrorHandlersEnabled,</span>
<span class="source-line-no">2160</span><span id="line-2160">                 () -&gt; "Arez-0182: ArezContext.addObserverErrorHandler() invoked when Arez.areObserverErrorHandlersEnabled() returns false." );</span>
<span class="source-line-no">2161</span><span id="line-2161">    }</span>
<span class="source-line-no">2162</span><span id="line-2162">    getObserverErrorHandlerSupport().addObserverErrorHandler( handler );</span>
<span class="source-line-no">2163</span><span id="line-2163">  }</span>
<span class="source-line-no">2164</span><span id="line-2164"></span>
<span class="source-line-no">2165</span><span id="line-2165">  /**</span>
<span class="source-line-no">2166</span><span id="line-2166">   * Remove error handler from list of existing error handlers.</span>
<span class="source-line-no">2167</span><span id="line-2167">   * The handler should already be in the list. This method should NOT be called if</span>
<span class="source-line-no">2168</span><span id="line-2168">   * {@link Arez#areObserverErrorHandlersEnabled()} returns false.</span>
<span class="source-line-no">2169</span><span id="line-2169">   *</span>
<span class="source-line-no">2170</span><span id="line-2170">   * @param handler the error handler.</span>
<span class="source-line-no">2171</span><span id="line-2171">   */</span>
<span class="source-line-no">2172</span><span id="line-2172">  @OmitSymbol( unless = "arez.enable_observer_error_handlers" )</span>
<span class="source-line-no">2173</span><span id="line-2173">  public void removeObserverErrorHandler( @Nonnull final ObserverErrorHandler handler )</span>
<span class="source-line-no">2174</span><span id="line-2174">  {</span>
<span class="source-line-no">2175</span><span id="line-2175">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2176</span><span id="line-2176">    {</span>
<span class="source-line-no">2177</span><span id="line-2177">      invariant( Arez::areObserverErrorHandlersEnabled,</span>
<span class="source-line-no">2178</span><span id="line-2178">                 () -&gt; "Arez-0181: ArezContext.removeObserverErrorHandler() invoked when Arez.areObserverErrorHandlersEnabled() returns false." );</span>
<span class="source-line-no">2179</span><span id="line-2179">    }</span>
<span class="source-line-no">2180</span><span id="line-2180">    getObserverErrorHandlerSupport().removeObserverErrorHandler( handler );</span>
<span class="source-line-no">2181</span><span id="line-2181">  }</span>
<span class="source-line-no">2182</span><span id="line-2182"></span>
<span class="source-line-no">2183</span><span id="line-2183">  /**</span>
<span class="source-line-no">2184</span><span id="line-2184">   * Report an error in observer.</span>
<span class="source-line-no">2185</span><span id="line-2185">   *</span>
<span class="source-line-no">2186</span><span id="line-2186">   * @param observer  the observer that generated error.</span>
<span class="source-line-no">2187</span><span id="line-2187">   * @param error     the type of the error.</span>
<span class="source-line-no">2188</span><span id="line-2188">   * @param throwable the exception that caused error if any.</span>
<span class="source-line-no">2189</span><span id="line-2189">   */</span>
<span class="source-line-no">2190</span><span id="line-2190">  void reportObserverError( @Nonnull final Observer observer,</span>
<span class="source-line-no">2191</span><span id="line-2191">                            @Nonnull final ObserverError error,</span>
<span class="source-line-no">2192</span><span id="line-2192">                            @Nullable final Throwable throwable )</span>
<span class="source-line-no">2193</span><span id="line-2193">  {</span>
<span class="source-line-no">2194</span><span id="line-2194">    if ( willPropagateSpyEvents() )</span>
<span class="source-line-no">2195</span><span id="line-2195">    {</span>
<span class="source-line-no">2196</span><span id="line-2196">      getSpy().reportSpyEvent( new ObserverErrorEvent( observer.asInfo(), error, throwable ) );</span>
<span class="source-line-no">2197</span><span id="line-2197">    }</span>
<span class="source-line-no">2198</span><span id="line-2198">    if ( Arez.areObserverErrorHandlersEnabled() )</span>
<span class="source-line-no">2199</span><span id="line-2199">    {</span>
<span class="source-line-no">2200</span><span id="line-2200">      getObserverErrorHandlerSupport().onObserverError( observer, error, throwable );</span>
<span class="source-line-no">2201</span><span id="line-2201">    }</span>
<span class="source-line-no">2202</span><span id="line-2202">  }</span>
<span class="source-line-no">2203</span><span id="line-2203"></span>
<span class="source-line-no">2204</span><span id="line-2204">  /**</span>
<span class="source-line-no">2205</span><span id="line-2205">   * Return true if spy events will be propagated.</span>
<span class="source-line-no">2206</span><span id="line-2206">   * This means spies are enabled and there is at least one spy event handler present.</span>
<span class="source-line-no">2207</span><span id="line-2207">   *</span>
<span class="source-line-no">2208</span><span id="line-2208">   * @return true if spy events will be propagated, false otherwise.</span>
<span class="source-line-no">2209</span><span id="line-2209">   */</span>
<span class="source-line-no">2210</span><span id="line-2210">  boolean willPropagateSpyEvents()</span>
<span class="source-line-no">2211</span><span id="line-2211">  {</span>
<span class="source-line-no">2212</span><span id="line-2212">    return Arez.areSpiesEnabled() &amp;&amp; getSpy().willPropagateSpyEvents();</span>
<span class="source-line-no">2213</span><span id="line-2213">  }</span>
<span class="source-line-no">2214</span><span id="line-2214"></span>
<span class="source-line-no">2215</span><span id="line-2215">  /**</span>
<span class="source-line-no">2216</span><span id="line-2216">   * Return the spy associated with context.</span>
<span class="source-line-no">2217</span><span id="line-2217">   * This method should not be invoked unless {@link Arez#areSpiesEnabled()} returns true.</span>
<span class="source-line-no">2218</span><span id="line-2218">   *</span>
<span class="source-line-no">2219</span><span id="line-2219">   * @return the spy associated with context.</span>
<span class="source-line-no">2220</span><span id="line-2220">   */</span>
<span class="source-line-no">2221</span><span id="line-2221">  @Nonnull</span>
<span class="source-line-no">2222</span><span id="line-2222">  public Spy getSpy()</span>
<span class="source-line-no">2223</span><span id="line-2223">  {</span>
<span class="source-line-no">2224</span><span id="line-2224">    if ( Arez.shouldCheckApiInvariants() )</span>
<span class="source-line-no">2225</span><span id="line-2225">    {</span>
<span class="source-line-no">2226</span><span id="line-2226">      apiInvariant( Arez::areSpiesEnabled, () -&gt; "Arez-0021: Attempting to get Spy but spies are not enabled." );</span>
<span class="source-line-no">2227</span><span id="line-2227">    }</span>
<span class="source-line-no">2228</span><span id="line-2228">    assert null != _spy;</span>
<span class="source-line-no">2229</span><span id="line-2229">    return _spy;</span>
<span class="source-line-no">2230</span><span id="line-2230">  }</span>
<span class="source-line-no">2231</span><span id="line-2231"></span>
<span class="source-line-no">2232</span><span id="line-2232">  /**</span>
<span class="source-line-no">2233</span><span id="line-2233">   * Return the task queue associated with the context.</span>
<span class="source-line-no">2234</span><span id="line-2234">   *</span>
<span class="source-line-no">2235</span><span id="line-2235">   * @return the task queue associated with the context.</span>
<span class="source-line-no">2236</span><span id="line-2236">   */</span>
<span class="source-line-no">2237</span><span id="line-2237">  @Nonnull</span>
<span class="source-line-no">2238</span><span id="line-2238">  TaskQueue getTaskQueue()</span>
<span class="source-line-no">2239</span><span id="line-2239">  {</span>
<span class="source-line-no">2240</span><span id="line-2240">    return _taskQueue;</span>
<span class="source-line-no">2241</span><span id="line-2241">  }</span>
<span class="source-line-no">2242</span><span id="line-2242"></span>
<span class="source-line-no">2243</span><span id="line-2243">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2244</span><span id="line-2244">  void registerObservableValue( @Nonnull final ObservableValue&lt;?&gt; observableValue )</span>
<span class="source-line-no">2245</span><span id="line-2245">  {</span>
<span class="source-line-no">2246</span><span id="line-2246">    final String name = observableValue.getName();</span>
<span class="source-line-no">2247</span><span id="line-2247">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2248</span><span id="line-2248">    {</span>
<span class="source-line-no">2249</span><span id="line-2249">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2250</span><span id="line-2250">                 () -&gt; "Arez-0022: ArezContext.registerObservableValue invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2251</span><span id="line-2251">      assert null != _observableValues;</span>
<span class="source-line-no">2252</span><span id="line-2252">      invariant( () -&gt; !_observableValues.containsKey( name ),</span>
<span class="source-line-no">2253</span><span id="line-2253">                 () -&gt; "Arez-0023: ArezContext.registerObservableValue invoked with observableValue named '" + name +</span>
<span class="source-line-no">2254</span><span id="line-2254">                       "' but an existing observableValue with that name is already registered." );</span>
<span class="source-line-no">2255</span><span id="line-2255">    }</span>
<span class="source-line-no">2256</span><span id="line-2256">    assert null != _observableValues;</span>
<span class="source-line-no">2257</span><span id="line-2257">    _observableValues.put( name, observableValue );</span>
<span class="source-line-no">2258</span><span id="line-2258">  }</span>
<span class="source-line-no">2259</span><span id="line-2259"></span>
<span class="source-line-no">2260</span><span id="line-2260">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2261</span><span id="line-2261">  void deregisterObservableValue( @Nonnull final ObservableValue&lt;?&gt; observableValue )</span>
<span class="source-line-no">2262</span><span id="line-2262">  {</span>
<span class="source-line-no">2263</span><span id="line-2263">    final String name = observableValue.getName();</span>
<span class="source-line-no">2264</span><span id="line-2264">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2265</span><span id="line-2265">    {</span>
<span class="source-line-no">2266</span><span id="line-2266">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2267</span><span id="line-2267">                 () -&gt; "Arez-0024: ArezContext.deregisterObservableValue invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2268</span><span id="line-2268">      assert null != _observableValues;</span>
<span class="source-line-no">2269</span><span id="line-2269">      invariant( () -&gt; _observableValues.containsKey( name ),</span>
<span class="source-line-no">2270</span><span id="line-2270">                 () -&gt; "Arez-0025: ArezContext.deregisterObservableValue invoked with observableValue named '" + name +</span>
<span class="source-line-no">2271</span><span id="line-2271">                       "' but no observableValue with that name is registered." );</span>
<span class="source-line-no">2272</span><span id="line-2272">    }</span>
<span class="source-line-no">2273</span><span id="line-2273">    assert null != _observableValues;</span>
<span class="source-line-no">2274</span><span id="line-2274">    _observableValues.remove( name );</span>
<span class="source-line-no">2275</span><span id="line-2275">  }</span>
<span class="source-line-no">2276</span><span id="line-2276"></span>
<span class="source-line-no">2277</span><span id="line-2277">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2278</span><span id="line-2278">  @Nonnull</span>
<span class="source-line-no">2279</span><span id="line-2279">  Map&lt;String, ObservableValue&lt;?&gt;&gt; getTopLevelObservables()</span>
<span class="source-line-no">2280</span><span id="line-2280">  {</span>
<span class="source-line-no">2281</span><span id="line-2281">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2282</span><span id="line-2282">    {</span>
<span class="source-line-no">2283</span><span id="line-2283">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2284</span><span id="line-2284">                 () -&gt; "Arez-0026: ArezContext.getTopLevelObservables() invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2285</span><span id="line-2285">    }</span>
<span class="source-line-no">2286</span><span id="line-2286">    assert null != _observableValues;</span>
<span class="source-line-no">2287</span><span id="line-2287">    return _observableValues;</span>
<span class="source-line-no">2288</span><span id="line-2288">  }</span>
<span class="source-line-no">2289</span><span id="line-2289"></span>
<span class="source-line-no">2290</span><span id="line-2290">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2291</span><span id="line-2291">  void registerObserver( @Nonnull final Observer observer )</span>
<span class="source-line-no">2292</span><span id="line-2292">  {</span>
<span class="source-line-no">2293</span><span id="line-2293">    final String name = observer.getName();</span>
<span class="source-line-no">2294</span><span id="line-2294">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2295</span><span id="line-2295">    {</span>
<span class="source-line-no">2296</span><span id="line-2296">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2297</span><span id="line-2297">                 () -&gt; "Arez-0027: ArezContext.registerObserver invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2298</span><span id="line-2298">      assert null != _observers;</span>
<span class="source-line-no">2299</span><span id="line-2299">      invariant( () -&gt; !_observers.containsKey( name ),</span>
<span class="source-line-no">2300</span><span id="line-2300">                 () -&gt; "Arez-0028: ArezContext.registerObserver invoked with observer named '" + name +</span>
<span class="source-line-no">2301</span><span id="line-2301">                       "' but an existing observer with that name is already registered." );</span>
<span class="source-line-no">2302</span><span id="line-2302">    }</span>
<span class="source-line-no">2303</span><span id="line-2303">    assert null != _observers;</span>
<span class="source-line-no">2304</span><span id="line-2304">    _observers.put( name, observer );</span>
<span class="source-line-no">2305</span><span id="line-2305">  }</span>
<span class="source-line-no">2306</span><span id="line-2306"></span>
<span class="source-line-no">2307</span><span id="line-2307">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2308</span><span id="line-2308">  void deregisterObserver( @Nonnull final Observer observer )</span>
<span class="source-line-no">2309</span><span id="line-2309">  {</span>
<span class="source-line-no">2310</span><span id="line-2310">    final String name = observer.getName();</span>
<span class="source-line-no">2311</span><span id="line-2311">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2312</span><span id="line-2312">    {</span>
<span class="source-line-no">2313</span><span id="line-2313">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2314</span><span id="line-2314">                 () -&gt; "Arez-0029: ArezContext.deregisterObserver invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2315</span><span id="line-2315">      assert null != _observers;</span>
<span class="source-line-no">2316</span><span id="line-2316">      invariant( () -&gt; _observers.containsKey( name ),</span>
<span class="source-line-no">2317</span><span id="line-2317">                 () -&gt; "Arez-0030: ArezContext.deregisterObserver invoked with observer named '" + name +</span>
<span class="source-line-no">2318</span><span id="line-2318">                       "' but no observer with that name is registered." );</span>
<span class="source-line-no">2319</span><span id="line-2319">    }</span>
<span class="source-line-no">2320</span><span id="line-2320">    assert null != _observers;</span>
<span class="source-line-no">2321</span><span id="line-2321">    _observers.remove( name );</span>
<span class="source-line-no">2322</span><span id="line-2322">  }</span>
<span class="source-line-no">2323</span><span id="line-2323"></span>
<span class="source-line-no">2324</span><span id="line-2324">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2325</span><span id="line-2325">  @Nonnull</span>
<span class="source-line-no">2326</span><span id="line-2326">  Map&lt;String, Observer&gt; getTopLevelObservers()</span>
<span class="source-line-no">2327</span><span id="line-2327">  {</span>
<span class="source-line-no">2328</span><span id="line-2328">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2329</span><span id="line-2329">    {</span>
<span class="source-line-no">2330</span><span id="line-2330">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2331</span><span id="line-2331">                 () -&gt; "Arez-0031: ArezContext.getTopLevelObservers() invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2332</span><span id="line-2332">    }</span>
<span class="source-line-no">2333</span><span id="line-2333">    assert null != _observers;</span>
<span class="source-line-no">2334</span><span id="line-2334">    return _observers;</span>
<span class="source-line-no">2335</span><span id="line-2335">  }</span>
<span class="source-line-no">2336</span><span id="line-2336"></span>
<span class="source-line-no">2337</span><span id="line-2337">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2338</span><span id="line-2338">  void registerComputableValue( @Nonnull final ComputableValue&lt;?&gt; computableValue )</span>
<span class="source-line-no">2339</span><span id="line-2339">  {</span>
<span class="source-line-no">2340</span><span id="line-2340">    final String name = computableValue.getName();</span>
<span class="source-line-no">2341</span><span id="line-2341">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2342</span><span id="line-2342">    {</span>
<span class="source-line-no">2343</span><span id="line-2343">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2344</span><span id="line-2344">                 () -&gt; "Arez-0032: ArezContext.registerComputableValue invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2345</span><span id="line-2345">      assert null != _computableValues;</span>
<span class="source-line-no">2346</span><span id="line-2346">      invariant( () -&gt; !_computableValues.containsKey( name ),</span>
<span class="source-line-no">2347</span><span id="line-2347">                 () -&gt; "Arez-0033: ArezContext.registerComputableValue invoked with ComputableValue named '" + name +</span>
<span class="source-line-no">2348</span><span id="line-2348">                       "' but an existing ComputableValue with that name is already registered." );</span>
<span class="source-line-no">2349</span><span id="line-2349">    }</span>
<span class="source-line-no">2350</span><span id="line-2350">    assert null != _computableValues;</span>
<span class="source-line-no">2351</span><span id="line-2351">    _computableValues.put( name, computableValue );</span>
<span class="source-line-no">2352</span><span id="line-2352">  }</span>
<span class="source-line-no">2353</span><span id="line-2353"></span>
<span class="source-line-no">2354</span><span id="line-2354">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2355</span><span id="line-2355">  void deregisterComputableValue( @Nonnull final ComputableValue&lt;?&gt; computableValue )</span>
<span class="source-line-no">2356</span><span id="line-2356">  {</span>
<span class="source-line-no">2357</span><span id="line-2357">    final String name = computableValue.getName();</span>
<span class="source-line-no">2358</span><span id="line-2358">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2359</span><span id="line-2359">    {</span>
<span class="source-line-no">2360</span><span id="line-2360">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2361</span><span id="line-2361">                 () -&gt; "Arez-0034: ArezContext.deregisterComputableValue invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2362</span><span id="line-2362">      assert null != _computableValues;</span>
<span class="source-line-no">2363</span><span id="line-2363">      invariant( () -&gt; _computableValues.containsKey( name ),</span>
<span class="source-line-no">2364</span><span id="line-2364">                 () -&gt; "Arez-0035: ArezContext.deregisterComputableValue invoked with ComputableValue named '" + name +</span>
<span class="source-line-no">2365</span><span id="line-2365">                       "' but no ComputableValue with that name is registered." );</span>
<span class="source-line-no">2366</span><span id="line-2366">    }</span>
<span class="source-line-no">2367</span><span id="line-2367">    assert null != _computableValues;</span>
<span class="source-line-no">2368</span><span id="line-2368">    _computableValues.remove( name );</span>
<span class="source-line-no">2369</span><span id="line-2369">  }</span>
<span class="source-line-no">2370</span><span id="line-2370"></span>
<span class="source-line-no">2371</span><span id="line-2371">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2372</span><span id="line-2372">  @Nonnull</span>
<span class="source-line-no">2373</span><span id="line-2373">  Map&lt;String, ComputableValue&lt;?&gt;&gt; getTopLevelComputableValues()</span>
<span class="source-line-no">2374</span><span id="line-2374">  {</span>
<span class="source-line-no">2375</span><span id="line-2375">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2376</span><span id="line-2376">    {</span>
<span class="source-line-no">2377</span><span id="line-2377">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2378</span><span id="line-2378">                 () -&gt; "Arez-0036: ArezContext.getTopLevelComputableValues() invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2379</span><span id="line-2379">    }</span>
<span class="source-line-no">2380</span><span id="line-2380">    assert null != _computableValues;</span>
<span class="source-line-no">2381</span><span id="line-2381">    return _computableValues;</span>
<span class="source-line-no">2382</span><span id="line-2382">  }</span>
<span class="source-line-no">2383</span><span id="line-2383"></span>
<span class="source-line-no">2384</span><span id="line-2384">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2385</span><span id="line-2385">  void registerTask( @Nonnull final Task task )</span>
<span class="source-line-no">2386</span><span id="line-2386">  {</span>
<span class="source-line-no">2387</span><span id="line-2387">    final String name = task.getName();</span>
<span class="source-line-no">2388</span><span id="line-2388">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2389</span><span id="line-2389">    {</span>
<span class="source-line-no">2390</span><span id="line-2390">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2391</span><span id="line-2391">                 () -&gt; "Arez-0214: ArezContext.registerTask invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2392</span><span id="line-2392">      assert null != _tasks;</span>
<span class="source-line-no">2393</span><span id="line-2393">      invariant( () -&gt; !_tasks.containsKey( name ),</span>
<span class="source-line-no">2394</span><span id="line-2394">                 () -&gt; "Arez-0225: ArezContext.registerTask invoked with Task named '" + name +</span>
<span class="source-line-no">2395</span><span id="line-2395">                       "' but an existing Task with that name is already registered." );</span>
<span class="source-line-no">2396</span><span id="line-2396">    }</span>
<span class="source-line-no">2397</span><span id="line-2397">    assert null != _tasks;</span>
<span class="source-line-no">2398</span><span id="line-2398">    _tasks.put( name, task );</span>
<span class="source-line-no">2399</span><span id="line-2399">  }</span>
<span class="source-line-no">2400</span><span id="line-2400"></span>
<span class="source-line-no">2401</span><span id="line-2401">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2402</span><span id="line-2402">  void deregisterTask( @Nonnull final Task task )</span>
<span class="source-line-no">2403</span><span id="line-2403">  {</span>
<span class="source-line-no">2404</span><span id="line-2404">    final String name = task.getName();</span>
<span class="source-line-no">2405</span><span id="line-2405">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2406</span><span id="line-2406">    {</span>
<span class="source-line-no">2407</span><span id="line-2407">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2408</span><span id="line-2408">                 () -&gt; "Arez-0226: ArezContext.deregisterTask invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2409</span><span id="line-2409">      assert null != _tasks;</span>
<span class="source-line-no">2410</span><span id="line-2410">      invariant( () -&gt; _tasks.containsKey( name ),</span>
<span class="source-line-no">2411</span><span id="line-2411">                 () -&gt; "Arez-0227: ArezContext.deregisterTask invoked with Task named '" + name +</span>
<span class="source-line-no">2412</span><span id="line-2412">                       "' but no Task with that name is registered." );</span>
<span class="source-line-no">2413</span><span id="line-2413">    }</span>
<span class="source-line-no">2414</span><span id="line-2414">    assert null != _tasks;</span>
<span class="source-line-no">2415</span><span id="line-2415">    _tasks.remove( name );</span>
<span class="source-line-no">2416</span><span id="line-2416">  }</span>
<span class="source-line-no">2417</span><span id="line-2417"></span>
<span class="source-line-no">2418</span><span id="line-2418">  @OmitSymbol( unless = "arez.enable_registries" )</span>
<span class="source-line-no">2419</span><span id="line-2419">  @Nonnull</span>
<span class="source-line-no">2420</span><span id="line-2420">  Map&lt;String, Task&gt; getTopLevelTasks()</span>
<span class="source-line-no">2421</span><span id="line-2421">  {</span>
<span class="source-line-no">2422</span><span id="line-2422">    if ( Arez.shouldCheckInvariants() )</span>
<span class="source-line-no">2423</span><span id="line-2423">    {</span>
<span class="source-line-no">2424</span><span id="line-2424">      invariant( Arez::areRegistriesEnabled,</span>
<span class="source-line-no">2425</span><span id="line-2425">                 () -&gt; "Arez-0228: ArezContext.getTopLevelTasks() invoked when Arez.areRegistriesEnabled() returns false." );</span>
<span class="source-line-no">2426</span><span id="line-2426">    }</span>
<span class="source-line-no">2427</span><span id="line-2427">    assert null != _tasks;</span>
<span class="source-line-no">2428</span><span id="line-2428">    return _tasks;</span>
<span class="source-line-no">2429</span><span id="line-2429">  }</span>
<span class="source-line-no">2430</span><span id="line-2430"></span>
<span class="source-line-no">2431</span><span id="line-2431">  @Nonnull</span>
<span class="source-line-no">2432</span><span id="line-2432">  Zone getZone()</span>
<span class="source-line-no">2433</span><span id="line-2433">  {</span>
<span class="source-line-no">2434</span><span id="line-2434">    assert null != _zone;</span>
<span class="source-line-no">2435</span><span id="line-2435">    return _zone;</span>
<span class="source-line-no">2436</span><span id="line-2436">  }</span>
<span class="source-line-no">2437</span><span id="line-2437"></span>
<span class="source-line-no">2438</span><span id="line-2438">  @OmitSymbol( unless = "arez.enable_observer_error_handlers" )</span>
<span class="source-line-no">2439</span><span id="line-2439">  @Nonnull</span>
<span class="source-line-no">2440</span><span id="line-2440">  ObserverErrorHandlerSupport getObserverErrorHandlerSupport()</span>
<span class="source-line-no">2441</span><span id="line-2441">  {</span>
<span class="source-line-no">2442</span><span id="line-2442">    assert null != _observerErrorHandlerSupport;</span>
<span class="source-line-no">2443</span><span id="line-2443">    return _observerErrorHandlerSupport;</span>
<span class="source-line-no">2444</span><span id="line-2444">  }</span>
<span class="source-line-no">2445</span><span id="line-2445"></span>
<span class="source-line-no">2446</span><span id="line-2446">  @Nullable</span>
<span class="source-line-no">2447</span><span id="line-2447">  private String observerToName( @Nonnull final Observer observer )</span>
<span class="source-line-no">2448</span><span id="line-2448">  {</span>
<span class="source-line-no">2449</span><span id="line-2449">    return Arez.areNamesEnabled() ? observer.getName() : null;</span>
<span class="source-line-no">2450</span><span id="line-2450">  }</span>
<span class="source-line-no">2451</span><span id="line-2451"></span>
<span class="source-line-no">2452</span><span id="line-2452">  private int trackerObserveFlags( @Nonnull final Observer observer )</span>
<span class="source-line-no">2453</span><span id="line-2453">  {</span>
<span class="source-line-no">2454</span><span id="line-2454">    return Transaction.Flags.REQUIRE_NEW_TRANSACTION |</span>
<span class="source-line-no">2455</span><span id="line-2455">           ( Arez.shouldCheckInvariants() ?</span>
<span class="source-line-no">2456</span><span id="line-2456">             observer.areArezDependenciesRequired() ?</span>
<span class="source-line-no">2457</span><span id="line-2457">             Observer.Flags.AREZ_DEPENDENCIES :</span>
<span class="source-line-no">2458</span><span id="line-2458">             Observer.Flags.AREZ_OR_NO_DEPENDENCIES :</span>
<span class="source-line-no">2459</span><span id="line-2459">             0 ) |</span>
<span class="source-line-no">2460</span><span id="line-2460">           ( Arez.areSpiesEnabled() &amp;&amp; observer.noReportResults() ? Observer.Flags.NO_REPORT_RESULT : 0 ) |</span>
<span class="source-line-no">2461</span><span id="line-2461">           ( Arez.shouldEnforceTransactionType() ?</span>
<span class="source-line-no">2462</span><span id="line-2462">             ( observer.isMutation() ? Observer.Flags.READ_WRITE : Observer.Flags.READ_ONLY ) :</span>
<span class="source-line-no">2463</span><span id="line-2463">             0 );</span>
<span class="source-line-no">2464</span><span id="line-2464">  }</span>
<span class="source-line-no">2465</span><span id="line-2465"></span>
<span class="source-line-no">2466</span><span id="line-2466">  private void reportActionStarted( @Nullable final String name,</span>
<span class="source-line-no">2467</span><span id="line-2467">                                    @Nullable final Object[] parameters,</span>
<span class="source-line-no">2468</span><span id="line-2468">                                    final boolean observed )</span>
<span class="source-line-no">2469</span><span id="line-2469">  {</span>
<span class="source-line-no">2470</span><span id="line-2470">    assert null != name;</span>
<span class="source-line-no">2471</span><span id="line-2471">    final Object[] params = null == parameters ? new Object[ 0 ] : parameters;</span>
<span class="source-line-no">2472</span><span id="line-2472">    getSpy().reportSpyEvent( new ActionStartEvent( name, observed, params ) );</span>
<span class="source-line-no">2473</span><span id="line-2473">  }</span>
<span class="source-line-no">2474</span><span id="line-2474"></span>
<span class="source-line-no">2475</span><span id="line-2475">  private void reportActionCompleted( @Nullable final String name,</span>
<span class="source-line-no">2476</span><span id="line-2476">                                      @Nullable final Object[] parameters,</span>
<span class="source-line-no">2477</span><span id="line-2477">                                      final boolean observed,</span>
<span class="source-line-no">2478</span><span id="line-2478">                                      final Throwable t,</span>
<span class="source-line-no">2479</span><span id="line-2479">                                      final long startedAt,</span>
<span class="source-line-no">2480</span><span id="line-2480">                                      final boolean returnsResult,</span>
<span class="source-line-no">2481</span><span id="line-2481">                                      final Object result )</span>
<span class="source-line-no">2482</span><span id="line-2482">  {</span>
<span class="source-line-no">2483</span><span id="line-2483">    final long duration = System.currentTimeMillis() - startedAt;</span>
<span class="source-line-no">2484</span><span id="line-2484">    assert null != name;</span>
<span class="source-line-no">2485</span><span id="line-2485">    final Object[] params = null == parameters ? new Object[ 0 ] : parameters;</span>
<span class="source-line-no">2486</span><span id="line-2486">    getSpy().reportSpyEvent( new ActionCompleteEvent( name,</span>
<span class="source-line-no">2487</span><span id="line-2487">                                                      observed,</span>
<span class="source-line-no">2488</span><span id="line-2488">                                                      params,</span>
<span class="source-line-no">2489</span><span id="line-2489">                                                      returnsResult,</span>
<span class="source-line-no">2490</span><span id="line-2490">                                                      result,</span>
<span class="source-line-no">2491</span><span id="line-2491">                                                      t,</span>
<span class="source-line-no">2492</span><span id="line-2492">                                                      (int) duration ) );</span>
<span class="source-line-no">2493</span><span id="line-2493">  }</span>
<span class="source-line-no">2494</span><span id="line-2494"></span>
<span class="source-line-no">2495</span><span id="line-2495">  @OmitSymbol</span>
<span class="source-line-no">2496</span><span id="line-2496">  int currentNextTransactionId()</span>
<span class="source-line-no">2497</span><span id="line-2497">  {</span>
<span class="source-line-no">2498</span><span id="line-2498">    return _nextTransactionId;</span>
<span class="source-line-no">2499</span><span id="line-2499">  }</span>
<span class="source-line-no">2500</span><span id="line-2500"></span>
<span class="source-line-no">2501</span><span id="line-2501">  @OmitSymbol</span>
<span class="source-line-no">2502</span><span id="line-2502">  void setNextNodeId( final int nextNodeId )</span>
<span class="source-line-no">2503</span><span id="line-2503">  {</span>
<span class="source-line-no">2504</span><span id="line-2504">    _nextNodeId = nextNodeId;</span>
<span class="source-line-no">2505</span><span id="line-2505">  }</span>
<span class="source-line-no">2506</span><span id="line-2506"></span>
<span class="source-line-no">2507</span><span id="line-2507">  @OmitSymbol</span>
<span class="source-line-no">2508</span><span id="line-2508">  int getNextNodeId()</span>
<span class="source-line-no">2509</span><span id="line-2509">  {</span>
<span class="source-line-no">2510</span><span id="line-2510">    return _nextNodeId;</span>
<span class="source-line-no">2511</span><span id="line-2511">  }</span>
<span class="source-line-no">2512</span><span id="line-2512"></span>
<span class="source-line-no">2513</span><span id="line-2513">  @OmitSymbol</span>
<span class="source-line-no">2514</span><span id="line-2514">  int getSchedulerLockCount()</span>
<span class="source-line-no">2515</span><span id="line-2515">  {</span>
<span class="source-line-no">2516</span><span id="line-2516">    return _schedulerLockCount;</span>
<span class="source-line-no">2517</span><span id="line-2517">  }</span>
<span class="source-line-no">2518</span><span id="line-2518"></span>
<span class="source-line-no">2519</span><span id="line-2519">  @SuppressWarnings( "SameParameterValue" )</span>
<span class="source-line-no">2520</span><span id="line-2520">  @OmitSymbol</span>
<span class="source-line-no">2521</span><span id="line-2521">  void setSchedulerLockCount( final int schedulerLockCount )</span>
<span class="source-line-no">2522</span><span id="line-2522">  {</span>
<span class="source-line-no">2523</span><span id="line-2523">    _schedulerLockCount = schedulerLockCount;</span>
<span class="source-line-no">2524</span><span id="line-2524">  }</span>
<span class="source-line-no">2525</span><span id="line-2525"></span>
<span class="source-line-no">2526</span><span id="line-2526">  @OmitSymbol</span>
<span class="source-line-no">2527</span><span id="line-2527">  void markSchedulerAsActive()</span>
<span class="source-line-no">2528</span><span id="line-2528">  {</span>
<span class="source-line-no">2529</span><span id="line-2529">    _schedulerActive = true;</span>
<span class="source-line-no">2530</span><span id="line-2530">  }</span>
<span class="source-line-no">2531</span><span id="line-2531">}</span>




























































</pre>
</div>
</main>
</body>
</html>
