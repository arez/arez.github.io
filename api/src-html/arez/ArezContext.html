<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>package arez;<a name="line.1"></a>
<span class="sourceLineNo">002</span><a name="line.2"></a>
<span class="sourceLineNo">003</span>import arez.spy.ActionCompletedEvent;<a name="line.3"></a>
<span class="sourceLineNo">004</span>import arez.spy.ActionStartedEvent;<a name="line.4"></a>
<span class="sourceLineNo">005</span>import arez.spy.ComponentCreateStartedEvent;<a name="line.5"></a>
<span class="sourceLineNo">006</span>import arez.spy.ObservableValueCreatedEvent;<a name="line.6"></a>
<span class="sourceLineNo">007</span>import arez.spy.ObserverErrorEvent;<a name="line.7"></a>
<span class="sourceLineNo">008</span>import arez.spy.PropertyAccessor;<a name="line.8"></a>
<span class="sourceLineNo">009</span>import arez.spy.PropertyMutator;<a name="line.9"></a>
<span class="sourceLineNo">010</span>import arez.spy.ReactionScheduledEvent;<a name="line.10"></a>
<span class="sourceLineNo">011</span>import arez.spy.Spy;<a name="line.11"></a>
<span class="sourceLineNo">012</span>import java.util.Collection;<a name="line.12"></a>
<span class="sourceLineNo">013</span>import java.util.Collections;<a name="line.13"></a>
<span class="sourceLineNo">014</span>import java.util.HashMap;<a name="line.14"></a>
<span class="sourceLineNo">015</span>import java.util.Objects;<a name="line.15"></a>
<span class="sourceLineNo">016</span>import javax.annotation.Nonnull;<a name="line.16"></a>
<span class="sourceLineNo">017</span>import javax.annotation.Nullable;<a name="line.17"></a>
<span class="sourceLineNo">018</span>import static org.realityforge.braincheck.Guards.*;<a name="line.18"></a>
<span class="sourceLineNo">019</span><a name="line.19"></a>
<span class="sourceLineNo">020</span>/**<a name="line.20"></a>
<span class="sourceLineNo">021</span> * The ArezContext defines the top level container of interconnected observables and observers.<a name="line.21"></a>
<span class="sourceLineNo">022</span> * The context also provides the mechanism for creating transactions to read and write state<a name="line.22"></a>
<span class="sourceLineNo">023</span> * within the system.<a name="line.23"></a>
<span class="sourceLineNo">024</span> */<a name="line.24"></a>
<span class="sourceLineNo">025</span>@SuppressWarnings( "Duplicates" )<a name="line.25"></a>
<span class="sourceLineNo">026</span>public final class ArezContext<a name="line.26"></a>
<span class="sourceLineNo">027</span>{<a name="line.27"></a>
<span class="sourceLineNo">028</span>  /**<a name="line.28"></a>
<span class="sourceLineNo">029</span>   * Id of next node to be created.<a name="line.29"></a>
<span class="sourceLineNo">030</span>   * This is only used if {@link Arez#areNamesEnabled()} returns true but no name has been supplied.<a name="line.30"></a>
<span class="sourceLineNo">031</span>   */<a name="line.31"></a>
<span class="sourceLineNo">032</span>  private int _nextNodeId = 1;<a name="line.32"></a>
<span class="sourceLineNo">033</span>  /**<a name="line.33"></a>
<span class="sourceLineNo">034</span>   * Id of next transaction to be created.<a name="line.34"></a>
<span class="sourceLineNo">035</span>   *<a name="line.35"></a>
<span class="sourceLineNo">036</span>   * This needs to start at 1 as {@link ObservableValue#NOT_IN_CURRENT_TRACKING} is used<a name="line.36"></a>
<span class="sourceLineNo">037</span>   * to optimize dependency tracking in transactions.<a name="line.37"></a>
<span class="sourceLineNo">038</span>   */<a name="line.38"></a>
<span class="sourceLineNo">039</span>  private int _nextTransactionId = 1;<a name="line.39"></a>
<span class="sourceLineNo">040</span>  /**<a name="line.40"></a>
<span class="sourceLineNo">041</span>   * Reaction Scheduler.<a name="line.41"></a>
<span class="sourceLineNo">042</span>   * Currently hard-coded, in the future potentially configurable.<a name="line.42"></a>
<span class="sourceLineNo">043</span>   */<a name="line.43"></a>
<span class="sourceLineNo">044</span>  private final ReactionScheduler _scheduler = new ReactionScheduler( Arez.areZonesEnabled() ? this : null );<a name="line.44"></a>
<span class="sourceLineNo">045</span>  /**<a name="line.45"></a>
<span class="sourceLineNo">046</span>   * Support infrastructure for propagating observer errors.<a name="line.46"></a>
<span class="sourceLineNo">047</span>   */<a name="line.47"></a>
<span class="sourceLineNo">048</span>  @Nullable<a name="line.48"></a>
<span class="sourceLineNo">049</span>  private final ObserverErrorHandlerSupport _observerErrorHandlerSupport =<a name="line.49"></a>
<span class="sourceLineNo">050</span>    Arez.areObserverErrorHandlersEnabled() ? new ObserverErrorHandlerSupport() : null;<a name="line.50"></a>
<span class="sourceLineNo">051</span>  /**<a name="line.51"></a>
<span class="sourceLineNo">052</span>   * Support infrastructure for spy events.<a name="line.52"></a>
<span class="sourceLineNo">053</span>   */<a name="line.53"></a>
<span class="sourceLineNo">054</span>  @Nullable<a name="line.54"></a>
<span class="sourceLineNo">055</span>  private final SpyImpl _spy = Arez.areSpiesEnabled() ? new SpyImpl( Arez.areZonesEnabled() ? this : null ) : null;<a name="line.55"></a>
<span class="sourceLineNo">056</span>  /**<a name="line.56"></a>
<span class="sourceLineNo">057</span>   * Support infrastructure for components.<a name="line.57"></a>
<span class="sourceLineNo">058</span>   */<a name="line.58"></a>
<span class="sourceLineNo">059</span>  @Nullable<a name="line.59"></a>
<span class="sourceLineNo">060</span>  private final HashMap&lt;String, HashMap&lt;Object, Component&gt;&gt; _components =<a name="line.60"></a>
<span class="sourceLineNo">061</span>    Arez.areNativeComponentsEnabled() ? new HashMap&lt;&gt;() : null;<a name="line.61"></a>
<span class="sourceLineNo">062</span>  /**<a name="line.62"></a>
<span class="sourceLineNo">063</span>   * Registry of top level observables.<a name="line.63"></a>
<span class="sourceLineNo">064</span>   * These are all the Observables instances not contained within a component.<a name="line.64"></a>
<span class="sourceLineNo">065</span>   */<a name="line.65"></a>
<span class="sourceLineNo">066</span>  @Nullable<a name="line.66"></a>
<span class="sourceLineNo">067</span>  private final HashMap&lt;String, ObservableValue&lt;?&gt;&gt; _observables = Arez.areRegistriesEnabled() ? new HashMap&lt;&gt;() : null;<a name="line.67"></a>
<span class="sourceLineNo">068</span>  /**<a name="line.68"></a>
<span class="sourceLineNo">069</span>   * Registry of top level computed values.<a name="line.69"></a>
<span class="sourceLineNo">070</span>   * These are all the ComputedValue instances not contained within a component.<a name="line.70"></a>
<span class="sourceLineNo">071</span>   */<a name="line.71"></a>
<span class="sourceLineNo">072</span>  @Nullable<a name="line.72"></a>
<span class="sourceLineNo">073</span>  private final HashMap&lt;String, ComputedValue&lt;?&gt;&gt; _computedValues =<a name="line.73"></a>
<span class="sourceLineNo">074</span>    Arez.areRegistriesEnabled() ? new HashMap&lt;&gt;() : null;<a name="line.74"></a>
<span class="sourceLineNo">075</span>  /**<a name="line.75"></a>
<span class="sourceLineNo">076</span>   * Registry of top level observers.<a name="line.76"></a>
<span class="sourceLineNo">077</span>   * These are all the Observer instances not contained within a component.<a name="line.77"></a>
<span class="sourceLineNo">078</span>   */<a name="line.78"></a>
<span class="sourceLineNo">079</span>  @Nullable<a name="line.79"></a>
<span class="sourceLineNo">080</span>  private final HashMap&lt;String, Observer&gt; _observers = Arez.areRegistriesEnabled() ? new HashMap&lt;&gt;() : null;<a name="line.80"></a>
<span class="sourceLineNo">081</span>  /**<a name="line.81"></a>
<span class="sourceLineNo">082</span>   * Locator used to resolve references.<a name="line.82"></a>
<span class="sourceLineNo">083</span>   */<a name="line.83"></a>
<span class="sourceLineNo">084</span>  @Nullable<a name="line.84"></a>
<span class="sourceLineNo">085</span>  private final AggregateLocator _locator = Arez.areReferencesEnabled() ? new AggregateLocator() : null;<a name="line.85"></a>
<span class="sourceLineNo">086</span>  /**<a name="line.86"></a>
<span class="sourceLineNo">087</span>   * Flag indicating whether the scheduler should run next time it is triggered.<a name="line.87"></a>
<span class="sourceLineNo">088</span>   * This should be active only when there is no uncommitted transaction for context.<a name="line.88"></a>
<span class="sourceLineNo">089</span>   */<a name="line.89"></a>
<span class="sourceLineNo">090</span>  private boolean _schedulerEnabled = true;<a name="line.90"></a>
<span class="sourceLineNo">091</span>  /**<a name="line.91"></a>
<span class="sourceLineNo">092</span>   * The number of un-released locks on the scheduler.<a name="line.92"></a>
<span class="sourceLineNo">093</span>   */<a name="line.93"></a>
<span class="sourceLineNo">094</span>  private int _schedulerLockCount;<a name="line.94"></a>
<span class="sourceLineNo">095</span>  /**<a name="line.95"></a>
<span class="sourceLineNo">096</span>   * Optional environment in which reactions are executed.<a name="line.96"></a>
<span class="sourceLineNo">097</span>   */<a name="line.97"></a>
<span class="sourceLineNo">098</span>  @Nullable<a name="line.98"></a>
<span class="sourceLineNo">099</span>  private ReactionEnvironment _environment;<a name="line.99"></a>
<span class="sourceLineNo">100</span>  /**<a name="line.100"></a>
<span class="sourceLineNo">101</span>   * Flag indicating whether the scheduler is currently active.<a name="line.101"></a>
<span class="sourceLineNo">102</span>   */<a name="line.102"></a>
<span class="sourceLineNo">103</span>  private boolean _schedulerActive;<a name="line.103"></a>
<span class="sourceLineNo">104</span><a name="line.104"></a>
<span class="sourceLineNo">105</span>  /**<a name="line.105"></a>
<span class="sourceLineNo">106</span>   * Arez context should not be created directly but only accessed via Arez.<a name="line.106"></a>
<span class="sourceLineNo">107</span>   */<a name="line.107"></a>
<span class="sourceLineNo">108</span>  ArezContext()<a name="line.108"></a>
<span class="sourceLineNo">109</span>  {<a name="line.109"></a>
<span class="sourceLineNo">110</span>  }<a name="line.110"></a>
<span class="sourceLineNo">111</span><a name="line.111"></a>
<span class="sourceLineNo">112</span>  /**<a name="line.112"></a>
<span class="sourceLineNo">113</span>   * Return the map for components of specified type.<a name="line.113"></a>
<span class="sourceLineNo">114</span>   *<a name="line.114"></a>
<span class="sourceLineNo">115</span>   * @param type the component type.<a name="line.115"></a>
<span class="sourceLineNo">116</span>   * @return the map for components of specified type.<a name="line.116"></a>
<span class="sourceLineNo">117</span>   */<a name="line.117"></a>
<span class="sourceLineNo">118</span>  @Nonnull<a name="line.118"></a>
<span class="sourceLineNo">119</span>  private HashMap&lt;Object, Component&gt; getComponentByTypeMap( @Nonnull final String type )<a name="line.119"></a>
<span class="sourceLineNo">120</span>  {<a name="line.120"></a>
<span class="sourceLineNo">121</span>    assert null != _components;<a name="line.121"></a>
<span class="sourceLineNo">122</span>    return _components.computeIfAbsent( type, t -&gt; new HashMap&lt;&gt;() );<a name="line.122"></a>
<span class="sourceLineNo">123</span>  }<a name="line.123"></a>
<span class="sourceLineNo">124</span><a name="line.124"></a>
<span class="sourceLineNo">125</span>  /**<a name="line.125"></a>
<span class="sourceLineNo">126</span>   * Return true if the component identified by type and id has been defined in context.<a name="line.126"></a>
<span class="sourceLineNo">127</span>   *<a name="line.127"></a>
<span class="sourceLineNo">128</span>   * @param type the component type.<a name="line.128"></a>
<span class="sourceLineNo">129</span>   * @param id   the component id.<a name="line.129"></a>
<span class="sourceLineNo">130</span>   * @return true if component is defined in context.<a name="line.130"></a>
<span class="sourceLineNo">131</span>   */<a name="line.131"></a>
<span class="sourceLineNo">132</span>  public boolean isComponentPresent( @Nonnull final String type, @Nonnull final Object id )<a name="line.132"></a>
<span class="sourceLineNo">133</span>  {<a name="line.133"></a>
<span class="sourceLineNo">134</span>    apiInvariant( Arez::areNativeComponentsEnabled,<a name="line.134"></a>
<span class="sourceLineNo">135</span>                  () -&gt; "Arez-0135: ArezContext.isComponentPresent() invoked when Arez.areNativeComponentsEnabled() returns false." );<a name="line.135"></a>
<span class="sourceLineNo">136</span>    return getComponentByTypeMap( type ).containsKey( id );<a name="line.136"></a>
<span class="sourceLineNo">137</span>  }<a name="line.137"></a>
<span class="sourceLineNo">138</span><a name="line.138"></a>
<span class="sourceLineNo">139</span>  /**<a name="line.139"></a>
<span class="sourceLineNo">140</span>   * Create a component with the specified parameters and return it.<a name="line.140"></a>
<span class="sourceLineNo">141</span>   * This method should only be invoked if {@link Arez#areNativeComponentsEnabled()} returns true.<a name="line.141"></a>
<span class="sourceLineNo">142</span>   * This method should not be invoked if {@link #isComponentPresent(String, Object)} returns true for<a name="line.142"></a>
<span class="sourceLineNo">143</span>   * the parameters. The caller should invoke {@link Component#complete()} on the returned component as<a name="line.143"></a>
<span class="sourceLineNo">144</span>   * soon as the component definition has completed.<a name="line.144"></a>
<span class="sourceLineNo">145</span>   *<a name="line.145"></a>
<span class="sourceLineNo">146</span>   * @param type the component type.<a name="line.146"></a>
<span class="sourceLineNo">147</span>   * @param id   the component id.<a name="line.147"></a>
<span class="sourceLineNo">148</span>   * @return true if component is defined in context.<a name="line.148"></a>
<span class="sourceLineNo">149</span>   */<a name="line.149"></a>
<span class="sourceLineNo">150</span>  @Nonnull<a name="line.150"></a>
<span class="sourceLineNo">151</span>  public Component component( @Nonnull final String type, @Nonnull final Object id )<a name="line.151"></a>
<span class="sourceLineNo">152</span>  {<a name="line.152"></a>
<span class="sourceLineNo">153</span>    return component( type, id, Arez.areNamesEnabled() ? type + "@" + id : null );<a name="line.153"></a>
<span class="sourceLineNo">154</span>  }<a name="line.154"></a>
<span class="sourceLineNo">155</span><a name="line.155"></a>
<span class="sourceLineNo">156</span>  /**<a name="line.156"></a>
<span class="sourceLineNo">157</span>   * Create a component with the specified parameters and return it.<a name="line.157"></a>
<span class="sourceLineNo">158</span>   * This method should only be invoked if {@link Arez#areNativeComponentsEnabled()} returns true.<a name="line.158"></a>
<span class="sourceLineNo">159</span>   * This method should not be invoked if {@link #isComponentPresent(String, Object)} returns true for<a name="line.159"></a>
<span class="sourceLineNo">160</span>   * the parameters. The caller should invoke {@link Component#complete()} on the returned component as<a name="line.160"></a>
<span class="sourceLineNo">161</span>   * soon as the component definition has completed.<a name="line.161"></a>
<span class="sourceLineNo">162</span>   *<a name="line.162"></a>
<span class="sourceLineNo">163</span>   * @param type the component type.<a name="line.163"></a>
<span class="sourceLineNo">164</span>   * @param id   the component id.<a name="line.164"></a>
<span class="sourceLineNo">165</span>   * @param name the name of the component. Should be null if {@link Arez#areNamesEnabled()} returns false.<a name="line.165"></a>
<span class="sourceLineNo">166</span>   * @return true if component is defined in context.<a name="line.166"></a>
<span class="sourceLineNo">167</span>   */<a name="line.167"></a>
<span class="sourceLineNo">168</span>  @Nonnull<a name="line.168"></a>
<span class="sourceLineNo">169</span>  public Component component( @Nonnull final String type, @Nonnull final Object id, @Nullable final String name )<a name="line.169"></a>
<span class="sourceLineNo">170</span>  {<a name="line.170"></a>
<span class="sourceLineNo">171</span>    return component( type, id, name, null );<a name="line.171"></a>
<span class="sourceLineNo">172</span>  }<a name="line.172"></a>
<span class="sourceLineNo">173</span><a name="line.173"></a>
<span class="sourceLineNo">174</span>  /**<a name="line.174"></a>
<span class="sourceLineNo">175</span>   * Create a component with the specified parameters and return it.<a name="line.175"></a>
<span class="sourceLineNo">176</span>   * This method should only be invoked if {@link Arez#areNativeComponentsEnabled()} returns true.<a name="line.176"></a>
<span class="sourceLineNo">177</span>   * This method should not be invoked if {@link #isComponentPresent(String, Object)} returns true for<a name="line.177"></a>
<span class="sourceLineNo">178</span>   * the parameters. The caller should invoke {@link Component#complete()} on the returned component as<a name="line.178"></a>
<span class="sourceLineNo">179</span>   * soon as the component definition has completed.<a name="line.179"></a>
<span class="sourceLineNo">180</span>   *<a name="line.180"></a>
<span class="sourceLineNo">181</span>   * @param type       the component type.<a name="line.181"></a>
<span class="sourceLineNo">182</span>   * @param id         the component id.<a name="line.182"></a>
<span class="sourceLineNo">183</span>   * @param name       the name of the component. Should be null if {@link Arez#areNamesEnabled()} returns false.<a name="line.183"></a>
<span class="sourceLineNo">184</span>   * @param preDispose the hook action called just before the Component is disposed. The hook method is called from within the dispose transaction.<a name="line.184"></a>
<span class="sourceLineNo">185</span>   * @return true if component is defined in context.<a name="line.185"></a>
<span class="sourceLineNo">186</span>   */<a name="line.186"></a>
<span class="sourceLineNo">187</span>  @Nonnull<a name="line.187"></a>
<span class="sourceLineNo">188</span>  public Component component( @Nonnull final String type,<a name="line.188"></a>
<span class="sourceLineNo">189</span>                              @Nonnull final Object id,<a name="line.189"></a>
<span class="sourceLineNo">190</span>                              @Nullable final String name,<a name="line.190"></a>
<span class="sourceLineNo">191</span>                              @Nullable final SafeProcedure preDispose )<a name="line.191"></a>
<span class="sourceLineNo">192</span>  {<a name="line.192"></a>
<span class="sourceLineNo">193</span>    return component( type, id, name, preDispose, null );<a name="line.193"></a>
<span class="sourceLineNo">194</span>  }<a name="line.194"></a>
<span class="sourceLineNo">195</span><a name="line.195"></a>
<span class="sourceLineNo">196</span>  /**<a name="line.196"></a>
<span class="sourceLineNo">197</span>   * Create a component with the specified parameters and return it.<a name="line.197"></a>
<span class="sourceLineNo">198</span>   * This method should only be invoked if {@link Arez#areNativeComponentsEnabled()} returns true.<a name="line.198"></a>
<span class="sourceLineNo">199</span>   * This method should not be invoked if {@link #isComponentPresent(String, Object)} returns true for<a name="line.199"></a>
<span class="sourceLineNo">200</span>   * the parameters. The caller should invoke {@link Component#complete()} on the returned component as<a name="line.200"></a>
<span class="sourceLineNo">201</span>   * soon as the component definition has completed.<a name="line.201"></a>
<span class="sourceLineNo">202</span>   *<a name="line.202"></a>
<span class="sourceLineNo">203</span>   * @param type        the component type.<a name="line.203"></a>
<span class="sourceLineNo">204</span>   * @param id          the component id.<a name="line.204"></a>
<span class="sourceLineNo">205</span>   * @param name        the name of the component. Should be null if {@link Arez#areNamesEnabled()} returns false.<a name="line.205"></a>
<span class="sourceLineNo">206</span>   * @param preDispose  the hook action called just before the Component is disposed. The hook method is called from within the dispose transaction.<a name="line.206"></a>
<span class="sourceLineNo">207</span>   * @param postDispose the hook action called just after the Component is disposed. The hook method is called from within the dispose transaction.<a name="line.207"></a>
<span class="sourceLineNo">208</span>   * @return true if component is defined in context.<a name="line.208"></a>
<span class="sourceLineNo">209</span>   */<a name="line.209"></a>
<span class="sourceLineNo">210</span>  @Nonnull<a name="line.210"></a>
<span class="sourceLineNo">211</span>  public Component component( @Nonnull final String type,<a name="line.211"></a>
<span class="sourceLineNo">212</span>                              @Nonnull final Object id,<a name="line.212"></a>
<span class="sourceLineNo">213</span>                              @Nullable final String name,<a name="line.213"></a>
<span class="sourceLineNo">214</span>                              @Nullable final SafeProcedure preDispose,<a name="line.214"></a>
<span class="sourceLineNo">215</span>                              @Nullable final SafeProcedure postDispose )<a name="line.215"></a>
<span class="sourceLineNo">216</span>  {<a name="line.216"></a>
<span class="sourceLineNo">217</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.217"></a>
<span class="sourceLineNo">218</span>    {<a name="line.218"></a>
<span class="sourceLineNo">219</span>      apiInvariant( Arez::areNativeComponentsEnabled,<a name="line.219"></a>
<span class="sourceLineNo">220</span>                    () -&gt; "Arez-0008: ArezContext.component() invoked when Arez.areNativeComponentsEnabled() returns false." );<a name="line.220"></a>
<span class="sourceLineNo">221</span>    }<a name="line.221"></a>
<span class="sourceLineNo">222</span>    final HashMap&lt;Object, Component&gt; map = getComponentByTypeMap( type );<a name="line.222"></a>
<span class="sourceLineNo">223</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.223"></a>
<span class="sourceLineNo">224</span>    {<a name="line.224"></a>
<span class="sourceLineNo">225</span>      apiInvariant( () -&gt; !map.containsKey( id ),<a name="line.225"></a>
<span class="sourceLineNo">226</span>                    () -&gt; "Arez-0009: ArezContext.component() invoked for type '" + type + "' and id '" +<a name="line.226"></a>
<span class="sourceLineNo">227</span>                          id + "' but a component already exists for specified type+id." );<a name="line.227"></a>
<span class="sourceLineNo">228</span>    }<a name="line.228"></a>
<span class="sourceLineNo">229</span>    final Component component =<a name="line.229"></a>
<span class="sourceLineNo">230</span>      new Component( Arez.areZonesEnabled() ? this : null, type, id, name, preDispose, postDispose );<a name="line.230"></a>
<span class="sourceLineNo">231</span>    map.put( id, component );<a name="line.231"></a>
<span class="sourceLineNo">232</span>    if ( willPropagateSpyEvents() )<a name="line.232"></a>
<span class="sourceLineNo">233</span>    {<a name="line.233"></a>
<span class="sourceLineNo">234</span>      getSpy().reportSpyEvent( new ComponentCreateStartedEvent( getSpy().asComponentInfo( component ) ) );<a name="line.234"></a>
<span class="sourceLineNo">235</span>    }<a name="line.235"></a>
<span class="sourceLineNo">236</span>    return component;<a name="line.236"></a>
<span class="sourceLineNo">237</span>  }<a name="line.237"></a>
<span class="sourceLineNo">238</span><a name="line.238"></a>
<span class="sourceLineNo">239</span>  /**<a name="line.239"></a>
<span class="sourceLineNo">240</span>   * Invoked by the component during it's dispose to release resources associated with the component.<a name="line.240"></a>
<span class="sourceLineNo">241</span>   *<a name="line.241"></a>
<span class="sourceLineNo">242</span>   * @param component the component.<a name="line.242"></a>
<span class="sourceLineNo">243</span>   */<a name="line.243"></a>
<span class="sourceLineNo">244</span>  void deregisterComponent( @Nonnull final Component component )<a name="line.244"></a>
<span class="sourceLineNo">245</span>  {<a name="line.245"></a>
<span class="sourceLineNo">246</span>    if ( Arez.shouldCheckInvariants() )<a name="line.246"></a>
<span class="sourceLineNo">247</span>    {<a name="line.247"></a>
<span class="sourceLineNo">248</span>      invariant( Arez::areNativeComponentsEnabled,<a name="line.248"></a>
<span class="sourceLineNo">249</span>                 () -&gt; "Arez-0006: ArezContext.deregisterComponent() invoked when Arez.areNativeComponentsEnabled() returns false." );<a name="line.249"></a>
<span class="sourceLineNo">250</span>    }<a name="line.250"></a>
<span class="sourceLineNo">251</span>    final String type = component.getType();<a name="line.251"></a>
<span class="sourceLineNo">252</span>    final HashMap&lt;Object, Component&gt; map = getComponentByTypeMap( type );<a name="line.252"></a>
<span class="sourceLineNo">253</span>    final Component removed = map.remove( component.getId() );<a name="line.253"></a>
<span class="sourceLineNo">254</span>    if ( Arez.shouldCheckInvariants() )<a name="line.254"></a>
<span class="sourceLineNo">255</span>    {<a name="line.255"></a>
<span class="sourceLineNo">256</span>      invariant( () -&gt; component == removed,<a name="line.256"></a>
<span class="sourceLineNo">257</span>                 () -&gt; "Arez-0007: ArezContext.deregisterComponent() invoked for '" + component + "' but was " +<a name="line.257"></a>
<span class="sourceLineNo">258</span>                       "unable to remove specified component from registry. Actual component removed: " + removed );<a name="line.258"></a>
<span class="sourceLineNo">259</span>    }<a name="line.259"></a>
<span class="sourceLineNo">260</span>    if ( map.isEmpty() )<a name="line.260"></a>
<span class="sourceLineNo">261</span>    {<a name="line.261"></a>
<span class="sourceLineNo">262</span>      assert _components != null;<a name="line.262"></a>
<span class="sourceLineNo">263</span>      _components.remove( type );<a name="line.263"></a>
<span class="sourceLineNo">264</span>    }<a name="line.264"></a>
<span class="sourceLineNo">265</span>  }<a name="line.265"></a>
<span class="sourceLineNo">266</span><a name="line.266"></a>
<span class="sourceLineNo">267</span>  /**<a name="line.267"></a>
<span class="sourceLineNo">268</span>   * Return component with specified type and id if component exists.<a name="line.268"></a>
<span class="sourceLineNo">269</span>   *<a name="line.269"></a>
<span class="sourceLineNo">270</span>   * @param type the component type.<a name="line.270"></a>
<span class="sourceLineNo">271</span>   * @param id   the component id.<a name="line.271"></a>
<span class="sourceLineNo">272</span>   * @return the component or null.<a name="line.272"></a>
<span class="sourceLineNo">273</span>   */<a name="line.273"></a>
<span class="sourceLineNo">274</span>  @Nullable<a name="line.274"></a>
<span class="sourceLineNo">275</span>  Component findComponent( @Nonnull final String type, @Nonnull final Object id )<a name="line.275"></a>
<span class="sourceLineNo">276</span>  {<a name="line.276"></a>
<span class="sourceLineNo">277</span>    if ( Arez.shouldCheckInvariants() )<a name="line.277"></a>
<span class="sourceLineNo">278</span>    {<a name="line.278"></a>
<span class="sourceLineNo">279</span>      invariant( Arez::areNativeComponentsEnabled,<a name="line.279"></a>
<span class="sourceLineNo">280</span>                 () -&gt; "Arez-0010: ArezContext.findComponent() invoked when Arez.areNativeComponentsEnabled() returns false." );<a name="line.280"></a>
<span class="sourceLineNo">281</span>    }<a name="line.281"></a>
<span class="sourceLineNo">282</span>    assert null != _components;<a name="line.282"></a>
<span class="sourceLineNo">283</span>    final HashMap&lt;Object, Component&gt; map = _components.get( type );<a name="line.283"></a>
<span class="sourceLineNo">284</span>    if ( null != map )<a name="line.284"></a>
<span class="sourceLineNo">285</span>    {<a name="line.285"></a>
<span class="sourceLineNo">286</span>      return map.get( id );<a name="line.286"></a>
<span class="sourceLineNo">287</span>    }<a name="line.287"></a>
<span class="sourceLineNo">288</span>    else<a name="line.288"></a>
<span class="sourceLineNo">289</span>    {<a name="line.289"></a>
<span class="sourceLineNo">290</span>      return null;<a name="line.290"></a>
<span class="sourceLineNo">291</span>    }<a name="line.291"></a>
<span class="sourceLineNo">292</span>  }<a name="line.292"></a>
<span class="sourceLineNo">293</span><a name="line.293"></a>
<span class="sourceLineNo">294</span>  /**<a name="line.294"></a>
<span class="sourceLineNo">295</span>   * Return all the components with specified type.<a name="line.295"></a>
<span class="sourceLineNo">296</span>   *<a name="line.296"></a>
<span class="sourceLineNo">297</span>   * @param type the component type.<a name="line.297"></a>
<span class="sourceLineNo">298</span>   * @return the components for type.<a name="line.298"></a>
<span class="sourceLineNo">299</span>   */<a name="line.299"></a>
<span class="sourceLineNo">300</span>  @Nonnull<a name="line.300"></a>
<span class="sourceLineNo">301</span>  Collection&lt;Component&gt; findAllComponentsByType( @Nonnull final String type )<a name="line.301"></a>
<span class="sourceLineNo">302</span>  {<a name="line.302"></a>
<span class="sourceLineNo">303</span>    if ( Arez.shouldCheckInvariants() )<a name="line.303"></a>
<span class="sourceLineNo">304</span>    {<a name="line.304"></a>
<span class="sourceLineNo">305</span>      invariant( Arez::areNativeComponentsEnabled,<a name="line.305"></a>
<span class="sourceLineNo">306</span>                 () -&gt; "Arez-0011: ArezContext.findAllComponentsByType() invoked when Arez.areNativeComponentsEnabled() returns false." );<a name="line.306"></a>
<span class="sourceLineNo">307</span>    }<a name="line.307"></a>
<span class="sourceLineNo">308</span>    assert null != _components;<a name="line.308"></a>
<span class="sourceLineNo">309</span>    final HashMap&lt;Object, Component&gt; map = _components.get( type );<a name="line.309"></a>
<span class="sourceLineNo">310</span>    if ( null != map )<a name="line.310"></a>
<span class="sourceLineNo">311</span>    {<a name="line.311"></a>
<span class="sourceLineNo">312</span>      return map.values();<a name="line.312"></a>
<span class="sourceLineNo">313</span>    }<a name="line.313"></a>
<span class="sourceLineNo">314</span>    else<a name="line.314"></a>
<span class="sourceLineNo">315</span>    {<a name="line.315"></a>
<span class="sourceLineNo">316</span>      return Collections.emptyList();<a name="line.316"></a>
<span class="sourceLineNo">317</span>    }<a name="line.317"></a>
<span class="sourceLineNo">318</span>  }<a name="line.318"></a>
<span class="sourceLineNo">319</span><a name="line.319"></a>
<span class="sourceLineNo">320</span>  /**<a name="line.320"></a>
<span class="sourceLineNo">321</span>   * Return all the component types as a collection.<a name="line.321"></a>
<span class="sourceLineNo">322</span>   *<a name="line.322"></a>
<span class="sourceLineNo">323</span>   * @return the component types.<a name="line.323"></a>
<span class="sourceLineNo">324</span>   */<a name="line.324"></a>
<span class="sourceLineNo">325</span>  @Nonnull<a name="line.325"></a>
<span class="sourceLineNo">326</span>  Collection&lt;String&gt; findAllComponentTypes()<a name="line.326"></a>
<span class="sourceLineNo">327</span>  {<a name="line.327"></a>
<span class="sourceLineNo">328</span>    if ( Arez.shouldCheckInvariants() )<a name="line.328"></a>
<span class="sourceLineNo">329</span>    {<a name="line.329"></a>
<span class="sourceLineNo">330</span>      invariant( Arez::areNativeComponentsEnabled,<a name="line.330"></a>
<span class="sourceLineNo">331</span>                 () -&gt; "Arez-0012: ArezContext.findAllComponentTypes() invoked when Arez.areNativeComponentsEnabled() returns false." );<a name="line.331"></a>
<span class="sourceLineNo">332</span>    }<a name="line.332"></a>
<span class="sourceLineNo">333</span>    assert null != _components;<a name="line.333"></a>
<span class="sourceLineNo">334</span>    return _components.keySet();<a name="line.334"></a>
<span class="sourceLineNo">335</span>  }<a name="line.335"></a>
<span class="sourceLineNo">336</span><a name="line.336"></a>
<span class="sourceLineNo">337</span>  /**<a name="line.337"></a>
<span class="sourceLineNo">338</span>   * Create a ComputedValue with specified parameters.<a name="line.338"></a>
<span class="sourceLineNo">339</span>   *<a name="line.339"></a>
<span class="sourceLineNo">340</span>   * @param &lt;T&gt;      the type of the computed value.<a name="line.340"></a>
<span class="sourceLineNo">341</span>   * @param function the function that computes the value.<a name="line.341"></a>
<span class="sourceLineNo">342</span>   * @return the ComputedValue instance.<a name="line.342"></a>
<span class="sourceLineNo">343</span>   */<a name="line.343"></a>
<span class="sourceLineNo">344</span>  @Nonnull<a name="line.344"></a>
<span class="sourceLineNo">345</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nonnull final SafeFunction&lt;T&gt; function )<a name="line.345"></a>
<span class="sourceLineNo">346</span>  {<a name="line.346"></a>
<span class="sourceLineNo">347</span>    return computed( function, 0 );<a name="line.347"></a>
<span class="sourceLineNo">348</span>  }<a name="line.348"></a>
<span class="sourceLineNo">349</span><a name="line.349"></a>
<span class="sourceLineNo">350</span>  /**<a name="line.350"></a>
<span class="sourceLineNo">351</span>   * Create a ComputedValue with specified parameters.<a name="line.351"></a>
<span class="sourceLineNo">352</span>   *<a name="line.352"></a>
<span class="sourceLineNo">353</span>   * @param &lt;T&gt;      the type of the computed value.<a name="line.353"></a>
<span class="sourceLineNo">354</span>   * @param function the function that computes the value.<a name="line.354"></a>
<span class="sourceLineNo">355</span>   * @param flags    the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.355"></a>
<span class="sourceLineNo">356</span>   * @return the ComputedValue instance.<a name="line.356"></a>
<span class="sourceLineNo">357</span>   */<a name="line.357"></a>
<span class="sourceLineNo">358</span>  @Nonnull<a name="line.358"></a>
<span class="sourceLineNo">359</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nonnull final SafeFunction&lt;T&gt; function, final int flags )<a name="line.359"></a>
<span class="sourceLineNo">360</span>  {<a name="line.360"></a>
<span class="sourceLineNo">361</span>    return computed( null, function, flags );<a name="line.361"></a>
<span class="sourceLineNo">362</span>  }<a name="line.362"></a>
<span class="sourceLineNo">363</span><a name="line.363"></a>
<span class="sourceLineNo">364</span>  /**<a name="line.364"></a>
<span class="sourceLineNo">365</span>   * Create a ComputedValue with specified parameters.<a name="line.365"></a>
<span class="sourceLineNo">366</span>   *<a name="line.366"></a>
<span class="sourceLineNo">367</span>   * @param &lt;T&gt;      the type of the computed value.<a name="line.367"></a>
<span class="sourceLineNo">368</span>   * @param name     the name of the ComputedValue.<a name="line.368"></a>
<span class="sourceLineNo">369</span>   * @param function the function that computes the value.<a name="line.369"></a>
<span class="sourceLineNo">370</span>   * @return the ComputedValue instance.<a name="line.370"></a>
<span class="sourceLineNo">371</span>   */<a name="line.371"></a>
<span class="sourceLineNo">372</span>  @Nonnull<a name="line.372"></a>
<span class="sourceLineNo">373</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nullable final String name, @Nonnull final SafeFunction&lt;T&gt; function )<a name="line.373"></a>
<span class="sourceLineNo">374</span>  {<a name="line.374"></a>
<span class="sourceLineNo">375</span>    return computed( name, function, 0 );<a name="line.375"></a>
<span class="sourceLineNo">376</span>  }<a name="line.376"></a>
<span class="sourceLineNo">377</span><a name="line.377"></a>
<span class="sourceLineNo">378</span>  /**<a name="line.378"></a>
<span class="sourceLineNo">379</span>   * Create a ComputedValue with specified parameters.<a name="line.379"></a>
<span class="sourceLineNo">380</span>   *<a name="line.380"></a>
<span class="sourceLineNo">381</span>   * @param &lt;T&gt;      the type of the computed value.<a name="line.381"></a>
<span class="sourceLineNo">382</span>   * @param name     the name of the ComputedValue.<a name="line.382"></a>
<span class="sourceLineNo">383</span>   * @param function the function that computes the value.<a name="line.383"></a>
<span class="sourceLineNo">384</span>   * @param flags    the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.384"></a>
<span class="sourceLineNo">385</span>   * @return the ComputedValue instance.<a name="line.385"></a>
<span class="sourceLineNo">386</span>   */<a name="line.386"></a>
<span class="sourceLineNo">387</span>  @Nonnull<a name="line.387"></a>
<span class="sourceLineNo">388</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nullable final String name,<a name="line.388"></a>
<span class="sourceLineNo">389</span>                                        @Nonnull final SafeFunction&lt;T&gt; function,<a name="line.389"></a>
<span class="sourceLineNo">390</span>                                        final int flags )<a name="line.390"></a>
<span class="sourceLineNo">391</span>  {<a name="line.391"></a>
<span class="sourceLineNo">392</span>    return computed( null, name, function, flags );<a name="line.392"></a>
<span class="sourceLineNo">393</span>  }<a name="line.393"></a>
<span class="sourceLineNo">394</span><a name="line.394"></a>
<span class="sourceLineNo">395</span>  /**<a name="line.395"></a>
<span class="sourceLineNo">396</span>   * Create a ComputedValue with specified parameters.<a name="line.396"></a>
<span class="sourceLineNo">397</span>   *<a name="line.397"></a>
<span class="sourceLineNo">398</span>   * @param &lt;T&gt;       the type of the computed value.<a name="line.398"></a>
<span class="sourceLineNo">399</span>   * @param component the component that contains the ComputedValue if any. Must be null unless {@link Arez#areNativeComponentsEnabled()} returns true.<a name="line.399"></a>
<span class="sourceLineNo">400</span>   * @param name      the name of the ComputedValue.<a name="line.400"></a>
<span class="sourceLineNo">401</span>   * @param function  the function that computes the value.<a name="line.401"></a>
<span class="sourceLineNo">402</span>   * @return the ComputedValue instance.<a name="line.402"></a>
<span class="sourceLineNo">403</span>   */<a name="line.403"></a>
<span class="sourceLineNo">404</span>  @Nonnull<a name="line.404"></a>
<span class="sourceLineNo">405</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nullable final Component component,<a name="line.405"></a>
<span class="sourceLineNo">406</span>                                        @Nullable final String name,<a name="line.406"></a>
<span class="sourceLineNo">407</span>                                        @Nonnull final SafeFunction&lt;T&gt; function )<a name="line.407"></a>
<span class="sourceLineNo">408</span>  {<a name="line.408"></a>
<span class="sourceLineNo">409</span>    return computed( component, name, function, 0 );<a name="line.409"></a>
<span class="sourceLineNo">410</span>  }<a name="line.410"></a>
<span class="sourceLineNo">411</span><a name="line.411"></a>
<span class="sourceLineNo">412</span>  /**<a name="line.412"></a>
<span class="sourceLineNo">413</span>   * Create a ComputedValue with specified parameters.<a name="line.413"></a>
<span class="sourceLineNo">414</span>   *<a name="line.414"></a>
<span class="sourceLineNo">415</span>   * @param &lt;T&gt;       the type of the computed value.<a name="line.415"></a>
<span class="sourceLineNo">416</span>   * @param component the component that contains the ComputedValue if any. Must be null unless {@link Arez#areNativeComponentsEnabled()} returns true.<a name="line.416"></a>
<span class="sourceLineNo">417</span>   * @param name      the name of the ComputedValue.<a name="line.417"></a>
<span class="sourceLineNo">418</span>   * @param function  the function that computes the value.<a name="line.418"></a>
<span class="sourceLineNo">419</span>   * @param flags     the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.419"></a>
<span class="sourceLineNo">420</span>   * @return the ComputedValue instance.<a name="line.420"></a>
<span class="sourceLineNo">421</span>   */<a name="line.421"></a>
<span class="sourceLineNo">422</span>  @Nonnull<a name="line.422"></a>
<span class="sourceLineNo">423</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nullable final Component component,<a name="line.423"></a>
<span class="sourceLineNo">424</span>                                        @Nullable final String name,<a name="line.424"></a>
<span class="sourceLineNo">425</span>                                        @Nonnull final SafeFunction&lt;T&gt; function,<a name="line.425"></a>
<span class="sourceLineNo">426</span>                                        final int flags )<a name="line.426"></a>
<span class="sourceLineNo">427</span>  {<a name="line.427"></a>
<span class="sourceLineNo">428</span>    return computed( component, name, function, null, null, null, flags );<a name="line.428"></a>
<span class="sourceLineNo">429</span>  }<a name="line.429"></a>
<span class="sourceLineNo">430</span><a name="line.430"></a>
<span class="sourceLineNo">431</span>  /**<a name="line.431"></a>
<span class="sourceLineNo">432</span>   * Create a ComputedValue with specified parameters.<a name="line.432"></a>
<span class="sourceLineNo">433</span>   *<a name="line.433"></a>
<span class="sourceLineNo">434</span>   * @param &lt;T&gt;          the type of the computed value.<a name="line.434"></a>
<span class="sourceLineNo">435</span>   * @param component    the component that contains the ComputedValue if any. Must be null unless {@link Arez#areNativeComponentsEnabled()} returns true.<a name="line.435"></a>
<span class="sourceLineNo">436</span>   * @param name         the name of the ComputedValue.<a name="line.436"></a>
<span class="sourceLineNo">437</span>   * @param function     the function that computes the value.<a name="line.437"></a>
<span class="sourceLineNo">438</span>   * @param onActivate   the procedure to invoke when the ComputedValue changes from the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.438"></a>
<span class="sourceLineNo">439</span>   * @param onDeactivate the procedure to invoke when the ComputedValue changes to the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.439"></a>
<span class="sourceLineNo">440</span>   * @param onStale      the procedure to invoke when the ComputedValue changes changes from the UP_TO_DATE state to STALE or POSSIBLY_STALE. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.440"></a>
<span class="sourceLineNo">441</span>   * @return the ComputedValue instance.<a name="line.441"></a>
<span class="sourceLineNo">442</span>   */<a name="line.442"></a>
<span class="sourceLineNo">443</span>  @Nonnull<a name="line.443"></a>
<span class="sourceLineNo">444</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nullable final Component component,<a name="line.444"></a>
<span class="sourceLineNo">445</span>                                        @Nullable final String name,<a name="line.445"></a>
<span class="sourceLineNo">446</span>                                        @Nonnull final SafeFunction&lt;T&gt; function,<a name="line.446"></a>
<span class="sourceLineNo">447</span>                                        @Nullable final Procedure onActivate,<a name="line.447"></a>
<span class="sourceLineNo">448</span>                                        @Nullable final Procedure onDeactivate,<a name="line.448"></a>
<span class="sourceLineNo">449</span>                                        @Nullable final Procedure onStale )<a name="line.449"></a>
<span class="sourceLineNo">450</span>  {<a name="line.450"></a>
<span class="sourceLineNo">451</span>    return computed( component, name, function, onActivate, onDeactivate, onStale, 0 );<a name="line.451"></a>
<span class="sourceLineNo">452</span>  }<a name="line.452"></a>
<span class="sourceLineNo">453</span><a name="line.453"></a>
<span class="sourceLineNo">454</span>  /**<a name="line.454"></a>
<span class="sourceLineNo">455</span>   * Create a ComputedValue with specified parameters.<a name="line.455"></a>
<span class="sourceLineNo">456</span>   *<a name="line.456"></a>
<span class="sourceLineNo">457</span>   * @param &lt;T&gt;          the type of the computed value.<a name="line.457"></a>
<span class="sourceLineNo">458</span>   * @param name         the name of the ComputedValue.<a name="line.458"></a>
<span class="sourceLineNo">459</span>   * @param function     the function that computes the value.<a name="line.459"></a>
<span class="sourceLineNo">460</span>   * @param onActivate   the procedure to invoke when the ComputedValue changes from the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.460"></a>
<span class="sourceLineNo">461</span>   * @param onDeactivate the procedure to invoke when the ComputedValue changes to the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.461"></a>
<span class="sourceLineNo">462</span>   * @param onStale      the procedure to invoke when the ComputedValue changes changes from the UP_TO_DATE state to STALE or POSSIBLY_STALE. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.462"></a>
<span class="sourceLineNo">463</span>   * @return the ComputedValue instance.<a name="line.463"></a>
<span class="sourceLineNo">464</span>   */<a name="line.464"></a>
<span class="sourceLineNo">465</span>  @Nonnull<a name="line.465"></a>
<span class="sourceLineNo">466</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nullable final String name,<a name="line.466"></a>
<span class="sourceLineNo">467</span>                                        @Nonnull final SafeFunction&lt;T&gt; function,<a name="line.467"></a>
<span class="sourceLineNo">468</span>                                        @Nullable final Procedure onActivate,<a name="line.468"></a>
<span class="sourceLineNo">469</span>                                        @Nullable final Procedure onDeactivate,<a name="line.469"></a>
<span class="sourceLineNo">470</span>                                        @Nullable final Procedure onStale )<a name="line.470"></a>
<span class="sourceLineNo">471</span>  {<a name="line.471"></a>
<span class="sourceLineNo">472</span>    return computed( name, function, onActivate, onDeactivate, onStale, 0 );<a name="line.472"></a>
<span class="sourceLineNo">473</span>  }<a name="line.473"></a>
<span class="sourceLineNo">474</span><a name="line.474"></a>
<span class="sourceLineNo">475</span>  /**<a name="line.475"></a>
<span class="sourceLineNo">476</span>   * Create a ComputedValue with specified parameters.<a name="line.476"></a>
<span class="sourceLineNo">477</span>   *<a name="line.477"></a>
<span class="sourceLineNo">478</span>   * @param &lt;T&gt;          the type of the computed value.<a name="line.478"></a>
<span class="sourceLineNo">479</span>   * @param name         the name of the ComputedValue.<a name="line.479"></a>
<span class="sourceLineNo">480</span>   * @param function     the function that computes the value.<a name="line.480"></a>
<span class="sourceLineNo">481</span>   * @param onActivate   the procedure to invoke when the ComputedValue changes from the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.481"></a>
<span class="sourceLineNo">482</span>   * @param onDeactivate the procedure to invoke when the ComputedValue changes to the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.482"></a>
<span class="sourceLineNo">483</span>   * @param onStale      the procedure to invoke when the ComputedValue changes changes from the UP_TO_DATE state to STALE or POSSIBLY_STALE. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.483"></a>
<span class="sourceLineNo">484</span>   * @param flags        the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.484"></a>
<span class="sourceLineNo">485</span>   * @return the ComputedValue instance.<a name="line.485"></a>
<span class="sourceLineNo">486</span>   */<a name="line.486"></a>
<span class="sourceLineNo">487</span>  @Nonnull<a name="line.487"></a>
<span class="sourceLineNo">488</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nullable final String name,<a name="line.488"></a>
<span class="sourceLineNo">489</span>                                        @Nonnull final SafeFunction&lt;T&gt; function,<a name="line.489"></a>
<span class="sourceLineNo">490</span>                                        @Nullable final Procedure onActivate,<a name="line.490"></a>
<span class="sourceLineNo">491</span>                                        @Nullable final Procedure onDeactivate,<a name="line.491"></a>
<span class="sourceLineNo">492</span>                                        @Nullable final Procedure onStale,<a name="line.492"></a>
<span class="sourceLineNo">493</span>                                        final int flags )<a name="line.493"></a>
<span class="sourceLineNo">494</span>  {<a name="line.494"></a>
<span class="sourceLineNo">495</span>    return computed( null, name, function, onActivate, onDeactivate, onStale, flags );<a name="line.495"></a>
<span class="sourceLineNo">496</span>  }<a name="line.496"></a>
<span class="sourceLineNo">497</span><a name="line.497"></a>
<span class="sourceLineNo">498</span>  /**<a name="line.498"></a>
<span class="sourceLineNo">499</span>   * Create a ComputedValue with specified parameters.<a name="line.499"></a>
<span class="sourceLineNo">500</span>   *<a name="line.500"></a>
<span class="sourceLineNo">501</span>   * @param &lt;T&gt;          the type of the computed value.<a name="line.501"></a>
<span class="sourceLineNo">502</span>   * @param component    the component that contains the ComputedValue if any. Must be null unless {@link Arez#areNativeComponentsEnabled()} returns true.<a name="line.502"></a>
<span class="sourceLineNo">503</span>   * @param name         the name of the ComputedValue.<a name="line.503"></a>
<span class="sourceLineNo">504</span>   * @param function     the function that computes the value.<a name="line.504"></a>
<span class="sourceLineNo">505</span>   * @param onActivate   the procedure to invoke when the ComputedValue changes from the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.505"></a>
<span class="sourceLineNo">506</span>   * @param onDeactivate the procedure to invoke when the ComputedValue changes to the INACTIVE state to any other state. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.506"></a>
<span class="sourceLineNo">507</span>   * @param onStale      the procedure to invoke when the ComputedValue changes changes from the UP_TO_DATE state to STALE or POSSIBLY_STALE. This will be invoked when the transition occurs and will occur in the context of the transaction that made the change.<a name="line.507"></a>
<span class="sourceLineNo">508</span>   * @param flags        the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.508"></a>
<span class="sourceLineNo">509</span>   * @return the ComputedValue instance.<a name="line.509"></a>
<span class="sourceLineNo">510</span>   */<a name="line.510"></a>
<span class="sourceLineNo">511</span>  @Nonnull<a name="line.511"></a>
<span class="sourceLineNo">512</span>  public &lt;T&gt; ComputedValue&lt;T&gt; computed( @Nullable final Component component,<a name="line.512"></a>
<span class="sourceLineNo">513</span>                                        @Nullable final String name,<a name="line.513"></a>
<span class="sourceLineNo">514</span>                                        @Nonnull final SafeFunction&lt;T&gt; function,<a name="line.514"></a>
<span class="sourceLineNo">515</span>                                        @Nullable final Procedure onActivate,<a name="line.515"></a>
<span class="sourceLineNo">516</span>                                        @Nullable final Procedure onDeactivate,<a name="line.516"></a>
<span class="sourceLineNo">517</span>                                        @Nullable final Procedure onStale,<a name="line.517"></a>
<span class="sourceLineNo">518</span>                                        final int flags )<a name="line.518"></a>
<span class="sourceLineNo">519</span>  {<a name="line.519"></a>
<span class="sourceLineNo">520</span>    return new ComputedValue&lt;&gt;( Arez.areZonesEnabled() ? this : null,<a name="line.520"></a>
<span class="sourceLineNo">521</span>                                component,<a name="line.521"></a>
<span class="sourceLineNo">522</span>                                generateNodeName( "ComputedValue", name ),<a name="line.522"></a>
<span class="sourceLineNo">523</span>                                function,<a name="line.523"></a>
<span class="sourceLineNo">524</span>                                onActivate,<a name="line.524"></a>
<span class="sourceLineNo">525</span>                                onDeactivate,<a name="line.525"></a>
<span class="sourceLineNo">526</span>                                onStale,<a name="line.526"></a>
<span class="sourceLineNo">527</span>                                flags );<a name="line.527"></a>
<span class="sourceLineNo">528</span>  }<a name="line.528"></a>
<span class="sourceLineNo">529</span><a name="line.529"></a>
<span class="sourceLineNo">530</span>  /**<a name="line.530"></a>
<span class="sourceLineNo">531</span>   * Build name for node.<a name="line.531"></a>
<span class="sourceLineNo">532</span>   * If {@link Arez#areNamesEnabled()} returns false then this method will return null, otherwise the specified<a name="line.532"></a>
<span class="sourceLineNo">533</span>   * name will be returned or a name synthesized from the prefix and a running number if no name is specified.<a name="line.533"></a>
<span class="sourceLineNo">534</span>   *<a name="line.534"></a>
<span class="sourceLineNo">535</span>   * @param prefix the prefix used if this method needs to generate name.<a name="line.535"></a>
<span class="sourceLineNo">536</span>   * @param name   the name specified by the user.<a name="line.536"></a>
<span class="sourceLineNo">537</span>   * @return the name.<a name="line.537"></a>
<span class="sourceLineNo">538</span>   */<a name="line.538"></a>
<span class="sourceLineNo">539</span>  @Nullable<a name="line.539"></a>
<span class="sourceLineNo">540</span>  String generateNodeName( @Nonnull final String prefix, @Nullable final String name )<a name="line.540"></a>
<span class="sourceLineNo">541</span>  {<a name="line.541"></a>
<span class="sourceLineNo">542</span>    return Arez.areNamesEnabled() ?<a name="line.542"></a>
<span class="sourceLineNo">543</span>           null != name ? name : prefix + "@" + _nextNodeId++ :<a name="line.543"></a>
<span class="sourceLineNo">544</span>           null;<a name="line.544"></a>
<span class="sourceLineNo">545</span>  }<a name="line.545"></a>
<span class="sourceLineNo">546</span><a name="line.546"></a>
<span class="sourceLineNo">547</span>  /**<a name="line.547"></a>
<span class="sourceLineNo">548</span>   * Create an "autorun" observer that reschedules tracked procedure when dependency updates occur.<a name="line.548"></a>
<span class="sourceLineNo">549</span>   *<a name="line.549"></a>
<span class="sourceLineNo">550</span>   * @param tracked the executable tracked by the observer.<a name="line.550"></a>
<span class="sourceLineNo">551</span>   * @return the new Observer.<a name="line.551"></a>
<span class="sourceLineNo">552</span>   */<a name="line.552"></a>
<span class="sourceLineNo">553</span>  @Nonnull<a name="line.553"></a>
<span class="sourceLineNo">554</span>  public Observer observer( @Nonnull final Procedure tracked )<a name="line.554"></a>
<span class="sourceLineNo">555</span>  {<a name="line.555"></a>
<span class="sourceLineNo">556</span>    return observer( tracked, 0 );<a name="line.556"></a>
<span class="sourceLineNo">557</span>  }<a name="line.557"></a>
<span class="sourceLineNo">558</span><a name="line.558"></a>
<span class="sourceLineNo">559</span>  /**<a name="line.559"></a>
<span class="sourceLineNo">560</span>   * Create an "autorun" observer that reschedules tracked procedure when dependency updates occur.<a name="line.560"></a>
<span class="sourceLineNo">561</span>   *<a name="line.561"></a>
<span class="sourceLineNo">562</span>   * @param tracked the executable tracked by the observer.<a name="line.562"></a>
<span class="sourceLineNo">563</span>   * @param flags   the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.563"></a>
<span class="sourceLineNo">564</span>   * @return the new Observer.<a name="line.564"></a>
<span class="sourceLineNo">565</span>   */<a name="line.565"></a>
<span class="sourceLineNo">566</span>  @Nonnull<a name="line.566"></a>
<span class="sourceLineNo">567</span>  public Observer observer( @Nonnull final Procedure tracked, final int flags )<a name="line.567"></a>
<span class="sourceLineNo">568</span>  {<a name="line.568"></a>
<span class="sourceLineNo">569</span>    return observer( (String) null, tracked, flags );<a name="line.569"></a>
<span class="sourceLineNo">570</span>  }<a name="line.570"></a>
<span class="sourceLineNo">571</span><a name="line.571"></a>
<span class="sourceLineNo">572</span>  /**<a name="line.572"></a>
<span class="sourceLineNo">573</span>   * Create an "autorun" observer that reschedules tracked procedure when dependency updates occur.<a name="line.573"></a>
<span class="sourceLineNo">574</span>   *<a name="line.574"></a>
<span class="sourceLineNo">575</span>   * @param name    the name of the observer.<a name="line.575"></a>
<span class="sourceLineNo">576</span>   * @param tracked the executable tracked by the observer.<a name="line.576"></a>
<span class="sourceLineNo">577</span>   * @return the new Observer.<a name="line.577"></a>
<span class="sourceLineNo">578</span>   */<a name="line.578"></a>
<span class="sourceLineNo">579</span>  @Nonnull<a name="line.579"></a>
<span class="sourceLineNo">580</span>  public Observer observer( @Nullable final String name, @Nonnull final Procedure tracked )<a name="line.580"></a>
<span class="sourceLineNo">581</span>  {<a name="line.581"></a>
<span class="sourceLineNo">582</span>    return observer( name, tracked, 0 );<a name="line.582"></a>
<span class="sourceLineNo">583</span>  }<a name="line.583"></a>
<span class="sourceLineNo">584</span><a name="line.584"></a>
<span class="sourceLineNo">585</span>  /**<a name="line.585"></a>
<span class="sourceLineNo">586</span>   * Create an "autorun" observer that reschedules tracked procedure when dependency updates occur.<a name="line.586"></a>
<span class="sourceLineNo">587</span>   *<a name="line.587"></a>
<span class="sourceLineNo">588</span>   * @param name    the name of the observer.<a name="line.588"></a>
<span class="sourceLineNo">589</span>   * @param tracked the executable tracked by the observer.<a name="line.589"></a>
<span class="sourceLineNo">590</span>   * @param flags   the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.590"></a>
<span class="sourceLineNo">591</span>   * @return the new Observer.<a name="line.591"></a>
<span class="sourceLineNo">592</span>   */<a name="line.592"></a>
<span class="sourceLineNo">593</span>  @Nonnull<a name="line.593"></a>
<span class="sourceLineNo">594</span>  public Observer observer( @Nullable final String name, @Nonnull final Procedure tracked, final int flags )<a name="line.594"></a>
<span class="sourceLineNo">595</span>  {<a name="line.595"></a>
<span class="sourceLineNo">596</span>    return observer( null, name, tracked, flags );<a name="line.596"></a>
<span class="sourceLineNo">597</span>  }<a name="line.597"></a>
<span class="sourceLineNo">598</span><a name="line.598"></a>
<span class="sourceLineNo">599</span>  /**<a name="line.599"></a>
<span class="sourceLineNo">600</span>   * Create an "autorun" observer that reschedules tracked procedure when dependency updates occur.<a name="line.600"></a>
<span class="sourceLineNo">601</span>   *<a name="line.601"></a>
<span class="sourceLineNo">602</span>   * @param component the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.602"></a>
<span class="sourceLineNo">603</span>   * @param name      the name of the observer.<a name="line.603"></a>
<span class="sourceLineNo">604</span>   * @param tracked   the executable tracked by the observer.<a name="line.604"></a>
<span class="sourceLineNo">605</span>   * @return the new Observer.<a name="line.605"></a>
<span class="sourceLineNo">606</span>   */<a name="line.606"></a>
<span class="sourceLineNo">607</span>  @Nonnull<a name="line.607"></a>
<span class="sourceLineNo">608</span>  public Observer observer( @Nullable final Component component,<a name="line.608"></a>
<span class="sourceLineNo">609</span>                            @Nullable final String name,<a name="line.609"></a>
<span class="sourceLineNo">610</span>                            @Nonnull final Procedure tracked )<a name="line.610"></a>
<span class="sourceLineNo">611</span>  {<a name="line.611"></a>
<span class="sourceLineNo">612</span>    return observer( component, name, tracked, 0 );<a name="line.612"></a>
<span class="sourceLineNo">613</span>  }<a name="line.613"></a>
<span class="sourceLineNo">614</span><a name="line.614"></a>
<span class="sourceLineNo">615</span>  /**<a name="line.615"></a>
<span class="sourceLineNo">616</span>   * Create an "autorun" observer that reschedules tracked procedure when dependency updates occur.<a name="line.616"></a>
<span class="sourceLineNo">617</span>   *<a name="line.617"></a>
<span class="sourceLineNo">618</span>   * @param component the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.618"></a>
<span class="sourceLineNo">619</span>   * @param name      the name of the observer.<a name="line.619"></a>
<span class="sourceLineNo">620</span>   * @param tracked   the executable tracked by the observer.<a name="line.620"></a>
<span class="sourceLineNo">621</span>   * @param flags     the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.621"></a>
<span class="sourceLineNo">622</span>   * @return the new Observer.<a name="line.622"></a>
<span class="sourceLineNo">623</span>   */<a name="line.623"></a>
<span class="sourceLineNo">624</span>  @Nonnull<a name="line.624"></a>
<span class="sourceLineNo">625</span>  public Observer observer( @Nullable final Component component,<a name="line.625"></a>
<span class="sourceLineNo">626</span>                            @Nullable final String name,<a name="line.626"></a>
<span class="sourceLineNo">627</span>                            @Nonnull final Procedure tracked,<a name="line.627"></a>
<span class="sourceLineNo">628</span>                            final int flags )<a name="line.628"></a>
<span class="sourceLineNo">629</span>  {<a name="line.629"></a>
<span class="sourceLineNo">630</span>    return observer( component, name, Objects.requireNonNull( tracked ), null, flags );<a name="line.630"></a>
<span class="sourceLineNo">631</span>  }<a name="line.631"></a>
<span class="sourceLineNo">632</span><a name="line.632"></a>
<span class="sourceLineNo">633</span>  /**<a name="line.633"></a>
<span class="sourceLineNo">634</span>   * Create an observer.<a name="line.634"></a>
<span class="sourceLineNo">635</span>   * The user must pass either the &lt;code&gt;tracked&lt;/code&gt; or &lt;code&gt;onDepsUpdated&lt;/code&gt; parameter.<a name="line.635"></a>
<span class="sourceLineNo">636</span>   *<a name="line.636"></a>
<span class="sourceLineNo">637</span>   * @param component     the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.637"></a>
<span class="sourceLineNo">638</span>   * @param name          the name of the observer.<a name="line.638"></a>
<span class="sourceLineNo">639</span>   * @param tracked       the executable tracked by the observer. May be null if observer is externally scheduled.<a name="line.639"></a>
<span class="sourceLineNo">640</span>   * @param onDepsUpdated the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.<a name="line.640"></a>
<span class="sourceLineNo">641</span>   * @return the new Observer.<a name="line.641"></a>
<span class="sourceLineNo">642</span>   */<a name="line.642"></a>
<span class="sourceLineNo">643</span>  @Nonnull<a name="line.643"></a>
<span class="sourceLineNo">644</span>  public Observer observer( @Nullable final Component component,<a name="line.644"></a>
<span class="sourceLineNo">645</span>                            @Nullable final String name,<a name="line.645"></a>
<span class="sourceLineNo">646</span>                            @Nullable final Procedure tracked,<a name="line.646"></a>
<span class="sourceLineNo">647</span>                            @Nullable final Procedure onDepsUpdated )<a name="line.647"></a>
<span class="sourceLineNo">648</span>  {<a name="line.648"></a>
<span class="sourceLineNo">649</span>    return observer( component, name, tracked, onDepsUpdated, 0 );<a name="line.649"></a>
<span class="sourceLineNo">650</span>  }<a name="line.650"></a>
<span class="sourceLineNo">651</span><a name="line.651"></a>
<span class="sourceLineNo">652</span>  /**<a name="line.652"></a>
<span class="sourceLineNo">653</span>   * Create an observer.<a name="line.653"></a>
<span class="sourceLineNo">654</span>   * The user must pass either the &lt;code&gt;tracked&lt;/code&gt; or &lt;code&gt;onDepsUpdated&lt;/code&gt; or both parameters.<a name="line.654"></a>
<span class="sourceLineNo">655</span>   *<a name="line.655"></a>
<span class="sourceLineNo">656</span>   * @param tracked       the executable tracked by the observer. May be null if observer is externally scheduled.<a name="line.656"></a>
<span class="sourceLineNo">657</span>   * @param onDepsUpdated the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.<a name="line.657"></a>
<span class="sourceLineNo">658</span>   * @return the new Observer.<a name="line.658"></a>
<span class="sourceLineNo">659</span>   */<a name="line.659"></a>
<span class="sourceLineNo">660</span>  @Nonnull<a name="line.660"></a>
<span class="sourceLineNo">661</span>  public Observer observer( @Nullable final Procedure tracked, @Nullable final Procedure onDepsUpdated )<a name="line.661"></a>
<span class="sourceLineNo">662</span>  {<a name="line.662"></a>
<span class="sourceLineNo">663</span>    return observer( tracked, onDepsUpdated, 0 );<a name="line.663"></a>
<span class="sourceLineNo">664</span>  }<a name="line.664"></a>
<span class="sourceLineNo">665</span><a name="line.665"></a>
<span class="sourceLineNo">666</span>  /**<a name="line.666"></a>
<span class="sourceLineNo">667</span>   * Create an observer.<a name="line.667"></a>
<span class="sourceLineNo">668</span>   * The user must pass either the &lt;code&gt;tracked&lt;/code&gt; or &lt;code&gt;onDepsUpdated&lt;/code&gt; or both parameters.<a name="line.668"></a>
<span class="sourceLineNo">669</span>   *<a name="line.669"></a>
<span class="sourceLineNo">670</span>   * @param tracked       the executable tracked by the observer. May be null if observer is externally scheduled.<a name="line.670"></a>
<span class="sourceLineNo">671</span>   * @param onDepsUpdated the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.<a name="line.671"></a>
<span class="sourceLineNo">672</span>   * @param flags         the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.672"></a>
<span class="sourceLineNo">673</span>   * @return the new Observer.<a name="line.673"></a>
<span class="sourceLineNo">674</span>   */<a name="line.674"></a>
<span class="sourceLineNo">675</span>  @Nonnull<a name="line.675"></a>
<span class="sourceLineNo">676</span>  public Observer observer( @Nullable final Procedure tracked,<a name="line.676"></a>
<span class="sourceLineNo">677</span>                            @Nullable final Procedure onDepsUpdated,<a name="line.677"></a>
<span class="sourceLineNo">678</span>                            final int flags )<a name="line.678"></a>
<span class="sourceLineNo">679</span>  {<a name="line.679"></a>
<span class="sourceLineNo">680</span>    return observer( null, tracked, onDepsUpdated, flags );<a name="line.680"></a>
<span class="sourceLineNo">681</span>  }<a name="line.681"></a>
<span class="sourceLineNo">682</span><a name="line.682"></a>
<span class="sourceLineNo">683</span>  /**<a name="line.683"></a>
<span class="sourceLineNo">684</span>   * Create an observer.<a name="line.684"></a>
<span class="sourceLineNo">685</span>   * The user must pass either the &lt;code&gt;tracked&lt;/code&gt; or &lt;code&gt;onDepsUpdated&lt;/code&gt; or both parameters.<a name="line.685"></a>
<span class="sourceLineNo">686</span>   *<a name="line.686"></a>
<span class="sourceLineNo">687</span>   * @param name          the name of the observer.<a name="line.687"></a>
<span class="sourceLineNo">688</span>   * @param tracked       the executable tracked by the observer. May be null if observer is externally scheduled.<a name="line.688"></a>
<span class="sourceLineNo">689</span>   * @param onDepsUpdated the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.<a name="line.689"></a>
<span class="sourceLineNo">690</span>   * @return the new Observer.<a name="line.690"></a>
<span class="sourceLineNo">691</span>   */<a name="line.691"></a>
<span class="sourceLineNo">692</span>  @Nonnull<a name="line.692"></a>
<span class="sourceLineNo">693</span>  public Observer observer( @Nullable final String name,<a name="line.693"></a>
<span class="sourceLineNo">694</span>                            @Nullable final Procedure tracked,<a name="line.694"></a>
<span class="sourceLineNo">695</span>                            @Nullable final Procedure onDepsUpdated )<a name="line.695"></a>
<span class="sourceLineNo">696</span>  {<a name="line.696"></a>
<span class="sourceLineNo">697</span>    return observer( name, tracked, onDepsUpdated, 0 );<a name="line.697"></a>
<span class="sourceLineNo">698</span>  }<a name="line.698"></a>
<span class="sourceLineNo">699</span><a name="line.699"></a>
<span class="sourceLineNo">700</span>  /**<a name="line.700"></a>
<span class="sourceLineNo">701</span>   * Create an observer.<a name="line.701"></a>
<span class="sourceLineNo">702</span>   * The user must pass either the &lt;code&gt;tracked&lt;/code&gt; or &lt;code&gt;onDepsUpdated&lt;/code&gt; or both parameters.<a name="line.702"></a>
<span class="sourceLineNo">703</span>   *<a name="line.703"></a>
<span class="sourceLineNo">704</span>   * @param name          the name of the observer.<a name="line.704"></a>
<span class="sourceLineNo">705</span>   * @param tracked       the executable tracked by the observer. May be null if observer is externally scheduled.<a name="line.705"></a>
<span class="sourceLineNo">706</span>   * @param onDepsUpdated the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.<a name="line.706"></a>
<span class="sourceLineNo">707</span>   * @param flags         the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.707"></a>
<span class="sourceLineNo">708</span>   * @return the new Observer.<a name="line.708"></a>
<span class="sourceLineNo">709</span>   */<a name="line.709"></a>
<span class="sourceLineNo">710</span>  @Nonnull<a name="line.710"></a>
<span class="sourceLineNo">711</span>  public Observer observer( @Nullable final String name,<a name="line.711"></a>
<span class="sourceLineNo">712</span>                            @Nullable final Procedure tracked,<a name="line.712"></a>
<span class="sourceLineNo">713</span>                            @Nullable final Procedure onDepsUpdated,<a name="line.713"></a>
<span class="sourceLineNo">714</span>                            final int flags )<a name="line.714"></a>
<span class="sourceLineNo">715</span>  {<a name="line.715"></a>
<span class="sourceLineNo">716</span>    return observer( null, name, tracked, onDepsUpdated, flags );<a name="line.716"></a>
<span class="sourceLineNo">717</span>  }<a name="line.717"></a>
<span class="sourceLineNo">718</span><a name="line.718"></a>
<span class="sourceLineNo">719</span>  /**<a name="line.719"></a>
<span class="sourceLineNo">720</span>   * Create an observer.<a name="line.720"></a>
<span class="sourceLineNo">721</span>   * The user must pass either the &lt;code&gt;tracked&lt;/code&gt; or &lt;code&gt;onDepsUpdated&lt;/code&gt; or both parameters.<a name="line.721"></a>
<span class="sourceLineNo">722</span>   *<a name="line.722"></a>
<span class="sourceLineNo">723</span>   * @param component     the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.723"></a>
<span class="sourceLineNo">724</span>   * @param name          the name of the observer.<a name="line.724"></a>
<span class="sourceLineNo">725</span>   * @param tracked       the executable tracked by the observer. May be null if observer is externally scheduled.<a name="line.725"></a>
<span class="sourceLineNo">726</span>   * @param onDepsUpdated the hook invoked when dependencies changed. If this is non-null then it is expected that hook will manually schedule the observer by calling {@link Observer#schedule()} at some point.<a name="line.726"></a>
<span class="sourceLineNo">727</span>   * @param flags         the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.727"></a>
<span class="sourceLineNo">728</span>   * @return the new Observer.<a name="line.728"></a>
<span class="sourceLineNo">729</span>   */<a name="line.729"></a>
<span class="sourceLineNo">730</span>  @Nonnull<a name="line.730"></a>
<span class="sourceLineNo">731</span>  public Observer observer( @Nullable final Component component,<a name="line.731"></a>
<span class="sourceLineNo">732</span>                            @Nullable final String name,<a name="line.732"></a>
<span class="sourceLineNo">733</span>                            @Nullable final Procedure tracked,<a name="line.733"></a>
<span class="sourceLineNo">734</span>                            @Nullable final Procedure onDepsUpdated,<a name="line.734"></a>
<span class="sourceLineNo">735</span>                            final int flags )<a name="line.735"></a>
<span class="sourceLineNo">736</span>  {<a name="line.736"></a>
<span class="sourceLineNo">737</span>    return new Observer( Arez.areZonesEnabled() ? this : null,<a name="line.737"></a>
<span class="sourceLineNo">738</span>                         component,<a name="line.738"></a>
<span class="sourceLineNo">739</span>                         generateNodeName( "Observer", name ),<a name="line.739"></a>
<span class="sourceLineNo">740</span>                         tracked,<a name="line.740"></a>
<span class="sourceLineNo">741</span>                         onDepsUpdated,<a name="line.741"></a>
<span class="sourceLineNo">742</span>                         flags );<a name="line.742"></a>
<span class="sourceLineNo">743</span>  }<a name="line.743"></a>
<span class="sourceLineNo">744</span><a name="line.744"></a>
<span class="sourceLineNo">745</span>  /**<a name="line.745"></a>
<span class="sourceLineNo">746</span>   * Create a tracking observer. The tracking observer triggers the onDepsUpdated hook function when<a name="line.746"></a>
<span class="sourceLineNo">747</span>   * dependencies in the tracked function are updated. Application code is responsible for executing the<a name="line.747"></a>
<span class="sourceLineNo">748</span>   * tracked function by invoking a track method such as {@link #track(Observer, Function, Object...)}.<a name="line.748"></a>
<span class="sourceLineNo">749</span>   *<a name="line.749"></a>
<span class="sourceLineNo">750</span>   * @param onDepsUpdated the hook invoked when dependencies changed.<a name="line.750"></a>
<span class="sourceLineNo">751</span>   * @return the new Observer.<a name="line.751"></a>
<span class="sourceLineNo">752</span>   */<a name="line.752"></a>
<span class="sourceLineNo">753</span>  @Nonnull<a name="line.753"></a>
<span class="sourceLineNo">754</span>  public Observer tracker( @Nonnull final Procedure onDepsUpdated )<a name="line.754"></a>
<span class="sourceLineNo">755</span>  {<a name="line.755"></a>
<span class="sourceLineNo">756</span>    return tracker( onDepsUpdated, 0 );<a name="line.756"></a>
<span class="sourceLineNo">757</span>  }<a name="line.757"></a>
<span class="sourceLineNo">758</span><a name="line.758"></a>
<span class="sourceLineNo">759</span>  /**<a name="line.759"></a>
<span class="sourceLineNo">760</span>   * Create a tracking observer. The tracking observer triggers the onDepsUpdated hook function when<a name="line.760"></a>
<span class="sourceLineNo">761</span>   * dependencies in the tracked function are updated. Application code is responsible for executing the<a name="line.761"></a>
<span class="sourceLineNo">762</span>   * tracked function by invoking a track method such as {@link #track(Observer, Function, Object...)}.<a name="line.762"></a>
<span class="sourceLineNo">763</span>   *<a name="line.763"></a>
<span class="sourceLineNo">764</span>   * @param onDepsUpdated the hook invoked when dependencies changed.<a name="line.764"></a>
<span class="sourceLineNo">765</span>   * @param flags         the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.765"></a>
<span class="sourceLineNo">766</span>   * @return the new Observer.<a name="line.766"></a>
<span class="sourceLineNo">767</span>   */<a name="line.767"></a>
<span class="sourceLineNo">768</span>  @Nonnull<a name="line.768"></a>
<span class="sourceLineNo">769</span>  public Observer tracker( @Nonnull final Procedure onDepsUpdated, final int flags )<a name="line.769"></a>
<span class="sourceLineNo">770</span>  {<a name="line.770"></a>
<span class="sourceLineNo">771</span>    return tracker( null, onDepsUpdated, flags );<a name="line.771"></a>
<span class="sourceLineNo">772</span>  }<a name="line.772"></a>
<span class="sourceLineNo">773</span><a name="line.773"></a>
<span class="sourceLineNo">774</span>  /**<a name="line.774"></a>
<span class="sourceLineNo">775</span>   * Create a tracking observer. The tracking observer triggers the onDepsUpdated hook function when<a name="line.775"></a>
<span class="sourceLineNo">776</span>   * dependencies in the tracked function are updated. Application code is responsible for executing the<a name="line.776"></a>
<span class="sourceLineNo">777</span>   * tracked function by invoking a track method such as {@link #track(Observer, Function, Object...)}.<a name="line.777"></a>
<span class="sourceLineNo">778</span>   *<a name="line.778"></a>
<span class="sourceLineNo">779</span>   * @param name          the name of the observer.<a name="line.779"></a>
<span class="sourceLineNo">780</span>   * @param onDepsUpdated the hook invoked when dependencies changed.<a name="line.780"></a>
<span class="sourceLineNo">781</span>   * @return the new Observer.<a name="line.781"></a>
<span class="sourceLineNo">782</span>   */<a name="line.782"></a>
<span class="sourceLineNo">783</span>  @Nonnull<a name="line.783"></a>
<span class="sourceLineNo">784</span>  public Observer tracker( @Nullable final String name, @Nonnull final Procedure onDepsUpdated )<a name="line.784"></a>
<span class="sourceLineNo">785</span>  {<a name="line.785"></a>
<span class="sourceLineNo">786</span>    return tracker( name, onDepsUpdated, 0 );<a name="line.786"></a>
<span class="sourceLineNo">787</span>  }<a name="line.787"></a>
<span class="sourceLineNo">788</span><a name="line.788"></a>
<span class="sourceLineNo">789</span>  /**<a name="line.789"></a>
<span class="sourceLineNo">790</span>   * Create a tracking observer. The tracking observer triggers the onDepsUpdated hook function when<a name="line.790"></a>
<span class="sourceLineNo">791</span>   * dependencies in the tracked function are updated. Application code is responsible for executing the<a name="line.791"></a>
<span class="sourceLineNo">792</span>   * tracked function by invoking a track method such as {@link #track(Observer, Function, Object...)}.<a name="line.792"></a>
<span class="sourceLineNo">793</span>   *<a name="line.793"></a>
<span class="sourceLineNo">794</span>   * @param name          the name of the observer.<a name="line.794"></a>
<span class="sourceLineNo">795</span>   * @param onDepsUpdated the hook invoked when dependencies changed.<a name="line.795"></a>
<span class="sourceLineNo">796</span>   * @param flags         the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.796"></a>
<span class="sourceLineNo">797</span>   * @return the new Observer.<a name="line.797"></a>
<span class="sourceLineNo">798</span>   */<a name="line.798"></a>
<span class="sourceLineNo">799</span>  @Nonnull<a name="line.799"></a>
<span class="sourceLineNo">800</span>  public Observer tracker( @Nullable final String name, @Nonnull final Procedure onDepsUpdated, final int flags )<a name="line.800"></a>
<span class="sourceLineNo">801</span>  {<a name="line.801"></a>
<span class="sourceLineNo">802</span>    return tracker( null, name, onDepsUpdated, flags );<a name="line.802"></a>
<span class="sourceLineNo">803</span>  }<a name="line.803"></a>
<span class="sourceLineNo">804</span><a name="line.804"></a>
<span class="sourceLineNo">805</span>  /**<a name="line.805"></a>
<span class="sourceLineNo">806</span>   * Create a tracking observer. The tracking observer triggers the onDepsUpdated hook function when<a name="line.806"></a>
<span class="sourceLineNo">807</span>   * dependencies in the tracked function are updated. Application code is responsible for executing the<a name="line.807"></a>
<span class="sourceLineNo">808</span>   * tracked function by invoking a track method such as {@link #track(Observer, Function, Object...)}.<a name="line.808"></a>
<span class="sourceLineNo">809</span>   *<a name="line.809"></a>
<span class="sourceLineNo">810</span>   * @param component     the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.810"></a>
<span class="sourceLineNo">811</span>   * @param name          the name of the observer.<a name="line.811"></a>
<span class="sourceLineNo">812</span>   * @param onDepsUpdated the hook invoked when dependencies changed.<a name="line.812"></a>
<span class="sourceLineNo">813</span>   * @return the new Observer.<a name="line.813"></a>
<span class="sourceLineNo">814</span>   */<a name="line.814"></a>
<span class="sourceLineNo">815</span>  @Nonnull<a name="line.815"></a>
<span class="sourceLineNo">816</span>  public Observer tracker( @Nullable final Component component,<a name="line.816"></a>
<span class="sourceLineNo">817</span>                           @Nullable final String name,<a name="line.817"></a>
<span class="sourceLineNo">818</span>                           @Nonnull final Procedure onDepsUpdated )<a name="line.818"></a>
<span class="sourceLineNo">819</span>  {<a name="line.819"></a>
<span class="sourceLineNo">820</span>    return tracker( component, name, onDepsUpdated, 0 );<a name="line.820"></a>
<span class="sourceLineNo">821</span>  }<a name="line.821"></a>
<span class="sourceLineNo">822</span><a name="line.822"></a>
<span class="sourceLineNo">823</span>  /**<a name="line.823"></a>
<span class="sourceLineNo">824</span>   * Create a tracking observer. The tracking observer triggers the onDepsUpdated hook function when<a name="line.824"></a>
<span class="sourceLineNo">825</span>   * dependencies in the tracked function are updated. Application code is responsible for executing the<a name="line.825"></a>
<span class="sourceLineNo">826</span>   * tracked function by invoking a track method such as {@link #track(Observer, Function, Object...)}.<a name="line.826"></a>
<span class="sourceLineNo">827</span>   *<a name="line.827"></a>
<span class="sourceLineNo">828</span>   * @param component     the component containing the observer if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.828"></a>
<span class="sourceLineNo">829</span>   * @param name          the name of the observer.<a name="line.829"></a>
<span class="sourceLineNo">830</span>   * @param onDepsUpdated the hook invoked when dependencies changed.<a name="line.830"></a>
<span class="sourceLineNo">831</span>   * @param flags         the flags used to create the observer. The acceptable flags are defined in {@link Flags}.<a name="line.831"></a>
<span class="sourceLineNo">832</span>   * @return the new Observer.<a name="line.832"></a>
<span class="sourceLineNo">833</span>   */<a name="line.833"></a>
<span class="sourceLineNo">834</span>  @Nonnull<a name="line.834"></a>
<span class="sourceLineNo">835</span>  public Observer tracker( @Nullable final Component component,<a name="line.835"></a>
<span class="sourceLineNo">836</span>                           @Nullable final String name,<a name="line.836"></a>
<span class="sourceLineNo">837</span>                           @Nonnull final Procedure onDepsUpdated,<a name="line.837"></a>
<span class="sourceLineNo">838</span>                           final int flags )<a name="line.838"></a>
<span class="sourceLineNo">839</span>  {<a name="line.839"></a>
<span class="sourceLineNo">840</span>    return observer( component, name, null, Objects.requireNonNull( onDepsUpdated ), flags );<a name="line.840"></a>
<span class="sourceLineNo">841</span>  }<a name="line.841"></a>
<span class="sourceLineNo">842</span><a name="line.842"></a>
<span class="sourceLineNo">843</span>  /**<a name="line.843"></a>
<span class="sourceLineNo">844</span>   * Create an ObservableValue synthesizing name if required.<a name="line.844"></a>
<span class="sourceLineNo">845</span>   *<a name="line.845"></a>
<span class="sourceLineNo">846</span>   * @param &lt;T&gt; the type of observable.<a name="line.846"></a>
<span class="sourceLineNo">847</span>   * @return the new ObservableValue.<a name="line.847"></a>
<span class="sourceLineNo">848</span>   */<a name="line.848"></a>
<span class="sourceLineNo">849</span>  @Nonnull<a name="line.849"></a>
<span class="sourceLineNo">850</span>  public &lt;T&gt; ObservableValue&lt;T&gt; observable()<a name="line.850"></a>
<span class="sourceLineNo">851</span>  {<a name="line.851"></a>
<span class="sourceLineNo">852</span>    return observable( null );<a name="line.852"></a>
<span class="sourceLineNo">853</span>  }<a name="line.853"></a>
<span class="sourceLineNo">854</span><a name="line.854"></a>
<span class="sourceLineNo">855</span>  /**<a name="line.855"></a>
<span class="sourceLineNo">856</span>   * Create an ObservableValue with the specified name.<a name="line.856"></a>
<span class="sourceLineNo">857</span>   *<a name="line.857"></a>
<span class="sourceLineNo">858</span>   * @param name the name of the ObservableValue. Should be non null if {@link Arez#areNamesEnabled()} returns true, null otherwise.<a name="line.858"></a>
<span class="sourceLineNo">859</span>   * @param &lt;T&gt;  the type of observable.<a name="line.859"></a>
<span class="sourceLineNo">860</span>   * @return the new ObservableValue.<a name="line.860"></a>
<span class="sourceLineNo">861</span>   */<a name="line.861"></a>
<span class="sourceLineNo">862</span>  @Nonnull<a name="line.862"></a>
<span class="sourceLineNo">863</span>  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final String name )<a name="line.863"></a>
<span class="sourceLineNo">864</span>  {<a name="line.864"></a>
<span class="sourceLineNo">865</span>    return observable( name, null, null );<a name="line.865"></a>
<span class="sourceLineNo">866</span>  }<a name="line.866"></a>
<span class="sourceLineNo">867</span><a name="line.867"></a>
<span class="sourceLineNo">868</span>  /**<a name="line.868"></a>
<span class="sourceLineNo">869</span>   * Create an ObservableValue.<a name="line.869"></a>
<span class="sourceLineNo">870</span>   *<a name="line.870"></a>
<span class="sourceLineNo">871</span>   * @param name     the name of the observable. Should be non null if {@link Arez#areNamesEnabled()} returns true, null otherwise.<a name="line.871"></a>
<span class="sourceLineNo">872</span>   * @param accessor the accessor for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.<a name="line.872"></a>
<span class="sourceLineNo">873</span>   * @param mutator  the mutator for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.<a name="line.873"></a>
<span class="sourceLineNo">874</span>   * @param &lt;T&gt;      the type of observable.<a name="line.874"></a>
<span class="sourceLineNo">875</span>   * @return the new ObservableValue.<a name="line.875"></a>
<span class="sourceLineNo">876</span>   */<a name="line.876"></a>
<span class="sourceLineNo">877</span>  @Nonnull<a name="line.877"></a>
<span class="sourceLineNo">878</span>  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final String name,<a name="line.878"></a>
<span class="sourceLineNo">879</span>                                            @Nullable final PropertyAccessor&lt;T&gt; accessor,<a name="line.879"></a>
<span class="sourceLineNo">880</span>                                            @Nullable final PropertyMutator&lt;T&gt; mutator )<a name="line.880"></a>
<span class="sourceLineNo">881</span>  {<a name="line.881"></a>
<span class="sourceLineNo">882</span>    return observable( null, name, accessor, mutator );<a name="line.882"></a>
<span class="sourceLineNo">883</span>  }<a name="line.883"></a>
<span class="sourceLineNo">884</span><a name="line.884"></a>
<span class="sourceLineNo">885</span>  /**<a name="line.885"></a>
<span class="sourceLineNo">886</span>   * Create an ObservableValue.<a name="line.886"></a>
<span class="sourceLineNo">887</span>   *<a name="line.887"></a>
<span class="sourceLineNo">888</span>   * @param &lt;T&gt;       The type of the value that is observable.<a name="line.888"></a>
<span class="sourceLineNo">889</span>   * @param component the component containing observable if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.889"></a>
<span class="sourceLineNo">890</span>   * @param name      the name of the observable. Should be non null if {@link Arez#areNamesEnabled()} returns true, null otherwise.<a name="line.890"></a>
<span class="sourceLineNo">891</span>   * @return the new ObservableValue.<a name="line.891"></a>
<span class="sourceLineNo">892</span>   */<a name="line.892"></a>
<span class="sourceLineNo">893</span>  @Nonnull<a name="line.893"></a>
<span class="sourceLineNo">894</span>  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final Component component,<a name="line.894"></a>
<span class="sourceLineNo">895</span>                                            @Nullable final String name )<a name="line.895"></a>
<span class="sourceLineNo">896</span>  {<a name="line.896"></a>
<span class="sourceLineNo">897</span>    return observable( component, name, null );<a name="line.897"></a>
<span class="sourceLineNo">898</span>  }<a name="line.898"></a>
<span class="sourceLineNo">899</span><a name="line.899"></a>
<span class="sourceLineNo">900</span>  /**<a name="line.900"></a>
<span class="sourceLineNo">901</span>   * Create an ObservableValue.<a name="line.901"></a>
<span class="sourceLineNo">902</span>   *<a name="line.902"></a>
<span class="sourceLineNo">903</span>   * @param &lt;T&gt;       The type of the value that is observable.<a name="line.903"></a>
<span class="sourceLineNo">904</span>   * @param component the component containing observable if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.904"></a>
<span class="sourceLineNo">905</span>   * @param name      the name of the observable. Should be non null if {@link Arez#areNamesEnabled()} returns true, null otherwise.<a name="line.905"></a>
<span class="sourceLineNo">906</span>   * @param accessor  the accessor for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.<a name="line.906"></a>
<span class="sourceLineNo">907</span>   * @return the new ObservableValue.<a name="line.907"></a>
<span class="sourceLineNo">908</span>   */<a name="line.908"></a>
<span class="sourceLineNo">909</span>  @Nonnull<a name="line.909"></a>
<span class="sourceLineNo">910</span>  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final Component component,<a name="line.910"></a>
<span class="sourceLineNo">911</span>                                            @Nullable final String name,<a name="line.911"></a>
<span class="sourceLineNo">912</span>                                            @Nullable final PropertyAccessor&lt;T&gt; accessor )<a name="line.912"></a>
<span class="sourceLineNo">913</span>  {<a name="line.913"></a>
<span class="sourceLineNo">914</span>    return observable( component, name, accessor, null );<a name="line.914"></a>
<span class="sourceLineNo">915</span>  }<a name="line.915"></a>
<span class="sourceLineNo">916</span><a name="line.916"></a>
<span class="sourceLineNo">917</span>  /**<a name="line.917"></a>
<span class="sourceLineNo">918</span>   * Create an ObservableValue.<a name="line.918"></a>
<span class="sourceLineNo">919</span>   *<a name="line.919"></a>
<span class="sourceLineNo">920</span>   * @param &lt;T&gt;       The type of the value that is observable.<a name="line.920"></a>
<span class="sourceLineNo">921</span>   * @param component the component containing observable if any. Should be null if {@link Arez#areNativeComponentsEnabled()} returns false.<a name="line.921"></a>
<span class="sourceLineNo">922</span>   * @param name      the name of the observable. Should be non null if {@link Arez#areNamesEnabled()} returns true, null otherwise.<a name="line.922"></a>
<span class="sourceLineNo">923</span>   * @param accessor  the accessor for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.<a name="line.923"></a>
<span class="sourceLineNo">924</span>   * @param mutator   the mutator for observable. Should be null if {@link Arez#arePropertyIntrospectorsEnabled()} returns false, may be non-null otherwise.<a name="line.924"></a>
<span class="sourceLineNo">925</span>   * @return the new ObservableValue.<a name="line.925"></a>
<span class="sourceLineNo">926</span>   */<a name="line.926"></a>
<span class="sourceLineNo">927</span>  @Nonnull<a name="line.927"></a>
<span class="sourceLineNo">928</span>  public &lt;T&gt; ObservableValue&lt;T&gt; observable( @Nullable final Component component,<a name="line.928"></a>
<span class="sourceLineNo">929</span>                                            @Nullable final String name,<a name="line.929"></a>
<span class="sourceLineNo">930</span>                                            @Nullable final PropertyAccessor&lt;T&gt; accessor,<a name="line.930"></a>
<span class="sourceLineNo">931</span>                                            @Nullable final PropertyMutator&lt;T&gt; mutator )<a name="line.931"></a>
<span class="sourceLineNo">932</span>  {<a name="line.932"></a>
<span class="sourceLineNo">933</span>    final ObservableValue&lt;T&gt; observableValue =<a name="line.933"></a>
<span class="sourceLineNo">934</span>      new ObservableValue&lt;&gt;( Arez.areZonesEnabled() ? this : null,<a name="line.934"></a>
<span class="sourceLineNo">935</span>                             component,<a name="line.935"></a>
<span class="sourceLineNo">936</span>                             generateNodeName( "ObservableValue", name ),<a name="line.936"></a>
<span class="sourceLineNo">937</span>                             null,<a name="line.937"></a>
<span class="sourceLineNo">938</span>                             accessor,<a name="line.938"></a>
<span class="sourceLineNo">939</span>                             mutator );<a name="line.939"></a>
<span class="sourceLineNo">940</span>    if ( willPropagateSpyEvents() )<a name="line.940"></a>
<span class="sourceLineNo">941</span>    {<a name="line.941"></a>
<span class="sourceLineNo">942</span>      getSpy().reportSpyEvent( new ObservableValueCreatedEvent( observableValue.asInfo() ) );<a name="line.942"></a>
<span class="sourceLineNo">943</span>    }<a name="line.943"></a>
<span class="sourceLineNo">944</span>    return observableValue;<a name="line.944"></a>
<span class="sourceLineNo">945</span>  }<a name="line.945"></a>
<span class="sourceLineNo">946</span><a name="line.946"></a>
<span class="sourceLineNo">947</span>  /**<a name="line.947"></a>
<span class="sourceLineNo">948</span>   * Pass the supplied observer to the scheduler.<a name="line.948"></a>
<span class="sourceLineNo">949</span>   * The observer should NOT be already pending execution.<a name="line.949"></a>
<span class="sourceLineNo">950</span>   *<a name="line.950"></a>
<span class="sourceLineNo">951</span>   * @param observer the reaction to schedule.<a name="line.951"></a>
<span class="sourceLineNo">952</span>   */<a name="line.952"></a>
<span class="sourceLineNo">953</span>  void scheduleReaction( @Nonnull final Observer observer )<a name="line.953"></a>
<span class="sourceLineNo">954</span>  {<a name="line.954"></a>
<span class="sourceLineNo">955</span>    if ( willPropagateSpyEvents() )<a name="line.955"></a>
<span class="sourceLineNo">956</span>    {<a name="line.956"></a>
<span class="sourceLineNo">957</span>      getSpy().reportSpyEvent( new ReactionScheduledEvent( observer.asInfo() ) );<a name="line.957"></a>
<span class="sourceLineNo">958</span>    }<a name="line.958"></a>
<span class="sourceLineNo">959</span>    if ( Arez.shouldEnforceTransactionType() &amp;&amp; isTransactionActive() &amp;&amp; Arez.shouldCheckInvariants() )<a name="line.959"></a>
<span class="sourceLineNo">960</span>    {<a name="line.960"></a>
<span class="sourceLineNo">961</span>      invariant( () -&gt; getTransaction().isMutation() || getTransaction().isComputedValueTracker(),<a name="line.961"></a>
<span class="sourceLineNo">962</span>                 () -&gt; "Arez-0013: Observer named '" + observer.getName() + "' attempted to be scheduled during " +<a name="line.962"></a>
<span class="sourceLineNo">963</span>                       "read-only transaction." );<a name="line.963"></a>
<span class="sourceLineNo">964</span>      invariant( () -&gt; getTransaction().getTracker() != observer ||<a name="line.964"></a>
<span class="sourceLineNo">965</span>                       getTransaction().isMutation(),<a name="line.965"></a>
<span class="sourceLineNo">966</span>                 () -&gt; "Arez-0014: Observer named '" + observer.getName() + "' attempted to schedule itself during " +<a name="line.966"></a>
<span class="sourceLineNo">967</span>                       "read-only tracking transaction. Observers that are supporting ComputedValue instances " +<a name="line.967"></a>
<span class="sourceLineNo">968</span>                       "must not schedule self." );<a name="line.968"></a>
<span class="sourceLineNo">969</span>    }<a name="line.969"></a>
<span class="sourceLineNo">970</span>    _scheduler.scheduleReaction( observer );<a name="line.970"></a>
<span class="sourceLineNo">971</span>  }<a name="line.971"></a>
<span class="sourceLineNo">972</span><a name="line.972"></a>
<span class="sourceLineNo">973</span>  /**<a name="line.973"></a>
<span class="sourceLineNo">974</span>   * Return true if there is a transaction in progress.<a name="line.974"></a>
<span class="sourceLineNo">975</span>   *<a name="line.975"></a>
<span class="sourceLineNo">976</span>   * @return true if there is a transaction in progress.<a name="line.976"></a>
<span class="sourceLineNo">977</span>   */<a name="line.977"></a>
<span class="sourceLineNo">978</span>  public boolean isTransactionActive()<a name="line.978"></a>
<span class="sourceLineNo">979</span>  {<a name="line.979"></a>
<span class="sourceLineNo">980</span>    return Transaction.isTransactionActive( this );<a name="line.980"></a>
<span class="sourceLineNo">981</span>  }<a name="line.981"></a>
<span class="sourceLineNo">982</span><a name="line.982"></a>
<span class="sourceLineNo">983</span>  /**<a name="line.983"></a>
<span class="sourceLineNo">984</span>   * Return true if there is a tracking transaction in progress.<a name="line.984"></a>
<span class="sourceLineNo">985</span>   * A tracking transaction is one created by an {@link Observer} via the {@link #observer(Procedure)}<a name="line.985"></a>
<span class="sourceLineNo">986</span>   * or {@link #tracker(Procedure)} methods.<a name="line.986"></a>
<span class="sourceLineNo">987</span>   *<a name="line.987"></a>
<span class="sourceLineNo">988</span>   * @return true if there is a tracking transaction in progress.<a name="line.988"></a>
<span class="sourceLineNo">989</span>   */<a name="line.989"></a>
<span class="sourceLineNo">990</span>  public boolean isTrackingTransactionActive()<a name="line.990"></a>
<span class="sourceLineNo">991</span>  {<a name="line.991"></a>
<span class="sourceLineNo">992</span>    return Transaction.isTransactionActive( this ) &amp;&amp; null != Transaction.current().getTracker();<a name="line.992"></a>
<span class="sourceLineNo">993</span>  }<a name="line.993"></a>
<span class="sourceLineNo">994</span><a name="line.994"></a>
<span class="sourceLineNo">995</span>  /**<a name="line.995"></a>
<span class="sourceLineNo">996</span>   * Return true if there is a read-write transaction in progress.<a name="line.996"></a>
<span class="sourceLineNo">997</span>   *<a name="line.997"></a>
<span class="sourceLineNo">998</span>   * @return true if there is a read-write transaction in progress.<a name="line.998"></a>
<span class="sourceLineNo">999</span>   */<a name="line.999"></a>
<span class="sourceLineNo">1000</span>  public boolean isWriteTransactionActive()<a name="line.1000"></a>
<span class="sourceLineNo">1001</span>  {<a name="line.1001"></a>
<span class="sourceLineNo">1002</span>    return Transaction.isTransactionActive( this ) &amp;&amp;<a name="line.1002"></a>
<span class="sourceLineNo">1003</span>           ( !Arez.shouldEnforceTransactionType() || Transaction.current().isMutation() );<a name="line.1003"></a>
<span class="sourceLineNo">1004</span>  }<a name="line.1004"></a>
<span class="sourceLineNo">1005</span><a name="line.1005"></a>
<span class="sourceLineNo">1006</span>  /**<a name="line.1006"></a>
<span class="sourceLineNo">1007</span>   * Return the current transaction.<a name="line.1007"></a>
<span class="sourceLineNo">1008</span>   * This method should not be invoked unless a transaction active and will throw an<a name="line.1008"></a>
<span class="sourceLineNo">1009</span>   * exception if invariant checks are enabled.<a name="line.1009"></a>
<span class="sourceLineNo">1010</span>   *<a name="line.1010"></a>
<span class="sourceLineNo">1011</span>   * @return the current transaction.<a name="line.1011"></a>
<span class="sourceLineNo">1012</span>   */<a name="line.1012"></a>
<span class="sourceLineNo">1013</span>  @Nonnull<a name="line.1013"></a>
<span class="sourceLineNo">1014</span>  Transaction getTransaction()<a name="line.1014"></a>
<span class="sourceLineNo">1015</span>  {<a name="line.1015"></a>
<span class="sourceLineNo">1016</span>    final Transaction current = Transaction.current();<a name="line.1016"></a>
<span class="sourceLineNo">1017</span>    if ( Arez.shouldCheckInvariants() )<a name="line.1017"></a>
<span class="sourceLineNo">1018</span>    {<a name="line.1018"></a>
<span class="sourceLineNo">1019</span>      invariant( () -&gt; !Arez.areZonesEnabled() || current.getContext() == this,<a name="line.1019"></a>
<span class="sourceLineNo">1020</span>                 () -&gt; "Arez-0015: Attempting to get current transaction but current transaction is for different context." );<a name="line.1020"></a>
<span class="sourceLineNo">1021</span>    }<a name="line.1021"></a>
<span class="sourceLineNo">1022</span>    return current;<a name="line.1022"></a>
<span class="sourceLineNo">1023</span>  }<a name="line.1023"></a>
<span class="sourceLineNo">1024</span><a name="line.1024"></a>
<span class="sourceLineNo">1025</span>  /**<a name="line.1025"></a>
<span class="sourceLineNo">1026</span>   * Enable scheduler so that it will run pending observers next time it is triggered.<a name="line.1026"></a>
<span class="sourceLineNo">1027</span>   */<a name="line.1027"></a>
<span class="sourceLineNo">1028</span>  void enableScheduler()<a name="line.1028"></a>
<span class="sourceLineNo">1029</span>  {<a name="line.1029"></a>
<span class="sourceLineNo">1030</span>    _schedulerEnabled = true;<a name="line.1030"></a>
<span class="sourceLineNo">1031</span>  }<a name="line.1031"></a>
<span class="sourceLineNo">1032</span><a name="line.1032"></a>
<span class="sourceLineNo">1033</span>  /**<a name="line.1033"></a>
<span class="sourceLineNo">1034</span>   * Disable scheduler so that it will not run pending observers next time it is triggered.<a name="line.1034"></a>
<span class="sourceLineNo">1035</span>   */<a name="line.1035"></a>
<span class="sourceLineNo">1036</span>  void disableScheduler()<a name="line.1036"></a>
<span class="sourceLineNo">1037</span>  {<a name="line.1037"></a>
<span class="sourceLineNo">1038</span>    _schedulerEnabled = false;<a name="line.1038"></a>
<span class="sourceLineNo">1039</span>  }<a name="line.1039"></a>
<span class="sourceLineNo">1040</span><a name="line.1040"></a>
<span class="sourceLineNo">1041</span>  /**<a name="line.1041"></a>
<span class="sourceLineNo">1042</span>   * Return true if the scheduler enabled flag is true.<a name="line.1042"></a>
<span class="sourceLineNo">1043</span>   * It is still possible that the scheduler has un-released locks so this<a name="line.1043"></a>
<span class="sourceLineNo">1044</span>   * does not necessarily imply that the schedule will run.<a name="line.1044"></a>
<span class="sourceLineNo">1045</span>   *<a name="line.1045"></a>
<span class="sourceLineNo">1046</span>   * @return true if the scheduler enabled flag is true.<a name="line.1046"></a>
<span class="sourceLineNo">1047</span>   */<a name="line.1047"></a>
<span class="sourceLineNo">1048</span>  boolean isSchedulerEnabled()<a name="line.1048"></a>
<span class="sourceLineNo">1049</span>  {<a name="line.1049"></a>
<span class="sourceLineNo">1050</span>    return _schedulerEnabled;<a name="line.1050"></a>
<span class="sourceLineNo">1051</span>  }<a name="line.1051"></a>
<span class="sourceLineNo">1052</span><a name="line.1052"></a>
<span class="sourceLineNo">1053</span>  /**<a name="line.1053"></a>
<span class="sourceLineNo">1054</span>   * Release a scheduler lock to enable scheduler to run again.<a name="line.1054"></a>
<span class="sourceLineNo">1055</span>   * Trigger reactions if lock reaches 0 and no current transaction.<a name="line.1055"></a>
<span class="sourceLineNo">1056</span>   */<a name="line.1056"></a>
<span class="sourceLineNo">1057</span>  void releaseSchedulerLock()<a name="line.1057"></a>
<span class="sourceLineNo">1058</span>  {<a name="line.1058"></a>
<span class="sourceLineNo">1059</span>    _schedulerLockCount--;<a name="line.1059"></a>
<span class="sourceLineNo">1060</span>    if ( Arez.shouldCheckInvariants() )<a name="line.1060"></a>
<span class="sourceLineNo">1061</span>    {<a name="line.1061"></a>
<span class="sourceLineNo">1062</span>      invariant( () -&gt; _schedulerLockCount &gt;= 0,<a name="line.1062"></a>
<span class="sourceLineNo">1063</span>                 () -&gt; "Arez-0016: releaseSchedulerLock() reduced schedulerLockCount below 0." );<a name="line.1063"></a>
<span class="sourceLineNo">1064</span>    }<a name="line.1064"></a>
<span class="sourceLineNo">1065</span>    triggerScheduler();<a name="line.1065"></a>
<span class="sourceLineNo">1066</span>  }<a name="line.1066"></a>
<span class="sourceLineNo">1067</span><a name="line.1067"></a>
<span class="sourceLineNo">1068</span>  /**<a name="line.1068"></a>
<span class="sourceLineNo">1069</span>   * Return true if the scheduler is paused.<a name="line.1069"></a>
<span class="sourceLineNo">1070</span>   * True means that {@link #pauseScheduler()} has been called one or more times and the lock not disposed.<a name="line.1070"></a>
<span class="sourceLineNo">1071</span>   *<a name="line.1071"></a>
<span class="sourceLineNo">1072</span>   * @return true if the scheduler is paused, false otherwise.<a name="line.1072"></a>
<span class="sourceLineNo">1073</span>   */<a name="line.1073"></a>
<span class="sourceLineNo">1074</span>  public boolean isSchedulerPaused()<a name="line.1074"></a>
<span class="sourceLineNo">1075</span>  {<a name="line.1075"></a>
<span class="sourceLineNo">1076</span>    return _schedulerLockCount != 0;<a name="line.1076"></a>
<span class="sourceLineNo">1077</span>  }<a name="line.1077"></a>
<span class="sourceLineNo">1078</span><a name="line.1078"></a>
<span class="sourceLineNo">1079</span>  /**<a name="line.1079"></a>
<span class="sourceLineNo">1080</span>   * Pause scheduler so that it will not run any reactions next time {@link #triggerScheduler()} is invoked.<a name="line.1080"></a>
<span class="sourceLineNo">1081</span>   * The scheduler will not resume scheduling reactions until the lock returned from this method is disposed.<a name="line.1081"></a>
<span class="sourceLineNo">1082</span>   *<a name="line.1082"></a>
<span class="sourceLineNo">1083</span>   * &lt;p&gt;The intention of this method is to allow the user to manually batch multiple actions, before<a name="line.1083"></a>
<span class="sourceLineNo">1084</span>   * disposing the lock and allowing reactions to flow through the system. A typical use-case is when<a name="line.1084"></a>
<span class="sourceLineNo">1085</span>   * a large network packet is received and processed over multiple ticks but you only want the<a name="line.1085"></a>
<span class="sourceLineNo">1086</span>   * application to react once.&lt;/p&gt;<a name="line.1086"></a>
<span class="sourceLineNo">1087</span>   *<a name="line.1087"></a>
<span class="sourceLineNo">1088</span>   * &lt;p&gt;If this is invoked from within a reaction then the current behaviour will continue to process any<a name="line.1088"></a>
<span class="sourceLineNo">1089</span>   * pending reactions until there is none left. However this behaviour should not be relied upon as it may<a name="line.1089"></a>
<span class="sourceLineNo">1090</span>   * result in an abort in the future.&lt;/p&gt;<a name="line.1090"></a>
<span class="sourceLineNo">1091</span>   *<a name="line.1091"></a>
<span class="sourceLineNo">1092</span>   * &lt;p&gt;It should be noted that this is the one way where inconsistent state can creep into an Arez application.<a name="line.1092"></a>
<span class="sourceLineNo">1093</span>   * If an external action can trigger while the scheduler is paused. i.e. In the browser when an<a name="line.1093"></a>
<span class="sourceLineNo">1094</span>   * event-handler calls back from UI when the reactions have not run. Thus the event handler could be<a name="line.1094"></a>
<span class="sourceLineNo">1095</span>   * based on stale data. If this can occur the developer should &lt;/p&gt;<a name="line.1095"></a>
<span class="sourceLineNo">1096</span>   *<a name="line.1096"></a>
<span class="sourceLineNo">1097</span>   * @return a lock on scheduler.<a name="line.1097"></a>
<span class="sourceLineNo">1098</span>   */<a name="line.1098"></a>
<span class="sourceLineNo">1099</span>  @Nonnull<a name="line.1099"></a>
<span class="sourceLineNo">1100</span>  public Disposable pauseScheduler()<a name="line.1100"></a>
<span class="sourceLineNo">1101</span>  {<a name="line.1101"></a>
<span class="sourceLineNo">1102</span>    _schedulerLockCount++;<a name="line.1102"></a>
<span class="sourceLineNo">1103</span>    return new SchedulerLock( Arez.areZonesEnabled() ? this : null );<a name="line.1103"></a>
<span class="sourceLineNo">1104</span>  }<a name="line.1104"></a>
<span class="sourceLineNo">1105</span><a name="line.1105"></a>
<span class="sourceLineNo">1106</span>  /**<a name="line.1106"></a>
<span class="sourceLineNo">1107</span>   * Specify the environment in which reactions are invoked.<a name="line.1107"></a>
<span class="sourceLineNo">1108</span>   *<a name="line.1108"></a>
<span class="sourceLineNo">1109</span>   * @param environment the environment in which to execute reactions.<a name="line.1109"></a>
<span class="sourceLineNo">1110</span>   */<a name="line.1110"></a>
<span class="sourceLineNo">1111</span>  public void setEnvironment( @Nullable final ReactionEnvironment environment )<a name="line.1111"></a>
<span class="sourceLineNo">1112</span>  {<a name="line.1112"></a>
<span class="sourceLineNo">1113</span>    _environment = environment;<a name="line.1113"></a>
<span class="sourceLineNo">1114</span>  }<a name="line.1114"></a>
<span class="sourceLineNo">1115</span><a name="line.1115"></a>
<span class="sourceLineNo">1116</span>  /**<a name="line.1116"></a>
<span class="sourceLineNo">1117</span>   * Method invoked to trigger the scheduler to run any pending reactions. The scheduler will only be<a name="line.1117"></a>
<span class="sourceLineNo">1118</span>   * triggered if there is no transaction active. This method is typically used after one or more Observers<a name="line.1118"></a>
<span class="sourceLineNo">1119</span>   * have been created outside a transaction with the runImmediately flag set to false and the caller wants<a name="line.1119"></a>
<span class="sourceLineNo">1120</span>   * to force the observers to react. Otherwise the Observers will not be schedule until the next top-level<a name="line.1120"></a>
<span class="sourceLineNo">1121</span>   * transaction completes. Pending reactions are run in the environment specified by {@link #setEnvironment(ReactionEnvironment)}<a name="line.1121"></a>
<span class="sourceLineNo">1122</span>   * if any has been specified.<a name="line.1122"></a>
<span class="sourceLineNo">1123</span>   */<a name="line.1123"></a>
<span class="sourceLineNo">1124</span>  public void triggerScheduler()<a name="line.1124"></a>
<span class="sourceLineNo">1125</span>  {<a name="line.1125"></a>
<span class="sourceLineNo">1126</span>    if ( isSchedulerEnabled() &amp;&amp; !isSchedulerPaused() )<a name="line.1126"></a>
<span class="sourceLineNo">1127</span>    {<a name="line.1127"></a>
<span class="sourceLineNo">1128</span>      // Each reaction creates a top level transaction that attempts to run call<a name="line.1128"></a>
<span class="sourceLineNo">1129</span>      // this method when it completes. Rather than allow this if it is detected<a name="line.1129"></a>
<span class="sourceLineNo">1130</span>      // that we are running reactions already then just abort and assume the top<a name="line.1130"></a>
<span class="sourceLineNo">1131</span>      // most invocation of runPendingTasks will handle scheduling<a name="line.1131"></a>
<span class="sourceLineNo">1132</span>      if ( !_schedulerActive )<a name="line.1132"></a>
<span class="sourceLineNo">1133</span>      {<a name="line.1133"></a>
<span class="sourceLineNo">1134</span>        _schedulerActive = true;<a name="line.1134"></a>
<span class="sourceLineNo">1135</span>        try<a name="line.1135"></a>
<span class="sourceLineNo">1136</span>        {<a name="line.1136"></a>
<span class="sourceLineNo">1137</span>          if ( null != _environment )<a name="line.1137"></a>
<span class="sourceLineNo">1138</span>          {<a name="line.1138"></a>
<span class="sourceLineNo">1139</span>            // The environment wrapper can perform actions that trigger the need for the Arez<a name="line.1139"></a>
<span class="sourceLineNo">1140</span>            // scheduler to re-run so we keep checking until there is no more work to be done.<a name="line.1140"></a>
<span class="sourceLineNo">1141</span>            // This is typically used when the environment reacts to changes that Arez triggered<a name="line.1141"></a>
<span class="sourceLineNo">1142</span>            // (i.e. via @Track callbacks) which in turn reschedules Arez changes. This happens<a name="line.1142"></a>
<span class="sourceLineNo">1143</span>            // in frameworks like react4j which have only scheduler that responds to changes and<a name="line.1143"></a>
<span class="sourceLineNo">1144</span>            // feeds back into Arez.<a name="line.1144"></a>
<span class="sourceLineNo">1145</span>            do<a name="line.1145"></a>
<span class="sourceLineNo">1146</span>            {<a name="line.1146"></a>
<span class="sourceLineNo">1147</span>              _environment.run( _scheduler::runPendingTasks );<a name="line.1147"></a>
<span class="sourceLineNo">1148</span>            }<a name="line.1148"></a>
<span class="sourceLineNo">1149</span>            while ( _scheduler.hasTasksToSchedule() );<a name="line.1149"></a>
<span class="sourceLineNo">1150</span>          }<a name="line.1150"></a>
<span class="sourceLineNo">1151</span>          else<a name="line.1151"></a>
<span class="sourceLineNo">1152</span>          {<a name="line.1152"></a>
<span class="sourceLineNo">1153</span>            _scheduler.runPendingTasks();<a name="line.1153"></a>
<span class="sourceLineNo">1154</span>          }<a name="line.1154"></a>
<span class="sourceLineNo">1155</span>        }<a name="line.1155"></a>
<span class="sourceLineNo">1156</span>        finally<a name="line.1156"></a>
<span class="sourceLineNo">1157</span>        {<a name="line.1157"></a>
<span class="sourceLineNo">1158</span>          _schedulerActive = false;<a name="line.1158"></a>
<span class="sourceLineNo">1159</span>        }<a name="line.1159"></a>
<span class="sourceLineNo">1160</span>      }<a name="line.1160"></a>
<span class="sourceLineNo">1161</span>    }<a name="line.1161"></a>
<span class="sourceLineNo">1162</span>  }<a name="line.1162"></a>
<span class="sourceLineNo">1163</span><a name="line.1163"></a>
<span class="sourceLineNo">1164</span>  /**<a name="line.1164"></a>
<span class="sourceLineNo">1165</span>   * Add the specified disposable to the list of pending disposables.<a name="line.1165"></a>
<span class="sourceLineNo">1166</span>   * The disposable must not already be in the list of pending observers.<a name="line.1166"></a>
<span class="sourceLineNo">1167</span>   * The disposable will be processed before the next top-level reaction.<a name="line.1167"></a>
<span class="sourceLineNo">1168</span>   *<a name="line.1168"></a>
<span class="sourceLineNo">1169</span>   * @param disposable the disposable.<a name="line.1169"></a>
<span class="sourceLineNo">1170</span>   */<a name="line.1170"></a>
<span class="sourceLineNo">1171</span>  public void scheduleDispose( @Nonnull final Disposable disposable )<a name="line.1171"></a>
<span class="sourceLineNo">1172</span>  {<a name="line.1172"></a>
<span class="sourceLineNo">1173</span>    _scheduler.scheduleDispose( disposable );<a name="line.1173"></a>
<span class="sourceLineNo">1174</span>  }<a name="line.1174"></a>
<span class="sourceLineNo">1175</span><a name="line.1175"></a>
<span class="sourceLineNo">1176</span>  /**<a name="line.1176"></a>
<span class="sourceLineNo">1177</span>   * Execute the supplied executable in a read-write transaction.<a name="line.1177"></a>
<span class="sourceLineNo">1178</span>   * The name is synthesized if {@link Arez#areNamesEnabled()} returns true.<a name="line.1178"></a>
<span class="sourceLineNo">1179</span>   * The executable may throw an exception.<a name="line.1179"></a>
<span class="sourceLineNo">1180</span>   *<a name="line.1180"></a>
<span class="sourceLineNo">1181</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1181"></a>
<span class="sourceLineNo">1182</span>   * @param executable the executable.<a name="line.1182"></a>
<span class="sourceLineNo">1183</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1183"></a>
<span class="sourceLineNo">1184</span>   * @return the value returned from the executable.<a name="line.1184"></a>
<span class="sourceLineNo">1185</span>   * @throws Exception if the executable throws an an exception.<a name="line.1185"></a>
<span class="sourceLineNo">1186</span>   */<a name="line.1186"></a>
<span class="sourceLineNo">1187</span>  public &lt;T&gt; T action( @Nonnull final Function&lt;T&gt; executable, @Nonnull final Object... parameters )<a name="line.1187"></a>
<span class="sourceLineNo">1188</span>    throws Throwable<a name="line.1188"></a>
<span class="sourceLineNo">1189</span>  {<a name="line.1189"></a>
<span class="sourceLineNo">1190</span>    return action( true, executable, parameters );<a name="line.1190"></a>
<span class="sourceLineNo">1191</span>  }<a name="line.1191"></a>
<span class="sourceLineNo">1192</span><a name="line.1192"></a>
<span class="sourceLineNo">1193</span>  /**<a name="line.1193"></a>
<span class="sourceLineNo">1194</span>   * Execute the supplied executable in a transaction.<a name="line.1194"></a>
<span class="sourceLineNo">1195</span>   * The name is synthesized if {@link Arez#areNamesEnabled()} returns true.<a name="line.1195"></a>
<span class="sourceLineNo">1196</span>   * The executable may throw an exception.<a name="line.1196"></a>
<span class="sourceLineNo">1197</span>   *<a name="line.1197"></a>
<span class="sourceLineNo">1198</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1198"></a>
<span class="sourceLineNo">1199</span>   * @param mutation   true if the action may modify state, false otherwise.<a name="line.1199"></a>
<span class="sourceLineNo">1200</span>   * @param executable the function to execute.<a name="line.1200"></a>
<span class="sourceLineNo">1201</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1201"></a>
<span class="sourceLineNo">1202</span>   * @return the value returned from the executable.<a name="line.1202"></a>
<span class="sourceLineNo">1203</span>   * @throws Exception if the executable throws an an exception.<a name="line.1203"></a>
<span class="sourceLineNo">1204</span>   */<a name="line.1204"></a>
<span class="sourceLineNo">1205</span>  public &lt;T&gt; T action( final boolean mutation,<a name="line.1205"></a>
<span class="sourceLineNo">1206</span>                       @Nonnull final Function&lt;T&gt; executable,<a name="line.1206"></a>
<span class="sourceLineNo">1207</span>                       @Nonnull final Object... parameters )<a name="line.1207"></a>
<span class="sourceLineNo">1208</span>    throws Throwable<a name="line.1208"></a>
<span class="sourceLineNo">1209</span>  {<a name="line.1209"></a>
<span class="sourceLineNo">1210</span>    return action( null, mutation, executable, parameters );<a name="line.1210"></a>
<span class="sourceLineNo">1211</span>  }<a name="line.1211"></a>
<span class="sourceLineNo">1212</span><a name="line.1212"></a>
<span class="sourceLineNo">1213</span>  /**<a name="line.1213"></a>
<span class="sourceLineNo">1214</span>   * Execute the supplied executable in a transaction.<a name="line.1214"></a>
<span class="sourceLineNo">1215</span>   * The executable may throw an exception.<a name="line.1215"></a>
<span class="sourceLineNo">1216</span>   *<a name="line.1216"></a>
<span class="sourceLineNo">1217</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1217"></a>
<span class="sourceLineNo">1218</span>   * @param name       the name of the transaction.<a name="line.1218"></a>
<span class="sourceLineNo">1219</span>   * @param executable the executable.<a name="line.1219"></a>
<span class="sourceLineNo">1220</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1220"></a>
<span class="sourceLineNo">1221</span>   * @return the value returned from the executable.<a name="line.1221"></a>
<span class="sourceLineNo">1222</span>   * @throws Exception if the executable throws an an exception.<a name="line.1222"></a>
<span class="sourceLineNo">1223</span>   */<a name="line.1223"></a>
<span class="sourceLineNo">1224</span>  public &lt;T&gt; T action( @Nullable final String name,<a name="line.1224"></a>
<span class="sourceLineNo">1225</span>                       @Nonnull final Function&lt;T&gt; executable,<a name="line.1225"></a>
<span class="sourceLineNo">1226</span>                       @Nonnull final Object... parameters )<a name="line.1226"></a>
<span class="sourceLineNo">1227</span>    throws Throwable<a name="line.1227"></a>
<span class="sourceLineNo">1228</span>  {<a name="line.1228"></a>
<span class="sourceLineNo">1229</span>    return action( name, true, executable, parameters );<a name="line.1229"></a>
<span class="sourceLineNo">1230</span>  }<a name="line.1230"></a>
<span class="sourceLineNo">1231</span><a name="line.1231"></a>
<span class="sourceLineNo">1232</span>  /**<a name="line.1232"></a>
<span class="sourceLineNo">1233</span>   * Execute the supplied executable in a transaction.<a name="line.1233"></a>
<span class="sourceLineNo">1234</span>   * The executable may throw an exception.<a name="line.1234"></a>
<span class="sourceLineNo">1235</span>   *<a name="line.1235"></a>
<span class="sourceLineNo">1236</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1236"></a>
<span class="sourceLineNo">1237</span>   * @param name       the name of the transaction.<a name="line.1237"></a>
<span class="sourceLineNo">1238</span>   * @param mutation   true if the action may modify state, false otherwise.<a name="line.1238"></a>
<span class="sourceLineNo">1239</span>   * @param executable the executable.<a name="line.1239"></a>
<span class="sourceLineNo">1240</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1240"></a>
<span class="sourceLineNo">1241</span>   * @return the value returned from the executable.<a name="line.1241"></a>
<span class="sourceLineNo">1242</span>   * @throws Exception if the executable throws an an exception.<a name="line.1242"></a>
<span class="sourceLineNo">1243</span>   */<a name="line.1243"></a>
<span class="sourceLineNo">1244</span>  public &lt;T&gt; T action( @Nullable final String name,<a name="line.1244"></a>
<span class="sourceLineNo">1245</span>                       final boolean mutation,<a name="line.1245"></a>
<span class="sourceLineNo">1246</span>                       @Nonnull final Function&lt;T&gt; executable,<a name="line.1246"></a>
<span class="sourceLineNo">1247</span>                       @Nonnull final Object... parameters )<a name="line.1247"></a>
<span class="sourceLineNo">1248</span>    throws Throwable<a name="line.1248"></a>
<span class="sourceLineNo">1249</span>  {<a name="line.1249"></a>
<span class="sourceLineNo">1250</span>    return action( name, mutation, true, executable, parameters );<a name="line.1250"></a>
<span class="sourceLineNo">1251</span>  }<a name="line.1251"></a>
<span class="sourceLineNo">1252</span><a name="line.1252"></a>
<span class="sourceLineNo">1253</span>  /**<a name="line.1253"></a>
<span class="sourceLineNo">1254</span>   * Execute the supplied executable in a transaction.<a name="line.1254"></a>
<span class="sourceLineNo">1255</span>   * The executable may throw an exception.<a name="line.1255"></a>
<span class="sourceLineNo">1256</span>   *<a name="line.1256"></a>
<span class="sourceLineNo">1257</span>   * @param &lt;T&gt;                  the type of return value.<a name="line.1257"></a>
<span class="sourceLineNo">1258</span>   * @param name                 the name of the transaction.<a name="line.1258"></a>
<span class="sourceLineNo">1259</span>   * @param mutation             true if the action may modify state, false otherwise.<a name="line.1259"></a>
<span class="sourceLineNo">1260</span>   * @param verifyActionRequired true if the action will add invariant checks to ensure reads or writes occur within<a name="line.1260"></a>
<span class="sourceLineNo">1261</span>   *                             the scope of the action. If no reads or writes occur, the action need not be an<a name="line.1261"></a>
<span class="sourceLineNo">1262</span>   *                             action.<a name="line.1262"></a>
<span class="sourceLineNo">1263</span>   * @param executable           the executable.<a name="line.1263"></a>
<span class="sourceLineNo">1264</span>   * @param parameters           the parameters if any. The parameters are only used to generate a spy event.<a name="line.1264"></a>
<span class="sourceLineNo">1265</span>   * @return the value returned from the executable.<a name="line.1265"></a>
<span class="sourceLineNo">1266</span>   * @throws Exception if the executable throws an an exception.<a name="line.1266"></a>
<span class="sourceLineNo">1267</span>   */<a name="line.1267"></a>
<span class="sourceLineNo">1268</span>  public &lt;T&gt; T action( @Nullable final String name,<a name="line.1268"></a>
<span class="sourceLineNo">1269</span>                       final boolean mutation,<a name="line.1269"></a>
<span class="sourceLineNo">1270</span>                       final boolean verifyActionRequired,<a name="line.1270"></a>
<span class="sourceLineNo">1271</span>                       @Nonnull final Function&lt;T&gt; executable,<a name="line.1271"></a>
<span class="sourceLineNo">1272</span>                       @Nonnull final Object... parameters )<a name="line.1272"></a>
<span class="sourceLineNo">1273</span>    throws Throwable<a name="line.1273"></a>
<span class="sourceLineNo">1274</span>  {<a name="line.1274"></a>
<span class="sourceLineNo">1275</span>    return action( name, mutation, verifyActionRequired, true, executable, parameters );<a name="line.1275"></a>
<span class="sourceLineNo">1276</span>  }<a name="line.1276"></a>
<span class="sourceLineNo">1277</span><a name="line.1277"></a>
<span class="sourceLineNo">1278</span>  /**<a name="line.1278"></a>
<span class="sourceLineNo">1279</span>   * Execute the supplied executable in a transaction.<a name="line.1279"></a>
<span class="sourceLineNo">1280</span>   * The executable may throw an exception.<a name="line.1280"></a>
<span class="sourceLineNo">1281</span>   *<a name="line.1281"></a>
<span class="sourceLineNo">1282</span>   * @param &lt;T&gt;                   the type of return value.<a name="line.1282"></a>
<span class="sourceLineNo">1283</span>   * @param name                  the name of the transaction.<a name="line.1283"></a>
<span class="sourceLineNo">1284</span>   * @param mutation              true if the action may modify state, false otherwise.<a name="line.1284"></a>
<span class="sourceLineNo">1285</span>   * @param verifyActionRequired  true if the action will add invariant checks to ensure reads or writes occur within<a name="line.1285"></a>
<span class="sourceLineNo">1286</span>   *                              the scope of the action. If no reads or writes occur, the action need not be an<a name="line.1286"></a>
<span class="sourceLineNo">1287</span>   *                              action.<a name="line.1287"></a>
<span class="sourceLineNo">1288</span>   * @param requireNewTransaction true if a new transaction should be created, false if can use the current transaction.<a name="line.1288"></a>
<span class="sourceLineNo">1289</span>   * @param executable            the executable.<a name="line.1289"></a>
<span class="sourceLineNo">1290</span>   * @param parameters            the parameters if any. The parameters are only used to generate a spy event.<a name="line.1290"></a>
<span class="sourceLineNo">1291</span>   * @return the value returned from the executable.<a name="line.1291"></a>
<span class="sourceLineNo">1292</span>   * @throws Exception if the executable throws an an exception.<a name="line.1292"></a>
<span class="sourceLineNo">1293</span>   */<a name="line.1293"></a>
<span class="sourceLineNo">1294</span>  public &lt;T&gt; T action( @Nullable final String name,<a name="line.1294"></a>
<span class="sourceLineNo">1295</span>                       final boolean mutation,<a name="line.1295"></a>
<span class="sourceLineNo">1296</span>                       final boolean verifyActionRequired,<a name="line.1296"></a>
<span class="sourceLineNo">1297</span>                       final boolean requireNewTransaction,<a name="line.1297"></a>
<span class="sourceLineNo">1298</span>                       @Nonnull final Function&lt;T&gt; executable,<a name="line.1298"></a>
<span class="sourceLineNo">1299</span>                       @Nonnull final Object... parameters )<a name="line.1299"></a>
<span class="sourceLineNo">1300</span>    throws Throwable<a name="line.1300"></a>
<span class="sourceLineNo">1301</span>  {<a name="line.1301"></a>
<span class="sourceLineNo">1302</span>    return action( generateNodeName( "Transaction", name ),<a name="line.1302"></a>
<span class="sourceLineNo">1303</span>                   mutation,<a name="line.1303"></a>
<span class="sourceLineNo">1304</span>                   verifyActionRequired,<a name="line.1304"></a>
<span class="sourceLineNo">1305</span>                   requireNewTransaction,<a name="line.1305"></a>
<span class="sourceLineNo">1306</span>                   executable,<a name="line.1306"></a>
<span class="sourceLineNo">1307</span>                   null,<a name="line.1307"></a>
<span class="sourceLineNo">1308</span>                   parameters );<a name="line.1308"></a>
<span class="sourceLineNo">1309</span>  }<a name="line.1309"></a>
<span class="sourceLineNo">1310</span><a name="line.1310"></a>
<span class="sourceLineNo">1311</span>  /**<a name="line.1311"></a>
<span class="sourceLineNo">1312</span>   * Execute the supplied executable with the specified Observer as the tracker.<a name="line.1312"></a>
<span class="sourceLineNo">1313</span>   * The Observer must be created by the {@link #tracker(Procedure)} methods.<a name="line.1313"></a>
<span class="sourceLineNo">1314</span>   * The executable may throw an exception.<a name="line.1314"></a>
<span class="sourceLineNo">1315</span>   *<a name="line.1315"></a>
<span class="sourceLineNo">1316</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1316"></a>
<span class="sourceLineNo">1317</span>   * @param tracker    the tracking Observer.<a name="line.1317"></a>
<span class="sourceLineNo">1318</span>   * @param executable the executable.<a name="line.1318"></a>
<span class="sourceLineNo">1319</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1319"></a>
<span class="sourceLineNo">1320</span>   * @return the value returned from the executable.<a name="line.1320"></a>
<span class="sourceLineNo">1321</span>   * @throws Exception if the executable throws an an exception.<a name="line.1321"></a>
<span class="sourceLineNo">1322</span>   */<a name="line.1322"></a>
<span class="sourceLineNo">1323</span>  public &lt;T&gt; T track( @Nonnull final Observer tracker,<a name="line.1323"></a>
<span class="sourceLineNo">1324</span>                      @Nonnull final Function&lt;T&gt; executable,<a name="line.1324"></a>
<span class="sourceLineNo">1325</span>                      @Nonnull final Object... parameters )<a name="line.1325"></a>
<span class="sourceLineNo">1326</span>    throws Throwable<a name="line.1326"></a>
<span class="sourceLineNo">1327</span>  {<a name="line.1327"></a>
<span class="sourceLineNo">1328</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.1328"></a>
<span class="sourceLineNo">1329</span>    {<a name="line.1329"></a>
<span class="sourceLineNo">1330</span>      apiInvariant( tracker::isExternalTracker,<a name="line.1330"></a>
<span class="sourceLineNo">1331</span>                    () -&gt; "Arez-0017: Attempted to track Observer named '" + tracker.getName() + "' but " +<a name="line.1331"></a>
<span class="sourceLineNo">1332</span>                          "observer is not a tracker." );<a name="line.1332"></a>
<span class="sourceLineNo">1333</span>    }<a name="line.1333"></a>
<span class="sourceLineNo">1334</span>    return action( generateNodeName( tracker ),<a name="line.1334"></a>
<span class="sourceLineNo">1335</span>                   Arez.shouldEnforceTransactionType() &amp;&amp; tracker.isMutation(),<a name="line.1335"></a>
<span class="sourceLineNo">1336</span>                   false,<a name="line.1336"></a>
<span class="sourceLineNo">1337</span>                   true,<a name="line.1337"></a>
<span class="sourceLineNo">1338</span>                   executable,<a name="line.1338"></a>
<span class="sourceLineNo">1339</span>                   tracker,<a name="line.1339"></a>
<span class="sourceLineNo">1340</span>                   parameters );<a name="line.1340"></a>
<span class="sourceLineNo">1341</span>  }<a name="line.1341"></a>
<span class="sourceLineNo">1342</span><a name="line.1342"></a>
<span class="sourceLineNo">1343</span>  private &lt;T&gt; T action( @Nullable final String name,<a name="line.1343"></a>
<span class="sourceLineNo">1344</span>                        final boolean mutation,<a name="line.1344"></a>
<span class="sourceLineNo">1345</span>                        final boolean verifyActionRequired,<a name="line.1345"></a>
<span class="sourceLineNo">1346</span>                        final boolean requireNewTransaction,<a name="line.1346"></a>
<span class="sourceLineNo">1347</span>                        @Nonnull final Function&lt;T&gt; executable,<a name="line.1347"></a>
<span class="sourceLineNo">1348</span>                        @Nullable final Observer tracker,<a name="line.1348"></a>
<span class="sourceLineNo">1349</span>                        @Nonnull final Object... parameters )<a name="line.1349"></a>
<span class="sourceLineNo">1350</span>    throws Throwable<a name="line.1350"></a>
<span class="sourceLineNo">1351</span>  {<a name="line.1351"></a>
<span class="sourceLineNo">1352</span>    final boolean tracked = null != tracker;<a name="line.1352"></a>
<span class="sourceLineNo">1353</span>    Throwable t = null;<a name="line.1353"></a>
<span class="sourceLineNo">1354</span>    boolean completed = false;<a name="line.1354"></a>
<span class="sourceLineNo">1355</span>    long startedAt = 0L;<a name="line.1355"></a>
<span class="sourceLineNo">1356</span>    T result;<a name="line.1356"></a>
<span class="sourceLineNo">1357</span>    try<a name="line.1357"></a>
<span class="sourceLineNo">1358</span>    {<a name="line.1358"></a>
<span class="sourceLineNo">1359</span>      if ( willPropagateSpyEvents() )<a name="line.1359"></a>
<span class="sourceLineNo">1360</span>      {<a name="line.1360"></a>
<span class="sourceLineNo">1361</span>        startedAt = System.currentTimeMillis();<a name="line.1361"></a>
<span class="sourceLineNo">1362</span>        assert null != name;<a name="line.1362"></a>
<span class="sourceLineNo">1363</span>        getSpy().reportSpyEvent( new ActionStartedEvent( name, tracked, parameters ) );<a name="line.1363"></a>
<span class="sourceLineNo">1364</span>      }<a name="line.1364"></a>
<span class="sourceLineNo">1365</span>      verifyActionNestingAllowed( name, tracker );<a name="line.1365"></a>
<span class="sourceLineNo">1366</span>      if ( canImmediatelyInvokeAction( mutation, requireNewTransaction ) )<a name="line.1366"></a>
<span class="sourceLineNo">1367</span>      {<a name="line.1367"></a>
<span class="sourceLineNo">1368</span>        result = executable.call();<a name="line.1368"></a>
<span class="sourceLineNo">1369</span>      }<a name="line.1369"></a>
<span class="sourceLineNo">1370</span>      else<a name="line.1370"></a>
<span class="sourceLineNo">1371</span>      {<a name="line.1371"></a>
<span class="sourceLineNo">1372</span>        final Transaction transaction =<a name="line.1372"></a>
<span class="sourceLineNo">1373</span>          Transaction.begin( this, generateNodeName( "Transaction", name ), mutation, tracker );<a name="line.1373"></a>
<span class="sourceLineNo">1374</span>        try<a name="line.1374"></a>
<span class="sourceLineNo">1375</span>        {<a name="line.1375"></a>
<span class="sourceLineNo">1376</span>          result = executable.call();<a name="line.1376"></a>
<span class="sourceLineNo">1377</span>          verifyActionRequired( transaction, name, verifyActionRequired );<a name="line.1377"></a>
<span class="sourceLineNo">1378</span>        }<a name="line.1378"></a>
<span class="sourceLineNo">1379</span>        finally<a name="line.1379"></a>
<span class="sourceLineNo">1380</span>        {<a name="line.1380"></a>
<span class="sourceLineNo">1381</span>          Transaction.commit( transaction );<a name="line.1381"></a>
<span class="sourceLineNo">1382</span>        }<a name="line.1382"></a>
<span class="sourceLineNo">1383</span>      }<a name="line.1383"></a>
<span class="sourceLineNo">1384</span>      if ( willPropagateSpyEvents() )<a name="line.1384"></a>
<span class="sourceLineNo">1385</span>      {<a name="line.1385"></a>
<span class="sourceLineNo">1386</span>        completed = true;<a name="line.1386"></a>
<span class="sourceLineNo">1387</span>        final long duration = System.currentTimeMillis() - startedAt;<a name="line.1387"></a>
<span class="sourceLineNo">1388</span>        assert null != name;<a name="line.1388"></a>
<span class="sourceLineNo">1389</span>        getSpy().reportSpyEvent( new ActionCompletedEvent( name, tracked, parameters, true, result, null, duration ) );<a name="line.1389"></a>
<span class="sourceLineNo">1390</span>      }<a name="line.1390"></a>
<span class="sourceLineNo">1391</span>      return result;<a name="line.1391"></a>
<span class="sourceLineNo">1392</span>    }<a name="line.1392"></a>
<span class="sourceLineNo">1393</span>    catch ( final Throwable e )<a name="line.1393"></a>
<span class="sourceLineNo">1394</span>    {<a name="line.1394"></a>
<span class="sourceLineNo">1395</span>      t = e;<a name="line.1395"></a>
<span class="sourceLineNo">1396</span>      throw e;<a name="line.1396"></a>
<span class="sourceLineNo">1397</span>    }<a name="line.1397"></a>
<span class="sourceLineNo">1398</span>    finally<a name="line.1398"></a>
<span class="sourceLineNo">1399</span>    {<a name="line.1399"></a>
<span class="sourceLineNo">1400</span>      if ( willPropagateSpyEvents() )<a name="line.1400"></a>
<span class="sourceLineNo">1401</span>      {<a name="line.1401"></a>
<span class="sourceLineNo">1402</span>        if ( !completed )<a name="line.1402"></a>
<span class="sourceLineNo">1403</span>        {<a name="line.1403"></a>
<span class="sourceLineNo">1404</span>          final long duration = System.currentTimeMillis() - startedAt;<a name="line.1404"></a>
<span class="sourceLineNo">1405</span>          assert null != name;<a name="line.1405"></a>
<span class="sourceLineNo">1406</span>          getSpy().reportSpyEvent( new ActionCompletedEvent( name, tracked, parameters, true, null, t, duration ) );<a name="line.1406"></a>
<span class="sourceLineNo">1407</span>        }<a name="line.1407"></a>
<span class="sourceLineNo">1408</span>      }<a name="line.1408"></a>
<span class="sourceLineNo">1409</span>      triggerScheduler();<a name="line.1409"></a>
<span class="sourceLineNo">1410</span>    }<a name="line.1410"></a>
<span class="sourceLineNo">1411</span>  }<a name="line.1411"></a>
<span class="sourceLineNo">1412</span><a name="line.1412"></a>
<span class="sourceLineNo">1413</span>  /**<a name="line.1413"></a>
<span class="sourceLineNo">1414</span>   * Execute the supplied executable in a read-write transaction.<a name="line.1414"></a>
<span class="sourceLineNo">1415</span>   * The executable is should not throw an exception.<a name="line.1415"></a>
<span class="sourceLineNo">1416</span>   *<a name="line.1416"></a>
<span class="sourceLineNo">1417</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1417"></a>
<span class="sourceLineNo">1418</span>   * @param executable the executable.<a name="line.1418"></a>
<span class="sourceLineNo">1419</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1419"></a>
<span class="sourceLineNo">1420</span>   * @return the value returned from the executable.<a name="line.1420"></a>
<span class="sourceLineNo">1421</span>   */<a name="line.1421"></a>
<span class="sourceLineNo">1422</span>  public &lt;T&gt; T safeAction( @Nonnull final SafeFunction&lt;T&gt; executable, @Nonnull final Object... parameters )<a name="line.1422"></a>
<span class="sourceLineNo">1423</span>  {<a name="line.1423"></a>
<span class="sourceLineNo">1424</span>    return safeAction( true, executable, parameters );<a name="line.1424"></a>
<span class="sourceLineNo">1425</span>  }<a name="line.1425"></a>
<span class="sourceLineNo">1426</span><a name="line.1426"></a>
<span class="sourceLineNo">1427</span>  /**<a name="line.1427"></a>
<span class="sourceLineNo">1428</span>   * Execute the supplied function in a transaction.<a name="line.1428"></a>
<span class="sourceLineNo">1429</span>   * The executable is should not throw an exception.<a name="line.1429"></a>
<span class="sourceLineNo">1430</span>   *<a name="line.1430"></a>
<span class="sourceLineNo">1431</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1431"></a>
<span class="sourceLineNo">1432</span>   * @param mutation   true if the action may modify state, false otherwise.<a name="line.1432"></a>
<span class="sourceLineNo">1433</span>   * @param executable the executable.<a name="line.1433"></a>
<span class="sourceLineNo">1434</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1434"></a>
<span class="sourceLineNo">1435</span>   * @return the value returned from the executable.<a name="line.1435"></a>
<span class="sourceLineNo">1436</span>   */<a name="line.1436"></a>
<span class="sourceLineNo">1437</span>  public &lt;T&gt; T safeAction( final boolean mutation,<a name="line.1437"></a>
<span class="sourceLineNo">1438</span>                           @Nonnull final SafeFunction&lt;T&gt; executable,<a name="line.1438"></a>
<span class="sourceLineNo">1439</span>                           @Nonnull final Object... parameters )<a name="line.1439"></a>
<span class="sourceLineNo">1440</span>  {<a name="line.1440"></a>
<span class="sourceLineNo">1441</span>    return safeAction( null, mutation, executable, parameters );<a name="line.1441"></a>
<span class="sourceLineNo">1442</span>  }<a name="line.1442"></a>
<span class="sourceLineNo">1443</span><a name="line.1443"></a>
<span class="sourceLineNo">1444</span>  /**<a name="line.1444"></a>
<span class="sourceLineNo">1445</span>   * Execute the supplied executable in a read-write transaction.<a name="line.1445"></a>
<span class="sourceLineNo">1446</span>   * The executable is should not throw an exception.<a name="line.1446"></a>
<span class="sourceLineNo">1447</span>   *<a name="line.1447"></a>
<span class="sourceLineNo">1448</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1448"></a>
<span class="sourceLineNo">1449</span>   * @param name       the name of the transaction.<a name="line.1449"></a>
<span class="sourceLineNo">1450</span>   * @param executable the executable.<a name="line.1450"></a>
<span class="sourceLineNo">1451</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1451"></a>
<span class="sourceLineNo">1452</span>   * @return the value returned from the executable.<a name="line.1452"></a>
<span class="sourceLineNo">1453</span>   */<a name="line.1453"></a>
<span class="sourceLineNo">1454</span>  public &lt;T&gt; T safeAction( @Nullable final String name,<a name="line.1454"></a>
<span class="sourceLineNo">1455</span>                           @Nonnull final SafeFunction&lt;T&gt; executable,<a name="line.1455"></a>
<span class="sourceLineNo">1456</span>                           @Nonnull final Object... parameters )<a name="line.1456"></a>
<span class="sourceLineNo">1457</span>  {<a name="line.1457"></a>
<span class="sourceLineNo">1458</span>    return safeAction( name, true, executable, parameters );<a name="line.1458"></a>
<span class="sourceLineNo">1459</span>  }<a name="line.1459"></a>
<span class="sourceLineNo">1460</span><a name="line.1460"></a>
<span class="sourceLineNo">1461</span>  /**<a name="line.1461"></a>
<span class="sourceLineNo">1462</span>   * Execute the supplied executable.<a name="line.1462"></a>
<span class="sourceLineNo">1463</span>   * The executable is should not throw an exception.<a name="line.1463"></a>
<span class="sourceLineNo">1464</span>   *<a name="line.1464"></a>
<span class="sourceLineNo">1465</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1465"></a>
<span class="sourceLineNo">1466</span>   * @param name       the name of the transaction.<a name="line.1466"></a>
<span class="sourceLineNo">1467</span>   * @param mutation   true if the action may modify state, false otherwise.<a name="line.1467"></a>
<span class="sourceLineNo">1468</span>   * @param executable the executable.<a name="line.1468"></a>
<span class="sourceLineNo">1469</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1469"></a>
<span class="sourceLineNo">1470</span>   * @return the value returned from the executable.<a name="line.1470"></a>
<span class="sourceLineNo">1471</span>   */<a name="line.1471"></a>
<span class="sourceLineNo">1472</span>  public &lt;T&gt; T safeAction( @Nullable final String name,<a name="line.1472"></a>
<span class="sourceLineNo">1473</span>                           final boolean mutation,<a name="line.1473"></a>
<span class="sourceLineNo">1474</span>                           @Nonnull final SafeFunction&lt;T&gt; executable,<a name="line.1474"></a>
<span class="sourceLineNo">1475</span>                           @Nonnull final Object... parameters )<a name="line.1475"></a>
<span class="sourceLineNo">1476</span>  {<a name="line.1476"></a>
<span class="sourceLineNo">1477</span>    return safeAction( name, mutation, true, executable, parameters );<a name="line.1477"></a>
<span class="sourceLineNo">1478</span>  }<a name="line.1478"></a>
<span class="sourceLineNo">1479</span><a name="line.1479"></a>
<span class="sourceLineNo">1480</span>  /**<a name="line.1480"></a>
<span class="sourceLineNo">1481</span>   * Execute the supplied executable.<a name="line.1481"></a>
<span class="sourceLineNo">1482</span>   * The executable is should not throw an exception.<a name="line.1482"></a>
<span class="sourceLineNo">1483</span>   *<a name="line.1483"></a>
<span class="sourceLineNo">1484</span>   * @param &lt;T&gt;                  the type of return value.<a name="line.1484"></a>
<span class="sourceLineNo">1485</span>   * @param name                 the name of the transaction.<a name="line.1485"></a>
<span class="sourceLineNo">1486</span>   * @param mutation             true if the action may modify state, false otherwise.<a name="line.1486"></a>
<span class="sourceLineNo">1487</span>   * @param verifyActionRequired true if the action will add invariant checks to ensure reads or writes occur within<a name="line.1487"></a>
<span class="sourceLineNo">1488</span>   *                             the scope of the action. If no reads or writes occur, the action need not be an<a name="line.1488"></a>
<span class="sourceLineNo">1489</span>   *                             action.<a name="line.1489"></a>
<span class="sourceLineNo">1490</span>   * @param executable           the executable.<a name="line.1490"></a>
<span class="sourceLineNo">1491</span>   * @param parameters           the parameters if any. The parameters are only used to generate a spy event.<a name="line.1491"></a>
<span class="sourceLineNo">1492</span>   * @return the value returned from the executable.<a name="line.1492"></a>
<span class="sourceLineNo">1493</span>   */<a name="line.1493"></a>
<span class="sourceLineNo">1494</span>  public &lt;T&gt; T safeAction( @Nullable final String name,<a name="line.1494"></a>
<span class="sourceLineNo">1495</span>                           final boolean mutation,<a name="line.1495"></a>
<span class="sourceLineNo">1496</span>                           final boolean verifyActionRequired,<a name="line.1496"></a>
<span class="sourceLineNo">1497</span>                           @Nonnull final SafeFunction&lt;T&gt; executable,<a name="line.1497"></a>
<span class="sourceLineNo">1498</span>                           @Nonnull final Object... parameters )<a name="line.1498"></a>
<span class="sourceLineNo">1499</span>  {<a name="line.1499"></a>
<span class="sourceLineNo">1500</span>    return safeAction( name, mutation, verifyActionRequired, true, executable, parameters );<a name="line.1500"></a>
<span class="sourceLineNo">1501</span>  }<a name="line.1501"></a>
<span class="sourceLineNo">1502</span><a name="line.1502"></a>
<span class="sourceLineNo">1503</span>  /**<a name="line.1503"></a>
<span class="sourceLineNo">1504</span>   * Execute the supplied executable.<a name="line.1504"></a>
<span class="sourceLineNo">1505</span>   * The executable is should not throw an exception.<a name="line.1505"></a>
<span class="sourceLineNo">1506</span>   *<a name="line.1506"></a>
<span class="sourceLineNo">1507</span>   * @param &lt;T&gt;                   the type of return value.<a name="line.1507"></a>
<span class="sourceLineNo">1508</span>   * @param name                  the name of the transaction.<a name="line.1508"></a>
<span class="sourceLineNo">1509</span>   * @param mutation              true if the action may modify state, false otherwise.<a name="line.1509"></a>
<span class="sourceLineNo">1510</span>   * @param verifyActionRequired  true if the action will add invariant checks to ensure reads or writes occur within<a name="line.1510"></a>
<span class="sourceLineNo">1511</span>   *                              the scope of the action. If no reads or writes occur, the action need not be an<a name="line.1511"></a>
<span class="sourceLineNo">1512</span>   *                              action.<a name="line.1512"></a>
<span class="sourceLineNo">1513</span>   * @param requireNewTransaction true if a new transaction should be created, false if can use the current transaction.<a name="line.1513"></a>
<span class="sourceLineNo">1514</span>   * @param executable            the executable.<a name="line.1514"></a>
<span class="sourceLineNo">1515</span>   * @param parameters            the parameters if any. The parameters are only used to generate a spy event.<a name="line.1515"></a>
<span class="sourceLineNo">1516</span>   * @return the value returned from the executable.<a name="line.1516"></a>
<span class="sourceLineNo">1517</span>   */<a name="line.1517"></a>
<span class="sourceLineNo">1518</span>  public &lt;T&gt; T safeAction( @Nullable final String name,<a name="line.1518"></a>
<span class="sourceLineNo">1519</span>                           final boolean mutation,<a name="line.1519"></a>
<span class="sourceLineNo">1520</span>                           final boolean verifyActionRequired,<a name="line.1520"></a>
<span class="sourceLineNo">1521</span>                           final boolean requireNewTransaction,<a name="line.1521"></a>
<span class="sourceLineNo">1522</span>                           @Nonnull final SafeFunction&lt;T&gt; executable,<a name="line.1522"></a>
<span class="sourceLineNo">1523</span>                           @Nonnull final Object... parameters )<a name="line.1523"></a>
<span class="sourceLineNo">1524</span>  {<a name="line.1524"></a>
<span class="sourceLineNo">1525</span>    return safeAction( generateNodeName( "Transaction", name ),<a name="line.1525"></a>
<span class="sourceLineNo">1526</span>                       mutation,<a name="line.1526"></a>
<span class="sourceLineNo">1527</span>                       verifyActionRequired,<a name="line.1527"></a>
<span class="sourceLineNo">1528</span>                       requireNewTransaction,<a name="line.1528"></a>
<span class="sourceLineNo">1529</span>                       executable,<a name="line.1529"></a>
<span class="sourceLineNo">1530</span>                       null,<a name="line.1530"></a>
<span class="sourceLineNo">1531</span>                       parameters );<a name="line.1531"></a>
<span class="sourceLineNo">1532</span>  }<a name="line.1532"></a>
<span class="sourceLineNo">1533</span><a name="line.1533"></a>
<span class="sourceLineNo">1534</span>  /**<a name="line.1534"></a>
<span class="sourceLineNo">1535</span>   * Execute the supplied executable with the specified Observer as the tracker.<a name="line.1535"></a>
<span class="sourceLineNo">1536</span>   * The Observer must be created by the {@link #tracker(Procedure)} methods.<a name="line.1536"></a>
<span class="sourceLineNo">1537</span>   * The executable is should not throw an exception.<a name="line.1537"></a>
<span class="sourceLineNo">1538</span>   *<a name="line.1538"></a>
<span class="sourceLineNo">1539</span>   * @param &lt;T&gt;        the type of return value.<a name="line.1539"></a>
<span class="sourceLineNo">1540</span>   * @param tracker    the tracking Observer.<a name="line.1540"></a>
<span class="sourceLineNo">1541</span>   * @param executable the executable.<a name="line.1541"></a>
<span class="sourceLineNo">1542</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1542"></a>
<span class="sourceLineNo">1543</span>   * @return the value returned from the executable.<a name="line.1543"></a>
<span class="sourceLineNo">1544</span>   */<a name="line.1544"></a>
<span class="sourceLineNo">1545</span>  public &lt;T&gt; T safeTrack( @Nonnull final Observer tracker,<a name="line.1545"></a>
<span class="sourceLineNo">1546</span>                          @Nonnull final SafeFunction&lt;T&gt; executable,<a name="line.1546"></a>
<span class="sourceLineNo">1547</span>                          @Nonnull final Object... parameters )<a name="line.1547"></a>
<span class="sourceLineNo">1548</span>  {<a name="line.1548"></a>
<span class="sourceLineNo">1549</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.1549"></a>
<span class="sourceLineNo">1550</span>    {<a name="line.1550"></a>
<span class="sourceLineNo">1551</span>      apiInvariant( tracker::isExternalTracker,<a name="line.1551"></a>
<span class="sourceLineNo">1552</span>                    () -&gt; "Arez-0018: Attempted to track Observer named '" + tracker.getName() + "' but " +<a name="line.1552"></a>
<span class="sourceLineNo">1553</span>                          "observer is not a tracker." );<a name="line.1553"></a>
<span class="sourceLineNo">1554</span>    }<a name="line.1554"></a>
<span class="sourceLineNo">1555</span>    return safeAction( generateNodeName( tracker ),<a name="line.1555"></a>
<span class="sourceLineNo">1556</span>                       Arez.shouldEnforceTransactionType() &amp;&amp; tracker.isMutation(),<a name="line.1556"></a>
<span class="sourceLineNo">1557</span>                       false,<a name="line.1557"></a>
<span class="sourceLineNo">1558</span>                       true,<a name="line.1558"></a>
<span class="sourceLineNo">1559</span>                       executable,<a name="line.1559"></a>
<span class="sourceLineNo">1560</span>                       tracker,<a name="line.1560"></a>
<span class="sourceLineNo">1561</span>                       parameters );<a name="line.1561"></a>
<span class="sourceLineNo">1562</span>  }<a name="line.1562"></a>
<span class="sourceLineNo">1563</span><a name="line.1563"></a>
<span class="sourceLineNo">1564</span>  private &lt;T&gt; T safeAction( @Nullable final String name,<a name="line.1564"></a>
<span class="sourceLineNo">1565</span>                            final boolean mutation,<a name="line.1565"></a>
<span class="sourceLineNo">1566</span>                            final boolean verifyActionRequired,<a name="line.1566"></a>
<span class="sourceLineNo">1567</span>                            final boolean requireNewTransaction,<a name="line.1567"></a>
<span class="sourceLineNo">1568</span>                            @Nonnull final SafeFunction&lt;T&gt; executable,<a name="line.1568"></a>
<span class="sourceLineNo">1569</span>                            @Nullable final Observer tracker,<a name="line.1569"></a>
<span class="sourceLineNo">1570</span>                            @Nonnull final Object... parameters )<a name="line.1570"></a>
<span class="sourceLineNo">1571</span>  {<a name="line.1571"></a>
<span class="sourceLineNo">1572</span>    final boolean tracked = null != tracker;<a name="line.1572"></a>
<span class="sourceLineNo">1573</span>    Throwable t = null;<a name="line.1573"></a>
<span class="sourceLineNo">1574</span>    boolean completed = false;<a name="line.1574"></a>
<span class="sourceLineNo">1575</span>    long startedAt = 0L;<a name="line.1575"></a>
<span class="sourceLineNo">1576</span>    T result;<a name="line.1576"></a>
<span class="sourceLineNo">1577</span>    try<a name="line.1577"></a>
<span class="sourceLineNo">1578</span>    {<a name="line.1578"></a>
<span class="sourceLineNo">1579</span>      if ( willPropagateSpyEvents() )<a name="line.1579"></a>
<span class="sourceLineNo">1580</span>      {<a name="line.1580"></a>
<span class="sourceLineNo">1581</span>        startedAt = System.currentTimeMillis();<a name="line.1581"></a>
<span class="sourceLineNo">1582</span>        assert null != name;<a name="line.1582"></a>
<span class="sourceLineNo">1583</span>        getSpy().reportSpyEvent( new ActionStartedEvent( name, tracked, parameters ) );<a name="line.1583"></a>
<span class="sourceLineNo">1584</span>      }<a name="line.1584"></a>
<span class="sourceLineNo">1585</span>      verifyActionNestingAllowed( name, tracker );<a name="line.1585"></a>
<span class="sourceLineNo">1586</span>      if ( canImmediatelyInvokeAction( mutation, requireNewTransaction ) )<a name="line.1586"></a>
<span class="sourceLineNo">1587</span>      {<a name="line.1587"></a>
<span class="sourceLineNo">1588</span>        result = executable.call();<a name="line.1588"></a>
<span class="sourceLineNo">1589</span>      }<a name="line.1589"></a>
<span class="sourceLineNo">1590</span>      else<a name="line.1590"></a>
<span class="sourceLineNo">1591</span>      {<a name="line.1591"></a>
<span class="sourceLineNo">1592</span>        final Transaction transaction =<a name="line.1592"></a>
<span class="sourceLineNo">1593</span>          Transaction.begin( this, generateNodeName( "Transaction", name ), mutation, tracker );<a name="line.1593"></a>
<span class="sourceLineNo">1594</span>        try<a name="line.1594"></a>
<span class="sourceLineNo">1595</span>        {<a name="line.1595"></a>
<span class="sourceLineNo">1596</span>          result = executable.call();<a name="line.1596"></a>
<span class="sourceLineNo">1597</span>          verifyActionRequired( transaction, name, verifyActionRequired );<a name="line.1597"></a>
<span class="sourceLineNo">1598</span>        }<a name="line.1598"></a>
<span class="sourceLineNo">1599</span>        finally<a name="line.1599"></a>
<span class="sourceLineNo">1600</span>        {<a name="line.1600"></a>
<span class="sourceLineNo">1601</span>          Transaction.commit( transaction );<a name="line.1601"></a>
<span class="sourceLineNo">1602</span>        }<a name="line.1602"></a>
<span class="sourceLineNo">1603</span>      }<a name="line.1603"></a>
<span class="sourceLineNo">1604</span>      if ( willPropagateSpyEvents() )<a name="line.1604"></a>
<span class="sourceLineNo">1605</span>      {<a name="line.1605"></a>
<span class="sourceLineNo">1606</span>        completed = true;<a name="line.1606"></a>
<span class="sourceLineNo">1607</span>        final long duration = System.currentTimeMillis() - startedAt;<a name="line.1607"></a>
<span class="sourceLineNo">1608</span>        assert null != name;<a name="line.1608"></a>
<span class="sourceLineNo">1609</span>        getSpy().reportSpyEvent( new ActionCompletedEvent( name, tracked, parameters, true, result, null, duration ) );<a name="line.1609"></a>
<span class="sourceLineNo">1610</span>      }<a name="line.1610"></a>
<span class="sourceLineNo">1611</span>      return result;<a name="line.1611"></a>
<span class="sourceLineNo">1612</span>    }<a name="line.1612"></a>
<span class="sourceLineNo">1613</span>    catch ( final Throwable e )<a name="line.1613"></a>
<span class="sourceLineNo">1614</span>    {<a name="line.1614"></a>
<span class="sourceLineNo">1615</span>      t = e;<a name="line.1615"></a>
<span class="sourceLineNo">1616</span>      throw e;<a name="line.1616"></a>
<span class="sourceLineNo">1617</span>    }<a name="line.1617"></a>
<span class="sourceLineNo">1618</span>    finally<a name="line.1618"></a>
<span class="sourceLineNo">1619</span>    {<a name="line.1619"></a>
<span class="sourceLineNo">1620</span>      if ( willPropagateSpyEvents() )<a name="line.1620"></a>
<span class="sourceLineNo">1621</span>      {<a name="line.1621"></a>
<span class="sourceLineNo">1622</span>        if ( !completed )<a name="line.1622"></a>
<span class="sourceLineNo">1623</span>        {<a name="line.1623"></a>
<span class="sourceLineNo">1624</span>          final long duration = System.currentTimeMillis() - startedAt;<a name="line.1624"></a>
<span class="sourceLineNo">1625</span>          assert null != name;<a name="line.1625"></a>
<span class="sourceLineNo">1626</span>          getSpy().reportSpyEvent( new ActionCompletedEvent( name, tracked, parameters, true, null, t, duration ) );<a name="line.1626"></a>
<span class="sourceLineNo">1627</span>        }<a name="line.1627"></a>
<span class="sourceLineNo">1628</span>      }<a name="line.1628"></a>
<span class="sourceLineNo">1629</span>      triggerScheduler();<a name="line.1629"></a>
<span class="sourceLineNo">1630</span>    }<a name="line.1630"></a>
<span class="sourceLineNo">1631</span>  }<a name="line.1631"></a>
<span class="sourceLineNo">1632</span><a name="line.1632"></a>
<span class="sourceLineNo">1633</span>  /**<a name="line.1633"></a>
<span class="sourceLineNo">1634</span>   * Execute the supplied executable in a read-write transaction.<a name="line.1634"></a>
<span class="sourceLineNo">1635</span>   * The procedure may throw an exception.<a name="line.1635"></a>
<span class="sourceLineNo">1636</span>   *<a name="line.1636"></a>
<span class="sourceLineNo">1637</span>   * @param executable the executable.<a name="line.1637"></a>
<span class="sourceLineNo">1638</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1638"></a>
<span class="sourceLineNo">1639</span>   * @throws Throwable if the procedure throws an an exception.<a name="line.1639"></a>
<span class="sourceLineNo">1640</span>   */<a name="line.1640"></a>
<span class="sourceLineNo">1641</span>  public void action( @Nonnull final Procedure executable, @Nonnull final Object... parameters )<a name="line.1641"></a>
<span class="sourceLineNo">1642</span>    throws Throwable<a name="line.1642"></a>
<span class="sourceLineNo">1643</span>  {<a name="line.1643"></a>
<span class="sourceLineNo">1644</span>    action( true, executable, parameters );<a name="line.1644"></a>
<span class="sourceLineNo">1645</span>  }<a name="line.1645"></a>
<span class="sourceLineNo">1646</span><a name="line.1646"></a>
<span class="sourceLineNo">1647</span>  /**<a name="line.1647"></a>
<span class="sourceLineNo">1648</span>   * Execute the supplied executable in a transaction.<a name="line.1648"></a>
<span class="sourceLineNo">1649</span>   * The executable may throw an exception.<a name="line.1649"></a>
<span class="sourceLineNo">1650</span>   *<a name="line.1650"></a>
<span class="sourceLineNo">1651</span>   * @param mutation   true if the action may modify state, false otherwise.<a name="line.1651"></a>
<span class="sourceLineNo">1652</span>   * @param executable the executable.<a name="line.1652"></a>
<span class="sourceLineNo">1653</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1653"></a>
<span class="sourceLineNo">1654</span>   * @throws Throwable if the procedure throws an an exception.<a name="line.1654"></a>
<span class="sourceLineNo">1655</span>   */<a name="line.1655"></a>
<span class="sourceLineNo">1656</span>  public void action( final boolean mutation, @Nonnull final Procedure executable, @Nonnull final Object... parameters )<a name="line.1656"></a>
<span class="sourceLineNo">1657</span>    throws Throwable<a name="line.1657"></a>
<span class="sourceLineNo">1658</span>  {<a name="line.1658"></a>
<span class="sourceLineNo">1659</span>    action( null, mutation, executable, parameters );<a name="line.1659"></a>
<span class="sourceLineNo">1660</span>  }<a name="line.1660"></a>
<span class="sourceLineNo">1661</span><a name="line.1661"></a>
<span class="sourceLineNo">1662</span>  /**<a name="line.1662"></a>
<span class="sourceLineNo">1663</span>   * Execute the supplied executable in a read-write transaction.<a name="line.1663"></a>
<span class="sourceLineNo">1664</span>   * The executable may throw an exception.<a name="line.1664"></a>
<span class="sourceLineNo">1665</span>   *<a name="line.1665"></a>
<span class="sourceLineNo">1666</span>   * @param name       the name of the transaction.<a name="line.1666"></a>
<span class="sourceLineNo">1667</span>   * @param executable the executable.<a name="line.1667"></a>
<span class="sourceLineNo">1668</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1668"></a>
<span class="sourceLineNo">1669</span>   * @throws Throwable if the procedure throws an an exception.<a name="line.1669"></a>
<span class="sourceLineNo">1670</span>   */<a name="line.1670"></a>
<span class="sourceLineNo">1671</span>  public void action( @Nullable final String name,<a name="line.1671"></a>
<span class="sourceLineNo">1672</span>                      @Nonnull final Procedure executable,<a name="line.1672"></a>
<span class="sourceLineNo">1673</span>                      @Nonnull final Object... parameters )<a name="line.1673"></a>
<span class="sourceLineNo">1674</span>    throws Throwable<a name="line.1674"></a>
<span class="sourceLineNo">1675</span>  {<a name="line.1675"></a>
<span class="sourceLineNo">1676</span>    action( name, true, executable, true, parameters );<a name="line.1676"></a>
<span class="sourceLineNo">1677</span>  }<a name="line.1677"></a>
<span class="sourceLineNo">1678</span><a name="line.1678"></a>
<span class="sourceLineNo">1679</span>  /**<a name="line.1679"></a>
<span class="sourceLineNo">1680</span>   * Execute the supplied executable in a transaction.<a name="line.1680"></a>
<span class="sourceLineNo">1681</span>   * The executable may throw an exception.<a name="line.1681"></a>
<span class="sourceLineNo">1682</span>   *<a name="line.1682"></a>
<span class="sourceLineNo">1683</span>   * @param name       the name of the transaction.<a name="line.1683"></a>
<span class="sourceLineNo">1684</span>   * @param mutation   true if the action may modify state, false otherwise.<a name="line.1684"></a>
<span class="sourceLineNo">1685</span>   * @param executable the executable.<a name="line.1685"></a>
<span class="sourceLineNo">1686</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1686"></a>
<span class="sourceLineNo">1687</span>   * @throws Throwable if the procedure throws an an exception.<a name="line.1687"></a>
<span class="sourceLineNo">1688</span>   */<a name="line.1688"></a>
<span class="sourceLineNo">1689</span>  public void action( @Nullable final String name,<a name="line.1689"></a>
<span class="sourceLineNo">1690</span>                      final boolean mutation,<a name="line.1690"></a>
<span class="sourceLineNo">1691</span>                      @Nonnull final Procedure executable,<a name="line.1691"></a>
<span class="sourceLineNo">1692</span>                      @Nonnull final Object... parameters )<a name="line.1692"></a>
<span class="sourceLineNo">1693</span>    throws Throwable<a name="line.1693"></a>
<span class="sourceLineNo">1694</span>  {<a name="line.1694"></a>
<span class="sourceLineNo">1695</span>    action( name, mutation, true, executable, parameters );<a name="line.1695"></a>
<span class="sourceLineNo">1696</span>  }<a name="line.1696"></a>
<span class="sourceLineNo">1697</span><a name="line.1697"></a>
<span class="sourceLineNo">1698</span>  /**<a name="line.1698"></a>
<span class="sourceLineNo">1699</span>   * Execute the supplied executable in a transaction.<a name="line.1699"></a>
<span class="sourceLineNo">1700</span>   * The executable may throw an exception.<a name="line.1700"></a>
<span class="sourceLineNo">1701</span>   *<a name="line.1701"></a>
<span class="sourceLineNo">1702</span>   * @param name                 the name of the transaction.<a name="line.1702"></a>
<span class="sourceLineNo">1703</span>   * @param mutation             true if the action may modify state, false otherwise.<a name="line.1703"></a>
<span class="sourceLineNo">1704</span>   * @param verifyActionRequired true if the action will add invariant checks to ensure reads or writes occur within<a name="line.1704"></a>
<span class="sourceLineNo">1705</span>   *                             the scope of the action. If no reads or writes occur, the action need not be an<a name="line.1705"></a>
<span class="sourceLineNo">1706</span>   *                             action.<a name="line.1706"></a>
<span class="sourceLineNo">1707</span>   * @param executable           the executable.<a name="line.1707"></a>
<span class="sourceLineNo">1708</span>   * @param parameters           the parameters if any. The parameters are only used to generate a spy event.<a name="line.1708"></a>
<span class="sourceLineNo">1709</span>   * @throws Throwable if the procedure throws an an exception.<a name="line.1709"></a>
<span class="sourceLineNo">1710</span>   */<a name="line.1710"></a>
<span class="sourceLineNo">1711</span>  public void action( @Nullable final String name,<a name="line.1711"></a>
<span class="sourceLineNo">1712</span>                      final boolean mutation,<a name="line.1712"></a>
<span class="sourceLineNo">1713</span>                      final boolean verifyActionRequired,<a name="line.1713"></a>
<span class="sourceLineNo">1714</span>                      @Nonnull final Procedure executable,<a name="line.1714"></a>
<span class="sourceLineNo">1715</span>                      @Nonnull final Object... parameters )<a name="line.1715"></a>
<span class="sourceLineNo">1716</span>    throws Throwable<a name="line.1716"></a>
<span class="sourceLineNo">1717</span>  {<a name="line.1717"></a>
<span class="sourceLineNo">1718</span>    action( name, mutation, verifyActionRequired, true, executable, parameters );<a name="line.1718"></a>
<span class="sourceLineNo">1719</span>  }<a name="line.1719"></a>
<span class="sourceLineNo">1720</span><a name="line.1720"></a>
<span class="sourceLineNo">1721</span>  /**<a name="line.1721"></a>
<span class="sourceLineNo">1722</span>   * Execute the supplied executable in a transaction.<a name="line.1722"></a>
<span class="sourceLineNo">1723</span>   * The executable may throw an exception.<a name="line.1723"></a>
<span class="sourceLineNo">1724</span>   *<a name="line.1724"></a>
<span class="sourceLineNo">1725</span>   * @param name                  the name of the transaction.<a name="line.1725"></a>
<span class="sourceLineNo">1726</span>   * @param mutation              true if the action may modify state, false otherwise.<a name="line.1726"></a>
<span class="sourceLineNo">1727</span>   * @param verifyActionRequired  true if the action will add invariant checks to ensure reads or writes occur within<a name="line.1727"></a>
<span class="sourceLineNo">1728</span>   *                              the scope of the action. If no reads or writes occur, the action need not be an<a name="line.1728"></a>
<span class="sourceLineNo">1729</span>   *                              action.<a name="line.1729"></a>
<span class="sourceLineNo">1730</span>   * @param requireNewTransaction true if a new transaction should be created, false if can use the current transaction.<a name="line.1730"></a>
<span class="sourceLineNo">1731</span>   * @param executable            the executable.<a name="line.1731"></a>
<span class="sourceLineNo">1732</span>   * @param parameters            the parameters if any. The parameters are only used to generate a spy event.<a name="line.1732"></a>
<span class="sourceLineNo">1733</span>   * @throws Throwable if the procedure throws an an exception.<a name="line.1733"></a>
<span class="sourceLineNo">1734</span>   */<a name="line.1734"></a>
<span class="sourceLineNo">1735</span>  public void action( @Nullable final String name,<a name="line.1735"></a>
<span class="sourceLineNo">1736</span>                      final boolean mutation,<a name="line.1736"></a>
<span class="sourceLineNo">1737</span>                      final boolean verifyActionRequired,<a name="line.1737"></a>
<span class="sourceLineNo">1738</span>                      final boolean requireNewTransaction,<a name="line.1738"></a>
<span class="sourceLineNo">1739</span>                      @Nonnull final Procedure executable,<a name="line.1739"></a>
<span class="sourceLineNo">1740</span>                      @Nonnull final Object... parameters )<a name="line.1740"></a>
<span class="sourceLineNo">1741</span>    throws Throwable<a name="line.1741"></a>
<span class="sourceLineNo">1742</span>  {<a name="line.1742"></a>
<span class="sourceLineNo">1743</span>    _action( generateNodeName( "Transaction", name ),<a name="line.1743"></a>
<span class="sourceLineNo">1744</span>             mutation,<a name="line.1744"></a>
<span class="sourceLineNo">1745</span>             verifyActionRequired,<a name="line.1745"></a>
<span class="sourceLineNo">1746</span>             requireNewTransaction,<a name="line.1746"></a>
<span class="sourceLineNo">1747</span>             executable,<a name="line.1747"></a>
<span class="sourceLineNo">1748</span>             true,<a name="line.1748"></a>
<span class="sourceLineNo">1749</span>             null,<a name="line.1749"></a>
<span class="sourceLineNo">1750</span>             parameters );<a name="line.1750"></a>
<span class="sourceLineNo">1751</span>  }<a name="line.1751"></a>
<span class="sourceLineNo">1752</span><a name="line.1752"></a>
<span class="sourceLineNo">1753</span>  /**<a name="line.1753"></a>
<span class="sourceLineNo">1754</span>   * Execute the supplied executable with the specified Observer as the tracker.<a name="line.1754"></a>
<span class="sourceLineNo">1755</span>   * The Observer must be created by the {@link #tracker(Procedure)} methods.<a name="line.1755"></a>
<span class="sourceLineNo">1756</span>   * The executable may throw an exception.<a name="line.1756"></a>
<span class="sourceLineNo">1757</span>   *<a name="line.1757"></a>
<span class="sourceLineNo">1758</span>   * @param tracker    the tracking Observer.<a name="line.1758"></a>
<span class="sourceLineNo">1759</span>   * @param executable the executable.<a name="line.1759"></a>
<span class="sourceLineNo">1760</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1760"></a>
<span class="sourceLineNo">1761</span>   * @throws Throwable if the procedure throws an an exception.<a name="line.1761"></a>
<span class="sourceLineNo">1762</span>   */<a name="line.1762"></a>
<span class="sourceLineNo">1763</span>  public void track( @Nonnull final Observer tracker,<a name="line.1763"></a>
<span class="sourceLineNo">1764</span>                     @Nonnull final Procedure executable,<a name="line.1764"></a>
<span class="sourceLineNo">1765</span>                     @Nonnull final Object... parameters )<a name="line.1765"></a>
<span class="sourceLineNo">1766</span>    throws Throwable<a name="line.1766"></a>
<span class="sourceLineNo">1767</span>  {<a name="line.1767"></a>
<span class="sourceLineNo">1768</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.1768"></a>
<span class="sourceLineNo">1769</span>    {<a name="line.1769"></a>
<span class="sourceLineNo">1770</span>      apiInvariant( tracker::isExternalTracker,<a name="line.1770"></a>
<span class="sourceLineNo">1771</span>                    () -&gt; "Arez-0019: Attempted to track Observer named '" + tracker.getName() + "' but " +<a name="line.1771"></a>
<span class="sourceLineNo">1772</span>                          "observer is not a tracker." );<a name="line.1772"></a>
<span class="sourceLineNo">1773</span>    }<a name="line.1773"></a>
<span class="sourceLineNo">1774</span>    _action( generateNodeName( tracker ),<a name="line.1774"></a>
<span class="sourceLineNo">1775</span>            Arez.shouldEnforceTransactionType() &amp;&amp; tracker.isMutation(),<a name="line.1775"></a>
<span class="sourceLineNo">1776</span>             false,<a name="line.1776"></a>
<span class="sourceLineNo">1777</span>             true,<a name="line.1777"></a>
<span class="sourceLineNo">1778</span>             executable,<a name="line.1778"></a>
<span class="sourceLineNo">1779</span>             true,<a name="line.1779"></a>
<span class="sourceLineNo">1780</span>             tracker,<a name="line.1780"></a>
<span class="sourceLineNo">1781</span>             parameters );<a name="line.1781"></a>
<span class="sourceLineNo">1782</span>  }<a name="line.1782"></a>
<span class="sourceLineNo">1783</span><a name="line.1783"></a>
<span class="sourceLineNo">1784</span>  @Nullable<a name="line.1784"></a>
<span class="sourceLineNo">1785</span>  private String generateNodeName( @Nonnull final Observer tracker )<a name="line.1785"></a>
<span class="sourceLineNo">1786</span>  {<a name="line.1786"></a>
<span class="sourceLineNo">1787</span>    return Arez.areNamesEnabled() ? tracker.getName() : null;<a name="line.1787"></a>
<span class="sourceLineNo">1788</span>  }<a name="line.1788"></a>
<span class="sourceLineNo">1789</span><a name="line.1789"></a>
<span class="sourceLineNo">1790</span>  void _action( @Nullable final String name,<a name="line.1790"></a>
<span class="sourceLineNo">1791</span>                final boolean mutation,<a name="line.1791"></a>
<span class="sourceLineNo">1792</span>                final boolean verifyActionRequired,<a name="line.1792"></a>
<span class="sourceLineNo">1793</span>                final boolean requireNewTransaction,<a name="line.1793"></a>
<span class="sourceLineNo">1794</span>                @Nonnull final Procedure executable,<a name="line.1794"></a>
<span class="sourceLineNo">1795</span>                final boolean reportAction,<a name="line.1795"></a>
<span class="sourceLineNo">1796</span>                @Nullable final Observer tracker,<a name="line.1796"></a>
<span class="sourceLineNo">1797</span>                @Nonnull final Object... parameters )<a name="line.1797"></a>
<span class="sourceLineNo">1798</span>    throws Throwable<a name="line.1798"></a>
<span class="sourceLineNo">1799</span>  {<a name="line.1799"></a>
<span class="sourceLineNo">1800</span>    final boolean tracked = null != tracker;<a name="line.1800"></a>
<span class="sourceLineNo">1801</span>    Throwable t = null;<a name="line.1801"></a>
<span class="sourceLineNo">1802</span>    boolean completed = false;<a name="line.1802"></a>
<span class="sourceLineNo">1803</span>    long startedAt = 0L;<a name="line.1803"></a>
<span class="sourceLineNo">1804</span>    try<a name="line.1804"></a>
<span class="sourceLineNo">1805</span>    {<a name="line.1805"></a>
<span class="sourceLineNo">1806</span>      if ( willPropagateSpyEvents() &amp;&amp; reportAction )<a name="line.1806"></a>
<span class="sourceLineNo">1807</span>      {<a name="line.1807"></a>
<span class="sourceLineNo">1808</span>        startedAt = System.currentTimeMillis();<a name="line.1808"></a>
<span class="sourceLineNo">1809</span>        assert null != name;<a name="line.1809"></a>
<span class="sourceLineNo">1810</span>        getSpy().reportSpyEvent( new ActionStartedEvent( name, tracked, parameters ) );<a name="line.1810"></a>
<span class="sourceLineNo">1811</span>      }<a name="line.1811"></a>
<span class="sourceLineNo">1812</span>      verifyActionNestingAllowed( name, tracker );<a name="line.1812"></a>
<span class="sourceLineNo">1813</span>      if ( canImmediatelyInvokeAction( mutation, requireNewTransaction ) )<a name="line.1813"></a>
<span class="sourceLineNo">1814</span>      {<a name="line.1814"></a>
<span class="sourceLineNo">1815</span>        executable.call();<a name="line.1815"></a>
<span class="sourceLineNo">1816</span>      }<a name="line.1816"></a>
<span class="sourceLineNo">1817</span>      else<a name="line.1817"></a>
<span class="sourceLineNo">1818</span>      {<a name="line.1818"></a>
<span class="sourceLineNo">1819</span>        final Transaction transaction =<a name="line.1819"></a>
<span class="sourceLineNo">1820</span>          Transaction.begin( this, generateNodeName( "Transaction", name ), mutation, tracker );<a name="line.1820"></a>
<span class="sourceLineNo">1821</span>        try<a name="line.1821"></a>
<span class="sourceLineNo">1822</span>        {<a name="line.1822"></a>
<span class="sourceLineNo">1823</span>          executable.call();<a name="line.1823"></a>
<span class="sourceLineNo">1824</span>          verifyActionRequired( transaction, name, verifyActionRequired );<a name="line.1824"></a>
<span class="sourceLineNo">1825</span>        }<a name="line.1825"></a>
<span class="sourceLineNo">1826</span>        finally<a name="line.1826"></a>
<span class="sourceLineNo">1827</span>        {<a name="line.1827"></a>
<span class="sourceLineNo">1828</span>          Transaction.commit( transaction );<a name="line.1828"></a>
<span class="sourceLineNo">1829</span>        }<a name="line.1829"></a>
<span class="sourceLineNo">1830</span>      }<a name="line.1830"></a>
<span class="sourceLineNo">1831</span>      if ( willPropagateSpyEvents() &amp;&amp; reportAction )<a name="line.1831"></a>
<span class="sourceLineNo">1832</span>      {<a name="line.1832"></a>
<span class="sourceLineNo">1833</span>        completed = true;<a name="line.1833"></a>
<span class="sourceLineNo">1834</span>        final long duration = System.currentTimeMillis() - startedAt;<a name="line.1834"></a>
<span class="sourceLineNo">1835</span>        assert null != name;<a name="line.1835"></a>
<span class="sourceLineNo">1836</span>        getSpy().reportSpyEvent( new ActionCompletedEvent( name, tracked, parameters, false, null, null, duration ) );<a name="line.1836"></a>
<span class="sourceLineNo">1837</span>      }<a name="line.1837"></a>
<span class="sourceLineNo">1838</span>    }<a name="line.1838"></a>
<span class="sourceLineNo">1839</span>    catch ( final Throwable e )<a name="line.1839"></a>
<span class="sourceLineNo">1840</span>    {<a name="line.1840"></a>
<span class="sourceLineNo">1841</span>      t = e;<a name="line.1841"></a>
<span class="sourceLineNo">1842</span>      throw e;<a name="line.1842"></a>
<span class="sourceLineNo">1843</span>    }<a name="line.1843"></a>
<span class="sourceLineNo">1844</span>    finally<a name="line.1844"></a>
<span class="sourceLineNo">1845</span>    {<a name="line.1845"></a>
<span class="sourceLineNo">1846</span>      if ( willPropagateSpyEvents() &amp;&amp; reportAction )<a name="line.1846"></a>
<span class="sourceLineNo">1847</span>      {<a name="line.1847"></a>
<span class="sourceLineNo">1848</span>        if ( !completed )<a name="line.1848"></a>
<span class="sourceLineNo">1849</span>        {<a name="line.1849"></a>
<span class="sourceLineNo">1850</span>          final long duration = System.currentTimeMillis() - startedAt;<a name="line.1850"></a>
<span class="sourceLineNo">1851</span>          assert null != name;<a name="line.1851"></a>
<span class="sourceLineNo">1852</span>          getSpy().reportSpyEvent( new ActionCompletedEvent( name, tracked, parameters, false, null, t, duration ) );<a name="line.1852"></a>
<span class="sourceLineNo">1853</span>        }<a name="line.1853"></a>
<span class="sourceLineNo">1854</span>      }<a name="line.1854"></a>
<span class="sourceLineNo">1855</span>      triggerScheduler();<a name="line.1855"></a>
<span class="sourceLineNo">1856</span>    }<a name="line.1856"></a>
<span class="sourceLineNo">1857</span>  }<a name="line.1857"></a>
<span class="sourceLineNo">1858</span><a name="line.1858"></a>
<span class="sourceLineNo">1859</span>  /**<a name="line.1859"></a>
<span class="sourceLineNo">1860</span>   * Execute the supplied executable in a read-write transaction.<a name="line.1860"></a>
<span class="sourceLineNo">1861</span>   * The executable is should not throw an exception.<a name="line.1861"></a>
<span class="sourceLineNo">1862</span>   *<a name="line.1862"></a>
<span class="sourceLineNo">1863</span>   * @param executable the executable.<a name="line.1863"></a>
<span class="sourceLineNo">1864</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1864"></a>
<span class="sourceLineNo">1865</span>   */<a name="line.1865"></a>
<span class="sourceLineNo">1866</span>  public void safeAction( @Nonnull final SafeProcedure executable, @Nonnull final Object... parameters )<a name="line.1866"></a>
<span class="sourceLineNo">1867</span>  {<a name="line.1867"></a>
<span class="sourceLineNo">1868</span>    safeAction( true, executable, parameters );<a name="line.1868"></a>
<span class="sourceLineNo">1869</span>  }<a name="line.1869"></a>
<span class="sourceLineNo">1870</span><a name="line.1870"></a>
<span class="sourceLineNo">1871</span>  /**<a name="line.1871"></a>
<span class="sourceLineNo">1872</span>   * Execute the supplied executable in a transaction.<a name="line.1872"></a>
<span class="sourceLineNo">1873</span>   * The executable is should not throw an exception.<a name="line.1873"></a>
<span class="sourceLineNo">1874</span>   *<a name="line.1874"></a>
<span class="sourceLineNo">1875</span>   * @param mutation   true if the action may modify state, false otherwise.<a name="line.1875"></a>
<span class="sourceLineNo">1876</span>   * @param executable the executable.<a name="line.1876"></a>
<span class="sourceLineNo">1877</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1877"></a>
<span class="sourceLineNo">1878</span>   */<a name="line.1878"></a>
<span class="sourceLineNo">1879</span>  public void safeAction( final boolean mutation,<a name="line.1879"></a>
<span class="sourceLineNo">1880</span>                          @Nonnull final SafeProcedure executable,<a name="line.1880"></a>
<span class="sourceLineNo">1881</span>                          @Nonnull final Object... parameters )<a name="line.1881"></a>
<span class="sourceLineNo">1882</span>  {<a name="line.1882"></a>
<span class="sourceLineNo">1883</span>    safeAction( null, mutation, executable, parameters );<a name="line.1883"></a>
<span class="sourceLineNo">1884</span>  }<a name="line.1884"></a>
<span class="sourceLineNo">1885</span><a name="line.1885"></a>
<span class="sourceLineNo">1886</span>  /**<a name="line.1886"></a>
<span class="sourceLineNo">1887</span>   * Execute the supplied executable in a read-write transaction.<a name="line.1887"></a>
<span class="sourceLineNo">1888</span>   * The executable is should not throw an exception.<a name="line.1888"></a>
<span class="sourceLineNo">1889</span>   *<a name="line.1889"></a>
<span class="sourceLineNo">1890</span>   * @param name       the name of the transaction.<a name="line.1890"></a>
<span class="sourceLineNo">1891</span>   * @param executable the executable.<a name="line.1891"></a>
<span class="sourceLineNo">1892</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1892"></a>
<span class="sourceLineNo">1893</span>   */<a name="line.1893"></a>
<span class="sourceLineNo">1894</span>  public void safeAction( @Nullable final String name,<a name="line.1894"></a>
<span class="sourceLineNo">1895</span>                          @Nonnull final SafeProcedure executable,<a name="line.1895"></a>
<span class="sourceLineNo">1896</span>                          @Nonnull final Object... parameters )<a name="line.1896"></a>
<span class="sourceLineNo">1897</span>  {<a name="line.1897"></a>
<span class="sourceLineNo">1898</span>    safeAction( name, true, executable, parameters );<a name="line.1898"></a>
<span class="sourceLineNo">1899</span>  }<a name="line.1899"></a>
<span class="sourceLineNo">1900</span><a name="line.1900"></a>
<span class="sourceLineNo">1901</span>  /**<a name="line.1901"></a>
<span class="sourceLineNo">1902</span>   * Execute the supplied executable in a transaction.<a name="line.1902"></a>
<span class="sourceLineNo">1903</span>   * The executable is should not throw an exception.<a name="line.1903"></a>
<span class="sourceLineNo">1904</span>   *<a name="line.1904"></a>
<span class="sourceLineNo">1905</span>   * @param name       the name of the transaction.<a name="line.1905"></a>
<span class="sourceLineNo">1906</span>   * @param mutation   true if the action may modify state, false otherwise.<a name="line.1906"></a>
<span class="sourceLineNo">1907</span>   * @param executable the executable.<a name="line.1907"></a>
<span class="sourceLineNo">1908</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1908"></a>
<span class="sourceLineNo">1909</span>   */<a name="line.1909"></a>
<span class="sourceLineNo">1910</span>  public void safeAction( @Nullable final String name,<a name="line.1910"></a>
<span class="sourceLineNo">1911</span>                          final boolean mutation,<a name="line.1911"></a>
<span class="sourceLineNo">1912</span>                          @Nonnull final SafeProcedure executable,<a name="line.1912"></a>
<span class="sourceLineNo">1913</span>                          @Nonnull final Object... parameters )<a name="line.1913"></a>
<span class="sourceLineNo">1914</span>  {<a name="line.1914"></a>
<span class="sourceLineNo">1915</span>    safeAction( name, mutation, true, executable, parameters );<a name="line.1915"></a>
<span class="sourceLineNo">1916</span>  }<a name="line.1916"></a>
<span class="sourceLineNo">1917</span><a name="line.1917"></a>
<span class="sourceLineNo">1918</span>  /**<a name="line.1918"></a>
<span class="sourceLineNo">1919</span>   * Execute the supplied executable in a transaction.<a name="line.1919"></a>
<span class="sourceLineNo">1920</span>   * The executable is should not throw an exception.<a name="line.1920"></a>
<span class="sourceLineNo">1921</span>   *<a name="line.1921"></a>
<span class="sourceLineNo">1922</span>   * @param name                 the name of the transaction.<a name="line.1922"></a>
<span class="sourceLineNo">1923</span>   * @param mutation             true if the action may modify state, false otherwise.<a name="line.1923"></a>
<span class="sourceLineNo">1924</span>   * @param verifyActionRequired true if the action will add invariant checks to ensure reads or writes occur within<a name="line.1924"></a>
<span class="sourceLineNo">1925</span>   *                             the scope of the action. If no reads or writes occur, the action need not be an<a name="line.1925"></a>
<span class="sourceLineNo">1926</span>   *                             action.<a name="line.1926"></a>
<span class="sourceLineNo">1927</span>   * @param executable           the executable.<a name="line.1927"></a>
<span class="sourceLineNo">1928</span>   * @param parameters           the parameters if any. The parameters are only used to generate a spy event.<a name="line.1928"></a>
<span class="sourceLineNo">1929</span>   */<a name="line.1929"></a>
<span class="sourceLineNo">1930</span>  public void safeAction( @Nullable final String name,<a name="line.1930"></a>
<span class="sourceLineNo">1931</span>                          final boolean mutation,<a name="line.1931"></a>
<span class="sourceLineNo">1932</span>                          final boolean verifyActionRequired,<a name="line.1932"></a>
<span class="sourceLineNo">1933</span>                          @Nonnull final SafeProcedure executable,<a name="line.1933"></a>
<span class="sourceLineNo">1934</span>                          @Nonnull final Object... parameters )<a name="line.1934"></a>
<span class="sourceLineNo">1935</span>  {<a name="line.1935"></a>
<span class="sourceLineNo">1936</span>    safeAction( name, mutation, verifyActionRequired, true, executable, parameters );<a name="line.1936"></a>
<span class="sourceLineNo">1937</span>  }<a name="line.1937"></a>
<span class="sourceLineNo">1938</span><a name="line.1938"></a>
<span class="sourceLineNo">1939</span>  /**<a name="line.1939"></a>
<span class="sourceLineNo">1940</span>   * Execute the supplied executable in a transaction.<a name="line.1940"></a>
<span class="sourceLineNo">1941</span>   * The executable is should not throw an exception.<a name="line.1941"></a>
<span class="sourceLineNo">1942</span>   *<a name="line.1942"></a>
<span class="sourceLineNo">1943</span>   * @param name                  the name of the transaction.<a name="line.1943"></a>
<span class="sourceLineNo">1944</span>   * @param mutation              true if the action may modify state, false otherwise.<a name="line.1944"></a>
<span class="sourceLineNo">1945</span>   * @param verifyActionRequired  true if the action will add invariant checks to ensure reads or writes occur within<a name="line.1945"></a>
<span class="sourceLineNo">1946</span>   *                              the scope of the action. If no reads or writes occur, the action need not be an<a name="line.1946"></a>
<span class="sourceLineNo">1947</span>   *                              action.<a name="line.1947"></a>
<span class="sourceLineNo">1948</span>   * @param requireNewTransaction true if a new transaction should be created, false if can use the current transaction.<a name="line.1948"></a>
<span class="sourceLineNo">1949</span>   * @param executable            the executable.<a name="line.1949"></a>
<span class="sourceLineNo">1950</span>   * @param parameters            the parameters if any. The parameters are only used to generate a spy event.<a name="line.1950"></a>
<span class="sourceLineNo">1951</span>   */<a name="line.1951"></a>
<span class="sourceLineNo">1952</span>  public void safeAction( @Nullable final String name,<a name="line.1952"></a>
<span class="sourceLineNo">1953</span>                          final boolean mutation,<a name="line.1953"></a>
<span class="sourceLineNo">1954</span>                          final boolean verifyActionRequired,<a name="line.1954"></a>
<span class="sourceLineNo">1955</span>                          final boolean requireNewTransaction,<a name="line.1955"></a>
<span class="sourceLineNo">1956</span>                          @Nonnull final SafeProcedure executable,<a name="line.1956"></a>
<span class="sourceLineNo">1957</span>                          @Nonnull final Object... parameters )<a name="line.1957"></a>
<span class="sourceLineNo">1958</span>  {<a name="line.1958"></a>
<span class="sourceLineNo">1959</span>    safeAction( generateNodeName( "Transaction", name ),<a name="line.1959"></a>
<span class="sourceLineNo">1960</span>                mutation,<a name="line.1960"></a>
<span class="sourceLineNo">1961</span>                verifyActionRequired,<a name="line.1961"></a>
<span class="sourceLineNo">1962</span>                requireNewTransaction,<a name="line.1962"></a>
<span class="sourceLineNo">1963</span>                executable,<a name="line.1963"></a>
<span class="sourceLineNo">1964</span>                null,<a name="line.1964"></a>
<span class="sourceLineNo">1965</span>                parameters );<a name="line.1965"></a>
<span class="sourceLineNo">1966</span>  }<a name="line.1966"></a>
<span class="sourceLineNo">1967</span><a name="line.1967"></a>
<span class="sourceLineNo">1968</span>  /**<a name="line.1968"></a>
<span class="sourceLineNo">1969</span>   * Execute the supplied executable with the specified Observer as the tracker.<a name="line.1969"></a>
<span class="sourceLineNo">1970</span>   * The Observer must be created by the {@link #tracker(Procedure)} methods.<a name="line.1970"></a>
<span class="sourceLineNo">1971</span>   * The executable is should not throw an exception.<a name="line.1971"></a>
<span class="sourceLineNo">1972</span>   *<a name="line.1972"></a>
<span class="sourceLineNo">1973</span>   * @param tracker    the tracking Observer.<a name="line.1973"></a>
<span class="sourceLineNo">1974</span>   * @param executable the executable.<a name="line.1974"></a>
<span class="sourceLineNo">1975</span>   * @param parameters the parameters if any. The parameters are only used to generate a spy event.<a name="line.1975"></a>
<span class="sourceLineNo">1976</span>   */<a name="line.1976"></a>
<span class="sourceLineNo">1977</span>  public void safeTrack( @Nonnull final Observer tracker,<a name="line.1977"></a>
<span class="sourceLineNo">1978</span>                         @Nonnull final SafeProcedure executable,<a name="line.1978"></a>
<span class="sourceLineNo">1979</span>                         @Nonnull final Object... parameters )<a name="line.1979"></a>
<span class="sourceLineNo">1980</span>  {<a name="line.1980"></a>
<span class="sourceLineNo">1981</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.1981"></a>
<span class="sourceLineNo">1982</span>    {<a name="line.1982"></a>
<span class="sourceLineNo">1983</span>      apiInvariant( tracker::isExternalTracker,<a name="line.1983"></a>
<span class="sourceLineNo">1984</span>                    () -&gt; "Arez-0020: Attempted to track Observer named '" + tracker.getName() + "' but " +<a name="line.1984"></a>
<span class="sourceLineNo">1985</span>                          "observer is not a tracker." );<a name="line.1985"></a>
<span class="sourceLineNo">1986</span>    }<a name="line.1986"></a>
<span class="sourceLineNo">1987</span>    safeAction( generateNodeName( tracker ),<a name="line.1987"></a>
<span class="sourceLineNo">1988</span>                Arez.shouldEnforceTransactionType() &amp;&amp; tracker.isMutation(),<a name="line.1988"></a>
<span class="sourceLineNo">1989</span>                false,<a name="line.1989"></a>
<span class="sourceLineNo">1990</span>                true,<a name="line.1990"></a>
<span class="sourceLineNo">1991</span>                executable,<a name="line.1991"></a>
<span class="sourceLineNo">1992</span>                tracker,<a name="line.1992"></a>
<span class="sourceLineNo">1993</span>                parameters );<a name="line.1993"></a>
<span class="sourceLineNo">1994</span>  }<a name="line.1994"></a>
<span class="sourceLineNo">1995</span><a name="line.1995"></a>
<span class="sourceLineNo">1996</span>  private void safeAction( @Nullable final String name,<a name="line.1996"></a>
<span class="sourceLineNo">1997</span>                           final boolean mutation,<a name="line.1997"></a>
<span class="sourceLineNo">1998</span>                           final boolean verifyActionRequired,<a name="line.1998"></a>
<span class="sourceLineNo">1999</span>                           final boolean requireNewTransaction,<a name="line.1999"></a>
<span class="sourceLineNo">2000</span>                           @Nonnull final SafeProcedure executable,<a name="line.2000"></a>
<span class="sourceLineNo">2001</span>                           @Nullable final Observer tracker,<a name="line.2001"></a>
<span class="sourceLineNo">2002</span>                           @Nonnull final Object... parameters )<a name="line.2002"></a>
<span class="sourceLineNo">2003</span>  {<a name="line.2003"></a>
<span class="sourceLineNo">2004</span>    final boolean tracked = null != tracker;<a name="line.2004"></a>
<span class="sourceLineNo">2005</span>    Throwable t = null;<a name="line.2005"></a>
<span class="sourceLineNo">2006</span>    boolean completed = false;<a name="line.2006"></a>
<span class="sourceLineNo">2007</span>    long startedAt = 0L;<a name="line.2007"></a>
<span class="sourceLineNo">2008</span>    try<a name="line.2008"></a>
<span class="sourceLineNo">2009</span>    {<a name="line.2009"></a>
<span class="sourceLineNo">2010</span>      if ( willPropagateSpyEvents() )<a name="line.2010"></a>
<span class="sourceLineNo">2011</span>      {<a name="line.2011"></a>
<span class="sourceLineNo">2012</span>        startedAt = System.currentTimeMillis();<a name="line.2012"></a>
<span class="sourceLineNo">2013</span>        assert null != name;<a name="line.2013"></a>
<span class="sourceLineNo">2014</span>        getSpy().reportSpyEvent( new ActionStartedEvent( name, tracked, parameters ) );<a name="line.2014"></a>
<span class="sourceLineNo">2015</span>      }<a name="line.2015"></a>
<span class="sourceLineNo">2016</span>      verifyActionNestingAllowed( name, tracker );<a name="line.2016"></a>
<span class="sourceLineNo">2017</span>      if ( canImmediatelyInvokeAction( mutation, requireNewTransaction ) )<a name="line.2017"></a>
<span class="sourceLineNo">2018</span>      {<a name="line.2018"></a>
<span class="sourceLineNo">2019</span>        executable.call();<a name="line.2019"></a>
<span class="sourceLineNo">2020</span>      }<a name="line.2020"></a>
<span class="sourceLineNo">2021</span>      else<a name="line.2021"></a>
<span class="sourceLineNo">2022</span>      {<a name="line.2022"></a>
<span class="sourceLineNo">2023</span>        final Transaction transaction =<a name="line.2023"></a>
<span class="sourceLineNo">2024</span>          Transaction.begin( this, generateNodeName( "Transaction", name ), mutation, tracker );<a name="line.2024"></a>
<span class="sourceLineNo">2025</span>        try<a name="line.2025"></a>
<span class="sourceLineNo">2026</span>        {<a name="line.2026"></a>
<span class="sourceLineNo">2027</span>          executable.call();<a name="line.2027"></a>
<span class="sourceLineNo">2028</span>          verifyActionRequired( transaction, name, verifyActionRequired );<a name="line.2028"></a>
<span class="sourceLineNo">2029</span>        }<a name="line.2029"></a>
<span class="sourceLineNo">2030</span>        finally<a name="line.2030"></a>
<span class="sourceLineNo">2031</span>        {<a name="line.2031"></a>
<span class="sourceLineNo">2032</span>          Transaction.commit( transaction );<a name="line.2032"></a>
<span class="sourceLineNo">2033</span>        }<a name="line.2033"></a>
<span class="sourceLineNo">2034</span>      }<a name="line.2034"></a>
<span class="sourceLineNo">2035</span>      if ( willPropagateSpyEvents() )<a name="line.2035"></a>
<span class="sourceLineNo">2036</span>      {<a name="line.2036"></a>
<span class="sourceLineNo">2037</span>        completed = true;<a name="line.2037"></a>
<span class="sourceLineNo">2038</span>        final long duration = System.currentTimeMillis() - startedAt;<a name="line.2038"></a>
<span class="sourceLineNo">2039</span>        assert null != name;<a name="line.2039"></a>
<span class="sourceLineNo">2040</span>        getSpy().reportSpyEvent( new ActionCompletedEvent( name, tracked, parameters, false, null, null, duration ) );<a name="line.2040"></a>
<span class="sourceLineNo">2041</span>      }<a name="line.2041"></a>
<span class="sourceLineNo">2042</span>    }<a name="line.2042"></a>
<span class="sourceLineNo">2043</span>    catch ( final Throwable e )<a name="line.2043"></a>
<span class="sourceLineNo">2044</span>    {<a name="line.2044"></a>
<span class="sourceLineNo">2045</span>      t = e;<a name="line.2045"></a>
<span class="sourceLineNo">2046</span>      throw e;<a name="line.2046"></a>
<span class="sourceLineNo">2047</span>    }<a name="line.2047"></a>
<span class="sourceLineNo">2048</span>    finally<a name="line.2048"></a>
<span class="sourceLineNo">2049</span>    {<a name="line.2049"></a>
<span class="sourceLineNo">2050</span>      if ( willPropagateSpyEvents() )<a name="line.2050"></a>
<span class="sourceLineNo">2051</span>      {<a name="line.2051"></a>
<span class="sourceLineNo">2052</span>        if ( !completed )<a name="line.2052"></a>
<span class="sourceLineNo">2053</span>        {<a name="line.2053"></a>
<span class="sourceLineNo">2054</span>          final long duration = System.currentTimeMillis() - startedAt;<a name="line.2054"></a>
<span class="sourceLineNo">2055</span>          assert null != name;<a name="line.2055"></a>
<span class="sourceLineNo">2056</span>          getSpy().reportSpyEvent( new ActionCompletedEvent( name, tracked, parameters, false, null, t, duration ) );<a name="line.2056"></a>
<span class="sourceLineNo">2057</span>        }<a name="line.2057"></a>
<span class="sourceLineNo">2058</span>      }<a name="line.2058"></a>
<span class="sourceLineNo">2059</span>      triggerScheduler();<a name="line.2059"></a>
<span class="sourceLineNo">2060</span>    }<a name="line.2060"></a>
<span class="sourceLineNo">2061</span>  }<a name="line.2061"></a>
<span class="sourceLineNo">2062</span><a name="line.2062"></a>
<span class="sourceLineNo">2063</span>  private void verifyActionNestingAllowed( @Nullable final String name, @Nullable final Observer tracker )<a name="line.2063"></a>
<span class="sourceLineNo">2064</span>  {<a name="line.2064"></a>
<span class="sourceLineNo">2065</span>    if ( Arez.shouldEnforceTransactionType() )<a name="line.2065"></a>
<span class="sourceLineNo">2066</span>    {<a name="line.2066"></a>
<span class="sourceLineNo">2067</span>      final Transaction parentTransaction = Transaction.isTransactionActive( this ) ? Transaction.current() : null;<a name="line.2067"></a>
<span class="sourceLineNo">2068</span>      if ( null != parentTransaction )<a name="line.2068"></a>
<span class="sourceLineNo">2069</span>      {<a name="line.2069"></a>
<span class="sourceLineNo">2070</span>        final Observer parent = parentTransaction.getTracker();<a name="line.2070"></a>
<span class="sourceLineNo">2071</span>        apiInvariant( () -&gt; null == parent ||<a name="line.2071"></a>
<span class="sourceLineNo">2072</span>                            parent.canNestActions() ||<a name="line.2072"></a>
<span class="sourceLineNo">2073</span>                            ( null != tracker &amp;&amp; tracker.isComputedValue() ),<a name="line.2073"></a>
<span class="sourceLineNo">2074</span>                      () -&gt; "Arez-0187: Attempting to nest action named '" + name + "' " +<a name="line.2074"></a>
<span class="sourceLineNo">2075</span>                            "inside transaction named '" + parentTransaction.getName() + "' created by an " +<a name="line.2075"></a>
<span class="sourceLineNo">2076</span>                            "observer that does not allow nested actions." );<a name="line.2076"></a>
<span class="sourceLineNo">2077</span>      }<a name="line.2077"></a>
<span class="sourceLineNo">2078</span>    }<a name="line.2078"></a>
<span class="sourceLineNo">2079</span>  }<a name="line.2079"></a>
<span class="sourceLineNo">2080</span><a name="line.2080"></a>
<span class="sourceLineNo">2081</span>  /**<a name="line.2081"></a>
<span class="sourceLineNo">2082</span>   * Return true if action can immediately invoked, false if a transaction needs to be created.<a name="line.2082"></a>
<span class="sourceLineNo">2083</span>   */<a name="line.2083"></a>
<span class="sourceLineNo">2084</span>  private boolean canImmediatelyInvokeAction( final boolean mutation, final boolean requireNewTransaction )<a name="line.2084"></a>
<span class="sourceLineNo">2085</span>  {<a name="line.2085"></a>
<span class="sourceLineNo">2086</span>    return !requireNewTransaction &amp;&amp;<a name="line.2086"></a>
<span class="sourceLineNo">2087</span>           ( Arez.shouldEnforceTransactionType() &amp;&amp; mutation ? isWriteTransactionActive() : isTransactionActive() );<a name="line.2087"></a>
<span class="sourceLineNo">2088</span>  }<a name="line.2088"></a>
<span class="sourceLineNo">2089</span><a name="line.2089"></a>
<span class="sourceLineNo">2090</span>  /**<a name="line.2090"></a>
<span class="sourceLineNo">2091</span>   * Execute the specified action outside of a transaction.<a name="line.2091"></a>
<span class="sourceLineNo">2092</span>   * The transaction is suspended for the duration of the action and the action must not<a name="line.2092"></a>
<span class="sourceLineNo">2093</span>   * attempt to create a nested transaction.<a name="line.2093"></a>
<span class="sourceLineNo">2094</span>   * The executable may throw an exception.<a name="line.2094"></a>
<span class="sourceLineNo">2095</span>   *<a name="line.2095"></a>
<span class="sourceLineNo">2096</span>   * @param executable the executable.<a name="line.2096"></a>
<span class="sourceLineNo">2097</span>   * @throws Throwable if the action throws an an exception.<a name="line.2097"></a>
<span class="sourceLineNo">2098</span>   */<a name="line.2098"></a>
<span class="sourceLineNo">2099</span>  public void noTxAction( @Nonnull final Procedure executable )<a name="line.2099"></a>
<span class="sourceLineNo">2100</span>    throws Throwable<a name="line.2100"></a>
<span class="sourceLineNo">2101</span>  {<a name="line.2101"></a>
<span class="sourceLineNo">2102</span>    final Transaction current = Transaction.current();<a name="line.2102"></a>
<span class="sourceLineNo">2103</span>    Transaction.suspend( current );<a name="line.2103"></a>
<span class="sourceLineNo">2104</span>    try<a name="line.2104"></a>
<span class="sourceLineNo">2105</span>    {<a name="line.2105"></a>
<span class="sourceLineNo">2106</span>      executable.call();<a name="line.2106"></a>
<span class="sourceLineNo">2107</span>    }<a name="line.2107"></a>
<span class="sourceLineNo">2108</span>    finally<a name="line.2108"></a>
<span class="sourceLineNo">2109</span>    {<a name="line.2109"></a>
<span class="sourceLineNo">2110</span>      Transaction.resume( current );<a name="line.2110"></a>
<span class="sourceLineNo">2111</span>    }<a name="line.2111"></a>
<span class="sourceLineNo">2112</span>  }<a name="line.2112"></a>
<span class="sourceLineNo">2113</span><a name="line.2113"></a>
<span class="sourceLineNo">2114</span>  /**<a name="line.2114"></a>
<span class="sourceLineNo">2115</span>   * Execute the specified action outside of a transaction.<a name="line.2115"></a>
<span class="sourceLineNo">2116</span>   * The transaction is suspended for the duration of the action and the action must not<a name="line.2116"></a>
<span class="sourceLineNo">2117</span>   * attempt to create a nested transaction.<a name="line.2117"></a>
<span class="sourceLineNo">2118</span>   * The executable may throw an exception.<a name="line.2118"></a>
<span class="sourceLineNo">2119</span>   *<a name="line.2119"></a>
<span class="sourceLineNo">2120</span>   * @param &lt;T&gt;        the type of return value.<a name="line.2120"></a>
<span class="sourceLineNo">2121</span>   * @param executable the executable.<a name="line.2121"></a>
<span class="sourceLineNo">2122</span>   * @return the value returned from the executable.<a name="line.2122"></a>
<span class="sourceLineNo">2123</span>   * @throws Throwable if the action throws an an exception.<a name="line.2123"></a>
<span class="sourceLineNo">2124</span>   */<a name="line.2124"></a>
<span class="sourceLineNo">2125</span>  public &lt;T&gt; T noTxAction( @Nonnull final Function&lt;T&gt; executable )<a name="line.2125"></a>
<span class="sourceLineNo">2126</span>    throws Throwable<a name="line.2126"></a>
<span class="sourceLineNo">2127</span>  {<a name="line.2127"></a>
<span class="sourceLineNo">2128</span>    final Transaction current = Transaction.current();<a name="line.2128"></a>
<span class="sourceLineNo">2129</span>    Transaction.suspend( current );<a name="line.2129"></a>
<span class="sourceLineNo">2130</span>    try<a name="line.2130"></a>
<span class="sourceLineNo">2131</span>    {<a name="line.2131"></a>
<span class="sourceLineNo">2132</span>      return executable.call();<a name="line.2132"></a>
<span class="sourceLineNo">2133</span>    }<a name="line.2133"></a>
<span class="sourceLineNo">2134</span>    finally<a name="line.2134"></a>
<span class="sourceLineNo">2135</span>    {<a name="line.2135"></a>
<span class="sourceLineNo">2136</span>      Transaction.resume( current );<a name="line.2136"></a>
<span class="sourceLineNo">2137</span>    }<a name="line.2137"></a>
<span class="sourceLineNo">2138</span>  }<a name="line.2138"></a>
<span class="sourceLineNo">2139</span><a name="line.2139"></a>
<span class="sourceLineNo">2140</span>  /**<a name="line.2140"></a>
<span class="sourceLineNo">2141</span>   * Execute the specified action outside of a transaction.<a name="line.2141"></a>
<span class="sourceLineNo">2142</span>   * The transaction is suspended for the duration of the action and the action must not<a name="line.2142"></a>
<span class="sourceLineNo">2143</span>   * attempt to create a nested transaction.<a name="line.2143"></a>
<span class="sourceLineNo">2144</span>   *<a name="line.2144"></a>
<span class="sourceLineNo">2145</span>   * @param executable the executable.<a name="line.2145"></a>
<span class="sourceLineNo">2146</span>   */<a name="line.2146"></a>
<span class="sourceLineNo">2147</span>  public void safeNoTxAction( @Nonnull final SafeProcedure executable )<a name="line.2147"></a>
<span class="sourceLineNo">2148</span>  {<a name="line.2148"></a>
<span class="sourceLineNo">2149</span>    final Transaction current = Transaction.current();<a name="line.2149"></a>
<span class="sourceLineNo">2150</span>    Transaction.suspend( current );<a name="line.2150"></a>
<span class="sourceLineNo">2151</span>    try<a name="line.2151"></a>
<span class="sourceLineNo">2152</span>    {<a name="line.2152"></a>
<span class="sourceLineNo">2153</span>      executable.call();<a name="line.2153"></a>
<span class="sourceLineNo">2154</span>    }<a name="line.2154"></a>
<span class="sourceLineNo">2155</span>    finally<a name="line.2155"></a>
<span class="sourceLineNo">2156</span>    {<a name="line.2156"></a>
<span class="sourceLineNo">2157</span>      Transaction.resume( current );<a name="line.2157"></a>
<span class="sourceLineNo">2158</span>    }<a name="line.2158"></a>
<span class="sourceLineNo">2159</span>  }<a name="line.2159"></a>
<span class="sourceLineNo">2160</span><a name="line.2160"></a>
<span class="sourceLineNo">2161</span>  /**<a name="line.2161"></a>
<span class="sourceLineNo">2162</span>   * Execute the specified action outside of a transaction.<a name="line.2162"></a>
<span class="sourceLineNo">2163</span>   * The transaction is suspended for the duration of the action and the action must not<a name="line.2163"></a>
<span class="sourceLineNo">2164</span>   * attempt to create a nested transaction.<a name="line.2164"></a>
<span class="sourceLineNo">2165</span>   *<a name="line.2165"></a>
<span class="sourceLineNo">2166</span>   * @param &lt;T&gt;        the type of return value.<a name="line.2166"></a>
<span class="sourceLineNo">2167</span>   * @param executable the executable.<a name="line.2167"></a>
<span class="sourceLineNo">2168</span>   * @return the value returned from the executable.<a name="line.2168"></a>
<span class="sourceLineNo">2169</span>   */<a name="line.2169"></a>
<span class="sourceLineNo">2170</span>  public &lt;T&gt; T safeNoTxAction( @Nonnull final SafeFunction&lt;T&gt; executable )<a name="line.2170"></a>
<span class="sourceLineNo">2171</span>  {<a name="line.2171"></a>
<span class="sourceLineNo">2172</span>    final Transaction current = Transaction.current();<a name="line.2172"></a>
<span class="sourceLineNo">2173</span>    Transaction.suspend( current );<a name="line.2173"></a>
<span class="sourceLineNo">2174</span>    try<a name="line.2174"></a>
<span class="sourceLineNo">2175</span>    {<a name="line.2175"></a>
<span class="sourceLineNo">2176</span>      return executable.call();<a name="line.2176"></a>
<span class="sourceLineNo">2177</span>    }<a name="line.2177"></a>
<span class="sourceLineNo">2178</span>    finally<a name="line.2178"></a>
<span class="sourceLineNo">2179</span>    {<a name="line.2179"></a>
<span class="sourceLineNo">2180</span>      Transaction.resume( current );<a name="line.2180"></a>
<span class="sourceLineNo">2181</span>    }<a name="line.2181"></a>
<span class="sourceLineNo">2182</span>  }<a name="line.2182"></a>
<span class="sourceLineNo">2183</span><a name="line.2183"></a>
<span class="sourceLineNo">2184</span>  /**<a name="line.2184"></a>
<span class="sourceLineNo">2185</span>   * Return next transaction id and increment internal counter.<a name="line.2185"></a>
<span class="sourceLineNo">2186</span>   * The id is a monotonically increasing number starting at 1.<a name="line.2186"></a>
<span class="sourceLineNo">2187</span>   *<a name="line.2187"></a>
<span class="sourceLineNo">2188</span>   * @return the next transaction id.<a name="line.2188"></a>
<span class="sourceLineNo">2189</span>   */<a name="line.2189"></a>
<span class="sourceLineNo">2190</span>  int nextTransactionId()<a name="line.2190"></a>
<span class="sourceLineNo">2191</span>  {<a name="line.2191"></a>
<span class="sourceLineNo">2192</span>    return _nextTransactionId++;<a name="line.2192"></a>
<span class="sourceLineNo">2193</span>  }<a name="line.2193"></a>
<span class="sourceLineNo">2194</span><a name="line.2194"></a>
<span class="sourceLineNo">2195</span>  /**<a name="line.2195"></a>
<span class="sourceLineNo">2196</span>   * Register an entity locator to use to resolve references.<a name="line.2196"></a>
<span class="sourceLineNo">2197</span>   * The Locator must not already be registered.<a name="line.2197"></a>
<span class="sourceLineNo">2198</span>   * This should not be invoked unless Arez.areReferencesEnabled() returns true.<a name="line.2198"></a>
<span class="sourceLineNo">2199</span>   *<a name="line.2199"></a>
<span class="sourceLineNo">2200</span>   * @param locator the Locator to register.<a name="line.2200"></a>
<span class="sourceLineNo">2201</span>   * @return the disposable to dispose to deregister locator.<a name="line.2201"></a>
<span class="sourceLineNo">2202</span>   */<a name="line.2202"></a>
<span class="sourceLineNo">2203</span>  @Nonnull<a name="line.2203"></a>
<span class="sourceLineNo">2204</span>  public Disposable registerLocator( @Nonnull final Locator locator )<a name="line.2204"></a>
<span class="sourceLineNo">2205</span>  {<a name="line.2205"></a>
<span class="sourceLineNo">2206</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.2206"></a>
<span class="sourceLineNo">2207</span>    {<a name="line.2207"></a>
<span class="sourceLineNo">2208</span>      apiInvariant( Arez::areReferencesEnabled,<a name="line.2208"></a>
<span class="sourceLineNo">2209</span>                    () -&gt; "Arez-0191: ArezContext.registerLocator invoked but Arez.areReferencesEnabled() returned false." );<a name="line.2209"></a>
<span class="sourceLineNo">2210</span>    }<a name="line.2210"></a>
<span class="sourceLineNo">2211</span>    assert null != _locator;<a name="line.2211"></a>
<span class="sourceLineNo">2212</span>    return _locator.registerLocator( Objects.requireNonNull( locator ) );<a name="line.2212"></a>
<span class="sourceLineNo">2213</span>  }<a name="line.2213"></a>
<span class="sourceLineNo">2214</span><a name="line.2214"></a>
<span class="sourceLineNo">2215</span>  /**<a name="line.2215"></a>
<span class="sourceLineNo">2216</span>   * Return the locator that can be used to resolve references.<a name="line.2216"></a>
<span class="sourceLineNo">2217</span>   * This should not be invoked unless Arez.areReferencesEnabled() returns true.<a name="line.2217"></a>
<span class="sourceLineNo">2218</span>   *<a name="line.2218"></a>
<span class="sourceLineNo">2219</span>   * @return the Locator.<a name="line.2219"></a>
<span class="sourceLineNo">2220</span>   */<a name="line.2220"></a>
<span class="sourceLineNo">2221</span>  @Nonnull<a name="line.2221"></a>
<span class="sourceLineNo">2222</span>  public Locator locator()<a name="line.2222"></a>
<span class="sourceLineNo">2223</span>  {<a name="line.2223"></a>
<span class="sourceLineNo">2224</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.2224"></a>
<span class="sourceLineNo">2225</span>    {<a name="line.2225"></a>
<span class="sourceLineNo">2226</span>      apiInvariant( Arez::areReferencesEnabled,<a name="line.2226"></a>
<span class="sourceLineNo">2227</span>                    () -&gt; "Arez-0192: ArezContext.locator() invoked but Arez.areReferencesEnabled() returned false." );<a name="line.2227"></a>
<span class="sourceLineNo">2228</span>    }<a name="line.2228"></a>
<span class="sourceLineNo">2229</span>    assert null != _locator;<a name="line.2229"></a>
<span class="sourceLineNo">2230</span>    return _locator;<a name="line.2230"></a>
<span class="sourceLineNo">2231</span>  }<a name="line.2231"></a>
<span class="sourceLineNo">2232</span><a name="line.2232"></a>
<span class="sourceLineNo">2233</span>  /**<a name="line.2233"></a>
<span class="sourceLineNo">2234</span>   * Add error handler to the list of error handlers called.<a name="line.2234"></a>
<span class="sourceLineNo">2235</span>   * The handler should not already be in the list. This method should NOT be called if<a name="line.2235"></a>
<span class="sourceLineNo">2236</span>   * {@link Arez#areObserverErrorHandlersEnabled()} returns false.<a name="line.2236"></a>
<span class="sourceLineNo">2237</span>   *<a name="line.2237"></a>
<span class="sourceLineNo">2238</span>   * @param handler the error handler.<a name="line.2238"></a>
<span class="sourceLineNo">2239</span>   */<a name="line.2239"></a>
<span class="sourceLineNo">2240</span>  public void addObserverErrorHandler( @Nonnull final ObserverErrorHandler handler )<a name="line.2240"></a>
<span class="sourceLineNo">2241</span>  {<a name="line.2241"></a>
<span class="sourceLineNo">2242</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2242"></a>
<span class="sourceLineNo">2243</span>    {<a name="line.2243"></a>
<span class="sourceLineNo">2244</span>      invariant( Arez::areObserverErrorHandlersEnabled,<a name="line.2244"></a>
<span class="sourceLineNo">2245</span>                 () -&gt; "Arez-0182: ArezContext.addObserverErrorHandler() invoked when Arez.areObserverErrorHandlersEnabled() returns false." );<a name="line.2245"></a>
<span class="sourceLineNo">2246</span>    }<a name="line.2246"></a>
<span class="sourceLineNo">2247</span>    assert null != _observerErrorHandlerSupport;<a name="line.2247"></a>
<span class="sourceLineNo">2248</span>    _observerErrorHandlerSupport.addObserverErrorHandler( handler );<a name="line.2248"></a>
<span class="sourceLineNo">2249</span>  }<a name="line.2249"></a>
<span class="sourceLineNo">2250</span><a name="line.2250"></a>
<span class="sourceLineNo">2251</span>  /**<a name="line.2251"></a>
<span class="sourceLineNo">2252</span>   * Remove error handler from list of existing error handlers.<a name="line.2252"></a>
<span class="sourceLineNo">2253</span>   * The handler should already be in the list. This method should NOT be called if<a name="line.2253"></a>
<span class="sourceLineNo">2254</span>   * {@link Arez#areObserverErrorHandlersEnabled()} returns false.<a name="line.2254"></a>
<span class="sourceLineNo">2255</span>   *<a name="line.2255"></a>
<span class="sourceLineNo">2256</span>   * @param handler the error handler.<a name="line.2256"></a>
<span class="sourceLineNo">2257</span>   */<a name="line.2257"></a>
<span class="sourceLineNo">2258</span>  public void removeObserverErrorHandler( @Nonnull final ObserverErrorHandler handler )<a name="line.2258"></a>
<span class="sourceLineNo">2259</span>  {<a name="line.2259"></a>
<span class="sourceLineNo">2260</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2260"></a>
<span class="sourceLineNo">2261</span>    {<a name="line.2261"></a>
<span class="sourceLineNo">2262</span>      invariant( Arez::areObserverErrorHandlersEnabled,<a name="line.2262"></a>
<span class="sourceLineNo">2263</span>                 () -&gt; "Arez-0181: ArezContext.removeObserverErrorHandler() invoked when Arez.areObserverErrorHandlersEnabled() returns false." );<a name="line.2263"></a>
<span class="sourceLineNo">2264</span>    }<a name="line.2264"></a>
<span class="sourceLineNo">2265</span>    assert null != _observerErrorHandlerSupport;<a name="line.2265"></a>
<span class="sourceLineNo">2266</span>    _observerErrorHandlerSupport.removeObserverErrorHandler( handler );<a name="line.2266"></a>
<span class="sourceLineNo">2267</span>  }<a name="line.2267"></a>
<span class="sourceLineNo">2268</span><a name="line.2268"></a>
<span class="sourceLineNo">2269</span>  /**<a name="line.2269"></a>
<span class="sourceLineNo">2270</span>   * Report an error in observer.<a name="line.2270"></a>
<span class="sourceLineNo">2271</span>   *<a name="line.2271"></a>
<span class="sourceLineNo">2272</span>   * @param observer  the observer that generated error.<a name="line.2272"></a>
<span class="sourceLineNo">2273</span>   * @param error     the type of the error.<a name="line.2273"></a>
<span class="sourceLineNo">2274</span>   * @param throwable the exception that caused error if any.<a name="line.2274"></a>
<span class="sourceLineNo">2275</span>   */<a name="line.2275"></a>
<span class="sourceLineNo">2276</span>  void reportObserverError( @Nonnull final Observer observer,<a name="line.2276"></a>
<span class="sourceLineNo">2277</span>                            @Nonnull final ObserverError error,<a name="line.2277"></a>
<span class="sourceLineNo">2278</span>                            @Nullable final Throwable throwable )<a name="line.2278"></a>
<span class="sourceLineNo">2279</span>  {<a name="line.2279"></a>
<span class="sourceLineNo">2280</span>    if ( willPropagateSpyEvents() )<a name="line.2280"></a>
<span class="sourceLineNo">2281</span>    {<a name="line.2281"></a>
<span class="sourceLineNo">2282</span>      getSpy().reportSpyEvent( new ObserverErrorEvent( observer.asInfo(), error, throwable ) );<a name="line.2282"></a>
<span class="sourceLineNo">2283</span>    }<a name="line.2283"></a>
<span class="sourceLineNo">2284</span>    if ( Arez.areObserverErrorHandlersEnabled() )<a name="line.2284"></a>
<span class="sourceLineNo">2285</span>    {<a name="line.2285"></a>
<span class="sourceLineNo">2286</span>      assert null != _observerErrorHandlerSupport;<a name="line.2286"></a>
<span class="sourceLineNo">2287</span>      _observerErrorHandlerSupport.onObserverError( observer, error, throwable );<a name="line.2287"></a>
<span class="sourceLineNo">2288</span>    }<a name="line.2288"></a>
<span class="sourceLineNo">2289</span>  }<a name="line.2289"></a>
<span class="sourceLineNo">2290</span><a name="line.2290"></a>
<span class="sourceLineNo">2291</span>  /**<a name="line.2291"></a>
<span class="sourceLineNo">2292</span>   * Return true if spy events will be propagated.<a name="line.2292"></a>
<span class="sourceLineNo">2293</span>   * This means spies are enabled and there is at least one spy event handler present.<a name="line.2293"></a>
<span class="sourceLineNo">2294</span>   *<a name="line.2294"></a>
<span class="sourceLineNo">2295</span>   * @return true if spy events will be propagated, false otherwise.<a name="line.2295"></a>
<span class="sourceLineNo">2296</span>   */<a name="line.2296"></a>
<span class="sourceLineNo">2297</span>  boolean willPropagateSpyEvents()<a name="line.2297"></a>
<span class="sourceLineNo">2298</span>  {<a name="line.2298"></a>
<span class="sourceLineNo">2299</span>    return Arez.areSpiesEnabled() &amp;&amp; getSpy().willPropagateSpyEvents();<a name="line.2299"></a>
<span class="sourceLineNo">2300</span>  }<a name="line.2300"></a>
<span class="sourceLineNo">2301</span><a name="line.2301"></a>
<span class="sourceLineNo">2302</span>  /**<a name="line.2302"></a>
<span class="sourceLineNo">2303</span>   * Return the spy associated with context.<a name="line.2303"></a>
<span class="sourceLineNo">2304</span>   * This method should not be invoked unless {@link Arez#areSpiesEnabled()} returns true.<a name="line.2304"></a>
<span class="sourceLineNo">2305</span>   *<a name="line.2305"></a>
<span class="sourceLineNo">2306</span>   * @return the spy associated with context.<a name="line.2306"></a>
<span class="sourceLineNo">2307</span>   */<a name="line.2307"></a>
<span class="sourceLineNo">2308</span>  @Nonnull<a name="line.2308"></a>
<span class="sourceLineNo">2309</span>  public Spy getSpy()<a name="line.2309"></a>
<span class="sourceLineNo">2310</span>  {<a name="line.2310"></a>
<span class="sourceLineNo">2311</span>    if ( Arez.shouldCheckApiInvariants() )<a name="line.2311"></a>
<span class="sourceLineNo">2312</span>    {<a name="line.2312"></a>
<span class="sourceLineNo">2313</span>      apiInvariant( Arez::areSpiesEnabled, () -&gt; "Arez-0021: Attempting to get Spy but spies are not enabled." );<a name="line.2313"></a>
<span class="sourceLineNo">2314</span>    }<a name="line.2314"></a>
<span class="sourceLineNo">2315</span>    assert null != _spy;<a name="line.2315"></a>
<span class="sourceLineNo">2316</span>    return _spy;<a name="line.2316"></a>
<span class="sourceLineNo">2317</span>  }<a name="line.2317"></a>
<span class="sourceLineNo">2318</span><a name="line.2318"></a>
<span class="sourceLineNo">2319</span>  /**<a name="line.2319"></a>
<span class="sourceLineNo">2320</span>   * Verify the action reads or writes to observables occur within scope of<a name="line.2320"></a>
<span class="sourceLineNo">2321</span>   * action if the verifyActionRequired parameter is true.<a name="line.2321"></a>
<span class="sourceLineNo">2322</span>   *<a name="line.2322"></a>
<span class="sourceLineNo">2323</span>   * @param transaction          the associated transaction.<a name="line.2323"></a>
<span class="sourceLineNo">2324</span>   * @param name                 the action name.<a name="line.2324"></a>
<span class="sourceLineNo">2325</span>   * @param verifyActionRequired if true then attempt validation.<a name="line.2325"></a>
<span class="sourceLineNo">2326</span>   */<a name="line.2326"></a>
<span class="sourceLineNo">2327</span>  private void verifyActionRequired( @Nonnull final Transaction transaction,<a name="line.2327"></a>
<span class="sourceLineNo">2328</span>                                     @Nullable final String name,<a name="line.2328"></a>
<span class="sourceLineNo">2329</span>                                     final boolean verifyActionRequired )<a name="line.2329"></a>
<span class="sourceLineNo">2330</span>  {<a name="line.2330"></a>
<span class="sourceLineNo">2331</span>    if ( Arez.shouldCheckInvariants() &amp;&amp; verifyActionRequired )<a name="line.2331"></a>
<span class="sourceLineNo">2332</span>    {<a name="line.2332"></a>
<span class="sourceLineNo">2333</span>      invariant( transaction::hasReadOrWriteOccurred,<a name="line.2333"></a>
<span class="sourceLineNo">2334</span>                 () -&gt; "Arez-0185: Action named '" + name + "' completed but no reads or writes " +<a name="line.2334"></a>
<span class="sourceLineNo">2335</span>                       "occurred within the scope of the action." );<a name="line.2335"></a>
<span class="sourceLineNo">2336</span>    }<a name="line.2336"></a>
<span class="sourceLineNo">2337</span>  }<a name="line.2337"></a>
<span class="sourceLineNo">2338</span><a name="line.2338"></a>
<span class="sourceLineNo">2339</span>  void registerObservableValue( @Nonnull final ObservableValue observableValue )<a name="line.2339"></a>
<span class="sourceLineNo">2340</span>  {<a name="line.2340"></a>
<span class="sourceLineNo">2341</span>    final String name = observableValue.getName();<a name="line.2341"></a>
<span class="sourceLineNo">2342</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2342"></a>
<span class="sourceLineNo">2343</span>    {<a name="line.2343"></a>
<span class="sourceLineNo">2344</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2344"></a>
<span class="sourceLineNo">2345</span>                 () -&gt; "Arez-0022: ArezContext.registerObservableValue invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2345"></a>
<span class="sourceLineNo">2346</span>      assert null != _observables;<a name="line.2346"></a>
<span class="sourceLineNo">2347</span>      invariant( () -&gt; !_observables.containsKey( name ),<a name="line.2347"></a>
<span class="sourceLineNo">2348</span>                 () -&gt; "Arez-0023: ArezContext.registerObservableValue invoked with observableValue named '" + name +<a name="line.2348"></a>
<span class="sourceLineNo">2349</span>                       "' but an existing observableValue with that name is already registered." );<a name="line.2349"></a>
<span class="sourceLineNo">2350</span>    }<a name="line.2350"></a>
<span class="sourceLineNo">2351</span>    assert null != _observables;<a name="line.2351"></a>
<span class="sourceLineNo">2352</span>    _observables.put( name, observableValue );<a name="line.2352"></a>
<span class="sourceLineNo">2353</span>  }<a name="line.2353"></a>
<span class="sourceLineNo">2354</span><a name="line.2354"></a>
<span class="sourceLineNo">2355</span>  void deregisterObservableValue( @Nonnull final ObservableValue observableValue )<a name="line.2355"></a>
<span class="sourceLineNo">2356</span>  {<a name="line.2356"></a>
<span class="sourceLineNo">2357</span>    final String name = observableValue.getName();<a name="line.2357"></a>
<span class="sourceLineNo">2358</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2358"></a>
<span class="sourceLineNo">2359</span>    {<a name="line.2359"></a>
<span class="sourceLineNo">2360</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2360"></a>
<span class="sourceLineNo">2361</span>                 () -&gt; "Arez-0024: ArezContext.deregisterObservableValue invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2361"></a>
<span class="sourceLineNo">2362</span>      assert null != _observables;<a name="line.2362"></a>
<span class="sourceLineNo">2363</span>      invariant( () -&gt; _observables.containsKey( name ),<a name="line.2363"></a>
<span class="sourceLineNo">2364</span>                 () -&gt; "Arez-0025: ArezContext.deregisterObservableValue invoked with observableValue named '" + name +<a name="line.2364"></a>
<span class="sourceLineNo">2365</span>                       "' but no observableValue with that name is registered." );<a name="line.2365"></a>
<span class="sourceLineNo">2366</span>    }<a name="line.2366"></a>
<span class="sourceLineNo">2367</span>    assert null != _observables;<a name="line.2367"></a>
<span class="sourceLineNo">2368</span>    _observables.remove( name );<a name="line.2368"></a>
<span class="sourceLineNo">2369</span>  }<a name="line.2369"></a>
<span class="sourceLineNo">2370</span><a name="line.2370"></a>
<span class="sourceLineNo">2371</span>  @Nonnull<a name="line.2371"></a>
<span class="sourceLineNo">2372</span>  HashMap&lt;String, ObservableValue&lt;?&gt;&gt; getTopLevelObservables()<a name="line.2372"></a>
<span class="sourceLineNo">2373</span>  {<a name="line.2373"></a>
<span class="sourceLineNo">2374</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2374"></a>
<span class="sourceLineNo">2375</span>    {<a name="line.2375"></a>
<span class="sourceLineNo">2376</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2376"></a>
<span class="sourceLineNo">2377</span>                 () -&gt; "Arez-0026: ArezContext.getTopLevelObservables() invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2377"></a>
<span class="sourceLineNo">2378</span>    }<a name="line.2378"></a>
<span class="sourceLineNo">2379</span>    assert null != _observables;<a name="line.2379"></a>
<span class="sourceLineNo">2380</span>    return _observables;<a name="line.2380"></a>
<span class="sourceLineNo">2381</span>  }<a name="line.2381"></a>
<span class="sourceLineNo">2382</span><a name="line.2382"></a>
<span class="sourceLineNo">2383</span>  void registerObserver( @Nonnull final Observer observer )<a name="line.2383"></a>
<span class="sourceLineNo">2384</span>  {<a name="line.2384"></a>
<span class="sourceLineNo">2385</span>    final String name = observer.getName();<a name="line.2385"></a>
<span class="sourceLineNo">2386</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2386"></a>
<span class="sourceLineNo">2387</span>    {<a name="line.2387"></a>
<span class="sourceLineNo">2388</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2388"></a>
<span class="sourceLineNo">2389</span>                 () -&gt; "Arez-0027: ArezContext.registerObserver invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2389"></a>
<span class="sourceLineNo">2390</span>      assert null != _observers;<a name="line.2390"></a>
<span class="sourceLineNo">2391</span>      invariant( () -&gt; !_observers.containsKey( name ),<a name="line.2391"></a>
<span class="sourceLineNo">2392</span>                 () -&gt; "Arez-0028: ArezContext.registerObserver invoked with observer named '" + name +<a name="line.2392"></a>
<span class="sourceLineNo">2393</span>                       "' but an existing observer with that name is already registered." );<a name="line.2393"></a>
<span class="sourceLineNo">2394</span>    }<a name="line.2394"></a>
<span class="sourceLineNo">2395</span>    assert null != _observers;<a name="line.2395"></a>
<span class="sourceLineNo">2396</span>    _observers.put( name, observer );<a name="line.2396"></a>
<span class="sourceLineNo">2397</span>  }<a name="line.2397"></a>
<span class="sourceLineNo">2398</span><a name="line.2398"></a>
<span class="sourceLineNo">2399</span>  void deregisterObserver( @Nonnull final Observer observer )<a name="line.2399"></a>
<span class="sourceLineNo">2400</span>  {<a name="line.2400"></a>
<span class="sourceLineNo">2401</span>    final String name = observer.getName();<a name="line.2401"></a>
<span class="sourceLineNo">2402</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2402"></a>
<span class="sourceLineNo">2403</span>    {<a name="line.2403"></a>
<span class="sourceLineNo">2404</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2404"></a>
<span class="sourceLineNo">2405</span>                 () -&gt; "Arez-0029: ArezContext.deregisterObserver invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2405"></a>
<span class="sourceLineNo">2406</span>      assert null != _observers;<a name="line.2406"></a>
<span class="sourceLineNo">2407</span>      invariant( () -&gt; _observers.containsKey( name ),<a name="line.2407"></a>
<span class="sourceLineNo">2408</span>                 () -&gt; "Arez-0030: ArezContext.deregisterObserver invoked with observer named '" + name +<a name="line.2408"></a>
<span class="sourceLineNo">2409</span>                       "' but no observer with that name is registered." );<a name="line.2409"></a>
<span class="sourceLineNo">2410</span>    }<a name="line.2410"></a>
<span class="sourceLineNo">2411</span>    assert null != _observers;<a name="line.2411"></a>
<span class="sourceLineNo">2412</span>    _observers.remove( name );<a name="line.2412"></a>
<span class="sourceLineNo">2413</span>  }<a name="line.2413"></a>
<span class="sourceLineNo">2414</span><a name="line.2414"></a>
<span class="sourceLineNo">2415</span>  @Nonnull<a name="line.2415"></a>
<span class="sourceLineNo">2416</span>  HashMap&lt;String, Observer&gt; getTopLevelObservers()<a name="line.2416"></a>
<span class="sourceLineNo">2417</span>  {<a name="line.2417"></a>
<span class="sourceLineNo">2418</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2418"></a>
<span class="sourceLineNo">2419</span>    {<a name="line.2419"></a>
<span class="sourceLineNo">2420</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2420"></a>
<span class="sourceLineNo">2421</span>                 () -&gt; "Arez-0031: ArezContext.getTopLevelObservers() invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2421"></a>
<span class="sourceLineNo">2422</span>    }<a name="line.2422"></a>
<span class="sourceLineNo">2423</span>    assert null != _observers;<a name="line.2423"></a>
<span class="sourceLineNo">2424</span>    return _observers;<a name="line.2424"></a>
<span class="sourceLineNo">2425</span>  }<a name="line.2425"></a>
<span class="sourceLineNo">2426</span><a name="line.2426"></a>
<span class="sourceLineNo">2427</span>  void registerComputedValue( @Nonnull final ComputedValue computedValue )<a name="line.2427"></a>
<span class="sourceLineNo">2428</span>  {<a name="line.2428"></a>
<span class="sourceLineNo">2429</span>    final String name = computedValue.getName();<a name="line.2429"></a>
<span class="sourceLineNo">2430</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2430"></a>
<span class="sourceLineNo">2431</span>    {<a name="line.2431"></a>
<span class="sourceLineNo">2432</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2432"></a>
<span class="sourceLineNo">2433</span>                 () -&gt; "Arez-0032: ArezContext.registerComputedValue invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2433"></a>
<span class="sourceLineNo">2434</span>      assert null != _computedValues;<a name="line.2434"></a>
<span class="sourceLineNo">2435</span>      invariant( () -&gt; !_computedValues.containsKey( name ),<a name="line.2435"></a>
<span class="sourceLineNo">2436</span>                 () -&gt; "Arez-0033: ArezContext.registerComputedValue invoked with computed value named '" + name +<a name="line.2436"></a>
<span class="sourceLineNo">2437</span>                       "' but an existing computed value with that name is already registered." );<a name="line.2437"></a>
<span class="sourceLineNo">2438</span>    }<a name="line.2438"></a>
<span class="sourceLineNo">2439</span>    assert null != _computedValues;<a name="line.2439"></a>
<span class="sourceLineNo">2440</span>    _computedValues.put( name, computedValue );<a name="line.2440"></a>
<span class="sourceLineNo">2441</span>  }<a name="line.2441"></a>
<span class="sourceLineNo">2442</span><a name="line.2442"></a>
<span class="sourceLineNo">2443</span>  void deregisterComputedValue( @Nonnull final ComputedValue computedValue )<a name="line.2443"></a>
<span class="sourceLineNo">2444</span>  {<a name="line.2444"></a>
<span class="sourceLineNo">2445</span>    final String name = computedValue.getName();<a name="line.2445"></a>
<span class="sourceLineNo">2446</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2446"></a>
<span class="sourceLineNo">2447</span>    {<a name="line.2447"></a>
<span class="sourceLineNo">2448</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2448"></a>
<span class="sourceLineNo">2449</span>                 () -&gt; "Arez-0034: ArezContext.deregisterComputedValue invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2449"></a>
<span class="sourceLineNo">2450</span>      assert null != _computedValues;<a name="line.2450"></a>
<span class="sourceLineNo">2451</span>      invariant( () -&gt; _computedValues.containsKey( name ),<a name="line.2451"></a>
<span class="sourceLineNo">2452</span>                 () -&gt; "Arez-0035: ArezContext.deregisterComputedValue invoked with computed value named '" + name +<a name="line.2452"></a>
<span class="sourceLineNo">2453</span>                       "' but no computed value with that name is registered." );<a name="line.2453"></a>
<span class="sourceLineNo">2454</span>    }<a name="line.2454"></a>
<span class="sourceLineNo">2455</span>    assert null != _computedValues;<a name="line.2455"></a>
<span class="sourceLineNo">2456</span>    _computedValues.remove( name );<a name="line.2456"></a>
<span class="sourceLineNo">2457</span>  }<a name="line.2457"></a>
<span class="sourceLineNo">2458</span><a name="line.2458"></a>
<span class="sourceLineNo">2459</span>  @Nonnull<a name="line.2459"></a>
<span class="sourceLineNo">2460</span>  HashMap&lt;String, ComputedValue&lt;?&gt;&gt; getTopLevelComputedValues()<a name="line.2460"></a>
<span class="sourceLineNo">2461</span>  {<a name="line.2461"></a>
<span class="sourceLineNo">2462</span>    if ( Arez.shouldCheckInvariants() )<a name="line.2462"></a>
<span class="sourceLineNo">2463</span>    {<a name="line.2463"></a>
<span class="sourceLineNo">2464</span>      invariant( Arez::areRegistriesEnabled,<a name="line.2464"></a>
<span class="sourceLineNo">2465</span>                 () -&gt; "Arez-0036: ArezContext.getTopLevelComputedValues() invoked when Arez.areRegistriesEnabled() returns false." );<a name="line.2465"></a>
<span class="sourceLineNo">2466</span>    }<a name="line.2466"></a>
<span class="sourceLineNo">2467</span>    assert null != _computedValues;<a name="line.2467"></a>
<span class="sourceLineNo">2468</span>    return _computedValues;<a name="line.2468"></a>
<span class="sourceLineNo">2469</span>  }<a name="line.2469"></a>
<span class="sourceLineNo">2470</span><a name="line.2470"></a>
<span class="sourceLineNo">2471</span>  @Nonnull<a name="line.2471"></a>
<span class="sourceLineNo">2472</span>  ObserverErrorHandlerSupport getObserverErrorHandlerSupport()<a name="line.2472"></a>
<span class="sourceLineNo">2473</span>  {<a name="line.2473"></a>
<span class="sourceLineNo">2474</span>    assert null != _observerErrorHandlerSupport;<a name="line.2474"></a>
<span class="sourceLineNo">2475</span>    return _observerErrorHandlerSupport;<a name="line.2475"></a>
<span class="sourceLineNo">2476</span>  }<a name="line.2476"></a>
<span class="sourceLineNo">2477</span><a name="line.2477"></a>
<span class="sourceLineNo">2478</span>  int currentNextTransactionId()<a name="line.2478"></a>
<span class="sourceLineNo">2479</span>  {<a name="line.2479"></a>
<span class="sourceLineNo">2480</span>    return _nextTransactionId;<a name="line.2480"></a>
<span class="sourceLineNo">2481</span>  }<a name="line.2481"></a>
<span class="sourceLineNo">2482</span><a name="line.2482"></a>
<span class="sourceLineNo">2483</span>  @Nonnull<a name="line.2483"></a>
<span class="sourceLineNo">2484</span>  ReactionScheduler getScheduler()<a name="line.2484"></a>
<span class="sourceLineNo">2485</span>  {<a name="line.2485"></a>
<span class="sourceLineNo">2486</span>    return _scheduler;<a name="line.2486"></a>
<span class="sourceLineNo">2487</span>  }<a name="line.2487"></a>
<span class="sourceLineNo">2488</span><a name="line.2488"></a>
<span class="sourceLineNo">2489</span>  void setNextNodeId( final int nextNodeId )<a name="line.2489"></a>
<span class="sourceLineNo">2490</span>  {<a name="line.2490"></a>
<span class="sourceLineNo">2491</span>    _nextNodeId = nextNodeId;<a name="line.2491"></a>
<span class="sourceLineNo">2492</span>  }<a name="line.2492"></a>
<span class="sourceLineNo">2493</span><a name="line.2493"></a>
<span class="sourceLineNo">2494</span>  int getNextNodeId()<a name="line.2494"></a>
<span class="sourceLineNo">2495</span>  {<a name="line.2495"></a>
<span class="sourceLineNo">2496</span>    return _nextNodeId;<a name="line.2496"></a>
<span class="sourceLineNo">2497</span>  }<a name="line.2497"></a>
<span class="sourceLineNo">2498</span><a name="line.2498"></a>
<span class="sourceLineNo">2499</span>  int getSchedulerLockCount()<a name="line.2499"></a>
<span class="sourceLineNo">2500</span>  {<a name="line.2500"></a>
<span class="sourceLineNo">2501</span>    return _schedulerLockCount;<a name="line.2501"></a>
<span class="sourceLineNo">2502</span>  }<a name="line.2502"></a>
<span class="sourceLineNo">2503</span><a name="line.2503"></a>
<span class="sourceLineNo">2504</span>  @SuppressWarnings( "SameParameterValue" )<a name="line.2504"></a>
<span class="sourceLineNo">2505</span>  void setSchedulerLockCount( final int schedulerLockCount )<a name="line.2505"></a>
<span class="sourceLineNo">2506</span>  {<a name="line.2506"></a>
<span class="sourceLineNo">2507</span>    _schedulerLockCount = schedulerLockCount;<a name="line.2507"></a>
<span class="sourceLineNo">2508</span>  }<a name="line.2508"></a>
<span class="sourceLineNo">2509</span><a name="line.2509"></a>
<span class="sourceLineNo">2510</span>  void markSchedulerAsActive()<a name="line.2510"></a>
<span class="sourceLineNo">2511</span>  {<a name="line.2511"></a>
<span class="sourceLineNo">2512</span>    _schedulerActive = true;<a name="line.2512"></a>
<span class="sourceLineNo">2513</span>  }<a name="line.2513"></a>
<span class="sourceLineNo">2514</span>}<a name="line.2514"></a>




























































</pre>
</div>
</body>
</html>
